<!--yml

类别：未分类

日期：2024-05-27 13:34:11

-->

# Firstyear 的博客

> 来源：[https://fy.blackhats.net.au/blog/2024-04-26-passkeys-a-shattered-dream/](https://fy.blackhats.net.au/blog/2024-04-26-passkeys-a-shattered-dream/)

昨晚大约在晚上11点，我的伴侣试图通过我们的家庭灯光控制系统更换客厅灯光时，她的账户无法访问。她的苹果钥匙链已删除了她在该网站上使用的 Passkey。

这只是对削弱 Webauthn 的一长串 [enshittification](https://en.wikipedia.org/wiki/Enshittification) 的点缀。我已经超越这一点了，我认为现在是为 Passkeys 倒一杯的时候了。讽刺的是，在我写下这些文字的今天，我正准备发布 [webauthn-rs](https://crates.io/crates/webauthn-rs) 的新主要版本。

## 梦想

2019 年，我飞往悉尼朋友家，花了一周时间开始编写如今 Rust 的 Webauthn 库。在那段时间里，我发现了一些标准中的问题，并为 Webauthn 工作组贡献了改进意见，尽管那些问题花了几年时间才得以解决。我开始审查规范变更并更多地参与讨论。

当时有很多乐观情绪认为这项技术可能是终结密码的一种方式。你有三个主要的使用案例：

+   第二因素

+   无密码

+   无用户名

第二因素是通往后两种情况的一个过渡阶段。无密码是你仍需输入帐户名，然后使用 PIN+Touch 对安全密钥进行身份验证，无用户名是你的帐户身份驻留（可发现）于密钥上。从我的角度来看，这被开发人员视为一个小众概念，因为一个网站要有一个 "记住我" 的复选框有多难呢？

这个库最终成为了 [Kanidm](https://kanidm.com/) 开源 IDM 中我所知道的第一个实现无密码（现在是 passkeys）。这一体验非常棒。你访问 [Kanidm](https://kanidm.com/)，输入用户名，然后提示你输入 PIN 并触摸你的密钥。简单、快速、轻松。

对于像你的 iPhone 或 Android 设备，你可以做类似的事情 - 只需使用你的 Touch ID 就可以进入。

那真的很简单，非常易于使用，我记得那几乎感觉不可能。认证可以具有密码学性质，但对消费者来说如此易用和琐碎。在 FIDO 和 Webauthn 中确实存在这样一个想法和目标，即这可能是 "终结密码" 的时代。

这是促使我继续改进 webauthn-rs 的动力。它的影响超出了我的预期，其中的部分内容被用于 Firefox 的 authenticator-rs 中，从这个库和我的工作中衍生出了整个 Rust 身份提供者（IDP）的微观世界，甚至其他语言的 Webauthn 实现和密码管理器都将我们的库作为参考实现进行测试。我无法低估 webauthn-rs 的影响力。

## 警告

然而，警告开始出现，标准并非如人们所设想的那样开放。我们现在面临的问题是众所周知的 - Chrome控制了浏览器市场的很大一部分，并且由Google严密控制其开发。

[认证器选择扩展](https://www.w3.org/TR/webauthn-1/#sctn-authenticator-selection-extension)的一个例子。

对于有严格安全要求的网站来说，这个扩展是*重要的*，因为它会证明所使用的认证器的品牌和型号。如果你知道认证将仅接受特定的设备，那么浏览器应该进行筛选，并且只允许这些设备参与。

然而，Chrome根本没有实现它，导致它被[移除](https://github.com/w3c/webauthn/issues/1386)。并且它被移除是因为Chrome从未实现它。因此，如果Chrome不喜欢规范中的某些内容，他们可以毫不犹豫地否决它，而不会受到任何后果。

后来对于未实施此功能的[理由](https://github.com/w3c/webauthn/issues/1688#issuecomment-1011516074)是：“我们从未实施它，因为我们认为认证器歧视在广泛意义上不是一件好事……他们[用户] *应该* 期望给定的安全密钥在他们想使用的地方广泛适用。”

*我希望你记住这句话及其含义。*

*用户应该能够自由选择任何设备而不受处罚。*

现在，对于互联网上的普通网站，我当然同意这种观念，但在一个有关设备可接受性政策的企业内部，过滤设备的能力确实很重要。

这使得你很可能去到一个公司网站，注册一个安全密钥，它似乎能工作，但后来注册失败了（更糟糕的是，如果这烧掉了你的某个不能被删除的常驻密钥槽位，你的设备必须进行完全重置）因为IDP拒绝了设备证明。没错，即使没有这个，IDP仍然可以对没有此扩展的设备“歧视”，但用户体验在某些情况下要糟糕得多，后果也更严重。

更糟糕的是，Chrome有内部的功能标志，他们可以为Google的需求启用自己的魔术功能，控制认证器模型的策略，而其他人必须接受次一等的体验。

更大的警告在于，这些决定很多都是在美国举行的“面对面”会议上做出的。这排除了大多数国际参与者，导致一些声音比其他声音更强烈。当你不在房间里时，很难说服别人，当房间在一个有[旅行建议](https://www.smartraveller.gov.au/destinations/americas/united-states-america)的国家时，这种情况就更加困难了，“美国的暴力犯罪比澳大利亚更普遍”，“美国存在大规模伤亡暴力和恐怖袭击的持续威胁”，“美国的医疗费用极高。你可能需要预付医疗援助费用”。（顺便说一句，有些国家因为更少的原因而有“不要旅行”的警告，但不知何故美国却被放过了…）。

## 下降

在2022年，Apple宣布了[Passkeys](https://appleinsider.com/articles/22/06/07/apple-passkey-feature-will-be-our-first-taste-of-a-truly-password-less-future)。

当时，这只是一个对无密码的“营销”术语的称呼，而且Apple的通行证可以选择性地不带用户名。总体而言，做得非常精致和出色。

当然，还有思想领袖存在，Apple还没有定义什么是通行证。其中一位思想领袖在FIDO会议上发言，宣布“通行证就是常驻密钥”，与此同时他们还发布了一个通行证开发网站（出于原则，我不会链接到它）。

这个问题在我[博客文章](../2023-02-02-how-hype-will-turn-your-security-key-into-junk/)中有详细描述，但总结起来，这种对常驻密钥的推动意味着安全密钥被排除在外，因为它们通常对存储有极低的限制，最高为25个yubikeys。对于大多数人来说，这根本不够用。

现在，作为用户的常驻密钥，我们当然不指望我们的安全密钥在我们想要使用它们时能够工作！

## 恩希托塞因纪

自那时起，通行证现在被视为将用户和观众捕捉到一个平台的一种方式。有什么比把所有他们的凭据锁在你的平台上更能鼓励长期囚禁用户的方式更好呢？甚至更好的是，这些凭据根本无法以任何方式被提取或导出。

Chrome和Safari都会试图强制你使用混合（caBLE）方式，其中你需要用手机扫描QR码进行身份验证 - 你必须通过菜单点击才能使用安全密钥。在大多数情况下，caBLE甚至都不是一个良好的体验，通常需要超过60秒的工作时间。UI已经非常让人讨厌了。有时候我觉得[密码游戏的用户体验更好](https://neal.fun/password-game/)。

更严重的问题在于 Android，如果网站发送了 Passkeys 所需的选项集，[甚至无法激活您的安全键](https://github.com/kanidm/webauthn-rs/issues/365#issuecomment-1756605203)，这意味着 IDP 可以选择您注册的设备，而您无法进行选择。当然，所有开发者示例只展示激活“存储在 Google 密码管理器中的 Google 通行密钥”的选项。毕竟，您为什么要使用其他任何东西呢？

一个令人深思的阅读材料是[GitHub 通行密钥 Beta](https://github.com/orgs/community/discussions/54450)和[GitHub 通行密钥](https://github.com/orgs/community/discussions/67791)的讨论帖。有用户反映，由于居住键槽已满，他们的安全键无法注册。多个用户描述说，由于平台错误，Android 无法创建通行密钥。某些设备需要固件重置才能创建通行密钥。密钥可以保存在客户端但不能保存在服务器上，导致账户重复存在和无法工作的凭证，甚至更糟的是导致用户删除[真实凭证](https://bugs.webkit.org/show_bug.cgi?id=270553)。

这些讨论帖上用户的无助是显而易见的 - 而这些用户都是技术上的早期采纳者。他们是我们需要说服从密码转向通行密钥的倡导者。如果这些用户无法使其正常工作，其他学科的人们又该如何应对呢？

外部存在其他问题。Apple Keychain 已经三次*个人*清除了我所有的通行密钥。我们还收到其他用户的外部报告，他们的 Keychain 通行密钥也被像我一样清除了。

自从这篇博客发表以来，许多人联系我，分享了他们自己使用通行密钥失败的故事。对这项技术的失望似乎成为常态而非例外。

作为用户，我们该如何信任这项技术，这项试图成为保护我们账户安全的默认方法的技术？

为了试图解决这个问题，工作组似乎在更加复杂的JS API上加倍努力，试图弥补他们最初造成的问题。所有这些额外复杂性都带来脆弱性和更糟的体验，但并未解决核心问题。

简直一团糟。

## 未来

我认为通行密钥在普通消费者手中将会失败。我们错过了通过渴望占领市场和推广炒作来消除密码的黄金机会。

企业利益再次凌驾于良好用户体验之上。就像广告拦截器一样，我预测通行密钥（Passkeys）只会被技术人群的一小部分使用，而消费者普遍会拒绝它们。

重申一遍 - 我的伴侣，一个极其聪明、狂热的电脑游戏玩家和*兽医外科医生*，因为用户体验太差而发誓不再使用通行密钥。她想要回到密码。

而且我开始同意——一个密码管理器比密码键提供了更好的体验。

是的。我在这里说*密码比密码键提供了更好的体验*。你知道我写下这句话有多痛苦吗？（是的，这意味着需要记忆密码管理器之外的密码的MFA仍然对重要密码很重要）。

所以，请对自己好一点。使用类似于[bitwarden](https://bitwarden.com/)这样的工具，或者如果你喜欢自行托管，可以选择[vaultwarden](https://github.com/dani-garcia/vaultwarden)。让它生成和管理你的密码。如果你真的想要密码键，把它们放在你能控制的密码管理器中。但不要使用平台控制的密码存储，并且要非常小心安全密钥。

如果你确实想使用安全密钥，只需用它来解锁你的密码管理器和电子邮件。

在企业内部，仍然存在一个需要经过验证的安全密钥的地方，你可以控制整个体验以避免供应商锁定的部分。尽管它仍然存在一些问题。就在今天，我发现了一个有损破解验证的浏览器，这不太好。你仍然必须在试图强制你通过caBLE的恶心用户体验元素中游走，尽管你的IDP只接受某些安全模型，因此你仍然可能会有一些困惑的用户。

尽管这一切，我将继续维护webauuthn-rs及其相关项目。即使我对生态系统的发展方向感到失望，它们对我仍然很重要。

但在这一点上，在[Kanidm](https://kanidm.com/)中，我们正在研究设备证书和智能卡。用户界面确实更好。这说了很多，考虑到PKCS11和PIV规范。但至少PIV不会容易受到使其变糟的尝试的影响。
