- en: <!--yml
  id: totrans-split-0
  prefs: []
  type: TYPE_NORMAL
  zh: <!--yml
- en: 'category: æœªåˆ†ç±»'
  id: totrans-split-1
  prefs: []
  type: TYPE_NORMAL
  zh: 'category: æœªåˆ†ç±»'
- en: 'date: 2024-05-27 13:14:19'
  id: totrans-split-2
  prefs: []
  type: TYPE_NORMAL
  zh: 'date: 2024-05-27 13:14:19'
- en: -->
  id: totrans-split-3
  prefs: []
  type: TYPE_NORMAL
  zh: -->
- en: Upgrading 3 Million Variables to Envelope Encryption
  id: totrans-split-4
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: å°† 300 ä¸‡ä¸ªå˜é‡å‡çº§ä¸ºä¿¡å°åŠ å¯†
- en: æ¥æºï¼š[https://blog.railway.app/p/envelope-encryption](https://blog.railway.app/p/envelope-encryption)
  id: totrans-split-5
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: æ¥æºï¼š[https://blog.railway.app/p/envelope-encryption](https://blog.railway.app/p/envelope-encryption)
- en: Railway is (temporarily, at least) hosted entirely on Google Cloud Platform
    while we begin [transitioning our infrastructure to bare metal](https://blog.railway.app/p/team-spotlight-infrastructure-engineering#a-glimpse-into-railway%27s-dynamic-infrastructure-team).
  id: totrans-split-6
  prefs: []
  type: TYPE_NORMAL
  zh: Railway åœ¨æˆ‘ä»¬å¼€å§‹ [å°†åŸºç¡€æ¶æ„è¿ç§»åˆ°è£¸é‡‘å±](https://blog.railway.app/p/team-spotlight-infrastructure-engineering#a-glimpse-into-railway%27s-dynamic-infrastructure-team)
    æ—¶ï¼ˆè‡³å°‘æ˜¯æš‚æ—¶çš„ï¼‰å®Œå…¨æ‰˜ç®¡åœ¨ Google Cloud Platform ä¸Šã€‚
- en: In the beginning, taking advantage of existing GCP-provided services to launch
    a start-up made total sense. Building core services like container registry, block
    storage, load balancers, or key management wouldâ€™ve only gotten in the way of
    building a product.
  id: totrans-split-7
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸€å¼€å§‹ï¼Œåˆ©ç”¨ç°æœ‰çš„ GCP æä¾›çš„æœåŠ¡æ¥å¯åŠ¨ä¸€ä¸ªåˆåˆ›å…¬å¸æ˜¯å®Œå…¨æœ‰é“ç†çš„ã€‚æ„å»ºæ ¸å¿ƒæœåŠ¡ï¼Œå¦‚å®¹å™¨æ³¨å†Œè¡¨ã€å—å­˜å‚¨ã€è´Ÿè½½å‡è¡¡å™¨æˆ–å¯†é’¥ç®¡ç†ï¼Œåªä¼šå¦¨ç¢äº§å“çš„å»ºè®¾ã€‚
- en: Moving to bare metal gets us the margins required to build a profitable business
    but, even disregarding cost, relying on a single infrastructure  provider is a
    huge technical risk. â€œHow often does GCP fail though?â€ You  may ask.  Enough to
    warrant an entire [blogpost](https://blog.railway.app/p/gcp-incidents) on the
    subject!
  id: totrans-split-8
  prefs: []
  type: TYPE_NORMAL
  zh: è½¬å‘è£¸é‡‘å±ä½¿æˆ‘ä»¬è·å¾—äº†æ‰€éœ€çš„åˆ©æ¶¦ç‡ï¼Œä½†å³ä½¿å¿½ç•¥æˆæœ¬ï¼Œä¾èµ–å•ä¸€åŸºç¡€è®¾æ–½æä¾›å•†ä¹Ÿæ˜¯å·¨å¤§çš„æŠ€æœ¯é£é™©ã€‚â€œGCP å¤±è´¥çš„é¢‘ç‡å¦‚ä½•ï¼Ÿâ€ ä½ å¯èƒ½ä¼šé—®ã€‚è¶³ä»¥å€¼å¾—å†™ä¸€ç¯‡
    [åšæ–‡](https://blog.railway.app/p/gcp-incidents) æ¥è®¨è®ºè¿™ä¸ªä¸»é¢˜ï¼
- en: The GCP service that continues to cause the most problems for us is Key Management
    Service (KMS). And, while the dependency still technically exists, our usage of
    KMS has been greatly reduced, making migrating away almost trivial.
  id: totrans-split-9
  prefs: []
  type: TYPE_NORMAL
  zh: å¯¹æˆ‘ä»¬é€ æˆæœ€å¤šé—®é¢˜çš„ä»ç„¶æ˜¯ GCP çš„ Key Management Service (KMS)ã€‚å°½ç®¡æŠ€æœ¯ä¸Šä»ç„¶å­˜åœ¨ä¾èµ–ï¼Œä½†æˆ‘ä»¬å¯¹ KMS çš„ä½¿ç”¨å¤§å¤§å‡å°‘ï¼Œä½¿å¾—è¿ç§»å‡ ä¹å˜å¾—å¾®ä¸è¶³é“ã€‚
- en: Letâ€™s dig into how we removed this KMS dependency while also improving performance,
    all with no downtime.
  id: totrans-split-10
  prefs: []
  type: TYPE_NORMAL
  zh: è®©æˆ‘ä»¬æ·±å…¥æ¢è®¨å¦‚ä½•åœ¨ä¸ä¸­æ–­çš„æƒ…å†µä¸‹å»é™¤è¿™ç§å¯¹ KMS çš„ä¾èµ–å¹¶åŒæ—¶æå‡æ€§èƒ½ã€‚
- en: View of cryptographic requests to KMS before and after
  id: totrans-split-11
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨ KMS åŠ å¯†è¯·æ±‚ä¹‹å‰å’Œä¹‹åçš„è§†å›¾
- en: Railway is all about making it easy for users to deploy code. These deployments
    often require configuration values like API keys and database credentials to be
    available. Railway solves this with [Service Variables](https://docs.railway.app/reference/variables#service-variables),
    which are automatically injected into deployments at runtime.
  id: totrans-split-12
  prefs: []
  type: TYPE_NORMAL
  zh: Railway è‡´åŠ›äºä½¿ç”¨æˆ·èƒ½å¤Ÿè½»æ¾éƒ¨ç½²ä»£ç ã€‚è¿™äº›éƒ¨ç½²é€šå¸¸éœ€è¦é…ç½®å€¼ï¼Œå¦‚ API å¯†é’¥å’Œæ•°æ®åº“å‡­æ®åœ¨è¿è¡Œæ—¶å¯ç”¨ã€‚Railway é€šè¿‡ [æœåŠ¡å˜é‡](https://docs.railway.app/reference/variables#service-variables)
    å®ç°äº†è¿™ä¸€ç‚¹ï¼Œè¿™äº›å˜é‡ä¼šè‡ªåŠ¨æ³¨å…¥åˆ°éƒ¨ç½²ä¸­ã€‚
- en: Since these values often contain sensitive information, they get encrypted prior
    to storage in our Postgres database. Until now, these encryption operations have
    been done by calling KMS directly.
  id: totrans-split-13
  prefs: []
  type: TYPE_NORMAL
  zh: ç”±äºè¿™äº›å€¼é€šå¸¸åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œæ‰€ä»¥åœ¨å­˜å‚¨åˆ°æˆ‘ä»¬çš„ Postgres æ•°æ®åº“ä¹‹å‰ä¼šå¯¹å…¶è¿›è¡ŒåŠ å¯†ã€‚ç›´åˆ°ç°åœ¨ï¼Œè¿™äº›åŠ å¯†æ“ä½œéƒ½æ˜¯é€šè¿‡ç›´æ¥è°ƒç”¨ KMS å®Œæˆçš„ã€‚
- en: This works as expected when the number of variables per deployment is average
    (around 10), but some deployments have hundreds ğŸ«£.
  id: totrans-split-14
  prefs: []
  type: TYPE_NORMAL
  zh: å½“éƒ¨ç½²çš„å˜é‡æ•°é‡å¹³å‡ä¸º 10 æ—¶ï¼Œè¿™ç§æ–¹æ³•èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œä½†æœ‰äº›éƒ¨ç½²ä¼šæœ‰æ•°ç™¾ä¸ª ğŸ«£ã€‚
- en: This spiky KMS usage pattern leads to problems.
  id: totrans-split-15
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™ç§æ³¢åŠ¨çš„ KMS ä½¿ç”¨æ¨¡å¼ä¼šå¯¼è‡´é—®é¢˜ã€‚
- en: KMS is an external service â†’ Decrypting hundreds of variables for a deployment
    requires many network request (~20ms each) which slows down large batches, even
    if done concurrently
  id: totrans-split-16
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: KMS æ˜¯ä¸€ä¸ªå¤–éƒ¨æœåŠ¡ â†’ è§£å¯†éƒ¨ç½²æ‰€éœ€çš„æ•°ç™¾ä¸ªå˜é‡éœ€è¦å¤§é‡çš„ç½‘ç»œè¯·æ±‚ï¼ˆæ¯ä¸ªçº¦ 20msï¼‰ï¼Œè¿™ä¼šå‡æ…¢å¤§æ‰¹é‡æ“ä½œçš„é€Ÿåº¦ï¼Œå³ä½¿æ˜¯å¹¶å‘æ‰§è¡Œä¹Ÿæ˜¯å¦‚æ­¤ã€‚
- en: KMS enforces a quota â†’ Exceeding the quota will cause all operations to fail
    temporarily. Quotas can be raised by request but approval is not guaranteed, and
    [GCP has lowered quotas without warning](https://twitter.com/JustJake/status/1667492928758095872?s=20)
    in the past
  id: totrans-split-17
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: KMS å¼ºåˆ¶æ‰§è¡Œé…é¢ â†’ è¶…è¿‡é…é¢å°†å¯¼è‡´æ‰€æœ‰æ“ä½œæš‚æ—¶å¤±è´¥ã€‚é…é¢å¯ä»¥é€šè¿‡è¯·æ±‚æå‡ï¼Œä½†ä¸ä¿è¯æ‰¹å‡†ï¼Œå¹¶ä¸”åœ¨è¿‡å» [GCP æœªç»è­¦å‘Šé™ä½äº†é…é¢](https://twitter.com/JustJake/status/1667492928758095872?s=20)ã€‚
- en: KMS is not meant for unlimited keys â†’ All variables are currently encrypted
    using the same KMS key, meaning a brute-force attack could compromise variables
    across all of Railway
  id: totrans-split-18
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: KMS ä¸é€‚ç”¨äºæ— é™å¯†é’¥ â†’ æ‰€æœ‰å˜é‡ç›®å‰éƒ½ä½¿ç”¨ç›¸åŒçš„ KMS å¯†é’¥è¿›è¡ŒåŠ å¯†ï¼Œè¿™æ„å‘³ç€æš´åŠ›æ”»å‡»å¯èƒ½ä¼šå¨èƒåˆ° Railway æ‰€æœ‰å˜é‡çš„å®‰å…¨æ€§ã€‚
- en: Fortunately, thereâ€™s a standard practice that solves all these problems at once
    and is actually what KMS is designed for. (Yes, we were holding it wrong.)
  id: totrans-split-19
  prefs: []
  type: TYPE_NORMAL
  zh: å¹¸è¿çš„æ˜¯ï¼Œæœ‰ä¸€ç§æ ‡å‡†åšæ³•å¯ä»¥ä¸€æ¬¡æ€§è§£å†³æ‰€æœ‰è¿™äº›é—®é¢˜ï¼Œè¿™å®é™…ä¸Šä¹Ÿæ˜¯ KMS è®¾è®¡çš„åˆè¡·ã€‚ï¼ˆæ˜¯çš„ï¼Œæˆ‘ä»¬ä¹‹å‰ç”¨é”™äº†ã€‚ï¼‰
- en: Envelope encryption is the practice of encrypting plaintext data â€” like variables
    â€” with a data encryption key (DEK), then encrypting the DEK with a key encryption
    key (KEK).
  id: totrans-split-20
  prefs: []
  type: TYPE_NORMAL
  zh: '**ä¿¡å°åŠ å¯†**æ˜¯ä½¿ç”¨æ•°æ®åŠ å¯†å¯†é’¥ï¼ˆDEKï¼‰åŠ å¯†æ˜æ–‡æ•°æ®ï¼ˆå¦‚å˜é‡ï¼‰ï¼Œç„¶åä½¿ç”¨å¯†é’¥åŠ å¯†å¯†é’¥ï¼ˆKEKï¼‰åŠ å¯†DEKçš„å®è·µã€‚'
- en: This reduces the surface area of an attack by allowing each user (or Railway
    project) to use separate encryption keys. Using locally generated data keys also
    means less reliance on an external key management service. Precisely what weâ€™re
    after!
  id: totrans-split-21
  prefs: []
  type: TYPE_NORMAL
  zh: é€šè¿‡å…è®¸æ¯ä¸ªç”¨æˆ·ï¼ˆæˆ–Railwayé¡¹ç›®ï¼‰ä½¿ç”¨å•ç‹¬çš„åŠ å¯†å¯†é’¥æ¥å‡å°‘æ”»å‡»é¢ã€‚ä½¿ç”¨æœ¬åœ°ç”Ÿæˆçš„æ•°æ®å¯†é’¥è¿˜æ„å‘³ç€è¾ƒå°‘ä¾èµ–å¤–éƒ¨å¯†é’¥ç®¡ç†æœåŠ¡ã€‚è¿™æ­£æ˜¯æˆ‘ä»¬è¿½æ±‚çš„ï¼
- en: As mentioned, KMS is designed for envelope encryption and is the reason for
    its maximum input size of  `64KiB` (enough to encrypt a large DEK). We knew this
    when implementing variable encryption, but since 99% of variables fit within the
    maximum size (about the length of a 10,000 word blogpost), it made sense to use
    KMS directly to get feature out the door.
  id: totrans-split-22
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚å‰æ‰€è¿°ï¼ŒKMSä¸“ä¸ºä¿¡å°åŠ å¯†è€Œè®¾è®¡ï¼Œè¿™ä¹Ÿæ˜¯å…¶æœ€å¤§è¾“å…¥å¤§å°ä¸º`64KiB`çš„åŸå› ï¼ˆè¶³ä»¥åŠ å¯†å¤§å‹DEKï¼‰ã€‚æˆ‘ä»¬åœ¨å®ç°å˜é‡åŠ å¯†æ—¶å·²ç»äº†è§£åˆ°äº†è¿™ä¸€ç‚¹ï¼Œä½†ç”±äº99%çš„å˜é‡é€‚åˆæœ€å¤§å°ºå¯¸ï¼ˆå¤§çº¦ç›¸å½“äº10000å­—çš„åšå®¢æ–‡ç« é•¿åº¦ï¼‰ï¼Œç›´æ¥ä½¿ç”¨KMSæ¥å®ç°åŠŸèƒ½æ˜¯åˆç†çš„ã€‚
- en: Envelope encryption eliminates the need call KMS hundreds of times for large
    batches of variables by requiring only one data encryption key (DEK) for the entire
    batch. We simply generate one DEK per [Environment](https://docs.railway.app/guides/environments)
    (an isolated instance of a project, like production or staging) and use it for
    all encryption operations.
  id: totrans-split-23
  prefs: []
  type: TYPE_NORMAL
  zh: é€šè¿‡ä»…éœ€è¦ä¸€ä¸ªæ•°æ®åŠ å¯†å¯†é’¥ï¼ˆDEKï¼‰æ¥æ¶ˆé™¤å¤§æ‰¹é‡å˜é‡çš„è°ƒç”¨KMSæ•°ç™¾æ¬¡çš„éœ€è¦ã€‚æˆ‘ä»¬åªéœ€ä¸ºæ¯ä¸ª[Environment](https://docs.railway.app/guides/environments)ç”Ÿæˆä¸€ä¸ªDEKï¼ˆé¡¹ç›®çš„éš”ç¦»å®ä¾‹ï¼Œå¦‚ç”Ÿäº§æˆ–æš‚å­˜ï¼‰ï¼Œç„¶åç”¨å®ƒæ‰§è¡Œæ‰€æœ‰åŠ å¯†æ“ä½œã€‚
- en: The DEK is generated locally (256-bit [AES using](https://en.wikipedia.org/wiki/Galois/Counter_Mode)
    [GCM](https://en.wikipedia.org/wiki/Galois/Counter_Mode)), encrypted once using
    KMS, then stored on the `Environment` data model. We created a helper utility
    to handle encryption, decryption, and key generation, and attached it to our request
    context, which has a lifetime of the current HTTP request or background job.
  id: totrans-split-24
  prefs: []
  type: TYPE_NORMAL
  zh: DEKåœ¨æœ¬åœ°ç”Ÿæˆï¼ˆä½¿ç”¨256ä½[AESä½¿ç”¨](https://en.wikipedia.org/wiki/Galois/Counter_Mode)[GCM](https://en.wikipedia.org/wiki/Galois/Counter_Mode)ï¼‰ï¼Œä»…ä½¿ç”¨ä¸€æ¬¡KMSåŠ å¯†ï¼Œç„¶åå­˜å‚¨åœ¨`Environment`æ•°æ®æ¨¡å‹ä¸Šã€‚æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªè¾…åŠ©å·¥å…·æ¥å¤„ç†åŠ å¯†ã€è§£å¯†å’Œå¯†é’¥ç”Ÿæˆï¼Œå¹¶å°†å…¶é™„åŠ åˆ°æˆ‘ä»¬çš„è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­ï¼Œè¯¥ä¸Šä¸‹æ–‡çš„ç”Ÿå‘½å‘¨æœŸä¸ºå½“å‰HTTPè¯·æ±‚æˆ–åå°ä½œä¸šã€‚
- en: '[PRE0]'
  id: totrans-split-25
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: This means that for each deployment (or other action), the encryption helper
    decrypts the necessary DEK once and caches it in memory for further operations,
    reducing  the 100+ trips to KMS to 1.
  id: totrans-split-26
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™æ„å‘³ç€å¯¹äºæ¯æ¬¡éƒ¨ç½²ï¼ˆæˆ–å…¶ä»–æ“ä½œï¼‰ï¼ŒåŠ å¯†åŠ©æ‰‹åªéœ€è§£å¯†ä¸€æ¬¡å¿…è¦çš„DEKå¹¶å°†å…¶ç¼“å­˜åœ¨å†…å­˜ä¸­ä»¥ä¾›åç»­æ“ä½œï¼Œå°†100+æ¬¡è®¿é—®KMSå‡å°‘åˆ°1æ¬¡ã€‚
- en: Thereâ€™s some other magic in here though. Did you notice that `decrypt()` doesnâ€™t
    require a DEK? How does that work?
  id: totrans-split-27
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™é‡Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„é­”æ³•ã€‚ä½ æ³¨æ„åˆ°`decrypt()`ä¸éœ€è¦DEKå—ï¼Ÿé‚£æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ
- en: One of the requirements for envelope encryption was the ability to easily rotate
    keys. As weâ€™ve seen, the DEK is stored on the `Environment` model, but how would
    we rotate it if needed? Weâ€™d either have to store a list of old keys to try during
    the encryption process, or re-encrypt all variables and update the database inside
    a potentially huge database transaction.
  id: totrans-split-28
  prefs: []
  type: TYPE_NORMAL
  zh: ä¿¡å°åŠ å¯†çš„è¦æ±‚ä¹‹ä¸€æ˜¯èƒ½å¤Ÿè½»æ¾åœ°è¿›è¡Œå¯†é’¥è½®æ¢ã€‚æ­£å¦‚æˆ‘ä»¬æ‰€è§ï¼ŒDEKå­˜å‚¨åœ¨`Environment`æ¨¡å‹ä¸Šï¼Œä½†å¦‚æœéœ€è¦å¦‚ä½•è¿›è¡Œè½®æ¢å‘¢ï¼Ÿæˆ‘ä»¬è¦ä¹ˆå¿…é¡»åœ¨åŠ å¯†è¿‡ç¨‹ä¸­å­˜å‚¨ä¸€ç³»åˆ—æ—§å¯†é’¥åˆ—è¡¨ä»¥ä¾›å°è¯•ï¼Œè¦ä¹ˆåœ¨ä¸€ä¸ªå¯èƒ½éå¸¸åºå¤§çš„æ•°æ®åº“äº‹åŠ¡å†…é‡æ–°åŠ å¯†æ‰€æœ‰å˜é‡å¹¶æ›´æ–°æ•°æ®åº“ã€‚
- en: Not great.
  id: totrans-split-29
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸æ˜¯å¾ˆå¥½ã€‚
- en: 'Luckily thereâ€™s also a best-practice for this, which is to store the encryption
    key next to the encrypted value (cipher text). For us, this meant serializing
    the encrypted DEK with the cipher text before storing the value in the database
    as a JSON string:'
  id: totrans-split-30
  prefs: []
  type: TYPE_NORMAL
  zh: å¹¸è¿çš„æ˜¯ï¼Œè¿™ä¹Ÿæœ‰ä¸€ä¸ªæœ€ä½³å®è·µï¼Œå³å°†åŠ å¯†å¯†é’¥ä¸åŠ å¯†å€¼ï¼ˆå¯†æ–‡ï¼‰å­˜å‚¨åœ¨ä¸€èµ·ã€‚å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œè¿™æ„å‘³ç€åœ¨å°†å€¼å­˜å‚¨ä¸ºJSONå­—ç¬¦ä¸²ä¹‹å‰ï¼Œå°†åŠ å¯†çš„DEKä¸å¯†æ–‡åºåˆ—åŒ–ï¼š
- en: '[PRE1]'
  id: totrans-split-31
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: Variable decryption with this setup can be done by decrypting the DEK using
    KMS (if not already cached in memory) and using it to decrypt the variable locally
    (without KMS). It also makes passing around encrypted values easier because the
    associated `Environment` or DEK doesnâ€™t need to go along for the ride.
  id: totrans-split-32
  prefs: []
  type: TYPE_NORMAL
  zh: ä½¿ç”¨è¿™ç§è®¾ç½®è¿›è¡Œå˜é‡è§£å¯†å¯ä»¥é€šè¿‡ä½¿ç”¨KMSè§£å¯†DEKï¼ˆå¦‚æœå°šæœªç¼“å­˜åœ¨å†…å­˜ä¸­ï¼‰å¹¶ä½¿ç”¨å®ƒæœ¬åœ°è§£å¯†å˜é‡æ¥å®Œæˆï¼ˆæ— éœ€KMSï¼‰ã€‚å®ƒè¿˜ä½¿å¾—ä¼ é€’åŠ å¯†å€¼æ›´åŠ å®¹æ˜“ï¼Œå› ä¸ºç›¸å…³çš„`Environment`æˆ–DEKä¸éœ€è¦ä¸€ç›´éšè¡Œã€‚
- en: The basic implementation of this strategy was only a few hundred lines of code
    but we still had to convert over 3 million existing variables to the new system.
  id: totrans-split-33
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™ç§ç­–ç•¥çš„åŸºæœ¬å®ç°åªæœ‰å‡ ç™¾è¡Œä»£ç ï¼Œä½†æˆ‘ä»¬ä»ç„¶ä¸å¾—ä¸å°†è¶…è¿‡300ä¸‡ä¸ªç°æœ‰å˜é‡è½¬æ¢ä¸ºæ–°ç³»ç»Ÿã€‚
- en: Storing the encrypted DEK next to the cipher text is also what made it possible
    to support both legacy and envelope encryption simultaneously, allowing us to
    progressively upgrade over 3 million variables.
  id: totrans-split-34
  prefs: []
  type: TYPE_NORMAL
  zh: å°†åŠ å¯†DEKå­˜å‚¨åœ¨å¯†æ–‡æ—è¾¹ä¹Ÿæ˜¯æ”¯æŒä¼ ç»Ÿå’Œä¿¡å°åŠ å¯†åŒæ—¶çš„å¯èƒ½æ€§æ‰€åœ¨ï¼Œå…è®¸æˆ‘ä»¬é€æ­¥å‡çº§è¶…è¿‡300ä¸‡ä¸ªå˜é‡ã€‚
- en: For decryption fallback, if a DEK isnâ€™t found within the encrypted variable,
    KMS is called directly to decrypt just like before.
  id: totrans-split-35
  prefs: []
  type: TYPE_NORMAL
  zh: å¯¹äºè§£å¯†å›é€€ï¼Œå¦‚æœåœ¨åŠ å¯†å˜é‡ä¸­æ‰¾ä¸åˆ°DEKï¼Œåˆ™ç›´æ¥è°ƒç”¨KMSè¿›è¡Œè§£å¯†ï¼Œå°±åƒä»¥å‰ä¸€æ ·ã€‚
- en: Similarly for encryption fallback, if no DEK exists yet on the `Environment`,
    KMS is called directly.
  id: totrans-split-36
  prefs: []
  type: TYPE_NORMAL
  zh: åŒæ ·ï¼Œå¯¹äºåŠ å¯†å›é€€ï¼Œå¦‚æœåœ¨`Environment`ä¸­å°šä¸å­˜åœ¨DEKï¼Œåˆ™ç›´æ¥è°ƒç”¨KMSã€‚
- en: 'This makes it possible to generate a DEK for a single environment. Modified
    variables within this environment will be upgraded to envelope encryption on write,
    reducing the migration effort to the following steps:'
  id: totrans-split-37
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™ä½¿å¾—å¯ä»¥ä¸ºå•ä¸ªç¯å¢ƒç”ŸæˆDEKã€‚åœ¨æ­¤ç¯å¢ƒä¸­ä¿®æ”¹çš„å˜é‡å°†åœ¨å†™å…¥æ—¶å‡çº§ä¸ºä¿¡å°åŠ å¯†ï¼Œä»è€Œå‡å°‘è¿ç§»å·¥ä½œåˆ°ä»¥ä¸‹æ­¥éª¤ï¼š
- en: Deploy initial envelope encryption code (does nothing by itself)
  id: totrans-split-38
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: éƒ¨ç½²åˆå§‹ä¿¡å°åŠ å¯†ä»£ç ï¼ˆæœ¬èº«ä¸èµ·ä»»ä½•ä½œç”¨ï¼‰
- en: Start generating DEKs for newly created environments
  id: totrans-split-39
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: ä¸ºæ–°åˆ›å»ºçš„ç¯å¢ƒç”ŸæˆDEKs
- en: Run data migration to generate DEKs for all environments
  id: totrans-split-40
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: è¿è¡Œæ•°æ®è¿ç§»ä»¥ä¸ºæ‰€æœ‰ç¯å¢ƒç”ŸæˆDEKs
- en: Run data migration to re-encrypt all variables
  id: totrans-split-41
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: è¿è¡Œæ•°æ®è¿ç§»ä»¥é‡æ–°åŠ å¯†æ‰€æœ‰å˜é‡
- en: 'Itâ€™s been a few weeks since introducing envelope encryption and itâ€™s been a
    success. Our KMS usage has dropped by 10x with no usage spikes, and weâ€™ve been
    able to realize the benefits mentioned earlier:'
  id: totrans-split-42
  prefs: []
  type: TYPE_NORMAL
  zh: è‡ªå¼•å…¥ä¿¡å°åŠ å¯†ä»¥æ¥å·²ç»è¿‡å»äº†å‡ å‘¨ï¼Œæ•ˆæœéå¸¸å¥½ã€‚ æˆ‘ä»¬çš„KMSä½¿ç”¨é‡ä¸‹é™äº†10å€ï¼Œæ²¡æœ‰ä½¿ç”¨é«˜å³°ï¼Œå¹¶ä¸”æˆ‘ä»¬å·²ç»èƒ½å¤Ÿå®ç°ä¹‹å‰æåˆ°çš„å¥½å¤„ï¼š
- en: Better performance â†’ Decrypting DEKs with KMS once per batch reduced the slow-case
    for variable decryption from ~10s at the slowest to only a handful of milliseconds
  id: totrans-split-43
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: æ›´å¥½çš„æ€§èƒ½ â†’ ä½¿ç”¨KMSä¸€æ¬¡æ‰¹é‡è§£å¯†DEKå°†æ…¢é€Ÿå˜é‡è§£å¯†çš„æ…¢é€Ÿæƒ…å†µä»æœ€æ…¢çš„10ç§’å‡å°‘åˆ°åªæœ‰å‡ æ¯«ç§’
- en: No service disruption â†’ The more consistent usage pattern means we no longer
    have to worry about spiking above our KMS quota and causing downtime. Weâ€™ve also
    been able to reduce our quota by several orders of magnitude
  id: totrans-split-44
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: æ— æœåŠ¡ä¸­æ–­ â†’ æ›´ä¸€è‡´çš„ä½¿ç”¨æ¨¡å¼æ„å‘³ç€æˆ‘ä»¬ä¸å†å¿…é¡»æ‹…å¿ƒè¶…å‡ºKMSé…é¢å¹¶å¯¼è‡´åœæœºçš„æƒ…å†µã€‚ æˆ‘ä»¬è¿˜èƒ½å¤Ÿå°†æˆ‘ä»¬çš„é…é¢å‡å°‘å‡ ä¸ªæ•°é‡çº§
- en: Better security â†’ Using a separate data key per environment means that a brute-force
    attack of one environment wonâ€™t compromise data for any others
  id: totrans-split-45
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: æ›´å¥½çš„å®‰å…¨æ€§ â†’ åœ¨æ¯ä¸ªç¯å¢ƒä¸­ä½¿ç”¨å•ç‹¬çš„æ•°æ®å¯†é’¥æ„å‘³ç€å¯¹ä¸€ä¸ªç¯å¢ƒçš„æš´åŠ›æ”»å‡»ä¸ä¼šå±åŠå…¶ä»–ä»»ä½•ç¯å¢ƒçš„æ•°æ®
- en: More flexible encryption â†’ While we donâ€™t necessarily need to surpass the `64KiB`
    KMS limit, the use of symmetric AES encryption means we can now encrypt data of
    any length
  id: totrans-split-46
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: æ›´çµæ´»çš„åŠ å¯† â†’ è™½ç„¶æˆ‘ä»¬ä¸ä¸€å®šéœ€è¦è¶…è¿‡`64KiB`çš„KMSé™åˆ¶ï¼Œä½†å¯¹ç§°AESåŠ å¯†çš„ä½¿ç”¨æ„å‘³ç€æˆ‘ä»¬ç°åœ¨å¯ä»¥åŠ å¯†ä»»æ„é•¿åº¦çš„æ•°æ®
- en: Not only do we get these direct benefits but weâ€™ve also already used this envelope
    encryption system to persist credentials for our recently-released [Private Registry
    Support](https://railway.app/changelog/2024-03-15-template-composer).
  id: totrans-split-47
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸ä»…è·å¾—äº†è¿™äº›ç›´æ¥çš„å¥½å¤„ï¼Œè€Œä¸”æˆ‘ä»¬å·²ç»ä½¿ç”¨è¿™ä¸ªä¿¡å°åŠ å¯†ç³»ç»Ÿæ¥ä¿å­˜æˆ‘ä»¬æœ€è¿‘å‘å¸ƒçš„[ç§æœ‰ä»“åº“æ”¯æŒ](https://railway.app/changelog/2024-03-15-template-composer)çš„å‡­è¯ã€‚
- en: Weâ€™re one step closer to having no dependencies on GCP. Yes, weâ€™re still technically
    using KMS, but replacing it with something like [Vault](https://www.vaultproject.io/)
    can now be done incrementally by repeating the above migration steps to rotate
    the DEKs for each environment.
  id: totrans-split-48
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ä»¬ç¦»ä¸ä¾èµ–äºGCPåˆè¿›äº†ä¸€æ­¥ã€‚ æ˜¯çš„ï¼Œæˆ‘ä»¬åœ¨æŠ€æœ¯ä¸Šä»åœ¨ä½¿ç”¨KMSï¼Œä½†å¯ä»¥é€šè¿‡é‡å¤ä¸Šè¿°è¿ç§»æ­¥éª¤é€æ­¥åœ°ä½¿ç”¨è¯¸å¦‚[Vault](https://www.vaultproject.io/)ä¹‹ç±»çš„ä¸œè¥¿æ›¿æ¢å®ƒæ¥è½®æ¢æ¯ä¸ªç¯å¢ƒçš„DEKã€‚
- en: So thatâ€™s how we upgraded 3 million variables to envelope encryption. Migrating
    data is always a scary task. Migrating sensitive data is even worse! But, as it
    goes, even the most daunting work can be broken down into manageable chunks, which
    is how we lived to tell this tale.
  id: totrans-split-49
  prefs: []
  type: TYPE_NORMAL
  zh: 'è¿™å°±æ˜¯æˆ‘ä»¬å¦‚ä½•å°†300ä¸‡ä¸ªå˜é‡å‡çº§ä¸ºä¿¡å°åŠ å¯†ã€‚ è¿ç§»æ•°æ®æ€»æ˜¯ä¸€ä¸ªå¯æ€•çš„ä»»åŠ¡ã€‚ è¿ç§»æ•æ„Ÿæ•°æ®ç”šè‡³æ›´ç³Ÿï¼ ä½†æ˜¯ï¼Œæ­£å¦‚å®ƒæ‰€è¯´çš„é‚£æ ·ï¼Œå³ä½¿æœ€è‰°å·¨çš„å·¥ä½œä¹Ÿå¯ä»¥åˆ†è§£æˆå¯ç®¡ç†çš„å—ï¼Œè¿™ä¾¿æ˜¯æˆ‘ä»¬æ´»ç€çš„è¯æ˜ã€‚ '
- en: Did we do something wrong? Let us know on [Twitter](https://twitter.com/railway)
    and stay tuned for more of these stories as we get further and further along our
    path to bare metal.
  id: totrans-split-50
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ä»¬åšé”™äº†ä»€ä¹ˆå—ï¼Ÿ åœ¨[Twitter](https://twitter.com/railway)ä¸Šå‘Šè¯‰æˆ‘ä»¬ï¼Œæ•¬è¯·æœŸå¾…æ›´å¤šè¿™æ ·çš„æ•…äº‹ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨å‰å¾€è£¸æœºçš„é“è·¯ä¸Šè¶Šèµ°è¶Šè¿œã€‚
