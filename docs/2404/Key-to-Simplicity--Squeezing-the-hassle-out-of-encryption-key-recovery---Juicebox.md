<!--yml

category: 未分类

date: 2024-05-27 13:06:13

-->

# 简化的关键：摆脱加密密钥恢复的麻烦 – Juicebox

> 来源：[https://www.juicebox.xyz/blog/key-to-simplicity-squeezing-the-hassle-out-of-encryption-key-recovery](https://www.juicebox.xyz/blog/key-to-simplicity-squeezing-the-hassle-out-of-encryption-key-recovery)

密码学将在多个系统和网络中传输和存储的庞大数据的保护任务转变为在一个位置安全地保护一个小而独特的密钥的简单任务。这是一种神奇的事情。然而，随着服务越来越多地采用端到端加密以提供隐私功能，这个小而独特的密钥也因其自身的挑战和问题而显现出来。

最引人注目的挑战之一是确保某人（但仅限于某人！）持续访问保护其数据的加密密钥，无论他们是否重新安装应用程序，丢失手机，或遇到生活中的其他种种困难。

不幸的是，解决这些问题的默认方法通常是直接将负担放在用户身上，要求他们管理密钥的备份。这些密钥过长，无法记忆，并且用户难以安全存储。当用户需要在新设备上输入他们的密钥材料时，这种复杂性尤为突出，导致一些人选择非安全的替代方案，而不是使用安全平台。

## 解锁密钥难题

在解决这个问题上提出了各种解决方案。在 web3/crypto 领域，种子短语通过将密钥表示为一系列单词略微简化了这一过程，但仍然需要用户管理冗长且不易记忆的字符串。而传递密码则更具吸引力，因为它消除了用户记忆密钥材料的需要，但在设备间存储和传输材料时，以及考虑到它们自身备份时的安全挑战，引入了自己的用户体验挑战。

“基于密码的加密”领域旨在通过迭代哈希或类似方法将短用户可记忆的密码转换为加密密钥，以便始终可以从用户可以记住的东西中恢复加密密钥来解决这一问题。然而，无论如何调整密钥派生函数，这些系统都被证明对攻击者非常脆弱，攻击者可以使用字典或暴力攻击进行猜测，直到他们能够恢复正确的密钥为止。

迄今为止，一些最有前途的解决方案利用安全硬件，如可编程的硬件安全模块（HSM）。创新之处在于安全硬件可用于限制攻击者进行猜测的能力，因此可以将用户易记输入转换为加密密钥，而不会像传统基于密码的加密那样面临暴力破解或字典攻击的风险。

实际上，像苹果和WhatsApp这样的公司 [以这种方式使用可编程HSM](https://engineering.fb.com/2021/09/10/security/whatsapp-e2ee-backups/) 来实现一些用户数据保护密钥的端到端备份。它们的接口通常涉及登录到账户（使用苹果ID或电话号码）并输入6位数PIN。这个PIN间接用于保护一个秘密，而HSM防止攻击者（包括操作员）进行暴力破解。Signal的 [Secure Value Recovery](https://signal.org/blog/secure-value-recovery/) 是这种类型系统的初始概念验证，但依赖较弱版本的安全硬件（Intel的SGX）来提供简化的基于PIN的用户界面，使用类似的底层机制。

然而，依赖硬件安全性虽然减少了用户的负担，但假设特定一组硬件和固件的固有安全性。您的秘密的安全性取决于用于恢复它们的硬件的安全性，这可能导致在跟上硬件漏洞演变方面面临挑战。此外，安全硬件通常受性能限制，过时且昂贵，存在规模化可持续性问题。

## Juicebox：混合了便利和安全性，无需果肉

我们设计了Juicebox来解决这些问题。与迄今为止一些最有前途的解决方案一样，Juicebox允许用户通过记住一个简短的PIN来恢复他们的秘密材料，而无需访问任何先前的设备 - 但也无需信任任何单一方或硬件制造商。

此外，Juicebox：

1.  绝不会向任何服务提供对用户秘密材料或PIN的访问。

1.  分布式信任跨互不信任的服务，消除对任何单个服务器操作者或硬件供应商的信任需求。

1.  通过限制尝试次数来防止暴力攻击。

1.  允许审计秘密访问尝试。

通过结合现有的、经过验证的分布式密码学技术来最小化传统上与之相关的风险，我们能够在不牺牲安全的情况下实现这些目标。同时，通过允许通过记忆低熵PIN进行恢复，并保持与使用高熵密钥的解决方案类似的安全性，从而减少用户的负担。

### 学会分享

标准HSM基础密钥恢复的最简单版本如下：

1.  客户端与运行在HSM中的进程建立了安全连接。

1.  客户端将一个密钥传输到HSM，以及用户选择的PIN。

1.  HSM 安全地存储密钥、PIN 和与该用户关联的猜测计数器。

1.  将来，如果客户端能够提供正确的 PIN，HSM 将返回密钥给客户端。

1.  HSM 使用猜测计数器来限制客户端可以尝试的可能 PIN 总数。

显而易见，如果 HSM 被破坏，所有用户数据也将一并被破坏。对于 Juicebox，我们最初的挑战是切断用户秘密的安全与存储它的单个服务器安全之间的联系。

第一步是允许信任分布超出单一组织或 HSM 供应商。Juicebox 采用分发秘密到 ***n*** 个独立服务的策略，每个服务都实现 ***Juicebox 协议***，并从 ***阈值*** 集合中检索，其中 ***n >= threshold***。我们称这些服务中的每一个为 ***领域***。

乍一看，分发秘密似乎很简单 - [秘密共享方案](https://en.wikipedia.org/wiki/Shamir%27s_secret_sharing) 已经广泛使用了将近半个世纪。然而，事情并不那么简单。在多个领域中运行上面概述的朴素方法，但用客户端密钥份额（密钥的阈值碎片）替换客户端密钥实际上并没有帮助。如果一个领域被入侵，攻击者可以获取 PIN 并使用它从其他领域中检索密钥份额的阈值。

相反，需要一种不同的方法，确保用户的 PIN 和他们的完整密钥都不会离开他们的设备。这是无视伪随机函数（OPRFs）可以施展魔力的地方！

### 无视，显而易见

OPRF 是一种加密原语，使一个领域能够安全地对客户端的输入进行函数评估。此评估确保服务器不会了解客户端输入的任何内容，客户端也不会了解服务器除了函数结果以外的私钥。

这是它的工作原理：

1.  客户端生成一个随机的混淆因子来模糊用户的 PIN，从而创建一个“混淆”的 PIN 版本。

1.  这个混淆的 PIN 被发送到一个领域，领域使用长期的私钥计算结果，而不知道原始的 PIN。

1.  在从领域接收到混淆结果后，客户端移除混淆因子，揭示最终结果用于领域的私钥和原始 PIN。

这个最终结果可以用作可恢复的加密密钥。

然而，当你处理由任意数量的操作员控制的 ***threshold*** 领域时，这种模型变得不切实际。为每个领域执行 OPRF 评估（并计算 ***threshold*** 个独立结果）会产生显著的性能成本。此外，如果一个领域的私钥被破坏，它将破坏对所有用户的该领域的信任。

引入[Threshold OPRFs (T-OPRFs)](https://eprint.iacr.org/2017/363.pdf) - 这是传统OPRF的一种变体，专门设计用于通过将秘密共享与OPRF结合来解决这两个问题。每个领域的私钥成为客户端在秘密存储期间创建的随机根私钥的唯一份额。这种领域私钥的数学关联使我们能够将整个阈值领域的操作优化为单个T-OPRF评估。

通过创建单个被盲目输入的份额，并稍后重建来自每个领域的被盲目结果份额，我们可以将整个阈值集合简化为一个共享结果。此外，由于这种方法要求客户端为每个领域生成相关的密钥，因此客户端也可以在更新存储的秘密时随时旋转这些密钥。

由于需要***阈值***领域来获取这个新的共享结果，它现在可以在原始模型中代替用户的PIN，与领域地址哈希化时大大降低了交互成本。

1.  客户端生成一个根OPRF密钥，并创建***n***份额。

1.  客户端使用用户选择的PIN和根密钥在本地计算OPRF结果。

1.  客户端使用每个领域的地址对结果进行哈希处理，推导***阈值***解锁标签。

1.  客户端与运行在***阈值*** HSM中的进程建立安全连接。

1.  客户端创建了一个关键的份额，并将每个份额与适当的解锁标签和OPRF密钥份额一起传输到每个HSM。

1.  HSM安全地存储了密钥份额、解锁标签、OPRF密钥份额以及与该用户相关的猜测计数器。

1.  在未来，客户端使用他们的PIN执行T-OPRF评估，并获得结果。

1.  当客户端推导并呈现正确的解锁标签时，HSM会返回密钥份额。

1.  客户端使用恢复的密钥份额重构密钥。

1.  HSM使用猜测计数器来限制客户端可以尝试的可能尝试总数。

### 确保完整性

在多个领域上执行T-OPRF时，验证份额的完整性变得很重要，以防止一个行为不端的领域阻止秘密的恢复。为了实现这一点，我们需要一种方法来检测行为不端的领域并将它们排除在恢复之外。

由于每个领域都维护一个独特的私钥份额，客户端可以在存储时为这些份额签名，然后丢弃签名密钥。然后，在恢复过程中，每个领域可以在T-OPRF评估开始时呈现其公共验证密钥和签名。这使得客户端能够快速建立具有匹配验证密钥和有效签名的领域阈值。

不幸的是，这仍然给了一个阈值的领域串通一气提供未由客户生成的有效签名的机会。为了解决这个问题，我们需要额外建立对一个值的共识，如果被操纵，将向客户显露自己。由于 T-OPRF 结果具有足够高的熵，我们可以将其分成两部分：一部分继续用于解锁秘密，而另一部分作为存储在每个领域中的承诺。现在，我们可以基于承诺和验证密钥建立领域的阈值共识，并在 T-OPRF 评估过程中验证生成的结果是否包含匹配的承诺。这样可以防止串通一气的领域阈值替换不同的 OPRF 密钥份额和签名，而不知道 PIN。

在确立这些保护措施后，我们的处境好了很多，但仍然有可能让某个领域做到*所有事情*都正确，同时返回一个恶意的 OPRF 结果共享来阻止用户访问他们的秘密。我们需要一种方法来过滤掉集合中的个别恶意领域，以便只要有足够数量的***阈值***正确领域存在，用户仍然可以继续进行。解决这个问题的最简单方法是允许验证单个 OPRF 结果共享，这样我们就可以拒绝一个共享并尝试一个新的领域，而不是随机猜测哪个领域污染了集合。使用[零知识证明](https://en.wikipedia.org/wiki/Zero-knowledge_proof)，一个领域可以与客户共享其公钥份额，并提供加密证据表明其结果分享是使用关联的私钥份额正确生成的。

领域有机会操纵的最后一部分信息是用户的秘密份额。这样做可能再次阻止用户访问他们的秘密，因为用户将无法正确重建它们。我们需要一种方法来验证自存储以来秘密未被操纵。由于我们已经可以验证 T-OPRF 结果，我们知道在存储时（而领域永远不会得知），我们可以通过对秘密和 T-OPRF 结果进行简单的哈希来解决这个问题。我们还希望这些哈希是领域特定的（因此恶意领域无法从另一个领域复制它们），因此我们还混入领域的秘密份额。在恢复过程中，我们可以验证这些值是否匹配，并从集合中移除任何篡改秘密的领域。

### 故意信任

我们已经确立的新范例使我们有机会探讨如何在与 HSM 领域共存的***阈值***集合中补充具有可扩展性和经济效益的额外领域。

Juicebox 支持两种基本类型的领域：

1.  ***硬件领域*** 是一种由安全硬件支持的领域 —— 具体来说是硬件安全模块（HSM），正如我们一直讨论的那样。硬件领域提供了狭窄的信任边界，因为HSM的设计只信任硬件和它执行的代码。而不信任操作员。

1.  ***软件领域*** 是一种在通用硬件或常见云提供商上运行的领域。与硬件领域配对时，它们可以用于在不需要运行安全硬件的情况下在组织间分发信任。

***Juicebox 协议*** 特别设计为，只要您在某些硬件领域上执行操作，有一个需要它们存在的***阈值***，在操作中包含软件领域是完全安全的，以进一步分散信任。

一个简单的配置可以包括一个由一个组织托管的硬件领域和一个由另一个组织托管的软件领域，具有阈值为两个。更复杂的配置可以使用多个HSM供应商和云提供商，以实现更高的可用性、可靠性和性能。

### 硬件障碍

在使用HSM的传统设置中，数据存储在这些专用设备的有限持久内存中。然而，由于HSM的存储容量受限，完全在其中存储大型数据集通常是不切实际甚至不可能的，任何硬件故障都可能导致用户数据的丢失，而不使用复杂的复制方案。

另一方面，在传统数据库中存储敏感数据将完全抵消HSM的好处。即使记录以加密形式存储，HSM也无法可靠区分记录的旧版本和最新版本，从而允许访问硬件的对手回滚状态。防止回滚攻击对确保领域不能拒绝访问机密资料至关重要，同时在机密材料变得不可访问之前限制攻击者的猜测次数。

为了解决这些挑战，Juicebox 使用 Merkle-Radix 树，允许服务扩展到数十亿的机密记录。这些记录被组织成树，树节点可以安全地存储在外部的、不受信任的存储系统中。Merkle-Radix 树允许HSM验证它们正在操作记录的最新版本。

Juicebox 的实现使以下功能成为可能：

+   **高效可扩展性：** 容量有限的HSM可以在非常大的树（数十亿条记录）上高效处理请求，同时确保数据的机密性、完整性和新鲜性。

+   **对数性能：** 树操作的性能随着树中记录数量的对数增长，相比线性查找键方法有显著改进。

+   **动态分区：** 可以动态地将整个数据集分区到多个树中，便于通过快速且廉价的重分区实现规模的快速扩展或缩减。

+   **并行化操作：** 每棵树的读取都可以完全并行化，即使在进行写入时也是如此，这使得 HSM 能够处理对树进行持续变更的请求，而无需等待结果传输到存储。

+   **降低存储成本：** 树节点可以在不受信任的非事务性存储系统上自由存储和缓存，通过使用高度可扩展的云存储解决方案如 Bigtable，从而降低存储成本。

Juicebox 还采用了经过身份验证的共识协议来从硬件故障中恢复，其中 HSM 在传统共识协议之上验证新鲜度和真实性。通过单个哈希验证整个 Merkle-Radix 树的能力，使得这种共识协议能够在树演变时仅达成对少量元数据的一致性，从而使操作更简单、更高效。

### 审计尝试

在我们最初讨论的简单存储系统的背景下，一个重要的缺点是缺乏透明度，无法了解用户尝试恢复其秘密材料的情况。没有这些信息，用户无法评估其秘密的安全性，也无法在尝试耗尽后采取必要的预防措施。用户现在期望能够及时收到有关对其存储的秘密进行的任何尝试的通知，类似于接收其它账户的登录尝试警报。

为了解决这些问题，我们系统中的每个领域都记录了恢复尝试——成功和失败——以及剩余的猜测次数。客户可以通过订阅 API 来访问这些数据，从而实现功能，例如通过推送通知警告用户对其账户进行的尝试。

## 总结：试试 Juicebox 的一口果汁

Juicebox 的 [源代码](https://github.com/juicebox-systems) 现已开放，我们鼓励您阅读我们的 [Juicebox 协议](https://docs.juicebox.xyz/whitepapers/juiceboxprotocol_revision7_20230807.pdf) 和 [Merkle-Radix 树](https://docs.juicebox.xyz/whitepapers/merkleradix_revision1_20230629.pdf) 白皮书获取更详细的信息。如果您准备好尝试，我们的 [演示](https://demo.juicebox.xyz/) 已配置为我们的沙盒领域。

Juicebox 代表我们解决端到端加密密钥恢复挑战的真诚努力和关怀。我们结合了诸如 Threshold OPRFs 和 Merkle-Radix 树之类的成熟技术，创造了一种既注重安全性又不牺牲用户体验的解决方案。我们在不断完善和增强所创造的内容的同时，也欢迎 [反馈和合作](mailto:eng@juicebox.me)。

Juicebox 是由 Alex Bochannek、Simon Fell、Moxie Marlinspike、Diego Ongaro、Daniela Perlein 和 Nora Trapp 创建的。该项目收到了 Trevor Perrin 的宝贵反馈，并于 2023 年 6 月由 NCC 进行了审计。
