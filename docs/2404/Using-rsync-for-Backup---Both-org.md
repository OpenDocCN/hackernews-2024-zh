<!--yml

category: 未分类

日期：2024-05-27 13:00:15

-->

# 使用rsync进行备份 – Both.org

> 来源：[https://www.both.org/?p=4647](https://www.both.org/?p=4647)

图片来源：创作共用许可证：CC-by-SA

## 备份选项

有许多备份执行选项。大多数Linux发行版提供了一个或多个专门设计用于执行备份的开源程序。还有许多商业选项可供选择。但这些选项没有直接满足我的需求，因此我决定使用基本的Linux工具来完成这项工作。

在先前的文章中，[使用tar和ssh进行备份](https://www.both.org/?p=4650)，我展示了设计和实施可行备份程序并不需要高端昂贵的备份程序。

几年前，我开始尝试另一种备份选项，即具有一些非常有趣功能的**`rsync`**命令，这些功能对我非常有利。我的主要目标是创建备份，使用户无需解压备份的tar文件即可定位和恢复文件，并减少创建备份所需的时间。

本文仅描述我在备份场景中使用**rsync**的个人经验，不涵盖**rsync**的所有能力或其它有趣的使用方式。

## rsync

rsync命令由Andrew Tridgell和Paul Mackerras编写，于1996年首次发布。rsync的主要意图是远程同步一台计算机上的文件与另一台计算机上的文件。你注意到他们是如何创建这个名字的吗？rsync是开源软件，并且与我熟悉的所有发行版一起提供。

rsync命令可以用于同步两个目录或目录树，无论它们是否在同一台计算机上或不同计算机上，但它的功能远不止于此。rsync创建或更新目标目录以使其与源目录相同。目标目录可以由所有常用的Linux工具自由访问，因为它不是存储在tarball、zip文件或任何其他归档文件类型中；它只是一个普通的目录，其中有普通文件，可以通过基本的Linux工具被普通用户浏览。这满足了我的主要目标之一。

rsync 最重要的特性之一是它用于同步源目录中已更改的现有文件的方法。它不是从源复制整个文件，而是使用校验和比较源文件和目标文件的块。如果两个文件的所有块都相同，则不传输任何数据。如果数据不同，则只传输在源上已更改的块到目标。这对远程同步节省了大量时间和网络带宽。例如，当我首次使用我的 rsync BASH 脚本将所有主机备份到大型外部 USB 硬盘时，花了大约 3 小时。这是因为所有数据都必须传输，因为没有数据被预先备份过。随后的同步根据自上次同步以来更改或创建的文件数量，实际花费时间在 3 到 8 分钟之间。我使用 time 命令确定了这一点，所以这是经验数据。例如，昨晚，同步约 750GB 数据从 6 个远程系统和本地工作站完成的时间是 3 分钟 12 秒。当然，实际上只有几百兆字节的数据在一天中实际更改并需要同步。

下面这个简单的 rsync 命令可以用来同步两个目录及其子目录的内容。也就是说，将目标目录的内容与源目录的内容同步，以便在同步结束时，目标目录与源目录相同。

```
**`# rsync -aH sourcedir targetdir`**
```

**-a** 选项用于归档模式，保留权限、所有权和符号（软）链接。**-H** 用于保留硬链接。请注意，源目录或目标目录可以位于远程主机上。

现在假设昨天我们使用 rsync 同步了两个目录。今天我们想要重新同步它们，但是从源目录中删除了一些文件。rsync 正常处理这种情况的方式是简单地将所有新的或更改的文件复制到目标位置，并在目标上保留已删除的文件。这可能是您希望的行为，但如果您希望从源删除的文件也从目标中删除，可以添加 **`--delete`** 选项来实现这一点。

另一个有趣的选项，也是我个人最喜欢的选项，因为它极大地增加了 rsync 的功能和灵活性，就是 **`--link-dest`** 选项。**`--link-dest`** 选项允许创建一系列每天备份，每天备份占用非常少的额外空间，而且创建时间也非常短。

使用此选项指定前一天的目标目录和今天的新目录。然后rsync在今天的新目录中为昨天的每个文件创建硬链接。因此，现在在今天的目录中有一堆昨天文件的硬链接。没有创建或复制新文件。只是创建了一堆硬链接。维基百科对[硬链接](https://en.wikipedia.org/wiki/Hard_link)有一个非常好的描述。使用这组硬链接创建了今天的目标目录后，rsync像往常一样执行同步，但是当检测到文件变化时，目标硬链接会被昨天文件的副本替换，然后将文件的更改从源复制到目标。

现在我们的命令看起来像下面这样。

```
`**rsync -aH --delete --link-dest=yesterdaystargetdir sourcedir todaystargetdir**`
```

有时还希望排除某些目录或文件不进行同步。为此有`--exclude`选项。使用此选项和要排除的文件或目录的模式。您可能希望排除浏览器缓存文件，因此您的新命令将如下所示。

```
**`rsync -aH --delete --exclude Cache --link-dest=yesterdaystargetdir sourcedir todaystargetdir`**
```

注意，你想要排除的每个文件模式都必须有单独的排除选项。

rsync可以将文件与远程主机同步，作为源或目标。对于下一个示例，假设源目录位于具有主机名remote1的远程计算机上，目标目录位于本地主机上。尽管SSH是默认的用于传输数据到或从远程主机的通信协议，但我总是添加ssh选项。现在命令看起来像这样。

```
**rsync -aH -e ssh --delete --exclude Cache --link-dest=yesterdaystargetdir remote1:sourcedir todaystargetdir**
```

这是我的rsync备份命令的最终形式。

rsync具有大量的选项，您可以使用这些选项来定制同步过程。就我个人需求而言，我描述的这些相对简单的命令非常适合制作备份。确保阅读rsync的详尽man页面，了解更多功能及这里讨论的选项。

## 执行备份

我自动化了我的备份，因为 – “[自动化一切](http://www.linux-databook.info/?page_id=4913)” 。我编写了一个BASH脚本，处理了创建一系列每日备份的详细信息，使用rsync。这包括确保备份介质已挂载，生成昨天和今天备份目录的名称，如果备份介质上不存在的话创建适当的目录结构，执行实际备份并卸载介质。

我每天早上定时运行这个脚本，作为cron作业，以确保我从不忘记执行我的备份。

## 恢复测试

没有测试的备份方案是不完整的。你应该定期测试随机文件或整个目录结构的恢复，以确保不仅备份工作正常，而且备份中的数据可以在灾难后恢复使用。我见过太多情况，因为缺乏测试而无法恢复备份，导致宝贵的数据丢失。

只需选择一个文件或目录进行测试，并将其恢复到/tmp等测试位置，以免覆盖自备份后可能已更新的文件。验证文件内容是否符合预期。从使用上述rsync命令创建的备份中恢复文件只是找到要从备份中恢复的文件，然后将其复制到要恢复到的位置的问题。

在几个情况下，我不得不恢复单个文件或完整目录结构。大多数情况下，这是我不小心删除文件或目录时自食其果的结果。至少有几次是因为硬盘崩溃。所以那些备份确实非常有用。

* * *

## 资源

你可以从[这个页面](https://www.both.org/?page_id=4666)下载我的rsbu程序及其支持文件。它是根据GPL V3许可证分发的。
