<!--yml

类别：未分类

日期：2024-05-27 13:08:43

-->

# CVE-2024-3400 PAN-OS：全球保护中的任意文件创建导致操作系统命令注入漏洞

> 来源：[https://security.paloaltonetworks.com/CVE-2024-3400](https://security.paloaltonetworks.com/CVE-2024-3400)

[Palo Alto Networks 安全公告](/)

/

CVE-2024-3400

## CVE-2024-3400 PAN-OS：全球保护中的任意文件创建导致操作系统命令注入漏洞

紧急性 **最高**

响应工作 **中等**

恢复 **用户**

价值密度 **集中**

攻击向量 **网络**

攻击复杂性 **低**

攻击要求 **无**

可自动化 **是**

用户交互 **无**

产品机密性 **高**

产品完整性 **高**

产品可用性 **高**

所需特权 **无**

随后机密性 **高**

随后完整性 **高**

随后可用性 **高**

[NVD](https://nvd.nist.gov/vuln/detail/CVE-2024-3400 "查看国家漏洞数据库中的信息") [JSON](/json/CVE-2024-3400 "以 CVE-JSON 格式下载此公告中的信息")[](/CVE-2024-3400 "此公告的永久链接")[](mailto:?subject=CVE-2024-3400%20PAN-OS:%20任意文件创建导致全球保护中的操作系统命令注入漏洞&body=CVE-2024-3400%20PAN-OS:%20任意文件创建导致全球保护中的操作系统命令注入漏洞%0A%0Ahttps://security.paloaltonetworks.com/CVE-2024-3400 "通过电子邮件分享此公告")

发布日期 **2024-04-12**

更新日期 **2024-05-03**

引用 **PAN-252214**

发现于 **生产环境中**

### 描述

由于 Palo Alto Networks PAN-OS 软件 GlobalProtect 功能中特定 PAN-OS 版本和不同功能配置的任意文件创建漏洞导致的命令注入可能使未经身份验证的攻击者能够在防火墙上以 root 权限执行任意代码。

云 NGFW、Panorama 设备和 Prisma Access 不受此漏洞影响。

客户应继续关注此安全公告以获取最新更新和产品指导。

### 产品状态

| 版本 | 受影响 | 未受影响 |
| --- | --- | --- |
| 云 NGFW | 无 | 所有 |
| PAN-OS 11.1 | < 11.1.0-h3, < 11.1.1-h1, < 11.1.2-h3 | >= 11.1.0-h3, >= 11.1.1-h1, >= 11.1.2-h3 |
| PAN-OS 11.0 | < 11.0.0-h3, < 11.0.1-h4, < 11.0.2-h4, < 11.0.3-h10, < 11.0.4-h1 | >= 11.0.0-h3, >= 11.0.1-h4, >= 11.0.2-h4, >= 11.0.3-h10, >= 11.0.4-h1 |
| PAN-OS 10.2 | < 10.2.0-h3, < 10.2.1-h2, < 10.2.2-h5, < 10.2.3-h13, < 10.2.4-h16, < 10.2.5-h6, < 10.2.6-h3, < 10.2.7-h8, < 10.2.8-h3, < 10.2.9-h1 | >= 10.2.0-h3, >= 10.2.1-h2, >= 10.2.2-h5, >= 10.2.3-h13, >= 10.2.4-h16, >= 10.2.5-h6, >= 10.2.6-h3, >= 10.2.7-h8, >= 10.2.8-h3, >= 10.2.9-h1 |
| PAN-OS 10.1 | 无 | 所有 |
| PAN-OS 10.0 | 无 | 所有 |
| PAN-OS 9.1 | 无 | 所有 |
| PAN-OS 9.0 | 无 | 所有 |
| Prisma Access | 无 | 所有 |

### 暴露所需配置

此问题仅适用于配置有GlobalProtect网关或GlobalProtect门户（或两者）的PAN-OS 10.2、PAN-OS 11.0和PAN-OS 11.1防火墙。不需要为PAN-OS防火墙启用设备遥测以使其暴露于与此漏洞相关的攻击。

您可以通过检查防火墙的网络界面（网络 > GlobalProtect > Gateways 或 网络 > GlobalProtect > Portals）来验证是否配置了GlobalProtect网关或GlobalProtect门户。

### 严重性：CRITICAL

CVSSv4.0 基础评分：10 ([CVSS:4.0/AV:N/AC:L/AT:N/PR:N/UI:N/VC:H/VI:H/VA:H/SC:H/SI:H/SA:H/AU:Y/R:U/V:C/RE:M/U:Red](https://www.first.org/cvss/calculator/4.0#CVSS:4.0/AV:N/AC:L/AT:N/PR:N/UI:N/VC:H/VI:H/VA:H/SC:H/SI:H/SA:H/AU:Y/R:U/V:C/RE:M/U:Red))

### 漏洞利用状态

Palo Alto Networks已经意识到有越来越多的攻击利用了此漏洞。此漏洞的验证概念已经被第三方公开披露。

我们还知道第三方的后期利用持久性技术的概念验证。目前我们不知道有任何恶意尝试利用这些持久性技术来主动利用此漏洞。下面列出的这些修复和威胁预防签名完全阻止了初始远程命令执行，停止了随后的后期利用或持久性。

更多关于此漏洞在野外利用的信息可以在Unit 42威胁简报 ([https://unit42.paloaltonetworks.com/cve-2024-3400/](https://unit42.paloaltonetworks.com/cve-2024-3400/)) 和Palo Alto Networks PSIRT博客帖子 ([https://www.paloaltonetworks.com/blog/2024/04/more-on-the-pan-os-cve/](https://www.paloaltonetworks.com/blog/2024/04/more-on-the-pan-os-cve/)) 中找到。

### 弱点类型

[CWE-77 命令注入中不正确的特殊元素中和](https://cwe.mitre.org/data/definitions/77 "更多信息请访问 https://cwe.mitre.org/data/definitions/77")

[CWE-20 不正确的输入验证](https://cwe.mitre.org/data/definitions/20 "更多信息请访问 https://cwe.mitre.org/data/definitions/20")

### 解决方案

我们强烈建议客户立即升级到PAN-OS的修复版本，以保护其设备，即使已经应用了解决方案和缓解措施。

此问题已在PAN-OS 10.2.9-h1、PAN-OS 11.0.4-h1、PAN-OS 11.1.2-h3及所有后续PAN-OS版本中修复。这些修复和下面列出的完全阻止了初始远程命令执行，停止了随后的后期利用或持久性。

为了为客户提供最无缝的升级路径，作为其他常见维护版本的礼遇，额外的热修复已经提供。

`PAN-OS 10.2:` `- 10.2.9-h1（发布于 4/14/24）` `- 10.2.8-h3（发布于 4/15/24）` `- 10.2.7-h8（发布于 4/15/24）` `- 10.2.6-h3（发布于 4/16/24）` `- 10.2.5-h6（发布于 4/16/24）` `- 10.2.4-h16（发布于 4/18/24）` `- 10.2.3-h13（发布于 4/18/24）` `- 10.2.2-h5（发布于 4/18/24）` `- 10.2.1-h2（发布于 4/18/24）` `- 10.2.0-h3（发布于 4/18/24)``PAN-OS 11.0:` `- 11.0.4-h1（发布于 4/14/24）` `- 11.0.4-h2（发布于 4/17/24）` `- 11.0.3-h10（发布于 4/16/24）` `- 11.0.2-h4（发布于 4/16/24）` `- 11.0.1-h4（发布于 4/18/24）` `- 11.0.0-h3（发布于 4/18/24)``PAN-OS 11.1:` `- 11.1.2-h3（发布于 4/14/24）` `- 11.1.1-h1（发布于 4/16/24）` `- 11.1.0-h3（发布于 4/16/24）

注意：由于命名约定限制，Azure Marketplace 上的“-h”热修复版本将以额外的“0”进行命名。例如，11.1.2-h3 在 Azure 上被发布为 11.1.203。

如果在设备上观察到任何利用情况，请按照此处建议的补救步骤进行处理：[https://knowledgebase.paloaltonetworks.com/KCSArticleDetail?id=kA14u000000CrO6CAK](https://knowledgebase.paloaltonetworks.com/KCSArticleDetail?id=kA14u000000CrO6CAK)

可通过客户支持（TAC）开设案例来安排一个增强型工厂重置（EFR）过程，该过程不依赖可能已受损设备的完整性。这对以下情况推荐使用：

1\. 截至 2024 年 4 月 25 日，未在 GlobalProtect 接口上应用 PAN-OS 修复程序或威胁预防签名的客户；或

2\. 关注持续风险的客户。

### 解决方法和缓解措施

推荐的缓解措施：具有威胁预防订阅的客户可以使用威胁 ID 95187、95189 和 95191（在应用和威胁内容版本 8836-8695 及更高版本中提供）阻止此漏洞的攻击。请监视此通告和新的威胁预防内容更新，了解 CVE-2024-3400 周围的其他威胁预防 ID。

若要应用威胁 ID，客户必须确保已将漏洞防护应用到其 GlobalProtect 接口，以防止设备受到此问题的攻击。请参阅 [https://live.paloaltonetworks.com/t5/globalprotect-articles/applying-vulnerability-protection-to-globalprotect-interfaces/ta-p/340184](https://live.paloaltonetworks.com/t5/globalprotect-articles/applying-vulnerability-protection-to-globalprotect-interfaces/ta-p/340184) 获取更多信息。

在本通告的早期版本中，将设备遥测禁用列为次要缓解措施。现在禁用设备遥测不再是有效的缓解措施。PAN-OS 防火墙不需要启用设备遥测即可面对与此漏洞相关的攻击。

### 致谢

拜亚络网络感谢 Volexity 将此问题的检测和识别信息公之于众，感谢 Bishop Fox 开发团队帮助提高威胁预防签名的效果，以及感谢 Nick Wilson 探索并分享了后渗透持久性技术的研究成果。

### 常见问题解答

#### Q. 这个问题是否已在野外被利用？

> 拜亚络网络已经意识到越来越多的攻击利用了此漏洞。关于此漏洞的实验性证据已经由第三方公开发布。
> 
> 我们也注意到了第三方实现的后渗透持久性技术的证明概念，这些技术能够在复位和升级后存活。这些技术可以在已经遭受侵害的设备上工作，该设备具有交互式 root 级别命令执行权限。

#### Q. 我能否在设备上进行检查，寻找尝试利用活动的证据？

> 可以使用以下命令在 PAN-OS 全局策略控制台 (CLI) 中帮助识别设备上是否曾有被自动利用的活动：
> 
> `使用正则表达式 "未能解码会话(.\+.\/" 在 mp-log 和 gpsvc.log* 文件中搜索`
> 
> 如果在 "session(" 和 ")" 之间的值看起来不像一个全局唯一标识符 (GUID)，而是包含文件系统路径或嵌入式 shell 命令，这可能是 CVE-2024-3400 漏洞尝试被利用的迹象，值得进一步调查以与其它恶意活动指标关联。
> 
> 使用 `grep` 的输出可能会呈现如下条目：
> 
> `未能解码会话(../../some/path)`
> 
> 使用 `grep` 的输出通常会显示如下条目：
> 
> `未能解码会话(01234567-89ab-cdef-1234-567890abcdef)`

#### Q. 在升级过程中，何时应该收集技术支持文件 (TSF) 和法医证据？

> 在升级至修补版本的 PAN-OS 之前，您应该先收集一份数字取证分析使用的技术支持文件 (TSF)。如果您已经将防火墙升级，并且未收集 TSF，那么先前系统的安装日志将无法在设备上访问。若需要帮助调查之前的 PAN-OS 安装，敬请联络支持团队。

#### Q. 我的设备是否通过此漏洞被侵害？

> 客户可以在客户支持门户（CSP）中开立案件并上传技术支持文件 (TSF)，以确定其设备日志是否匹配此漏洞的已知尝试利用记录。

#### Q. 我如何验证我正确地应用了威胁预防签名？

> 对配置有全局保护的 PAN-OS 10.2+ 防火墙运行以下命令：
> 
> `curl -v -k -H "Cookie: SESSID=/../TESTVULN" https://<目标主机>/global-protect/login.esp`
> 
> 如果防火墙受到必要的威胁预防签名保护，则不会返回任何响应。将发生TCP复位。成功的响应表明威胁预防签名未正确应用。请按照 [https://live.paloaltonetworks.com/t5/globalprotect-articles/applying-vulnerability-protection-to-globalprotect-interfaces/ta-p/340184](https://live.paloaltonetworks.com/t5/globalprotect-articles/applying-vulnerability-protection-to-globalprotect-interfaces/ta-p/340184) 中的步骤操作。

#### Q.我在哪里可以找到有关此问题的额外妥协指标？

> 请参阅Unit42威胁简报（[https://unit42.paloaltonetworks.com/cve-2024-3400/](https://unit42.paloaltonetworks.com/cve-2024-3400/)）和Volexity博客文章（[https://www.volexity.com/blog/2024/04/12/zero-day-exploitation-of-unauthenticated-remote-code-execution-vulnerability-in-globalprotect-cve-2024-3400/](https://www.volexity.com/blog/2024/04/12/zero-day-exploitation-of-unauthenticated-remote-code-execution-vulnerability-in-globalprotect-cve-2024-3400/)）获取最新信息。

#### Q.云中由客户部署和管理的VM受到影响吗？

> 虽然AWS和Azure上的云NGFW托管服务没有受到影响，但由客户管理的特定PAN-OS版本和全局保护配置的VM-Series受到影响。

### 时间轴

可用于对抗任何潜在的后利用持久技术的增强工厂重置（EFR）过程。

回答了一个关于如何验证修复或威胁预防签名是否正确应用的常见问题。

更新了第三方证明概念的利用技术后续技术状态。

添加了一个链接到KB文章，用于修复设备。

回答了一个关于技术支持文件收集和法证证据的常见问题。

添加了有关CVE-2024-3400的PSIRT博客文章的参考。

澄清了漏洞标题和描述。

澄清了有关企图利用活动证据的常见问题。

将新的威胁预防威胁ID添加到解决方法和缓解措施中。

添加了一个CLI命令，用于搜索可能的利用活动尝试。

更新了产品和缓解指南，利用状态和PAN-OS修复的可用性。

现在所有必要的PAN-OS修复程序均已提供，并在使用Panorama模板时澄清了解决方法和缓解措施。

澄清了对GlobalProtect门户配置的影响。

添加了Unit42威胁简报的链接，并澄清了云中由客户管理的VM的影响。

初次发布。
