<!--yml

分类：未分类

日期：2024-05-27 14:48:53

-->

# 逃离孤立网络：广播 DNS 的应用 | 作者：lvj | SensorFu | Medium

> 来源：[https://medium.com/sensorfu/escaping-isolated-networks-using-broadcast-dns-5aee866bcaff](https://medium.com/sensorfu/escaping-isolated-networks-using-broadcast-dns-5aee866bcaff)

# 逃离孤立网络：广播 DNS 的应用

我们最新的一种逃逸方法是通过广播以太网包发送域名系统 (DNS) 查询的能力。我们称之为广播 DNS 逃逸。我们的假设是，DNS 服务器或缓存可以从网络中捕获这些，并愉快地将其重定向到另一个网络。

而我们的假设已被证明是正确的。我们向您呈现两个广播 DNS 在实际网络中发现真实问题的案例。

# 活动目录，隐藏服务器

我们的客户在其站点上将信标更新到最新版本，其中包括我们的新广播 DNS 测试。升级后，我们收到警报称信标已通过此新逃逸从站点泄漏。

信标部署在一个生产网络中 — 一个用于监控和控制工业过程的网络 — 并且 DNS 解析器已在 DMZ 区域正确分割。其站点上的 DNS 服务器与信标处于不同的 IP 子网中。信标以前从未通过单播 DNS 泄漏，因为防火墙阻止了信标与 DNS 服务器之间的流量。那么 DNS 如何通过广播泄漏？

一个可能性是，包含信标的孤立网络与包含 DNS 解析器的网络意外连接在一起。这可能是由于错误的布线或 VLAN 设置造成的。以太网级别连接的网络可以在意外连接的网络内转发以太网帧，从而使信标通过广播到达本地 DNS 解析器。这意味着网络并非孤立，分割失败了。

另一个可能性是，网络拥有一个未知的 DNS 解析器，它接受广播的 DNS 查询并允许将其转发到上游解析器。

在调查发现后，发现网络实际上仍然在网络中运行着一个旧的、据说已被废弃的 Microsoft 活动目录 (AD) 服务器。该 AD 服务器还充当 DNS 服务器，乐意处理广播的 DNS 包并将其转发到上游的 DNS 基础架构。防火墙还有一条规则允许来自该特定 DNS 服务器的 DNS 流量出站。

未知的 AD 服务器的 DNS 查询在防火墙中有一个异常

# 互联网络

另一个广播 DNS 逃逸案例很快就出现了。该公司在生产环境和 IT 网络中已经使用 Beacon 一年多了。在将 Beacon 升级到最新版本后，意外地观察到了在隔离的生产网络中部署的 Beacon 发出的广播 DNS 逃逸。在这种情况下，逻辑假设是相同的；生产网络中存在未知的 DNS 解析器，或者交换网络以某种方式连接到另一个具有处理和解析数据包的 DNS 解析器的网络。

在通知客户后，他们迅速调查了该问题，并发现有迹象表明有两个网络意外连接在一起。两个网络连接在一起后，隔离的生产网络中的 Beacon 发出的广播数据包到达包含 DNS 解析器的 IT 网络，然后将查询转发到上游 DNS 解析器，一直到达 Beacon Home。确定了连接网络的交换机端口，并在断开网络连接后，Beacon 停止了对 Home 的呼叫。

两个二层网络意外连接在一起，允许广播 DNS 查询逃逸出隔离网络。

# 思后记

这种广播数据包（无论是 DNS、ICMP 还是其他什么）利用了 TCP/IP 网络堆栈的弱点。以太网层接收广播数据包并允许其在堆栈中向上流动到下一个网络层。然后，下一层检查数据包的部分并相应地采取行动，完全忽视了这是一个广播数据包，也许不是打算供它们处理的。
