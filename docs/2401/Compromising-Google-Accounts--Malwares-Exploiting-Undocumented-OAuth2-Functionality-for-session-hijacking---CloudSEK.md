<!--yml

分类：未分类

日期：2024年05月27日 14:39:33

-->

# 破解谷歌账户：恶意软件利用未记录的OAuth2功能进行会话劫持 | CloudSEK

> 来源：[https://www.cloudsek.com/blog/compromising-google-accounts-malwares-exploiting-undocumented-oauth2-functionality-for-session-hijacking](https://www.cloudsek.com/blog/compromising-google-accounts-malwares-exploiting-undocumented-oauth2-functionality-for-session-hijacking)

+   ‍**分类：**对手情报**‍**

+   **行业：**所有行业**‍**

+   **动机：**金融**‍**

+   **来源*****：**C - 相当可靠

    1 - 被独立消息来源证实

## **执行摘要**

2023年10月，开发者PRISMA发现了一个关键的漏洞，通过令牌操纵可以生成持久的谷歌Cookie。这个漏洞使得用户即使重置密码后也能持续访问谷歌服务。后来，一个威胁行为者客户反向工程了这个脚本并将其整合到Lumma Infostealer中*(见附录8)*，通过先进的黑盒技术保护了这种方法。这标志着一个涟漪效应的开始，因为这个漏洞迅速在各种恶意软件组织中传播，以保持与独特功能的同步。

‍

CloudSEK的威胁研究团队利用人工情报和技术分析，确定了该漏洞的根源，即未记录的谷歌OAuth端点名为“MultiLogin”。本报告探讨了漏洞的发现、演变以及对网络安全的更广泛影响。

‍

## **事件时间线：**

**2023年10月20日：** 攻击首次在Telegram频道上曝光。*(图1)*

**2023年11月14日：** Lumma宣布该功能已整合了先进的黑盒方法。该功能因安全领域对Lumma独特功能的报道而开始风靡。*(附录1)*

**2023年11月17日：** Rhadamanthys宣布该功能采用与Lumma类似的黑盒方法。*(附录6)*

**2023年11月24日：** Lumma更新了漏洞以对抗谷歌的欺诈检测措施。*(附录7)*

**Stealc 2023年12月1日 -** 实施了谷歌账户令牌恢复功能*(附录4)*

**Meduza 2023年12月11日 -** 实施了谷歌账户令牌恢复功能*(附录5)*

**RisePro 2023年12月12日 -** 实施了谷歌账户令牌恢复功能*(附录3)*

**WhiteSnake 2023年12月26日 -** 实施了谷歌账户令牌恢复功能*(附录2)*

**2023年12月27日** - Hudson Rock在[Darkweb](https://www.youtube.com/watch?v=NzAtZzzFoOs)上发布视频，展示黑客如何利用生成的Cookie进行攻击。

‍

# **分析和归因**

## **来自帖子的信息**

+   在2023年10月20日，[CloudSEK](https://cloudsek.com/)的上下文人工智能数字风险平台[XVigil](https://cloudsek.com/xvigil/) 发现，名为'PRISMA'的威胁行为者在其Telegram频道上发布了一项重大声明，揭示了一个解决Google账户进入会话的挑战的强大0-day解决方案。这个解决方案拥有两个关键特性：**会话持久性：**即使账户密码更改，会话仍然有效，为绕过典型安全措施提供了独特的优势。

    ‍**Cookie生成：**在会话中断的情况下生成有效的Cookie的能力增强了攻击者维持未经授权访问的能力。

+   开发人员表示愿意合作，暗示愿意就这一新发现的漏洞进行合作或分享见解。

‍

*图1：关于他在2023年10月20日在电报频道中的发现的TA帖子*

Lumma Infostealer，整合了所发现的漏洞，于11月14日实施。随后，Rhadamanthys、Risepro、Meduza和Stealc Stealer也采用了这一技术。12月26日，White Snake也实施了这一漏洞。目前，Eternity Stealer正在积极努力更新，这表明各种Infostealer团体之间快速整合的令人担忧的趋势。

在下面的屏幕截图中，您可以看到新版本的Lumma（日期为11月26日）中存在的新加密恢复令牌，而截图的另一侧突出显示了旧版本，其中来自浏览器的Cookie被汇总以创建Account_Chrome_Default.txt。

图2：Lumma恶意软件日志的差异，一个日期为11月26日，包含加密Cookie和一个日期为12日的仅从浏览器中提取的Cookie。

‍

‍

## 技术分析

### 从零开始扩展 - 恶意软件如何外泄所需的秘密

令牌和账户ID的外泄：通过反向恶意软件变体，我们了解到它们针对Chrome的WebData的token_service表来提取Chrome配置文件中已登录的令牌和账户ID。该表包含两个关键列：service（GAIA ID）和encrypted_token。加密令牌使用存储在Chrome的UserData目录中的Local State中的加密密钥进行解密，类似于用于存储密码的加密。

‍

*图3 令牌服务表的结构*

‍

*图4 Stealer功能的描述：从受害者计算机中提取所需详细信息*

‍

## **分析终端的起源和用途**

通过Chromium源代码揭示的MultiLogin终端是一个内部机制，旨在在服务之间同步Google账户。它通过确保浏览器账户状态与Google的身份验证Cookie一致，来提供一致的用户体验。

‍

我们尝试使用Google Dork找到终端的提及，但我们未能找到任何内容。后来在GitHub中尝试找到相同的终端时发现了完全匹配，这揭示了如下所示的Chromium源代码。

*图 5 Google 的 Chromium 源代码中显示了参数格式、数据格式和目的*

这个终端点通过接受一组账户 ID 和授权登录令牌来运行，这些数据对于管理同时会话或无缝切换用户配置文件至关重要。来自 Chromium 代码库的见解证实，尽管 MultiLogin 功能在用户认证中扮演着重要角色，但如果处理不当，它也会成为一个可利用的途径，正如最近的恶意软件发展所证明的那样。

‍

*图 6 单元测试显示了预期请求数据*

‍

我们的 TI 消息来源与发现此问题的威胁行为者进行了交流，这加速了我们对负责重新生成 cookie 的终端点的发现。

## **逆向工程利用代码**

**揭示终端点**：通过对原作者提供的利用可执行文件进行逆向工程，发现了利用涉及的具体终端点。这个未记录的 MultiLogin 终端点是 Google OAuth 系统的关键部分，接受账户 ID 和授权登录令牌的向量。

*图 7 反向工程利用代码显示了被利用的终端点*

### **威胁行为者的复杂策略**

在网络威胁领域，威胁行为者采用的策略常常既复杂又隐秘。Lumma对未记录的 Google OAuth2 MultiLogin 终端点的利用案例提供了一个典型的例子，展示了这种复杂性。

Lumma的方法取决于对令牌:GAIA ID 对的微妙操纵，这是 Google 认证流程的关键组成部分。当与 MultiLogin 终端点一起使用时，这对令牌有效地实现了 Google 服务 cookie 的重新生成。Lumma的战略创新在于使用他们专有的私钥加密这对令牌:GAIA ID。通过这样做，他们有效地“黑箱化”了利用过程，将利用的核心机制笼罩在秘密之中。这种黑箱化服务两个目的：

+   **利用技术的保护**：通过对关键的令牌:GAIA ID 对应用加密，Lumma有效地掩盖了他们利用的核心机制。这层加密起到了屏障的作用，阻碍其他恶意实体复制他们的方法。这一战略举措不仅在网络犯罪的竞争环境中保留了他们利用的独特性，还为他们在非法市场上提供了优势。然而，Lumma随后的调整，引入了使用 SOCKS 代理来规避 Google 基于 IP 的 cookie 重生限制，无意间暴露了一些请求和响应的细节，可能影响了利用的隐秘性。

+   **规避检测**：恶意软件 c2 与 MultiLogin 终端点之间的加密通信不太可能触发网络安全系统的警报。标准的安全协议更容易忽视加密流量，将其误认为是合法的加密数据交换。

*图 8 重置密码后成功重新生成 cookie*

## ‍**攻击技术的复杂性**

此攻击技术展示了对 Google 内部身份验证机制的更高水平的复杂性和理解。通过操纵令牌：GAIA ID 对，Lumma 可以持续为 Google 服务重新生成 cookie。更令人担忧的是，即使用户已经重置了密码，这种攻击仍然有效。这种持续的访问允许对用户账户和数据进行长时间且潜在地不被注意的利用。

‍

对加密攻击的关键组件的战术决定显示了向更高级、更隐蔽的网络威胁的有意识转移。这标志着恶意软件开发领域的变化，其中重点越来越多地放在了攻击方法的隐藏和保护上，而不仅仅是攻击本身的效果。

# **HUMINT 分析：**

**人类智能的作用：** HUMINT 在加速研究过程中发挥了关键作用。来源提供了关于攻击的部分信息，导致最初的尝试（400 响应）未能成功。然而，进一步的 HUMINT 洞察力，结合 OSINT，揭示了攻击的架构。

‍

*图 9 原始 TA 与我们的消息来源的对话*

‍**攻击源和起源：** 在源代码中发现的用户代理字符串的分析（如 *图7* 中所示（com.google.Drive/6.0.230903 iSL/3.4 iPhone/15.7.4 hw/iPhone9_4 (gzip)））表明，针对 Apple 设备上的 Google Drive 服务的渗透测试是攻击的潜在起源。攻击的不完善测试导致了其源代码的泄露。

‍

## 临时补救措施

尽管我们正在等待来自 Google 的全面解决方案，但用户可以立即采取行动来防范此攻击。如果您怀疑您的账户可能已受到攻击，或者作为一般预防措施，请登出所有浏览器配置文件以使当前会话令牌失效。然后，重置您的密码并重新登录以生成新的令牌。对于那些可能已经外泄了令牌和 GAIA ID 的用户来说，这一步骤尤其重要。通过重置密码，有效地破坏了[信息窃取者](/tag/infostealer)依赖的旧令牌，从而为其攻击的延续提供了至关重要的屏障。

临时补救措施

‍

## 常见问题

### **涉及 Google 账户的攻击的本质是什么？**

此攻击涉及使用一个未记录的 Google OAuth 端点“MultiLogin” 的恶意软件，以重新生成过期的 Google 服务 cookie，从而允许持久访问被 compromise 的账户。这种方法绕过了密码的需求，但并不代表 OAuth 系统本身存在直接漏洞。

### **更改密码是否能够保护账户免受此攻击？**

仅仅更改密码可能不足以保护账户。该漏洞允许即使在重置密码后也可以重新生成身份验证 cookie，但仅限一次。为了完全保护账户，用户应注销所有会话并撤销任何可疑连接。

### **如果用户的账户被入侵了，用户可以撤销访问权限吗？**

用户可以通过退出受影响的浏览器或通过其账户的设备管理页面远程撤销会话来使被盗会话失效。

### **这是一种新的网络攻击形式吗？**

虽然特定的漏洞和特定令牌的外泄相对较新，但恶意软件窃取密码和 cookie 的概念并不是一种新颖的网络威胁。最近的事件引起了人们对现代网络攻击的复杂性和隐秘性的关注。

### **用户应该采取什么措施来保护他们的账户？**

建议用户定期检查不熟悉的会话，更改密码，并在下载未知软件和未知附件时保持警惕。

‍

## **结论**

这项分析强调了现代网络威胁的复杂性和隐秘性。它突出了持续监控技术漏洞和人类情报来源的必要性，以保持对新兴网络威胁的预防。技术和人类情报的合作在揭示和理解像本报告中分析的复杂攻击这样的漏洞方面至关重要。

‍

## **参考文献**

## **附录**

*附录 1：Lumma 在 2023 年 11 月 14 日发布了该功能*

‍

*附录 2：White snake stealer 在 2023 年 12 月 26 日实施了该功能*

‍

*附录 3：RisePro在 2023 年 12 月 12 日实施了相同功能*

*附录 4：StealC 在 2023 年 12 月 1 日实施了该功能*

‍

*附录 5：Meduza 在 2023 年 12 月 11 日的功能*

‍

*附录 6：Rhadamanthys恢复Google账户的特征*

‍

*附录 7：Lumma 团队由于 Google 的欺诈检测而采取的对抗措施。*

*附录 8：Prisma 开发人员与另一公开来源关于 Lumma 的盗窃和再利用的对话。*

‍
