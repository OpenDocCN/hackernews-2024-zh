- en: <!--yml
  id: totrans-0
  prefs: []
  type: TYPE_NORMAL
- en: 'category: æœªåˆ†ç±»'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
- en: 'date: 2024-05-27 14:37:48'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
- en: -->
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
- en: How Discord Serves 15-Million Users on One Server
  id: totrans-4
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: æ¥æºï¼š[https://blog.bytebytego.com/p/how-discord-serves-15-million-users](https://blog.bytebytego.com/p/how-discord-serves-15-million-users)
  id: totrans-5
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: How is GenAI impacting software development?
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
- en: Join LinearB and ThoughtWorksâ€™ Global Lead for AI Software Delivery to explore
    the metrics showing AIâ€™s impact, unpack best practices for leveraging AI in software
    development, and measure the ROI of your own GenAI initiative.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
- en: '[This workshop](https://bit.ly/LinearB_010924) includes:'
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
- en: '**ğŸ“ŠData insights** from LinearBâ€™s new GenAI Impact Report'
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
- en: '**ğŸ—£ï¸Case studies** into how others are already doing it'
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
- en: '**ğŸ”Impact Measures:** adoption, benefits & risk metrics'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
- en: âœ…**Live demo:** How you can measure the impact of your GenAI initiative today
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
- en: Join the conversation on January 25th or 30th.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
- en: '[Register Now](https://bit.ly/LinearB_010924)'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
- en: '* * *'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
- en: In early summer 2022, the Discord operations team noticed unusually high activity
    on their dashboards. They thought it was a bot attack, but it was legitimate traffic
    from MidJourney - a new, fast-growing community for generating AI images from
    text prompts.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
- en: To use MidJourney, you need a Discord account. Most MidJourney users join one
    main Discord server. This server grew so quickly that it soon hit Discordâ€™s old
    limit of around 1 million users per server.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
- en: Discord risked losing this important new community if they didnâ€™t act fast.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
- en: This is the story of how the Discord team creatively solved this challenge.
    They found ways to dramatically expand what their infrastructure could handle
    - keeping the thriving MidJourney community active on Discord.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
- en: Discord is a popular chat app used by hundreds of millions to connect. Originally
    for gamers, now all types of communities use it - from hiking clubs to study groups
    to large gaming communities.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
- en: In Discord, a "server" hosts a community. It has chat channels to discuss topics
    chosen by the server owner.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
- en: Internally, Discord calls these servers "guilds" - so we'll use that term going
    forward.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
- en: 'Largest Discord Guilds (image source: [Discord](https://discord.com/servers))'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
- en: Before MidJourney, the biggest guilds had around 1 million members - huge gaming
    communities like Roblox and Fortnite.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
- en: The Discord engineering team thought 1 million members was very close to the
    maximum a guild could handle. Let's explore why - but first, some quick background
    on the technologies powering Discord.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
- en: Discordâ€™s real-time messaging backend is built with Elixir. Elixir runs on the
    BEAM virtual machine. BEAM was created for Erlang - a language optimized for large
    real-time systems requiring rock-solid reliability and uptime.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
- en: A key capability BEAM provides is extremely lightweight parallel processes.
    This enables a single server to efficiently run tens or hundreds of thousands
    of processes concurrently.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
- en: Elixir brings friendlier, Ruby-inspired syntax to the battle-tested foundation
    of BEAM. Combined they make it much easier to program massively scalable, fault-tolerant
    systems.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: Elixir å°†å‹å¥½ã€å— Ruby å¯å‘çš„è¯­æ³•å¸¦å…¥äº† BEAM çš„ç»è¿‡å¤§é‡æµ‹è¯•çš„åŸºç¡€ã€‚å®ƒä»¬çš„ç»“åˆä½¿å¾—ç¼–å†™å¤§è§„æ¨¡å¯æ‰©å±•ã€å®¹é”™ç³»ç»Ÿå˜å¾—æ›´åŠ å®¹æ˜“ã€‚
- en: 'Code snippets comparing Erlang and Elixir syntax (image source: [elixirforum](https://elixirforum.com/t/code-snippets-to-compare-erlang-and-elixir-syntax/16443/3))'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: æ¯”è¾ƒ Erlang å’Œ Elixir è¯­æ³•çš„ä»£ç ç‰‡æ®µï¼ˆå›¾ç‰‡æ¥æºï¼š[elixirforum](https://elixirforum.com/t/code-snippets-to-compare-erlang-and-elixir-syntax/16443/3)ï¼‰
- en: So by leveraging BEAM's lightweight processes, the Elixir code powering Discord
    can "fan out" messages to hundreds of thousands of users around the world concurrently.
    However, limits emerge as communities grow larger.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: å› æ­¤ï¼Œé€šè¿‡åˆ©ç”¨ BEAM çš„è½»é‡çº§è¿›ç¨‹ï¼Œé©±åŠ¨ Discord çš„ Elixir ä»£ç å¯ä»¥åŒæ—¶å‘å…¨çƒæ•°åä¸‡ç”¨æˆ·â€œæ‰‡å‡ºâ€æ¶ˆæ¯ã€‚ç„¶è€Œï¼Œéšç€ç¤¾åŒºè§„æ¨¡çš„æ‰©å¤§ï¼Œé™åˆ¶ä¹Ÿå‡ºç°äº†ã€‚
- en: As mentioned, Discord handles all real-time communication using Elixir processes
    on the highly concurrent BEAM virtual machine.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: æ­£å¦‚å‰é¢æåˆ°çš„ï¼ŒDiscord ä½¿ç”¨é«˜åº¦å¹¶å‘çš„ BEAM è™šæ‹Ÿæœºä¸Šçš„ Elixir è¿›ç¨‹å¤„ç†æ‰€æœ‰å®æ—¶é€šä¿¡ã€‚
- en: 'The path of a message through Discordâ€™s real-time infra to other users and
    bots in a guild (Source: [Discord eng blog](https://discord.com/blog/maxjourney-pushing-discords-limits-with-a-million-plus-online-users-in-a-single-server))'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: æ¶ˆæ¯é€šè¿‡ Discord çš„å®æ—¶åŸºç¡€è®¾æ–½ä¼ é€’åˆ°å…¬ä¼šä¸­çš„å…¶ä»–ç”¨æˆ·å’Œæœºå™¨äººçš„è·¯å¾„ï¼ˆæ¥æºï¼š[Discord å·¥ç¨‹åšå®¢](https://discord.com/blog/maxjourney-pushing-discords-limits-with-a-million-plus-online-users-in-a-single-server)ï¼‰
- en: Internally, each Discord community is called a â€œguildâ€. A dedicated Elixir â€œguild
    processâ€ handles coordination and routing for each guild. This tracks all connected
    users to the guild.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨å†…éƒ¨ï¼Œæ¯ä¸ª Discord ç¤¾åŒºè¢«ç§°ä¸ºâ€œå…¬ä¼šâ€ã€‚ä¸€ä¸ªä¸“é—¨çš„ Elixir â€œå…¬ä¼šè¿›ç¨‹â€å¤„ç†æ¯ä¸ªå…¬ä¼šçš„åè°ƒå’Œè·¯ç”±ã€‚è¿™è·Ÿè¸ªæ‰€æœ‰è¿æ¥åˆ°å…¬ä¼šçš„ç”¨æˆ·ã€‚
- en: Every online user has a separate Elixir "session processâ€. When the guild process
    gets a new message, event, or update, it fans out this information to the relevant
    session processes. These session processes then push the update over WebSocket
    to the Discord clients.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: æ¯ä¸ªåœ¨çº¿ç”¨æˆ·éƒ½æœ‰ä¸€ä¸ªå•ç‹¬çš„ Elixir â€œä¼šè¯è¿›ç¨‹â€ã€‚å½“å…¬ä¼šè¿›ç¨‹æ”¶åˆ°æ–°æ¶ˆæ¯ã€äº‹ä»¶æˆ–æ›´æ–°æ—¶ï¼Œå®ƒä¼šå°†è¿™äº›ä¿¡æ¯æ‰‡å‡ºåˆ°ç›¸å…³çš„ä¼šè¯è¿›ç¨‹ã€‚ç„¶åï¼Œè¿™äº›ä¼šè¯è¿›ç¨‹å°†æ›´æ–°é€šè¿‡
    WebSocket æ¨é€ç»™ Discord å®¢æˆ·ç«¯ã€‚
- en: This architecture provides a cost-effective way to handle millions of active
    guilds across a large pool of Linux servers in Discord's cloud infrastructure.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™ç§æ¶æ„ä¸º Discord åœ¨äº‘åŸºç¡€è®¾æ–½ä¸­çš„å¤§é‡ Linux æœåŠ¡å™¨ä¸Šå¤„ç†æ•°ç™¾ä¸‡ä¸ªæ´»è·ƒå…¬ä¼šæä¾›äº†ä¸€ç§ç»æµæœ‰æ•ˆçš„æ–¹å¼ã€‚
- en: However, scaling limits emerge as guilds grow larger. Distributing messages
    and events to more users creates exponentially more work. Larger guilds also have
    more activity to distribute.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: ç„¶è€Œï¼Œéšç€å…¬ä¼šè§„æ¨¡çš„æ‰©å¤§ï¼Œæ‰©å±•é™åˆ¶ä¹Ÿå‡ºç°äº†ã€‚å‘æ›´å¤šç”¨æˆ·åˆ†å‘æ¶ˆæ¯å’Œäº‹ä»¶ä¼šäº§ç”ŸæŒ‡æ•°çº§çš„å·¥ä½œé‡ã€‚æ›´å¤§çš„å…¬ä¼šä¹Ÿæœ‰æ›´å¤šçš„æ´»åŠ¨è¦åˆ†å‘ã€‚
- en: So the guild process load grows much faster as its number of users increases.
    BEAM helps tremendously, but there's only so much one BEAM process can handle.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: å› æ­¤ï¼Œéšç€ç”¨æˆ·æ•°é‡çš„å¢åŠ ï¼Œå…¬ä¼šè¿›ç¨‹çš„è´Ÿè½½å¢é•¿é€Ÿåº¦ä¼šæ›´å¿«ã€‚BEAM èƒ½æä¾›å·¨å¤§å¸®åŠ©ï¼Œä½†æ˜¯ä¸€ä¸ª BEAM è¿›ç¨‹èƒ½å¤„ç†çš„äº‹æƒ…æ˜¯æœ‰é™çš„ã€‚
- en: This is why Discord thought breaking 1 million concurrent users per guild would
    be very difficult.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Discord è®¤ä¸ºæ¯ä¸ªå…¬ä¼šåŒæ—¶åœ¨çº¿ç”¨æˆ·çªç ´ 100 ä¸‡ä¼šå¾ˆå›°éš¾ã€‚
- en: '* * *'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: If youâ€™re not a paid subscriber, hereâ€™s what you missed this month.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚æœä½ ä¸æ˜¯ä»˜è´¹è®¢é˜…è€…ï¼Œè¿™å°±æ˜¯ä½ æœ¬æœˆé”™è¿‡çš„å†…å®¹ã€‚
- en: '[Netflix: What Happens When You Press Play?](https://blog.bytebytego.com/p/netflix-what-happens-when-you-press)'
  id: totrans-41
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '[Netflixï¼šå½“ä½ æŒ‰ä¸‹æ’­æ”¾æŒ‰é’®æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ](https://blog.bytebytego.com/p/netflix-what-happens-when-you-press)'
- en: '[6 More Microservices Interview Questions](https://blog.bytebytego.com/p/6-more-microservices-interview-questions)'
  id: totrans-42
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '[å¦å¤–6ä¸ªå¾®æœåŠ¡é¢è¯•é—®é¢˜](https://blog.bytebytego.com/p/6-more-microservices-interview-questions)'
- en: '[7 Microservices Interview Questions](https://blog.bytebytego.com/p/7-microservices-interview-questions)'
  id: totrans-43
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '[7ä¸ªå¾®æœåŠ¡é¢è¯•é—®é¢˜](https://blog.bytebytego.com/p/7-microservices-interview-questions)'
- en: '[Why the Internet Is Both Robust and Fragile](https://blog.bytebytego.com/p/why-the-internet-is-both-robust-and)'
  id: totrans-44
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '[ä¸ºä»€ä¹ˆäº’è”ç½‘æ—¢ç¨³å¥åˆè„†å¼±](https://blog.bytebytego.com/p/why-the-internet-is-both-robust-and)'
- en: '[Unlock Highly Relevant Search with AI](https://blog.bytebytego.com/p/unlock-highly-relevant-search-with)'
  id: totrans-45
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '[åˆ©ç”¨äººå·¥æ™ºèƒ½å®ç°é«˜åº¦ç›¸å…³çš„æœç´¢](https://blog.bytebytego.com/p/unlock-highly-relevant-search-with)'
- en: 'To receive all the full articles and support ByteByteGo, consider subscribing:'
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: è¦è·å–æ‰€æœ‰å®Œæ•´æ–‡ç« å¹¶æ”¯æŒ ByteByteGoï¼Œè¯·è€ƒè™‘è®¢é˜…ï¼š
- en: '* * *'
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: With that background established, letâ€™s return to the main story. Facing a scaling
    crisis from Midjourney's runaway growth, Discord formed a small team of senior
    engineers to dig into the problems. This team was called MaxJourney.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨å»ºç«‹äº†è¿™æ ·çš„èƒŒæ™¯ä¹‹åï¼Œè®©æˆ‘ä»¬å›åˆ°ä¸»è¦æ•…äº‹ã€‚é¢å¯¹ Midjourney çš„å¿«é€Ÿå¢é•¿å¸¦æ¥çš„è§„æ¨¡å±æœºï¼ŒDiscord ç»„å»ºäº†ä¸€ä¸ªç”±èµ„æ·±å·¥ç¨‹å¸ˆç»„æˆçš„å°å›¢é˜Ÿæ¥æ·±å…¥ç ”ç©¶è¿™äº›é—®é¢˜ã€‚è¿™ä¸ªå›¢é˜Ÿè¢«ç§°ä¸º
    MaxJourneyã€‚
- en: Hereâ€™s what they accomplished.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™å°±æ˜¯ä»–ä»¬å–å¾—çš„æˆå°±ã€‚
- en: Understanding where systems spend time and memory is critical before improving
    them. The team used various profiling techniques to analyze guild process performance.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨æ”¹è¿›ä¹‹å‰ï¼Œäº†è§£ç³»ç»ŸèŠ±è´¹æ—¶é—´å’Œå†…å­˜çš„ä½ç½®è‡³å…³é‡è¦ã€‚å›¢é˜Ÿä½¿ç”¨å„ç§åˆ†ææŠ€æœ¯åˆ†æå…¬ä¼šæµç¨‹çš„æ€§èƒ½ã€‚
- en: The simplest was sampling stack traces to reveal expensive operations. This
    quickly highlights issues without much effort. However, richer data was needed.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: æœ€ç®€å•çš„æ–¹æ³•æ˜¯æŠ½æ ·å †æ ˆè·Ÿè¸ªä»¥æ­ç¤ºæ˜‚è´µçš„æ“ä½œã€‚è¿™æ ·å¯ä»¥å¿«é€Ÿå‡¸æ˜¾é—®é¢˜ï¼Œè€Œä¸éœ€è¦å¤ªå¤šåŠªåŠ›ã€‚ä½†æ˜¯ï¼Œéœ€è¦æ›´ä¸°å¯Œçš„æ•°æ®ã€‚
- en: So they instrumented the event loop to record metrics on each message type.
    This included frequency, min/max/average processing times. This analysis revealed
    the costliest operations to optimize. Cheap ones could be ignored.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: å› æ­¤ï¼Œä»–ä»¬å¯¹äº‹ä»¶å¾ªç¯è¿›è¡Œäº†ä»ªè¡¨åŒ–ï¼Œä»¥è®°å½•æ¯ç§æ¶ˆæ¯ç±»å‹çš„æŒ‡æ ‡ã€‚è¿™åŒ…æ‹¬é¢‘ç‡ã€æœ€å°/æœ€å¤§/å¹³å‡å¤„ç†æ—¶é—´ã€‚è¿™ç§åˆ†ææ­ç¤ºäº†éœ€è¦ä¼˜åŒ–çš„æˆæœ¬æœ€é«˜çš„æ“ä½œã€‚å¯ä»¥å¿½ç•¥å»‰ä»·çš„æ“ä½œã€‚
- en: Memory usage was also examined, since it impacts hardware needs and garbage
    collection throughput.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: è¿˜æ£€æŸ¥äº†å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œå› ä¸ºå®ƒå½±å“ç¡¬ä»¶éœ€æ±‚å’Œåƒåœ¾æ”¶é›†ååé‡ã€‚
- en: To estimate sizes of large data structures reasonably quickly, a helper library
    was built to sample maps and lists. It avoids fully traversing all elements.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸ºäº†ç›¸å¯¹å¿«é€Ÿåœ°ä¼°è®¡å¤§å‹æ•°æ®ç»“æ„çš„å¤§å°ï¼Œæ„å»ºäº†ä¸€ä¸ªè¾…åŠ©åº“æ¥å¯¹åœ°å›¾å’Œåˆ—è¡¨è¿›è¡ŒæŠ½æ ·ã€‚å®ƒé¿å…äº†å®Œå…¨éå†æ‰€æœ‰å…ƒç´ ã€‚
- en: This sampling revealed memory-intensive fields to refactor.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™æ¬¡æŠ½æ ·æ­ç¤ºäº†éœ€è¦é‡æ„çš„å†…å­˜å¯†é›†å‹é¢†åŸŸã€‚
- en: Armed with visibility into these time and memory hotspots, the team could now
    systematically target optimizations to rewrite inefficient code.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: æœ‰äº†å¯¹è¿™äº›æ—¶é—´å’Œå†…å­˜çƒ­ç‚¹çš„å¯è§æ€§ï¼Œå›¢é˜Ÿç°åœ¨å¯ä»¥æœ‰ç³»ç»Ÿåœ°é’ˆå¯¹æ€§åœ°ä¼˜åŒ–ä»£ç ã€‚
- en: The team's first optimization was reducing unnecessary work. They realized the
    client app did not always need every update for guilds that users were not actively
    viewing in the app's foreground.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: å›¢é˜Ÿçš„ç¬¬ä¸€ä¸ªä¼˜åŒ–æ˜¯å‡å°‘ä¸å¿…è¦çš„å·¥ä½œã€‚ä»–ä»¬æ„è¯†åˆ°å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºå¹¶ä¸æ€»æ˜¯éœ€è¦åœ¨åº”ç”¨ç¨‹åºå‰å°ä¸æ´»åŠ¨æ—¶æ›´æ–°å…¬ä¼šçš„æ¯ä¸ªæ›´æ–°ã€‚
- en: So they implemented "passive" connections for those guilds. Passive connections
    skip processing and data transmission until the user opens the guild.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: å› æ­¤ï¼Œä»–ä»¬ä¸ºè¿™äº›å…¬ä¼šå®ç°äº†â€œè¢«åŠ¨â€è¿æ¥ã€‚è¢«åŠ¨è¿æ¥è·³è¿‡å¤„ç†å’Œæ•°æ®ä¼ è¾“ï¼Œç›´åˆ°ç”¨æˆ·æ‰“å¼€è¯¥å…¬ä¼šã€‚
- en: Over 90% of the user-guild connections became passive for large servers. This
    cut required work by 90%, greatly reducing load.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: è¶…è¿‡ 90% çš„ç”¨æˆ· - å…¬ä¼šè¿æ¥å˜ä¸ºå¤§æœåŠ¡å™¨çš„è¢«åŠ¨è¿æ¥ã€‚è¿™å°†æ‰€éœ€çš„å·¥ä½œé‡å‡å°‘äº† 90%ï¼Œå¤§å¤§å‡è½»äº†è´Ÿè½½ã€‚
- en: However, MidJourney kept growing. So this alone was not enough.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: ç„¶è€Œï¼ŒMidJourney ä¸æ–­å¢é•¿ã€‚å› æ­¤ï¼Œå•ç‹¬åšè¿™äº›è¿˜ä¸å¤Ÿã€‚
- en: Relays already existed to split fanout work across BEAM processes for scaling.
    Relays are only enabled for large guilds, where they maintain session connections
    on behalf of the guild.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸­ç»§å·²ç»å­˜åœ¨ï¼Œç”¨äºè·¨ BEAM è¿›ç¨‹è¿›è¡Œæ‰©å±•çš„æ‰‡å‡ºå·¥ä½œã€‚ä¸­ç»§ä»…åœ¨å¤§å‹å…¬ä¼šä¸­å¯ç”¨ï¼Œå®ƒä»¬ä»£è¡¨å…¬ä¼šç»´æŠ¤ä¼šè¯è¿æ¥ã€‚
- en: Each relay handles fanout and permissions for up to 15,000 users. This allowed
    leverage more BEAM processes to serve large guilds.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: æ¯ä¸ªä¸­ç»§å¤„ç†æ‰‡å‡ºå’Œæƒé™ï¼Œæœ€å¤šå¯å®¹çº³ 15,000 åç”¨æˆ·ã€‚è¿™å…è®¸åˆ©ç”¨æ›´å¤šçš„ BEAM è¿›ç¨‹æ¥æœåŠ¡å¤§å‹å…¬ä¼šã€‚
- en: Originally, relays duplicated full member lists. It was simple to implement,
    but for massive guilds with millions of members, dozens of copied lists wasted
    huge amount of RAM.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: æœ€åˆï¼Œä¸­ç»§å¤åˆ¶äº†å®Œæ•´çš„æˆå‘˜åˆ—è¡¨ã€‚è¿™å¾ˆå®¹æ˜“å®ç°ï¼Œä½†å¯¹äºæ‹¥æœ‰æ•°ç™¾ä¸‡æˆå‘˜çš„å¤§å‹å…¬ä¼šæ¥è¯´ï¼Œå‡ åä¸ªå¤åˆ¶åˆ—è¡¨æµªè´¹äº†å¤§é‡çš„å†…å­˜ã€‚
- en: Also, creating relays stalled massive guilds for seconds while serializing and
    transmitting member data.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: æ­¤å¤–ï¼Œåˆ›å»ºä¸­ç»§ä¼šåœ¨åºåˆ—åŒ–å’Œä¼ è¾“æˆå‘˜æ•°æ®æ—¶ä½¿å¤§å‹å…¬ä¼šåœé¡¿å‡ ç§’é’Ÿã€‚
- en: So the team optimized relays to track just the tiny subset of members needed
    per relay.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: å›¢é˜Ÿä¼˜åŒ–äº†ä¸­ç»§ï¼Œä»…è·Ÿè¸ªæ¯ä¸ªä¸­ç»§æ‰€éœ€çš„å¾®å°æˆå‘˜å­é›†ã€‚
- en: In addition to overall throughput, ensuring low latency was critical. So the
    team analyzed operations with high per-call duration, beyond just total time.
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: é™¤äº†æ•´ä½“ååé‡ï¼Œç¡®ä¿ä½å»¶è¿Ÿä¹Ÿè‡³å…³é‡è¦ã€‚å› æ­¤ï¼Œå›¢é˜Ÿåˆ†æäº†æ“ä½œçš„æ¯æ¬¡è°ƒç”¨æŒç»­æ—¶é—´é«˜çš„æƒ…å†µï¼Œè€Œä¸ä»…ä»…æ˜¯æ€»æ—¶é—´ã€‚
- en: Key culprits were member iterations taking seconds, blocking guilds. The solution
    was worker processes to offload these. Workers leverage ETS, an in-memory database
    for fast inter-BEAM-process data sharing.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: é‡è¦çš„é—®é¢˜æ˜¯æˆå‘˜è¿­ä»£éœ€è¦èŠ±è´¹å‡ ç§’é’Ÿï¼Œé˜»å¡äº†å…¬ä¼šã€‚è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨å·¥ä½œè¿›ç¨‹æ¥å¸è½½è¿™äº›ä»»åŠ¡ã€‚å·¥ä½œè¿›ç¨‹åˆ©ç”¨ ETSï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºå¿«é€Ÿ BEAM è¿›ç¨‹é—´æ•°æ®å…±äº«çš„å†…å­˜æ•°æ®åº“ã€‚
- en: Members were stored in ETS, with recent changes in the guild's heap. This hybrid
    model kept the guild's memory small.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: æˆå‘˜å­˜å‚¨åœ¨ ETS ä¸­ï¼Œæœ€è¿‘çš„æ›´æ”¹åœ¨å…¬ä¼šçš„å †ä¸­ã€‚è¿™ç§æ··åˆæ¨¡å‹ä¿æŒäº†å…¬ä¼šçš„å†…å­˜è¾ƒå°ã€‚
- en: For slow tasks, workers are spawned to run them asynchronously using the shared
    ETS data, freeing the guild to continue handling messages.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: å¯¹äºæ…¢ä»»åŠ¡ï¼Œä¼šç”Ÿæˆå·¥ä½œè¿›ç¨‹ä»¥å¼‚æ­¥æ–¹å¼è¿è¡Œå®ƒä»¬ï¼Œä½¿ç”¨å…±äº«çš„ ETS æ•°æ®ï¼Œä»è€Œä½¿å…¬ä¼šèƒ½å¤Ÿç»§ç»­å¤„ç†æ¶ˆæ¯ã€‚
- en: An example slow task is handling guild migration between machines. Copying state
    from the old guild process to the new process normally stalls the old one for
    minutes. But offloading this to a worker avoids blocking the old guild process
    from handling incoming messages.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸€ä¸ªä¾‹å­æ˜¯å¤„ç†æœºå™¨ä¹‹é—´çš„å…¬ä¼šè¿ç§»çš„ç¼“æ…¢ä»»åŠ¡ã€‚å°†çŠ¶æ€ä»æ—§çš„å…¬ä¼šè¿›ç¨‹å¤åˆ¶åˆ°æ–°è¿›ç¨‹é€šå¸¸ä¼šä½¿æ—§è¿›ç¨‹åœæ»æ•°åˆ†é’Ÿã€‚ä½†æ˜¯ï¼Œå°†æ­¤ä»»åŠ¡å¸è½½åˆ°å·¥ä½œç¨‹åºä¸­å¯é¿å…é˜»å¡æ—§çš„å…¬ä¼šè¿›ç¨‹å¤„ç†ä¼ å…¥æ¶ˆæ¯ã€‚
- en: Another idea was offloading fanout from guilds to separate "sender" processes,
    further reducing guild workload and insulating the guild processes from network
    backpressure.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: å¦ä¸€ä¸ªæƒ³æ³•æ˜¯å°†å…¬ä¼šçš„æ‰‡å‡ºä»å…¬ä¼šåˆ†ç¦»åˆ°å•ç‹¬çš„â€œå‘é€è€…â€è¿›ç¨‹ï¼Œè¿›ä¸€æ­¥å‡å°‘å…¬ä¼šçš„å·¥ä½œé‡ï¼Œå¹¶ä½¿å…¬ä¼šè¿›ç¨‹å…å—ç½‘ç»œèƒŒå‹çš„å½±å“ã€‚
- en: However, this unexpectedly tanked performance due to pathological garbage collection.
    Analysis showed it was triggered by freeing small memory outside the heap.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: ç„¶è€Œï¼Œç”±äºç—…æ€åƒåœ¾æ”¶é›†ï¼Œæ€§èƒ½æ„å¤–ä¸‹é™ã€‚åˆ†æè¡¨æ˜ï¼Œè¿™æ˜¯ç”±äºé‡Šæ”¾å †å¤–çš„å°å†…å­˜è€Œè§¦å‘çš„ã€‚
- en: Tuning the virtual binary heap size fixed this. Now offload could be enabled,
    significantly improving throughput.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: è°ƒæ•´è™šæ‹ŸäºŒè¿›åˆ¶å †å¤§å°è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚ç°åœ¨å¯ä»¥å¯ç”¨å¸è½½ï¼Œæ˜¾ç€æé«˜ååé‡ã€‚
- en: Through systematic optimization, the MaxJourney team achieved the seemingly
    impossible - expanding guild capacity 15x to keep MidJourney thriving on Discord.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: é€šè¿‡ç³»ç»Ÿä¼˜åŒ–ï¼ŒMaxJourneyå›¢é˜Ÿå®ç°äº†çœ‹ä¼¼ä¸å¯èƒ½çš„äº‹æƒ… - å°†å…¬ä¼šå®¹é‡æ‰©å±•äº†15å€ï¼Œä»¥ä¿æŒMidJourneyåœ¨Discordä¸Šè“¬å‹ƒå‘å±•ã€‚
- en: '[1] [Maxjourney: Pushing Discordâ€™s Limits with a Million+ Online Users in a
    Single Server](https://discord.com/blog/maxjourney-pushing-discords-limits-with-a-million-plus-online-users-in-a-single-server)'
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: '[1] [Maxjourneyï¼šåœ¨å•ä¸ªæœåŠ¡å™¨ä¸Šæ¨åŠ¨Discordè¶…è¿‡ä¸€ç™¾ä¸‡åœ¨çº¿ç”¨æˆ·çš„é™åˆ¶](https://discord.com/blog/maxjourney-pushing-discords-limits-with-a-million-plus-online-users-in-a-single-server)'
- en: '[Using Rust to Scale Elixir for 11 Million Concurrent Users](https://discord.com/blog/using-rust-to-scale-elixir-for-11-million-concurrent-users)'
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: '[ä½¿ç”¨Rustå°†Elixiræ‰©å±•åˆ°1100ä¸‡å¹¶å‘ç”¨æˆ·](https://discord.com/blog/using-rust-to-scale-elixir-for-11-million-concurrent-users)'
- en: '[2] [How Discord Scaled Elixir to 5,000,000 Concurrent Users](https://discord.com/blog/how-discord-scaled-elixir-to-5-000-000-concurrent-users)'
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: '[2] [å¦‚ä½•å°†Discordçš„Elixiræ‰©å±•åˆ°500ä¸‡å¹¶å‘ç”¨æˆ·](https://discord.com/blog/how-discord-scaled-elixir-to-5-000-000-concurrent-users)'
- en: '[3] [Discord Developer Portal â€” Documentation â€” Guild](https://discord.com/developers/docs/resources/guild)'
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: '[3] [Discordå¼€å‘è€…é—¨æˆ· â€” æ–‡æ¡£ â€” å…¬ä¼š](https://discord.com/developers/docs/resources/guild)'
- en: '[4] [GitHub - discord/manifold: Fast batch message passing between nodes for
    Erlang/Elixir.](https://github.com/discord/manifold)'
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: '[4] [GitHub - discord/manifoldï¼šErlang/Elixirä¹‹é—´çš„å¿«é€Ÿæ‰¹é‡æ¶ˆæ¯ä¼ é€’ã€‚](https://github.com/discord/manifold)'
- en: '[5] [BEAM (Erlang virtual machine) - Wikipedia](https://en.wikipedia.org/wiki/BEAM_(Erlang_virtual_machine))'
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: '[5] [BEAMï¼ˆè‰¾ä¼¦è™šæ‹Ÿæœºå™¨ï¼‰ - ç»´åŸºç™¾ç§‘](https://en.wikipedia.org/wiki/BEAM_(Erlang_virtual_machine))'
- en: '[6] [Erlang''s virtual machine, the BEAM](https://www.erlang-solutions.com/blog/erlangs-virtual-machine-the-beam/)'
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: '[6] [è‰¾ä¼¦çš„è™šæ‹Ÿæœºå™¨ï¼ŒBEAM](https://www.erlang-solutions.com/blog/erlangs-virtual-machine-the-beam/)'
- en: '[7] [Introduction â€” Elixir v1.16.0](https://hexdocs.pm/elixir/1.16/introduction.html)'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: '[7] [ä»‹ç» â€” Elixir v1.16.0](https://hexdocs.pm/elixir/1.16/introduction.html)'
