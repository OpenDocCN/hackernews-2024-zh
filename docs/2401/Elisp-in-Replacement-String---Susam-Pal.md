<!--yml

category: 未分类

日期：2024 年 05 月 27 日 14:43:12

-->

# 替换字符串中的 Elisp - Susam Pal

> 来源：[`susam.net/maze/elisp-in-replacement-string.html`](https://susam.net/maze/elisp-in-replacement-string.html)

<main>

# 替换字符串中的 Elisp

作者**Susam Pal**于 2024 年 01 月 09 日

对于 Emacs 用户而言，很可能众所周知，以下关键序列启动了搜索和替换操作，以匹配正则表达式模式`f..`的字符串，并用`bar`替换匹配项。

```
C-M-% f.. RET bar RET
```

同样，以下关键序列查找匹配具有两个捕获组的模式的字符串，并将每个匹配替换为新字符串，该新字符串交换了捕获组匹配的子字符串：

```
C-M-% \(f..\)-\(b..\) RET \2-\1
```

例如，此操作匹配字符串`foo-bar`并将其替换为`bar-foo`。像`postfix-boxing`这样的字符串变成了`postbox-fixing`。反向引用`\1`指的是第一个捕获组`\（f..\)`匹配的字符串，类似地`\2`指的是第二个捕获组`\（b..\)`.然后，替换字符串交换了两个捕获组中匹配的位置。

可能较少人知道的是，利用 Elisp 表达式动态计算替换字符串的部分的能力。要使用此功能，只需在替换字符串中写入`\,`（即反斜杠和逗号），然后写入 Elisp 表达式。考虑以下关键序列：

```
C-M-% f.. RET \,(upcase \&) RET
```

反向引用`\＆`指的是整个匹配项。我们将其作为 Elisp 函数`upcase`的参数传递。此函数将其参数转换为大写。此示例搜索与模式`f..`匹配的字符串，并将每个匹配项替换为匹配项的大写形式。像`foo-bar`这样的字符串将被替换为`FOO-bar`。

这是另一个稍微复杂一些的例子：

```
C-M-% host:\([0-9]+\) RET host:\,(+ 1000 \#1)
```

反向引用`\＃1`将第一个捕获组`\([0-9]+\)`匹配的字符串作为*数字*。替换模式中的 Elisp 表达式简单地将`1000`添加到该数字，并用结果替换匹配的字符串。像`host:80`这样的字符串变成了`host:1080`。另一个字符串`localhost:8000`变成了`localhost:9000`。

最后，这里有一个来自文本编辑真实世界的示例，最近在解决文本编辑问题时，这个功能对我很有用。考虑以下包含编号项目列表的文本缓冲区：

```
### 1) apple
### 2) ball
### 3) bat
### 4) cat
### 5) dog
### 6) elephant
### 7) fish
### 8) grapes
### 9) hen
### 10) ink
### 11) jug
### 12) kite
### 13) lion

```

尽管此处提供的是一个为了简单和清晰起见而提供的玩具示例，但此示例基于我最近遇到的一个实际文本编辑问题。不过，在我的实际问题中，每行上有更多的单词，并且每个连续项目对之间有一些任意的文本段落。此外，列表很长，有大约 50 个项目。现在的问题是删除第 3 项并对其下面的所有行重新编号。

很容易删除第 3 项。只需将点（光标）移到该行并键入`C-S-<backspace>`或`C-a C-k`以删除该行。我们得到这个：

```
### 1) apple
### 2) ball
### 4) cat
### 5) dog
### 6) elephant
### 7) fish
### 8) grapes
### 9) hen
### 10) ink
### 11) jug
### 12) kite
### 13) lion

```

我们现在如何重新编号所有以 `4) cat` 开头的项目？这就是支持替换字符串中 Elisp 表达式的地方。首先将光标移动到那一行的开头。然后输入以下键序列：

```
C-M-% ^### \([0-9]+\) RET ### \,(1- \#1) RET
```

搜索模式在每行中捕获项目编号。替换字符串包含一个 Elisp 表达式，用于从该编号中减去一。因此像 `### 4` 这样的字符串将被替换为 `### 3`。替换完成后，缓冲区看起来像这样：

```
### 1) apple
### 2) ball
### 3) cat
### 4) dog
### 5) elephant
### 6) fish
### 7) grapes
### 8) hen
### 9) ink
### 10) jug
### 11) kite
### 12) lion

```

希望这对你有帮助。你有一个有趣的 Elisp-in-replacement-string 故事吗？请在评论中分享。

</main>
