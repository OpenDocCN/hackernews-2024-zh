<!--yml

类别：未分类

日期：2024-05-27 14:58:57

-->

# SuperH-3，第 1 部分：介绍 - 旧日新物

> 来源：[https://devblogs.microsoft.com/oldnewthing/20190805-00/?p=102749](https://devblogs.microsoft.com/oldnewthing/20190805-00/?p=102749)

# SuperH-3，第 1 部分：介绍

[Windows CE 支持日立 SuperH-3 和 SuperH-4 处理器](https://www.hpcfactor.com/support/windowsce/wce2.asp)。这些常常被缩写为 SH-3 和 SH-4，或者只是 SH3 和 SH4，架构系列被称为 SHx。

我将在此系列中介绍 SH-3 处理器，同时在必要时提及 SH-4。但我现在可用于逆向工程的唯一二进制文件是 SH-3 二进制文件，所以我的重点将在此。

SH-3 是从 SH-1 和 SH-2 开始的处理器系列的下一步。它被 SH-4 取代，同时也有 SH-3e 和 SH-3-DSP 的分支。SH-4 最著名的可能是作为 Sega Dreamcast 背后的处理器。

与所有处理器回顾系列一样，我将重点关注 Windows CE 在用户模式下如何使用处理器，特别关注你将在编译代码中看到的指令。

SH-3 是一款 32 位 RISC 风格（加载/存储）处理器，具有固定长度的 16 位指令。小型指令尺寸允许比同类产品更高的代码密度，日立声称与具有 32 位指令的处理器相比，代码大小减少了三分之一到一半。这一设计显然非常成功，以至于[ARM 授权其用于他们的 Thumb 指令集](https://lwn.net/Articles/647636/)。

SH-3 可以在大端或小端模式下运行。Windows CE 将其用于小端模式。

SH-3 有十六个通用整数寄存器，每个寄存器宽度为 32 位，正式命名为 `r0` 到 `r15`。它们通常如下使用：

| 寄存器 | 含义 | 是否保留？ |
| --- | --- | --- |
| `r0` | 返回值 | 否 |
| `r1` |   | 否 |
| `r2` |   | 否 |
| `r3` |   | 否 |
| `r4` | 第 1 个参数 | 否 |
| `r5` | 第 2 个参数 | 否 |
| `r6` | 第 3 个参数 | 否 |
| `r7` | 第 4 个参数 | 否 |
| `r8` |   | 是 |
| `r9` |   | 是 |
| `r10` |   | 是 |
| `r11` |   | 是 |
| `r12` |   | 是 |
| `r13` |   | 是 |
| `r14`，又称 `fp` | 帧指针 | 是 |
| `r15`，又称 `sp` | 栈指针 | 是 |

当我们学习[调用约定](https://devblogs.microsoft.com/oldnewthing/20190820-00/?p=102792)时，我们会更多地了解惯例。

实际上，前八个寄存器（`r0` 到 `r7`）有两组（银行）。用户模式代码只使用银行 0，但内核模式可以选择使用银行 0 或银行 1。（当内核模式使用一个银行时，有特殊的指令可用于从另一个银行访问寄存器。）

SH-3 不支持浮点运算，但 SH-4 支持。有十六个单精度浮点寄存器，它们的体系结构名称为 `fpr0` 到 `fpr15`，但是微软汇编器称其为 `fr0` 到 `fr15`。它们可以配对以产生八个双精度浮点寄存器：

| 双精度寄存器 | 单精度寄存器对 |
| --- | --- |
| `dr0` | `fr0` | `fr1` |
| `dr2` | `fr2` | `fr3` |
| `dr4` | `fr4` | `fr5` |
| `dr6` | `fr6` | `fr7` |
| `dr8` | `fr8` | `fr9` |
| `dr10` | `fr10` | `fr11` |
| `dr12` | `fr12` | `fr13` |
| `dr14` | `fr14` | `fr15` |

如果在 SH-3 上执行浮点运算，将会触发陷阱，内核将模拟该指令。因此，SH-3 上的浮点运算非常慢。

Windows NT 要求栈保持在 4 字节边界上。我没有观察到任何红色区域。

还有一些特殊的寄存器：

| 寄存器 | 含义 | 是否保留？ | 备注 |
| --- | --- | --- | --- |
| `pc` | 程序计数器 | 显而易见 | 指令指针，必须是偶数 |
| `gbr` | 全局基址寄存器 | 否 | 额外的指针寄存器 |
| `sr` | 状态寄存器 | 否 | 标志 |
| `mach` | 高乘积累加 | 否 | 用于乘加运算 |
| `macl` | 低乘积累加 | 否 | 用于乘加运算 |
| `pr` | 过程寄存器 | 是 | 返回地址 |

一些 SH-3 的调用约定规定 `mach` 和 `macl` 是保留的，或者 `gbr` 是保留的，但在 Windows CE 中，它们都是临时的。

[稍后我们将更仔细地研究状态寄存器](https://devblogs.microsoft.com/oldnewthing/20190807-00/?p=102769)。

数据大小的体系结构名称如下：

+   **byte**：8 位值

+   **word**：16 位值

+   **longword**：32 位值

+   **quadword**：64 位值

非对齐的内存访问将引发错误。[稍后我们将更仔细地研究非对齐的内存访问](https://devblogs.microsoft.com/oldnewthing/20190821-00/?p=102794)。

SH-3 具有分支延迟槽。啊，分支延迟槽。更糟糕的是，一些分支指令有分支延迟槽，而另一些则没有。呀！[我们将在控制转移时更详细地讨论这个问题](https://devblogs.microsoft.com/oldnewthing/20190816-00/?p=102788)。

SH-3 上的指令通常以左侧为源，右侧为目的编写。例如，

```
    MOV     r1, r2      ; move r1 to r2

```

SH-3 每个周期最多可以退役两条指令，尽管内部资源冲突可能会阻止这种情况发生。例如，一个 `ADD` 指令可以与一个比较指令并行执行，但不能与一个 `SUB` 指令并行执行。在资源冲突的情况下，仅有一条指令在该周期内退役。

在修改标志位的指令之后，新的标志位在一个周期内不可用，在加载指令之后，结果在两个周期内不可用。还有其他的流水线障碍，但这些是你可能会遇到的。如果你试图过早使用先前指令的结果，处理器将会停滞。（不要忘记SH-3是双发射的，所以两个周期可能意味着多达四条指令。）

好的，背景介绍到此为止。[我们下次将通过查看寻址模式来深入了解](https://devblogs.microsoft.com/oldnewthing/20190806-00/?p=102752)。
