<!--yml

category: 未分类

日期：2024-05-27 14:29:59

-->

# 关于 Horizon 出了什么问题：从邮政审判中汲取教训 – Bentham’s Gaze

> 来源：[https://www.benthamsgaze.org/2021/07/15/what-went-wrong-with-horizon-learning-from-the-post-office-trial/](https://www.benthamsgaze.org/2021/07/15/what-went-wrong-with-horizon-learning-from-the-post-office-trial/)

这次邮政审判揭示了英国法律史上可能是[最大的司法失误](https://www.computerweekly.com/news/252500460/Miscarriages-of-justice-are-the-potent-tip-of-Post-Office-scandal)。经营邮政分支机构的数百人（分局长）基于 Horizon 会计系统发现的资金缺失而被判有欺诈和盗窃罪。还有数千名分局长被迫向邮局支付这些亏损。但是邮政审判得出结论，[Horizon“远非坚固”](https://www.benthamsgaze.org/2019/12/19/resolving-disputes-through-computer-evidence-lessons-from-the-post-office-trial/)，所谓的亏损可能根本不存在，而即使存在，它们也可能不是分局长的过错。

这场丑闻的起因是在起诉邮政分局长的过程中披露的信息不足，对邮政的监督不力（包括其管理层和政府），以及法律系统未能以适当的怀疑看待由 Horizon 生成的证据。这些问题已经在[其他地方讨论过](https://www.bbc.co.uk/programmes/m000jf7j)，但很少有人谈论的是 Horizon 和相关系统中可能导致所谓短缺的技术故障。

我在 [Computerphile YouTube 频道上发表了讲话](https://www.youtube.com/watch?v=hBJm9ZYqL10)，谈到了我们从邮政审判中对 Horizon 及其失败的了解。一个看似简单的问题——跟踪分支中的资金和库存——实际上比看起来更难。考虑到 Horizon 每天执行的大量交易（数百万次），不可避免的硬件和通信故障，以及系统之间复杂的交互作用，错误应该是经常发生的。

[https://www.youtube.com/embed/hBJm9ZYqL10?feature=oembed](https://www.youtube.com/embed/hBJm9ZYqL10?feature=oembed)

VIDEO

在这个视频中，我解释了双重记账的基础知识，以及必须在事务系统上实施的方式（提供原子性、一致性、隔离性和持久性 - ACID），并举了一些 Horizon 失败的例子。对于这个视频，我不得不缩写和简化所讨论的一些方面，所以我写了这篇博客文章，参考了邮局审判裁决，其中提到了 Horizon 被确定会失败的情况。

## 原子性失败导致转账的重复

在 7:06，我谈到了原子性要求交易的所有部分必须精确发生一次。在[判决书（第346段）](https://www.benthamsgaze.org/wp-content/uploads/2021/07/Bates-and-Ors-v-the-Post-Office-Ltd-2019-EWHC-3408-QB.pdf#page=105)中，举例说明了 Horizon 在系统崩溃后复制交易部分的情况。

> 2010年，Godeseth 先生被非常谨慎地引导通过了交易更正工具的特定使用。在 PEAK 0195561 中，2010年3月4日向 SSC 报告了一个问题，在此问题中，SPM 在2010年3月2日尝试将 4000 英镑（在 PEAK 中称为 4,000 pds，表示英镑（复数）或英镑）从个别股票单位转入共享主要股票单位时，系统崩溃了。然后向 SPM 发出了 2 张 4000 英镑的收据。这两张收据具有相同的会话号。PEAK 通常以笔记形式记录各种事项，并且还使用非正式的速记。但是，主要的重点是，当 SPM 进行现金声明时，尽管主要的股票单位（将 4000 英镑转入其中的股票单位）“状态良好”，但是现金来源单位“亏损了 4000 英镑（亏损了 4000 pds）”。这与 Latif 先生所说发生在他身上的情况非常相似，尽管他所提到的 2015 年 7 月的转账金额是 2000 英镑。PEAK 与 Horizon Online 相关，并且是 Balancing Transaction 工具被使用的承认场合。

## 一致性失败导致系统之间同步丢失

在 8:03，我谈到了一致性要求保留不变量。其中一个不变量是 Horizon（维护邮局柜台）与会计系统（跟踪资金）的同步。在[判决的技术附录（第131段）](https://www.benthamsgaze.org/wp-content/uploads/2021/07/Bates-and-Ors-v-the-Post-Office-Ltd-2019-EWHC-3408-QB.pdf#page=353)中，给出了一个示例，在此示例中，柜台系统与后端会计系统失去了同步。

> 与将差异移入本地悬而未决账户的过程相关的错误。大多数事件记录在2010年8月至10月之间发生。该错误在截至2010年9月29日的加雷斯·詹金斯先生的报告中有所记录，其中声明：
> 
> “这将产生以下后果：收付不匹配，对应于丢失的差异值。请注意，如果用户不仔细检查他们的最终余额报告，**他们可能不会意识到这个问题，因为在最终余额报告中没有明确的消息表明收付不匹配**（只有在试算平衡期间检测到收付不匹配时才会提示用户）”
> 
> 此问题被报告为在分支遵循某些步骤后在柜台或终端上消失的差异，但在后端分支账户内仍然存在或保持。因此，这与复式记账原则相违背，明显不应该发生。当一个分支取消了交易周期的完成，然后在同一个会话中转入新的余额或交易周期时，问题就会发生。由于差异在柜台上消失，所以 SPM 不会知道差异的存在。

## 孤立性失败导致报告中缺少交易

孤立性要求同时发生的交易不应相互干扰。在 8:59，我谈到了在生成报告过程和另一个交易发生之间孤立性失败的情况。[判决书的技术附录（第 252 段）](https://www.benthamsgaze.org/wp-content/uploads/2021/07/Bates-and-Ors-v-the-Post-Office-Ltd-2019-EWHC-3408-QB.pdf#page=384)讨论了这个案例。

> 邮局另外识别了与 Girobank 有关的一些其他问题，作为 Bug Table 中条目 8 下的问题 3、4、5 和 6。问题 3 适用于两个 PEAK，均来自 2000 年。它们是 PC0052575（其中 SPM 报告的差异为 £20 和 £628.25），该问题被诊断为由于使用共享库存单元而引起。邮局的提交是：“用户打印并截断报告之间存在一段时间窗口。如果另一个用户在该窗口期间执行交易，则该交易可能不会显示在报告中。该问题已计划在未来版本中修复”。Coyne 先生在交叉审讯中承认，这些是发现差异的迹象，但这些本身并不是 Horizon 中错误的证据。关于这一点的整体证据包含在他的最终答案中，即“它在 Horizon 系统内创建了财务差异，最终可能影响分支账户。”我接受这个问题造成了财务差异。鉴于该问题“即将修复”在所谓的“未来版本”中，该问题是由系统的运行引起的，因此，在我的判断中，正确地描述为缺陷。

## 耐久性失败导致一笔交易从 Horizon 中消失

持久性要求一旦事务提交，就不会被撤销。通常实现这一点的方式是系统在事务完全记录之前检测到发生的故障，并通过完成记录事务的过程从故障中恢复。[裁决（第142段）](https://www.benthamsgaze.org/wp-content/uploads/2021/07/Bates-and-Ors-v-the-Post-Office-Ltd-2019-EWHC-3408-QB.pdf#page=48)讨论了一个场景（我在9:40时介绍过），在此场景中，已在连接的银行系统上提交了一个事务，但在 Horizon 中消失了。

> 她的证词与2016年5月9日发生的事件有关，当时出现了全国性的故障，与她提供证词的帕特尼斯先生提供证词的日期相同。她提供了关于分支业务的影响、她为客户服务的方式以及当天 Horizon 的运行速度非常慢的证词，屏幕上出现了一个沙漏很长一段时间。她为一名客户服务，该客户正在进行现金提款，当她在屏幕上获得相关的消息和批准时。然而，在他们离开后，打印出一张写着“恢复失败”的收据，150英镑的提款没有显示出来。后来她研究了交易日志，后一笔交易并未出现。
> 
> …
> 
> 伯克夫人随后采取了非同寻常的行动。她也证明了自己非常坚韧，因为许多人可能早就放弃了150英镑。她确认了客户的身份，并追踪到了他。她去了他的家，解释了发生的事情。他碰巧还保存着她在邮局办理交易时的收据。这完全符合她的陈述。她与客户一起去了他的银行，那是古尔的 TSB。她与客户一起向银行出纳解释发生了什么事情，出纳打印出银行对账单，并显示该笔款项已从客户的银行账户中提取。客户允许伯克夫人拿走这份对账单。

## 日志复制失败

Horizon 的早期版本通过维护一份消息日志来跟踪发生的事件，这些消息在分系统之间进行复制，以确保分支的所有计算机和邮局的后端系统之间保持一致的状态。我在11:33谈到了这一点，以及它是共识算法问题的一个例子，构建可靠的实现仍然是一个开放的研究问题。[裁决的技术附录（第263段）](https://www.benthamsgaze.org/wp-content/uploads/2021/07/Bates-and-Ors-v-the-Post-Office-Ltd-2019-EWHC-3408-QB.pdf#page=386)讨论了一种复制失败的情况。

> 理论上，当一个计数器被替换时，它会在“恢复模式”中与其邻居复制其消息存储。 它的邻居取决于办公室的大小（这将影响其他计数器的数量）和节点号。 对于单个计数器办公室，邻居是数据中心的通信服务器和镜像磁盘（同一计数器中的第二块硬盘）。 对于多计数器办公室，邻居是通信服务器和办公室中的所有其他节点，或办公室中的所有其他节点（称为从属节点），具体取决于要替换的计数器的节点号。
> 
> 换位计数器应在相信已成功复制所有相关消息来自其邻居时退出恢复模式。 邮政公司提交的文件表示：“在这种情况下，换位计数器在其邻居的所有消息都复制完毕之前就提前退出了恢复模式。 换位计数器开始写入自其认为已复制了其邻居的所有相关消息的时间点的消息。 这意味着它使用了已用于未从其邻居复制的消息的消息 ID，这阻止了“丢失”消息在稍后被复制（因为这样做会创建重复的消息 ID）。 因此，缺失的消息被换位计数器“覆盖”了。”

## 未能确保证据的可靠性

在 14:55，我谈到了由 Horizon 生成的证据有时是起诉副邮局长的唯一依据，因此它必须是可靠的。 这意味着我们可以确信行动发生的时间，发生了什么事，以及是谁做的。 我们还希望确保只有最少的人被授予系统特权，允许进行敏感更改。 判决表明 Horizon 未能满足这些要求中的任何一个。

### 当发生行动时

[914 判例段落](https://www.benthamsgaze.org/wp-content/uploads/2021/07/Bates-and-Ors-v-the-Post-Office-Ltd-2019-EWHC-3408-QB.pdf#page=291):

> Coyne 先生已经发现了使用 Credence 数据存在的问题。富士通和 Credence 使用的时间戳相差一个小时，这几乎没有帮助 SPMs 在提出疑问时进行合理的调查，但情况远不止如此。2011 年 3 月的 E&Y 回顾发现了 Credence 存在的各种问题，包括系统后端的弱变更控制，这使得 Logica 开发人员（第三方提供商）能够将自己的未受控制的变更移入生产环境，这些变更包括 Credence 软件代码和用于所谓“审计证据”的 Credence 内部数据，但必须将其与我所指的审计存储中的审计记录区分开。缺乏进一步的文件来批准应用于 Credence 的修复和补丁，这意味着无法将更改链接到问题票据以记录原始的错误修复请求。

### 发生了什么事情

[692 判决段落](https://www.benthamsgaze.org/wp-content/uploads/2021/07/Bates-and-Ors-v-the-Post-Office-Ltd-2019-EWHC-3408-QB.pdf#page=221)：

> 然而，当然考虑了第 4 位专家声明的后续段落，可以看出 Horizon 系统离这个共同同意的（并在技术上证明合理的）立场有多远。特权用户访问（在 PUA 日志中）的记录始于 2009 年 10 月。对于 2009 年至 2015 年的时期 - 显然是一个 6 年的时期 - 这些日志只显示了特权用户登录或退出的事实，“但没有记录他们登录后执行的操作”。因此，在他们登录时执行的操作既没有记录也没有审核。能够看到的只是他们已经登录。此外，已经看到具有相关特权的用户数量在我看来并未受到限制。此外，在这些日志中无法看到交易校正工具的使用。更进一步，专家们一致认为，任何特权用户访问日志始终只显示了 BRDB 表的少数极小部分访问时期的内容。

### 谁执行了一个行动

[532 判决段落](https://www.benthamsgaze.org/wp-content/uploads/2021/07/Bates-and-Ors-v-the-Post-Office-Ltd-2019-EWHC-3408-QB.pdf#page=162)：

> 态度由总邮政局在其代表 Horizon 问题审判提供的证据中维持，直到 Roll 先生的第二份证人声明的服务。为了公正地对待总邮政局，它的起源是由富士通员工提供的证人声明，而不是总邮政局员工。在后来由 Parker 先生的声明更正之前，富士通的证人证据中的立场是 Roll 先生说的在传统 Horizon 上是可能的，而他自己所做的事情是根本不可能的。事实上，Worden 博士认为，作为一名 IT 专家，他可以有信心地断言他在第一份专家报告中已经“确认”了 Roll 先生在这方面的事实证据是错误的。在 Roll 先生的第二份证人声明发出后，富士通终于坦诚并确认（通过 Parker 先生），Roll 先生所说的是正确的。数据可以被富士通在 Horizon 上像在分支机构一样更改；在传统 Horizon 下，交易可以像 Roll 先生描述的那样在柜台插入。这可以在 SPM 不知情的情况下完成。Godeseth 先生还确认，看起来好像是 SPM 们自己执行了交易。这与总邮政局多年来公开发表的说法完全相反。

以及 [判决段落 916](https://www.benthamsgaze.org/wp-content/uploads/2021/07/Bates-and-Ors-v-the-Post-Office-Ltd-2019-EWHC-3408-QB.pdf#page=291)：

> 还有至少一个具体的场合，经过审判证据考虑，显示 Credence 数据未显示正确的情况。这被提到了 Van Den Bogerd 女士。这是 2012 年 10 月 Lepton 发生的事情。这导致了在整个审判过程中被称为 Helen Rose 报告或 Rose 报告的事情，因为报告的作者被称为 Helen Rose。我在上文 [227] 中对此进行了一定程度的处理。该报告记录了以下内容：“2012 年 10 月 4 日 10:42 在 Lepton SPSO 191320 发生了一笔英国电信账单支付交易，金额为 £76.09；这笔款项由 Lloyds TSB 提款 £80.00 支付，找零为 £3.91。在同一天的 10:37，英国电信账单支付被撤销为现金结算。
> 
> 该分支发行了一项金额为 £76.09 的交易更正，他们按时结清了；然而，总邮政局长否认撤销了此交易，并涉及一位法证会计师，因为他认为他的声誉受到了质疑。”（“按时结清”表示 SPM 支付了总邮局那笔款项）。Credence 数据显示，SPM 已经撤销了该交易。通过查阅审计数据，Jenkins 先生发现他并没有这样做。这在 Rose 报告中明确确认过，也在 Van Den Bogerd 女士的交叉审问中得到了证实。

### 减少对敏感系统的访问

[判决的技术附录第423段](https://www.benthamsgaze.org/wp-content/uploads/2021/07/Bates-and-Ors-v-the-Post-Office-Ltd-2019-EWHC-3408-QB.pdf#page=424)：

> 这表明在脚本更改之前（由于明显的原因，脚本更改不可能在实施日期之前发生），所有的 SSC 用户都拥有非常强大的权限（有时也称为特权）APP SUP 用户。专家们一致认为，这些用户实际上可以在系统访问方面随心所欲。这显然可能会对分支账户产生影响，具体取决于任何特定用户在任何特定场合所做的事情。SSC 用户应该只拥有更为有限的 SSC 角色，而富士通自身也意识到了这一点，只能将错误的更广泛角色归因于富士通本身，因为他们都是富士通的雇员。陪审员戈德塞斯在陪审中所附的判决中的这一部分还提到了科因和帕克先生就同一问题提供的证据。帕克先生对科因先生的数字提出了质疑，但没有任何依据，因为他只有自己的印象，而且他明确未能进行适当的调查，即使我发现富士通可以提供更多关于发生次数的适当、有力的证据。我接受科因先生的证词，鉴于沃登博士和戈德塞斯先生都承认强大的 APP SUP 权限或特权比他们应该拥有的更广泛，并且受到的控制也更少（即使基于富士通自己的内部控制），这不可避免地会对 Horizon 的稳健性产生不利影响。

## 结论

邮政审判是少数公开进行系统故障深入检查的案例之一，因此它是一个值得学习的宝贵教训。即使是像维护库存余额这样的简单问题，在分布式系统的一部分时也变得复杂。像 ACID 事务这样的技术可以降低错误的可能性，但真实的实现有时会失败。当系统处理大量交易时，这种失败的概率虽然很小，但会导致频繁的错误。我希望人们重新考虑计算机正确运行的假设，并且在这样做时考虑到邮政审判揭示的因素。

*照片由[Mick Haupt](https://unsplash.com/@rocinante_11?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)在[Unsplash](https://unsplash.com/s/photos/post-office?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)上拍摄*。
