- en: <!--yml
  id: totrans-0
  prefs: []
  type: TYPE_NORMAL
  zh: <!--yml
- en: 'category: æœªåˆ†ç±»'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 'category: æœªåˆ†ç±»'
- en: 'date: 2024-05-27 14:45:32'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: æ—¥æœŸï¼š2024-05-27 14:45:32
- en: -->
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: -->
- en: 'Perception: A back-port of @Observable'
  id: totrans-4
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 'Perception: @Observable çš„å›æº¯'
- en: æ¥æºï¼š[https://www.pointfree.co/blog/posts/129-perception-a-back-port-of-observable](https://www.pointfree.co/blog/posts/129-perception-a-back-port-of-observable)
  id: totrans-5
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: æ¥æºï¼š[https://www.pointfree.co/blog/posts/129-perception-a-back-port-of-observable](https://www.pointfree.co/blog/posts/129-perception-a-back-port-of-observable)
- en: Swift 5.9 brought powerful observation tools to the language, but unfortunately
    they only work in iOS 17, macOS 14, tvOS 17, watchOS 10, and newer. But by some
    accounts, less than 50% of devices are on iOS 17, and so most developers will
    not be able to make use of these tools for a few more years.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: Swift 5.9 ä¸ºè¯­è¨€å¸¦æ¥äº†å¼ºå¤§çš„è§‚å¯Ÿå·¥å…·ï¼Œä½†ä¸å¹¸çš„æ˜¯ï¼Œå®ƒä»¬ä»…é€‚ç”¨äº iOS 17ã€macOS 14ã€tvOS 17ã€watchOS 10 å’Œæ›´æ–°çš„ç‰ˆæœ¬ã€‚ä½†æ ¹æ®ä¸€äº›ç»Ÿè®¡æ•°æ®ï¼Œä¸åˆ°
    50% çš„è®¾å¤‡ä½¿ç”¨ iOS 17ï¼Œæ‰€ä»¥å¤§å¤šæ•°å¼€å‘è€…å°†æ— æ³•åœ¨å‡ å¹´å†…ä½¿ç”¨è¿™äº›å·¥å…·ã€‚
- en: So we have backported the observation tools to work on Appleâ€™s platforms going
    all the way back to iOS 13, macOS 10.15, tvOS 13, watchOS 6, and weâ€™ve released
    it as an [open-source library](http://github.com/pointfreeco/swift-perception).
    This means you can massively simplify your SwiftUI views *today* by using our
    library.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: æ‰€ä»¥æˆ‘ä»¬å·²ç»å°†è§‚å¯Ÿå·¥å…·å›æº¯åˆ°é€‚ç”¨äºè‹¹æœå¹³å°çš„ç‰ˆæœ¬ï¼ŒåŒ…æ‹¬ iOS 13ã€macOS 10.15ã€tvOS 13ã€watchOS 6ï¼Œå¹¶å°†å…¶å‘å¸ƒä¸º[å¼€æºåº“](http://github.com/pointfreeco/swift-perception)ã€‚è¿™æ„å‘³ç€æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨æˆ‘ä»¬çš„åº“æ¥å¤§å¤§ç®€åŒ–æ‚¨çš„
    SwiftUI è§†å›¾*ä»Šå¤©*ã€‚
- en: 'Join us for a quick overview of our new library: [Perception](http://github.com/pointfreeco/swift-perception).'
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: åŠ å…¥æˆ‘ä»¬å¿«é€Ÿæµè§ˆæˆ‘ä»¬çš„æ–°åº“ï¼š[Perception](http://github.com/pointfreeco/swift-perception)ã€‚
- en: Using Perception
  id: totrans-9
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: ä½¿ç”¨ Perception
- en: 'The library provides its own version of the observation tools from Swift 5.9,
    but they can be used on older Apple platforms. When designing your models, instead
    of using the `@Observable` macro, you will use our `@Perceptible` macro:'
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: è¯¥åº“æä¾›äº†å…¶è‡ªå·±ç‰ˆæœ¬çš„ Swift 5.9 ä¸­çš„è§‚å¯Ÿå·¥å…·ï¼Œä½†å®ƒä»¬å¯ä»¥åœ¨æ—§çš„ Apple å¹³å°ä¸Šä½¿ç”¨ã€‚åœ¨è®¾è®¡æ‚¨çš„æ¨¡å‹æ—¶ï¼Œæ‚¨å°†ä½¿ç”¨æˆ‘ä»¬çš„`@Perceptible`å®ï¼Œè€Œä¸æ˜¯ä½¿ç”¨`@Observable`å®ï¼š
- en: '[PRE0]'
  id: totrans-11
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: That is all it takes for the `FeatureModel` class to track access to its properties
    and to broadcast when those properties are mutated.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™å°±æ˜¯`FeatureModel`ç±»è·Ÿè¸ªå…¶å±æ€§è®¿é—®å¹¶åœ¨è¿™äº›å±æ€§å‘ç”Ÿå˜åŒ–æ—¶å¹¿æ’­çš„å…¨éƒ¨å†…å®¹ã€‚
- en: 'This model can be used in a SwiftUI view, but there is one additional step
    that must be taken to guarantee that the view subscribes to the modelâ€™s changes.
    We must wrap the view in a special view called `WithPerceptionTracking`:'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™ä¸ªæ¨¡å‹å¯ä»¥åœ¨ SwiftUI è§†å›¾ä¸­ä½¿ç”¨ï¼Œä½†å¿…é¡»æ‰§è¡Œä¸€ä¸ªé¢å¤–æ­¥éª¤ä»¥ç¡®ä¿è§†å›¾è®¢é˜…æ¨¡å‹çš„æ›´æ”¹ã€‚æˆ‘ä»¬å¿…é¡»å°†è§†å›¾åŒ…è£…åœ¨ä¸€ä¸ªç‰¹æ®Šçš„è§†å›¾ä¸­ï¼Œç§°ä¸º`WithPerceptionTracking`ï¼š
- en: '[PRE1]'
  id: totrans-14
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: On the one hand itâ€™s unfortunate that we have to wrap our view in this, but
    on the other hand itâ€™s fantastic that we can use these observation tools *today*
    without waiting for iOS 17 to have mass adoption.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬ä¸å¾—ä¸å°†æˆ‘ä»¬çš„è§†å›¾åŒ…è£…åœ¨è¿™ä¸ªè§†å›¾ä¸­ï¼Œè¿™æœ‰ç‚¹ä¸å¤ªå¹¸è¿ï¼Œä½†å¦ä¸€æ–¹é¢ï¼Œä»Šå¤©å°±å¯ä»¥ä½¿ç”¨è¿™äº›è§‚å¯Ÿå·¥å…·æ˜¯å¤ªæ£’äº†ï¼Œè€Œä¸å¿…ç­‰å¾… iOS 17 çš„å¹¿æ³›é‡‡ç”¨ã€‚
- en: 'And the library will help you out if you forget to use `WithPerceptionTracking`.
    If a field of a `@Perceptible` class is accessed in a view while *not* inside
    `WithPerceptionTracking`, then a runtime warning will be triggered:'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚æœæ‚¨å¿˜è®°ä½¿ç”¨`WithPerceptionTracking`ï¼Œè¯¥åº“å°†ä¼šå¸®åŠ©æ‚¨ã€‚å¦‚æœåœ¨è§†å›¾ä¸­è®¿é—®`@Perceptible`ç±»çš„å­—æ®µï¼Œè€Œ *ä¸* åœ¨`WithPerceptionTracking`å†…éƒ¨ï¼Œåˆ™ä¼šè§¦å‘è¿è¡Œæ—¶è­¦å‘Šï¼š
- en: 'ğŸŸ£ Runtime Warning: Perceptible state was accessed but is not being tracked.
    Track changes to state by wrapping your view in a â€˜WithPerceptionTrackingâ€™ view.'
  id: totrans-17
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: ğŸŸ£ è¿è¡Œæ—¶è­¦å‘Šï¼šPerceptible çŠ¶æ€å·²è¢«è®¿é—®ï¼Œä½†æœªè¢«è·Ÿè¸ªã€‚é€šè¿‡å°†æ‚¨çš„è§†å›¾åŒ…è£…åœ¨â€˜WithPerceptionTrackingâ€™è§†å›¾ä¸­æ¥è·Ÿè¸ªçŠ¶æ€çš„å˜åŒ–ã€‚
- en: This lets you instantly know when something is not set up correctly, and do
    so in a noticeable yet [unobstrusive](https://www.pointfree.co/blog/posts/70-unobtrusive-runtime-warnings-for-libraries)
    way. To debug this, expand the warning in the Issue Navigator of Xcode (âŒ˜5), and
    click through the stack frames displayed to find the line in your view where you
    are accessing state without being inside `WithPerceptionTracking`.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™è®©æ‚¨ç«‹å³çŸ¥é“ä½•æ—¶è®¾ç½®ä¸æ­£ç¡®ï¼Œå¹¶ä»¥ä¸€ç§å¼•äººæ³¨ç›®ä½†[ä¸æ˜¾çœ¼çš„](https://www.pointfree.co/blog/posts/70-unobtrusive-runtime-warnings-for-libraries)æ–¹å¼æ‰§è¡Œæ­¤æ“ä½œã€‚è¦è°ƒè¯•æ­¤é—®é¢˜ï¼Œè¯·å±•å¼€
    Xcode çš„ Issue Navigatorï¼ˆâŒ˜5ï¼‰ï¼Œå¹¶ç‚¹å‡»æ˜¾ç¤ºçš„å †æ ˆå¸§ï¼Œæ‰¾åˆ°æ‚¨æ­£åœ¨è®¿é—®çŠ¶æ€è€Œä¸åœ¨`WithPerceptionTracking`å†…éƒ¨çš„è§†å›¾ä¸­çš„è¡Œã€‚
- en: How the Perception library works
  id: totrans-19
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Perception åº“çš„å·¥ä½œåŸç†
- en: The new Observation framework is a part of the Swift open source project, which
    means all of the [source code](https://github.com/apple/swift/tree/f7f5070454850ed6bda85a9574b1759115705da4/stdlib/public/Observation)
    is immediately available, including the [source for the @Observable macro](https://github.com/apple/swift/tree/f7f5070454850ed6bda85a9574b1759115705da4/lib/Macros/Sources/ObservationMacros).
    So, we were able to copy all of that code to a new project, and with a few small
    changes we were able to get it all compiling.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: æ–°çš„ Observation æ¡†æ¶æ˜¯ Swift å¼€æºé¡¹ç›®çš„ä¸€éƒ¨åˆ†ï¼Œè¿™æ„å‘³ç€æ‰€æœ‰çš„[æºä»£ç ](https://github.com/apple/swift/tree/f7f5070454850ed6bda85a9574b1759115705da4/stdlib/public/Observation)éƒ½å¯ä»¥ç«‹å³è·å¾—ï¼ŒåŒ…æ‹¬[@Observableå®çš„æºä»£ç ](https://github.com/apple/swift/tree/f7f5070454850ed6bda85a9574b1759115705da4/lib/Macros/Sources/ObservationMacros)ã€‚å› æ­¤ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå°†æ‰€æœ‰è¿™äº›ä»£ç å¤åˆ¶åˆ°ä¸€ä¸ªæ–°é¡¹ç›®ä¸­ï¼Œå¹¶åœ¨è¿›è¡Œäº†ä¸€äº›å°çš„æ›´æ”¹åä½¿å…¶å…¨éƒ¨ç¼–è¯‘é€šè¿‡ã€‚
- en: We also made some major changes to the code to have it behave the way we wanted.
    The first major change we made to the code was to rename all variations of â€œobservationâ€
    to â€œperceptionâ€ (*e.g.*, `@Observable` becomes `@Perceptible`). We did this so
    to make it clear that these are tools separate from the ones that Apple ships
    directly in the Swift tool chain. But we also [deprecated](https://github.com/pointfreeco/swift-perception/blob/92858a542c498742d51c1e736591d91a807d65a7/Sources/Perception/Perceptible.swift#L19-L23)
    all of the backported tools with renames so that once you can set your minimum
    deployment target to iOS 17 you will have an easy way to transition off of our
    library.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ä»¬è¿˜å¯¹ä»£ç è¿›è¡Œäº†ä¸€äº›é‡å¤§æ›´æ”¹ï¼Œä½¿å…¶è¡¨ç°å‡ºæˆ‘ä»¬æƒ³è¦çš„è¡Œä¸ºã€‚æˆ‘ä»¬å¯¹ä»£ç è¿›è¡Œçš„ç¬¬ä¸€ä¸ªé‡å¤§æ›´æ”¹æ˜¯å°†æ‰€æœ‰â€œobservationâ€çš„å˜ä½“é‡å‘½åä¸ºâ€œperceptionâ€ï¼ˆ*ä¾‹å¦‚*ï¼Œ`@Observable`å˜ä¸º`@Perceptible`ï¼‰ã€‚æˆ‘ä»¬è¿™æ ·åšæ˜¯ä¸ºäº†æ¸…æ¥šåœ°è¡¨æ˜è¿™äº›å·¥å…·æ˜¯ä¸è‹¹æœç›´æ¥åœ¨
    Swift å·¥å…·é“¾ä¸­æä¾›çš„å·¥å…·åˆ†å¼€çš„ã€‚ä½†æˆ‘ä»¬è¿˜[å¼ƒç”¨](https://github.com/pointfreeco/swift-perception/blob/92858a542c498742d51c1e736591d91a807d65a7/Sources/Perception/Perceptible.swift#L19-L23)äº†æ‰€æœ‰ä½¿ç”¨é‡å‘½åçš„åå¤‡å·¥å…·ï¼Œè¿™æ ·ä¸€æ—¦æ‚¨å°†æœ€ä½éƒ¨ç½²ç›®æ ‡è®¾ç½®ä¸º
    iOS 17ï¼Œæ‚¨å°±å¯ä»¥è½»æ¾è¿‡æ¸¡åˆ°æˆ‘ä»¬çš„åº“ã€‚
- en: 'Further, we wanted our tools to be able to defer to Appleâ€™s native Observation
    framework when running on an iOS 17 device. This took a bit of extra work at runtime.
    All of the work takes place in the `PerceptionRegistrar`, which wraps either a
    native `ObservationRegistrar` when possible, and if not possible it falls back
    to our back-port, the `_PerceptionRegistrar`:'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: æ­¤å¤–ï¼Œæˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬çš„å·¥å…·åœ¨è¿è¡Œåœ¨ iOS 17 è®¾å¤‡ä¸Šæ—¶èƒ½å¤Ÿæ¨è¿Ÿä½¿ç”¨ Apple çš„åŸç”Ÿ Observation æ¡†æ¶ã€‚è¿™éœ€è¦åœ¨è¿è¡Œæ—¶è¿›è¡Œä¸€äº›é¢å¤–çš„å·¥ä½œã€‚æ‰€æœ‰çš„å·¥ä½œéƒ½å‘ç”Ÿåœ¨`PerceptionRegistrar`ä¸­ï¼Œå®ƒåŒ…è£…äº†ä¸€ä¸ªåŸç”Ÿçš„`ObservationRegistrar`ï¼ˆå¦‚æœå¯èƒ½çš„è¯ï¼‰ï¼Œå¦‚æœä¸å¯èƒ½ï¼Œå®ƒå°±ä¼šå›é€€åˆ°æˆ‘ä»¬çš„åç«¯ç«¯å£ï¼Œå³`_PerceptionRegistrar`ï¼š
- en: '[PRE2]'
  id: totrans-23
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'And we expose ways to get the honest, unwrapped `ObservationRegistrar` or `_PerceptionRegistrar`
    from this type:'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ä»¬æä¾›äº†è·å–è¿™ç§ç±»å‹çš„è¯šå®ã€æœªåŒ…è£…çš„`ObservationRegistrar`æˆ–`_PerceptionRegistrar`çš„æ–¹æ³•ï¼š
- en: '[PRE3]'
  id: totrans-25
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: Note that these properties are technically unsafe since we are force casting.
    But we can be careful to only invoke the properties when the underlying wrapped
    value is of the type of registrar we expect.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: è¯·æ³¨æ„ï¼Œè¿™äº›å±æ€§åœ¨æŠ€æœ¯ä¸Šæ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸ºæˆ‘ä»¬è¿›è¡Œäº†å¼ºåˆ¶ç±»å‹è½¬æ¢ã€‚ä½†æˆ‘ä»¬å¯ä»¥å°å¿ƒåœ°åªåœ¨åŸºç¡€åŒ…è£…å€¼æ˜¯æˆ‘ä»¬é¢„æœŸçš„æ³¨å†Œå™¨ç±»å‹æ—¶æ‰è°ƒç”¨è¿™äº›å±æ€§ã€‚
- en: Then we need to implement the `access`, `willSet`, `didSet` and `withMutation`
    methods on `PerceptionRegistrar`, and do so in a way that can dynamically, at
    runtime, choose to invoke our backported tools or Appleâ€™s native tools.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: ç„¶åï¼Œæˆ‘ä»¬éœ€è¦åœ¨`PerceptionRegistrar`ä¸Šå®ç°`access`ã€`willSet`ã€`didSet`å’Œ`withMutation`æ–¹æ³•ï¼Œå¹¶ä»¥ä¸€ç§å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€é€‰æ‹©è°ƒç”¨æˆ‘ä»¬çš„åå¤‡å·¥å…·æˆ–è‹¹æœåŸç”Ÿå·¥å…·çš„æ–¹å¼æ¥å®ç°ã€‚
- en: 'For example, `access` can be implemented as a method constrained to work with
    the backported `Perceptible` types rather than `Observable` types:'
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: ä¾‹å¦‚ï¼Œ`access`å¯ä»¥ä½œä¸ºä¸€ç§æ–¹æ³•æ¥å®ç°ï¼Œè¯¥æ–¹æ³•å—é™äºä¸`Observable`ç±»å‹è€Œä¸æ˜¯`Perceptible`ç±»å‹ä¸€èµ·ä½¿ç”¨ï¼š
- en: '[PRE4]'
  id: totrans-29
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'Then in the body of this method we can dynamically check if iOS 17 is available,
    and if so try casting the object to the `Observable` protocol, as well as do some
    fancy maneuvers to open the existential and cast the key path to the right type:'
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: ç„¶ååœ¨è¿™ä¸ªæ–¹æ³•çš„ä¸»ä½“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åŠ¨æ€åœ°æ£€æŸ¥ iOS 17 æ˜¯å¦å¯ç”¨ï¼Œå¦‚æœæ˜¯ï¼Œå°è¯•å°†å¯¹è±¡è½¬æ¢ä¸º`Observable`åè®®ï¼Œä»¥åŠè¿›è¡Œä¸€äº›èŠ±å“¨çš„æ“ä½œæ¥æ‰“å¼€å¤–åœ¨æ€§å¹¶å°†å…³é”®è·¯å¾„è½¬æ¢ä¸ºæ­£ç¡®çš„ç±»å‹ï¼š
- en: '[PRE5]'
  id: totrans-31
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: And similar tricks can be employed for the `willSet`, `didSet` and `withMutation`
    methods.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: ç±»ä¼¼çš„æŠ€å·§ä¹Ÿå¯ä»¥ç”¨äº`willSet`ã€`didSet`å’Œ`withMutation`æ–¹æ³•ã€‚
- en: Those little tricks allow iOS 16 and earlier devices to use our perception framework,
    but iOS 17 and new devices will use the native observation tools in Swift 5.9.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™äº›å°æŠ€å·§ä½¿ iOS 16 åŠæ›´æ—©ç‰ˆæœ¬çš„è®¾å¤‡å¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„æ„ŸçŸ¥æ¡†æ¶ï¼Œä½† iOS 17 åŠæ›´æ–°ç‰ˆæœ¬çš„è®¾å¤‡å°†ä½¿ç”¨ Swift 5.9 ä¸­çš„æœ¬åœ°è§‚å¯Ÿå·¥å…·ã€‚
- en: Get started today
  id: totrans-34
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: ä»ä»Šå¤©å¼€å§‹å…¥é—¨
- en: Try out [Perception](http://github.com/pointfreeco/swift-perception) in your
    project today to start making use of Swiftâ€™s amazing observation tools, even if
    you canâ€™t target the newest Apple platforms.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: ä»Šå¤©å°±åœ¨ä½ çš„é¡¹ç›®ä¸­å°è¯•ä½¿ç”¨[Perception](http://github.com/pointfreeco/swift-perception)ï¼Œå¼€å§‹åˆ©ç”¨
    Swift ä»¤äººæƒŠå¹çš„è§‚å¯Ÿå·¥å…·ï¼Œå³ä½¿ä½ æ— æ³•é¢å‘æœ€æ–°çš„è‹¹æœå¹³å°ã€‚
