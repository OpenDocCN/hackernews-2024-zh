<!--yml

类别：未分类

日期：2024-05-27 15:14:16

-->

# 长期重构 - Max Chernyak

> 来源：[https://max.engineer/long-term-refactors](https://max.engineer/long-term-refactors)

在繁忙的公司中进行大（或“长期”）重构是很困难的。要成功，我们必须：

+   说服业务，值得延迟。

+   决定哪些功能必须等待。

+   定期提供状态更新和预计完成时间。

+   在进行重构时进行合理的论证。这是否是正确的方法？

+   防止自己燃尽。

+   给团队留出时间来消化和审查巨大的差异。

+   解决 QA 问题的大量问题。

我们最好快点做完这一切，因为万一原始和重构的代码共存那就糟了！

这真的是唯一的方式吗？功能冻结，匆忙，一个错误满满的发布，很可能是燃尽？

## 另一种方式

我有一个理论，即长期重构之所以声名狼藉，是因为大多数情况下它们所需的时间比我们预期的要长得多。这种长度导致压力、一个笨拙的代码库、一个困惑的团队，通常没有尽头。相反，如果我们*准备好*一个有意识的长期重构会怎样呢？几年前，我开始尝试这种方法，结果出奇地成功：

+   我们不需要协商业务时间表。

+   我们不需要与业务优先事项竞争。

+   团队很快就理解并逐渐接管了重构。

+   没有增加压力和燃尽风险。

+   PR 很容易审查，没有巨大的差异。

+   整个团队一直在一致地、协作地重新评估重构。

+   我们从不浪费时间重构不需要的代码。

+   我们的功能开发仍然没有受阻。

+   团队扩展了他们的架构知识。

+   新工程师有很好的首个任务来源。

+   我们逐步推出了重构，使其更容易进行 QA，减少了错误。

长期重构从一开始就涉及整个团队，这是它们最强大的方面之一。到目前为止，我已经使用这种方法参与了 ~10 个大重构，跨越了 2 家公司的至少 3 个不同的团队，而且我还没有见过失败的情况。以下是我们的方法。

## 先决条件

要开始，你应该具备以下条件：

1.  具有对重构的愿景的经验丰富的软件工程师。

1.  由各种水平的软件工程师组成的团队。

1.  内部知识库。（可以是 Github Wiki、Notion、Confluence、Markdown 文件等）

1.  少于 ~5-10 个长期重构正在进行中，具体取决于它们的范围。

## 过程

几乎我遇到的每一个大重构都遵循一个半一致的模式。重构之所以变得庞大，是因为你必须多次应用该模式。在理想的世界里，这种工作是分工的。不幸的是，重构通常需要逐案决策。我提出的过程围绕着向同事解释重构的想法，以便他们也能做出决策。

注意：此过程适用于先决条件 #1 中的“有经验的工程师”。

1.  **识别应该重构的代码。**

1.  **识别重构模式。**

    探索代码库，识别出所需更改的常见模式。现在，只需粗略的想法就可以了。暂时忽略特殊情况，专注于共同点。

1.  **实施重构的示例。**

    找到您可以将粗略模式应用于的最小代表性样本，并对其进行重构。这是您要非常认真的地方。实验并彻底完善您的模式。不要吝啬最佳实践。遵循[4 reasons to leave a code comment](https://max.engineer/reasons-to-leave-comment)。传达[how, what, and why](https://max.engineer/maintainable-code)。把它做得最好，因为它将成为您团队的主要参考资料。提交合并请求。

1.  **为重构准备代码库。**

    现在您已经尝试了重构，并做出了决策，并克服了阻力，您对同事将要处理的情况有了一个概念。利用您的经验为他们铺平一条更平滑的道路。浏览代码库并进行小的准备工作：重排代码，填补空白，为清晰性重命名事物，解决模棱两可的地方，创建新的目录结构。保持您的更改较小。不要自己重构所有内容。分享工作的大部分是至关重要的。提交合并请求。

1.  **给您的重构起个名字。**

    为您的重构提供一个方便的名称，以供讨论和文档使用。确保名称简洁，清晰且描述性强。例如，“删除对 [package X] 的依赖”。 

1.  **撰写重构说明。**

    在您的内部知识库中创建一个文档，并以步骤 5 的名称命名它。一些建议：

    +   准确说明要做什么，以及如何做。简明扼要，具体。

        +   *不要讲故事*：“多年来，我们意识到我们一直在使用的方法…”

        +   *列出具体步骤*：“找到一个包含函数 X 的类。创建一个名为 Y 的新类。将函数 X 移动到类 Y 中。” 当然，步骤不能都是平淡的，但是要挑战自己，看看能多简洁和具体。

    +   从第 3 步中链接您的示例合并请求。人们应该看到代码的前后变化。

    +   最后，在文档末尾添加一些背景信息是可以的。在这里，您可以提供背景资料，讲故事，链接到相关资源和讨论。也就是说，将此部分隐藏在可展开的元素下，比如[<details>](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/details)。我们希望文档专注于模式本身，有必要时可以展开上下文。

1.  **将此次重构添加到长期重构列表中。**

    确保您的知识库中有一个页面列出所有长期重构。第 6 步的文档应添加到该列表中。

1.  **向您的团队介绍此次重构。**

    使用书面公告或会议。解释如何选择需要重构的块，引导他们通过你的示例。别忘了在步骤6中编写的说明。你的工程团队了解当前正在进行的每个长期重构是非常重要的。这就是为什么你希望一次只做几个，并适当地介绍每一个。添加一个新的长期重构应该是一件大事。

1.  **分配重构任务。**

    现在你的重构准备好随着时间逐渐进行了，但我建议不要在任务跟踪器中提前创建所有任务。这将破坏一个主要的好处——不浪费时间在不重要或即将删除的代码上。相反，创建任务应该是在规划过程中自然而然出现的。“嘿，既然你要更改那个，也许在那里删除对 X 包的依赖？”此外，我建议将整个大规模重构远离任务跟踪器，或者至少远离企业管理可以看到的区域。一个成功的长期重构应该由工程师来跟踪，而不是公司管理层。只要它写在知识库中，并且始终存在于工程师的头脑中，你就应该没问题。对于业务来说，重构是否完成，以及花费多长时间都不重要。

1.  **保持对长期重构的警觉。**

    让每位新加入团队的工程师都阅读第7步的列表。确保你的入职流程中包含这一步骤。这也是他们的第一个任务的绝佳来源，帮助他们了解现有代码和新方向。随时参考这个列表很容易（记住，列表必须保持简洁），但工程师在规划时也倾向于提醒彼此这些重构。

1.  **完成重构。**

    长期重构不需要100%完成。相反，有一天你会发现你的文档是多余的，因为代码库已经说明了问题。如果所有主要部分都被重构了，而且对你的方向没有更多的困惑，那么随时标记为已完成是可以的。这为下一个任务留下了空间。

仔细遵循这个过程后，我看到了一些令人惊奇的事情发生。团队养成了根据需要自我分配重构的习惯。当他们有问题时，他们会发起讨论和会议。这使得每个人在可能会引起争议的决定上达成了共识。随着每个完成的重构任务，我们都会在即将到来的任务中获得新的例子。

将其与独自工作数周或数月，并且用一大堆巨大的差异给团队一个闪电式袭击进行比较。

## 缺点

这是我能想到的一些。

+   尽管罕见，但有些大规模重构没有共同的模式。有可能你实际上正在处理不应该放在同一篮子里的多个重构。试着将它们拆分开来。

+   你需要耐心来完成这些重构。它们可能会持续一年、两年，谁知道呢。在这段时间里，旧代码和新代码将共存，并且如果第7步的列表不在每个人的心中，可能会引起一些混乱。我个人在实践中还没有遇到这个缺点，因为这个过程不断地让每个人保持一致。由于组织和沟通，没有人会对我们来自哪里以及我们将要去哪里感到困惑。

+   代码的某些部分可能永远不会被重构。这可能有一个很好的理由。可能是因为这部分现在很容易维护，不需要更改。或者也许这段代码已经快要被淘汰了。把它看作是一种胜利——你节省了时间，而且没有不必要地引入错误。

+   如果你喜欢一个人做所有事情，那就不适用这种方法。这种方法旨在让每个人都理解一致。你将不得不在解决方案上达成一致，并阐明你的推理。如果你不喜欢这样做，你就不会喜欢长期的重构。

试试看，然后告诉我进展如何！
