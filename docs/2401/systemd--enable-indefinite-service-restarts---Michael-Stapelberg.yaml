- en: <!--yml
  prefs: []
  type: TYPE_NORMAL
- en: 'category: 未分类'
  prefs: []
  type: TYPE_NORMAL
- en: 'date: 2024-05-27 14:53:34'
  prefs: []
  type: TYPE_NORMAL
- en: -->
  prefs: []
  type: TYPE_NORMAL
- en: 'systemd: enable indefinite service restarts - Michael Stapelberg'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 来源：[https://michael.stapelberg.ch/posts/2024-01-17-systemd-indefinite-service-restarts/](https://michael.stapelberg.ch/posts/2024-01-17-systemd-indefinite-service-restarts/)
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: When a service fails to start up enough times in a row, systemd gives up on
    it.
  prefs: []
  type: TYPE_NORMAL
- en: On servers, this isn’t what I want — in general it’s helpful for automated recovery
    if daemons are restarted indefinitely. As long as you don’t have circular dependencies
    between services, all your services will eventually come up after transient failures,
    without having to specify dependencies.
  prefs: []
  type: TYPE_NORMAL
- en: 'This is particularly useful because specifying dependencies on the systemd
    level introduces footguns: when interactively stopping individual services, systemd
    also stops the dependents. And then you need to remember to restart the dependent
    services later, which is easy to forget.'
  prefs: []
  type: TYPE_NORMAL
- en: Enabling indefinite restarts for a service
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'To make systemd restart a service indefinitely, I first like to create a drop-in
    config file like so:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: 'Then, I can enable the restart behavior for individual services like `prometheus-node-exporter`,
    without having to modify their `.service` files (which needs manual effort when
    updating):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: Changing the defaults for all services
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'If most of your services set `Restart=always` or `Restart=on-failure`, you
    can change the system-wide defaults for `RestartSec` and `StartLimitIntervalSec`
    like so:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: What do the default settings do?
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: So why do we need to change these settings to begin with?
  prefs: []
  type: TYPE_NORMAL
- en: 'The default systemd settings (as of systemd 255) are:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: This means that services which specify `Restart=always` are restarted 100ms
    after they crash, and if the service crashes more than 5 times in 10 seconds,
    systemd does not attempt to restart the service anymore.
  prefs: []
  type: TYPE_NORMAL
- en: 'It’s easy to see that for a service which takes, say, 100ms to crash, for example
    because it can’t bind on its listening IP address, this means:'
  prefs: []
  type: TYPE_NORMAL
- en: '| time | event |'
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  prefs: []
  type: TYPE_TB
- en: '| T+0 | first start |'
  prefs: []
  type: TYPE_TB
- en: '| T+100ms | first crash |'
  prefs: []
  type: TYPE_TB
- en: '| T+200ms | second start |'
  prefs: []
  type: TYPE_TB
- en: '| T+300ms | second crash |'
  prefs: []
  type: TYPE_TB
- en: '| T+400ms | third start |'
  prefs: []
  type: TYPE_TB
- en: '| T+500ms | third crash |'
  prefs: []
  type: TYPE_TB
- en: '| T+600ms | fourth start |'
  prefs: []
  type: TYPE_TB
- en: '| T+700ms | fourth crash |'
  prefs: []
  type: TYPE_TB
- en: '| T+800ms | fifth start |'
  prefs: []
  type: TYPE_TB
- en: '| T+900ms | fifth crash within 10s |'
  prefs: []
  type: TYPE_TB
- en: '| T+1s | systemd gives up |'
  prefs: []
  type: TYPE_TB
- en: Why does systemd give up by default?
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: I’m not sure. If I had to speculate, I would guess the developers wanted to
    prevent laptops running out of battery too quickly because one CPU core is permanently
    busy just restarting some service that’s crashing in a tight loop.
  prefs: []
  type: TYPE_NORMAL
- en: 'That same goal could be achieved with a more relaxed `DefaultRestartSec=` value,
    though: With `DefaultRestartSec=5s`, for example, we would sufficiently space
    out these crashes over time.'
  prefs: []
  type: TYPE_NORMAL
- en: There is [some recent discussion upstream](https://github.com/systemd/systemd/issues/30804)
    regarding changing the default. Let’s see where the discussion goes.
  prefs: []
  type: TYPE_NORMAL
- en: I run a blog since 2005, spreading knowledge and experience for almost 20 years!
    :)
  prefs: []
  type: TYPE_NORMAL
- en: If you want to support my work, you can [buy me a coffee](https://www.buymeacoffee.com/stapelberg).
  prefs: []
  type: TYPE_NORMAL
- en: Thank you for your support! ❤️
  prefs: []
  type: TYPE_NORMAL
