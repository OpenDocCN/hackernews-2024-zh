<!--yml

类别：未分类

日期：2024-05-27 15:05:47

-->

# 应用兼容性探险：从无处跳入指令中间的案例 - 旧的新东西

> 来源：[`devblogs.microsoft.com/oldnewthing/20230324-00/?p=107966`](https://devblogs.microsoft.com/oldnewthing/20230324-00/?p=107966)

# 应用兼容性探险：从无处跳入指令中间的案例

一个特定的 Windows Insider 构建发布后发生了 Explorer 崩溃的激增。崩溃看起来像这样：

```
explorer!SomeRandomInternalFunction+0x7d4:
00007ffe`27b00720 006639          add     byte ptr [rsi+39h],ah ds:00000000`0000003a=??

```

这很可能是一个无意义的指令。显然没有明显的理由添加部分上位寄存器。

看起来这要么是一个损坏的指令指针，要么是损坏的代码，因为第一个代码字节是可疑的零。而且由于第二个字节是 `66h`，看起来是一个偏移量错误，因为 `66h` 不是一个不寻常的初始指令字节。（这是操作数大小覆盖前缀。）另一个线索是，未显示的调用函数没有理由调用 `Some­Random­Internal­Function` 函数，事实上，检查所谓的调用者，它确实没有调用它。

在指令周围进行反汇编显示指令指针确实在指令中间：

```
00007ffe`27b0071c b820000000      mov     eax,20h
00007ffe`27b00721 6639853e020000  cmp     word ptr [rbp+23Eh],ax

```

指令指针比实际指令的起始位置小一个，导致前一条指令的立即数末尾的零字节被错误地解释为要执行的指令的起始位置。

我们是怎么在指令中间结束的呢？

我对我们收到的所有崩溃转储进行了批量分析，并观察到其中一个第三方 DLL 在所有崩溃转储中都是共同存在的。进一步的调查显示，这个第三方 DLL 是一个“Shell Enhancement”程序的一部分。该程序对 Explorer 进行补丁以完成其增强功能，显然其中一个补丁出了问题。

这里有趣的是程序如何决定在哪里安装其补丁，特别是它如何成功地对一个从未导出或存储在 vtable 中的函数进行补丁：它通过联系 Microsoft 符号服务器来获取 Explorer 中所有函数的名称和地址！

发生的情况是，我们最近对这个内部函数进行了更改，显然这些更改足以导致打补丁程序失控。不幸的是，这种情况经常发生：每当新的构建发布时，Explorer 崩溃的数量就会激增，因为所有这些打补丁程序开始打错代码，而安装了这些“Shell Enhancement”程序的所有系统上的 Explorer 都开始崩溃。如果你真的很不走运，它们的异常补丁可能会导致 Explorer 启动路径中的某个地方崩溃，用户发现自己因为 Explorer 崩溃而陷入无法使用的机器循环中。

这个问题在每月安全补丁上尤为严重，因为我们无法撤销修复。那样会使系统暴露于月度安全更新旨在解决的安全问题中。（而现在修复已经发布，所有坏人都已经反向工程了安全问题，可能正在努力将其武器化并利用未修补的系统。）我们必须希望足够多的用户意识到他们的系统崩溃是因为“外壳增强”程序（而不是归咎于 Windows 本身，这更有可能），并卸载或禁用这些程序以使系统重新正常工作。不幸的是，这些修补程序还会在每次更新发布时导致 Windows 客户满意度数字暴跌，特别是在那些不知道问题是由他们精通计算机的侄子为他们安装的程序引起的用户中。
