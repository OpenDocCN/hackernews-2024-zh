<!--yml

category: 未分类

date: 2024-05-27 14:44:12

-->

# 弄清楚谁离开了公司：转储、对比、重复

> 来源：[https://rachelbythebay.com/w/2024/02/08/ldap/](https://rachelbythebay.com/w/2024/02/08/ldap/)

## 弄清楚谁离开了公司：转储、对比、重复

我工作过的大公司的一个共同特点是，它们通常有一种目录服务，用来跟踪谁是员工，谁不是。通过定期转储列表，然后与上一次转储进行比较，你可以学到一些有趣的事情。

一个公司将这个整合到一个名为"墓志"的内部服务中，当一个人"从LDAP中消失"后，一两天后会出现一个条目，意味着他们离开了公司。然后其他仍在公司工作的人可以添加评论，比如"回学校了"，"搬到爱达荷州养羊"，这类的事情。

这带来了一个有趣的副作用，你无法自己写自己的"墓志铭"，因为根据定义，你必须已经离开公司才能有你的页面存在。必须有其他知道你的人来添加。我实际上曾收到过一封电子邮件："我要离开了，所以当它出现时，请添加XYZ。"他们信任我去做这件事，几天后，我按要求粘贴了进去。

另一个我工作过的地方并没有类似的东西。有一个"内部档案"，你可以看到某某在公司工作从<date>到<date>，但没有任何周期性更新的机制。我决定自己动手来做这件事。实际上，并没有花费多少精力。在我的开发服务器上（一个物理机器，位于数据中心，可以访问我的主目录），设置了一个定时任务，每天醒来几次，将整个列表转储到一个文件中。然后它会将其与上次的列表进行比较，精简成只有uid（Unix账户名）字段，并将结果追加到日志文件中。

随着时间的推移，其他人也了解了这件事，并且因为我把它设置成了全员可读，他们可以通过"tail -f <path>"来持续关注，有时候会出现一些令人惊讶的事情。有些人有时会突然消失。其他时候，发生了一些奇怪的事情，这些事情增加了一些背景信息。

日志条目看起来是这样的：

```
Thu Feb 08 18:26:42 PST 2024 : uid: <someone>

```

这已经足够让你深挖并找出更多信息，如果你真的关心为什么那个特定的人不再在那里工作。否则，它不会用无用的数据淹没你。

有一次，我把这样一行粘贴到IRC频道中，然后<某人>出现并说："是的，我不在这里工作了。"原来他们的账户已被停用，但他们仍然保持连接。当我提到他们的账户名时，他们收到通知，转到那个窗口并回复。我们有几分钟时间进行了交流。

以这种方式向某人告别感觉很奇怪。通常，电子通信的联系早已被切断。我想这里发生的事情是IRC服务器只在连接时检查认证，然后没有任何操作去确保会话仍与当前员工关联。（这是一个有点难的问题。）

另一次，某位经理类型的人说，他们要因为某种“愚蠢的经理事情”而迟到开会。果然，会议开始没几分钟，屏幕上滚动显示了他们直属下属账户停用的消息。显然，他们得参加那种要把某人送走的人事会议。

我想说，最好开始做这种事情的时机是在你加入一家公司的时候，或者那家公司变得足够大以至于实际上有LDAP或其他技术支持的时候。这意味着第二好的时机就是今天。

顺便说一下，“comm”工具非常适合这种事情。

```
comm -2 -3 <(grep ^uid: old | sort) <(grep ^uid: new | sort)

```

... 然后你就会明白了。

现在，这种事情并不完美。如果你没有发现错误，第一次未能转储并且将完整列表与空列表进行差异比较，看起来就好像每个人都离开了。这不是你想要的结果。此外，一旦你在一个足够大的公司工作，总会有一些自动化失控的时候，“解雇”每个人，[并且每个账户都会被停用。](/w/2019/11/01/gb/) 如果你在那里待得足够久，这种情况将不止一次发生。

顺便说一句，如果有人因为你做这种事情而生气，你可能本来就不想在那里工作。另一方面，如果你能在没有IT或类似部门“威胁”的情况下构建这样的工具，那么你可能在一个真正喜欢创造有趣和有用东西的地方。珍惜这样的地方，它们往往不会持久。
