<!--yml

类别：未分类

日期：2024-05-27 14:52:21

-->

# 通过缓存投毒进行的远程用户冒充和接管

> 来源：[https://arcanican.is/excerpts/cve-2024-23832/discovery.htm](https://arcanican.is/excerpts/cve-2024-23832/discovery.htm)

可查看原始报告（和最初发送的电子邮件）[在这里](/excerpts/cve-2024-23832/)

Mastodon团队现在公开的详细信息可在[此处](https://github.com/mastodon/mastodon/security/advisories/GHSA-3fjr-858r-92rw)找到

我想写一些关于：

+   更广泛生态系统的现状

+   我发现了更多脆弱/短视的代码，来自另一种类型的库

+   关于HTTP签名及其关联用户密钥对的可笑虚伪实施的强烈看法（[用户甚至不能导出他们的私钥](https://github.com/mastodon/mastodon/discussions/22315#discussioncomment-4423581)，因为*网络*的风险，以前）

+   一些实际的解决方案可以在多种方式上最小化这一问题，这些都可以作为一个[在一夜之间编写的工作原型](https://arcanican.is/tools/proof.php)开始。

..但是我没时间了，也许明天（或者技术上的“今天”）再处理其中一些。

尽管如此：这不是要说“联合宇宙糟糕，它完全有缺陷”，而更多是一个问题：

+   尽管有大量可选择的选项（或者创建更好/更多的选项），人们仍然涌向一个软件。

+   当一个软件可以无障碍地朝着任何方向推进时（因为市场份额），这就是一个生态系统的本质，当其“在一个供应商的封闭门后”（至少据我了解如此），远离实际标准机构和社区组织的努力时，这将如何阻碍谨慎协议开发的进展

+   人们似乎只关心免费软件的“gratis”部分，很少关心“libre”，数百万用户主要依赖几个开发者的工作，假设他们有足够的专注力来自己发现每一个错误

最后：这是根据我的视角和对事物的理解编写的；可能存在错误和其他观点，如果有的话，我很乐意按要求进行更正。

## 发现

*警告：这篇大部分内容都是针对协议及其术语有一定理解的人写的。有关代码示例，请查看[原始提交的报告](/excerpts/cve-2024-23832/)。*

在一个非常晚的夜晚（1月26日）进入第二天的早晨（约5点），当我在自己的联合宇宙服务器实现上工作时，我对攻击我的项目的理论攻击有了一些过境的想法。通常情况下，我会在另一份文档中记录笔记，或者将它们作为代码的内联注释写下来，以便稍后回来进行更彻底的测试和分析。尽管如此，我想到的是实现是否确实对手动拉取的帖子进行验证，概念上跳过了HTTP签名等。

我模拟了一个简单的Note对象，将其设置为一个不同域的可解析的actor，确保主机名也匹配，保存为文本文件，并确保它以正确的媒体类型提供。我的实现已经像一个活跃软件和静态站点生成器的组合一样运行，所以只需把文本文件倒入“posts”目录中。

然后我尝试在Mastodon中查询URL，纯粹出于愚蠢的好奇心，怀疑根本不会发生任何事情。我最多期望的是，也许——最多——它只会显示错误的用户名，或者交换头像，如果有的话。但它奏效了。而且效果太好了。事实上，它运行得如此之好，以至于帖子甚至似乎永久地存储在数据库中，并会显示在被冒名顶替的用户的帖子历史中。

但这肯定不可能是正确的，这肯定只是我的开发环境——我自己的封闭本地实验室，其中安装了几个fediverse应用程序，使用自己的私有本地TLD和自定义证书颁发机构等。也许是某种逻辑因为从192.168.x.x子网而被抛弃，或者在运行生产配置的情况下更加宽松。

由于我自己没有任何公共Mastodon实例上的账户，而我在fedi上唯一的账户是我管理的Rebased实例上的账户：我请朋友用他们所在的Mastodon实例再次检查这种现象。我在个人网站上创建了简单的载荷，给他们链接，结果立即一样。效果太好了。

因此，我给Mastodon列出的安全报告电子邮件地址写了一封简短的电子邮件。我描述了我发现的行为，即可以注入远程用户的帖子，实现方法简单，并附上了它奏效的截图。此时，我的眼睛主要盯着我的收件箱，期待大约10-30分钟后可能会收到什么。此时是本地时间早上7:06（美国中部时间），相当于欧洲中部时间下午2:06，所以平均核心Mastodon开发人员肯定会看到这封电子邮件。

但我并没有永久地盯着我的收件箱，而是不断在中间摆弄这个漏洞。我对我的实例进行了测试：没有效果；我对Misskey进行了测试：没有效果。但后来我继续检查我的列表，发现实验室安装的其他软件也存在类似的漏洞。真是个大问题…

我向相关开发者发送了一条直接消息（通过fedi），警告他们我发现了他们软件中的一个漏洞，但我需要一个安全的媒介来传输信息，并询问他们的偏好。与此同时，对于Mastodon，我尝试在mastodon.social上查询一两个开发者，但出于某种原因，我仍然无法加载来自mastodon.social的任何个人资料更新或帖子，就像几个月来一直如此[[脚注1]](#footnote-1)。鉴于环绕fediblock的不懈的众愚和取消文化，以及人们盲目地重新循环使用封锁列表，如果我的实例被mastodon.social和其他实例完全封锁，这一点也不奇怪，尤其是当它通常被误认为是单用户实例时（通常会在不通知的情况下悄悄封锁或隐藏）。

在我的私人fedi实验室中，我进一步探索这个漏洞，并发现它也适用于角色（用户/个人资料），正如我首次尝试调整个人简介描述以轻松成功一样。然后我尝试调整其他字段，但有几个事情被拒绝了。我还尝试交换角色的收件箱和共享收件箱终点，这些变更似乎都能很好地接受。在此背景下，这是一个黑盒子：我只知道它是否接受了负载，如果可见细节发生了变化，因为我在每个负载中更改个人资料/简介等。为了测试我的理论是否正确，我在我的fedi服务器实现中写了一个快速的虚拟收件箱脚本，将其绑定到请求调试器以捕获响应，并确保它编码为始终返回202 Accepted响应代码。

从我的私人fedi实验室中的开发Mastodon实例，我向远程受害用户发送了一条直接消息（理论上应该已经从之前覆盖了他们的收件箱地址），然后...在*[攻击者控制的]*虚拟收件箱中毫无问题地捕获到了它，内容如预期地是直接消息的内容。这在这一点上简直令人难以置信。这太可怕了---对于一个据称服务于200到800万用户的软件，像这样的事情竟然就这样掉进了我的手里，这一切仅仅因为一个刹那间的想法闯入了我的脑海，我想要解决一个问题。

好吧，这能变得更糟吗？我们控制了入站公共内容的注入，我们可以控制流量的出站位置，但我们能否更轻松地完成，并且可能替换掉我们没有私钥的那个令人讨厌的公钥？

嗯，我理解的是每个角色只能有一个公钥，因此已经提出了其他表示密钥方式的扩展（特别是多个密钥），但也许还有其他我可以尝试的东西。我能否只将值作为密钥列表而不是直接一个对象？于是我用方括号包装了publicKey对象，它似乎接受了。然后我尝试在该列表中添加另一个publicKey对象。它接受了（正如这些测试过程中更新个人资料字段的例程所示），但它是否真的保存了第二个键？

在我的软件项目中，我创建了一个脚本，使用我的现有HTTP签名签名实现，输入对应于我尝试注入的公钥的私钥，然后尝试看看是否可以伪造使用我试图注入的密钥的S2S流量，以查看是否被接受。但是，制作的签名请求被拒绝了。

嗯，由于我记得在Mastodon中每个角色只存储一个公钥，也许它只存储第一个键？但也有可能：显然它仍然需要旧的键，否则它会拒绝更改，所以也许可以将其列为第二个键？于是我交换了公钥的顺序：它接受了。事实上，我在第二次尝试中尝试省略旧的键，它也接受了。等等---它需要的只是旧键的*存在*来暗示密钥轮换，而不需要实际签名认可？嗯，我不知道，这可能只是个例外。

尽管如此，我还是用之前写的脚本再次尝试刺探它，试图使用攻击者控制的密钥伪造S2S流量…

...而且那也行得通…

...？

怎么做？

这一系列的发现看起来根本不能成立。我并不经常进行渗透测试、审计、安全研究等工作。我只是一个普通的自学网页开发者，只知道我应该做的基本事情：验证/清理不受信任的输入，验证/清理查询的内容，使用预编译的SQL语句，使用CSRF令牌在表单中，使用密码哈希算法来存储密码等等。我没有任何学位，只有高中文凭。

然而，Mozilla为Mastodon代码库支付了正式的安全审计费用，却错过了这一点，而这正好落到我手上。太好了，我更加厌恶“安全咨询”行业的典型性质，仿佛一切只是围绕着模糊器和扫描器四处奔波，如果没有什么问题就算了。根本不是人们真正费心分析和实验协议，玩弄理论攻击之类的事情；只是将其视为另一个通用企业软件项目。

我的意思是，该死的：有一个超过60,000注册用户（和超过15,000月活跃用户）的大型Mastodon实例，它自己标榜为一个安全研究人员社区（或者更确切地说是“关注安全”的社区），运行在Mastodon上，但这些人中没有一个愿意深入尝试他们在线社交媒体存在和身份的一部分依赖的代码库？一个漏洞，甚至可能已经存在多年？难道没有人发现运行一个1.5GB安装大小的平台，以及预计跨Ruby、gems、npm等数百（可能会扩展到数千）的依赖项是令人担忧的吗？现在有：一年内3个严重性>9.8的漏洞，7.5的3个漏洞，以及其他4个漏洞。

我们真的应该处于这种单一文化中吗？在这种文化中，1个漏洞就可能对超过72%的网络造成严重破坏，因为每个人都想聚集在“现在所有人都在使用的东西”周围？尽管有各种功能丰富且在功能和性能上都非常竞争的选择可供选择？

记住：Pleroma和Misskey在我发现的情况下没有受到任何影响，而Mastodon受到了影响，这只是一个简单的概念，并非一些漫长的战略性的利用链。即使在Lemmy中私信泄漏漏洞至少需要一些智慧（对不属于您的私信进行报告），而这并不需要。

重申一下，我发现：

+   您可以注入一篇帖子，归因于任何远程用户。

+   您可以覆盖服务器上任何远程用户的副本。

+   您可以通过列出另一个密钥重新设定服务器上任何远程用户的副本。

最重要的细节在于：如果认证用户的密钥不再被信任（在我的实验室中，我已经确认了这一点），那么远程用户的任何真实流量也将被拒绝，而攻击者则保留控制发送S2S流量，使用他们控制的密钥对。而且这不仅仅限于与其他Mastodon服务器的通信，而是来自网络上任何远程用户的视角，对于一个易受攻击的Mastodon实例而言。这就是将其从9.1严重性提升到9.8的原因。未来流量的机密性受到了损害，完整性受到了影响，可用性被削弱。

所以除了深入研究这一混合体，看着我的收件箱却什么也没有收到之外，最终我在早上9点左右终于睡着了（这是非常不寻常的），在前述发现的某个中间点。

在接下来的日循环中，我已经收到了另一个已识别软件的开发人员的回复（事实上，几小时内就收到了他们在9:12am时回复的DM），并跟进了细节。与此同时，依然没有任何 Mastodon 的开发人员回复，即使发送了3封电子邮件，即使我已经检查了交付能力、DKIM、DMARC 等所有内容。因此，由于在 mastodon.social 上联系任何人的问题，我尝试在另一个服务器上的不同 Mastodon 开发人员账户上直接发送私信。这一天的最后，我总结了所有的发现，而且越来越不耐烦。我询问其他人是否可以代表我联系，或者是否可以接触到他们更近的联系人，但没有听到任何有用的回复。

两个日循环过去（技术上总共2天；现在只是被炸了的睡眠时间表），但仍然没有任何进展。因此，这时我详细记录了我的发现（尽管最初的发现已经足够，但考虑到这件事情的升级程度，以及他们根本不回复，我不想在电子邮件中泄露剩余部分），列出了我发现的一切，用简单的概念和截图提交了 Github 安全报告。再次，我的眼睛大部分时间都紧盯着屏幕，希望看到任何动静，同时我还在应付其他事情，*试图*在处理这个烫手山芋的同时做一些有生产力的事情。

然后，***终于***，在1月29日深夜（凌晨2:34），我收到了回复，报告被接受，他们能够重现问题，并且正在进一步处理，请求CVE编号，并要求保密，因为问题的严重性。我表示同意。我提到我发现了另一个具有类似漏洞的项目，我也在与他们进行沟通，他们同意，只要大家在补丁发布之前保持沉默。

由于问题的严重性以及实现的简易性，即将发布的安全报告的措辞必须被最小化，因此必须将其减少到更模糊的细节，否则人们可能会自己重新发现其中的任何部分。已经确定了发布时间表，发布了公告，并且私下进行了修复测试。

与此同时，我还联系了另一个项目的开发人员，想要确认一下他们的项目是否也受到影响，但在细节上保持了模糊。对一些具体情况进行了挖掘，经过简短的源代码审查，看起来他们的项目可能也受到影响，仅限于注入帖子，最终他们也为他们的项目准备了一个补丁。因此，从理论上讲，现在有3个受影响的产品，但与 Mastodon 相关的情况最糟糕。

修复猛犸象补丁的日子来了，网络中相当一部分在一两天内升级了；而我还戳了那些尚未更新的相邻实例管理员。安全公告随着补丁发布，指出漏洞的深层细节将于2月15日后逐步揭示，以避免使攻击者更容易入侵，所以我保持了对细节的保密。与此同时，我继续测试其他联邦软件，发现了第四个受影响的产品，并通知了开发者，在那里也解决了问题。

此时，这一切即将结束，我想要再次核实负责披露期的确切时间结束，并且是否有任何报告奖励，如果有的话——在哪个平台上。但是，我得到的回复是没有足够的资源来支付赏金制度。好吧。好吧。我想我只能把过去一两周被这个发现搁置，以及帮助其他较小项目，完全视为一次慈善行动了。并不是我反对帮助他人，因为我经常试图用助人为乐的方式耗费我的钱包。

* * *

*(希望我今天/明天能写更多)*
