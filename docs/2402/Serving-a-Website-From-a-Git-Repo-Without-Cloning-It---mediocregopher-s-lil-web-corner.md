<!--yml

类别：未分类

日期：2024-05-27 15:00:54

-->

# 从Git Repo提供网站而无需克隆 - mediocregopher的小小网络角落

> 来源：[https://mediocregopher.com/posts/git-proxy](https://mediocregopher.com/posts/git-proxy)

```
                .%*.                                                        .-.
               .%@@@+.                                                .--=%@@@-
               =@@@@@@-                                         :--+@@@@@@@@@*
               *@%@@@@@%:                               :--=#@@@@@@@@@@@@#@@+
               @@::%@@@@@@-:                   :::-=%@@@@@@@@@@@@@@%#*-  :@*
              .@@   =@@@@@@@@@+-:::::::-=*@@@@@@@@@@@@@@@@@@@%##-        @@:
              #@#     +%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%#*:              -@@
              #@-        *%@@@@@@@@@@@@@@@@@%%%#=                       %@=
              @@:             -=+++==     ..                            @@:
              @@        .               -@@@                           +@@
             #@%     =@@@@-            +@@@@#              *+          %@#
             #@-   -@@@@@@@.          +@@@@@%           .%@@@@=        @@:
             @@:  +@@@@@@@@@         +@+ +@@@         %@@@@@@@@@      -@@
             @@  *@%@*  :@@@        *@+  -@@@       %@@@@@@@@@@@#     @@@
            #@% %@ @%    %@@       *@*   .@@@     =@@@*@@   :@@@@     @@:
            %@:## *@+    :@@      :@@     @@@    %@@: @#     .@@@    .@@
            @@:.  @@:    .@@      @@      @@@   %@:  @@       @@%    @@%
            @@   -@@.    =@@     @@.      @@@  %@.  #@-       @@#    @@.
           %@%   +@@.    @@.    %@-       @@@ #@    @@.      :@@    -@@
           %@:   +@@+   .@%    #@=        @@@.@    *@@       +@+    @@*
           @@:   +@@%. .%%    *@+         @@@      %@@      -@#     @@
           @@    :@@@@@@%    :@@          @@%      %@@      @#     *@@
          %@@     #@@@@*     @@           @@%      %@@.    %@.     @@:
          @@:      ===:     @@.           @@%      %@@:  =@%.     .@@
          @@.              #@=            @@%      %@@%+%@#.      @@%
          @@              +@*             @@#      -@@@@@*       .@@
         %@@             :@@              @@#       %@@#:        =@@
         @@:            .@@               @@#        :           @@=
         @@.            @@.               @@#                   :@@
         @@            #@=                @@%                   %@%
        #@@           +@+                 #@%                  .@@
        @@:          =@#                  +@%                  =@%
        @@          :@%                   -@@                  @@+
        @@         .@@                    -@:                 -@@
       -@@         @%                     .:                  *@#
       @@*         #                                          @@.
       @@                                                    =@@
      .@@                                                    @@*
      .@@                                                   .@@
      *@@                                                   =@#
      @@*                                                   @@*
      @@                                                   -@@
     .@@                                                   +@*
     .@@                                                   @@-
     -@@                                                  =@@
     %@%                                                  #@*
     @@                                                   @@:
     @@                                                  +@@
    .@@                                                  %@+
    :@%                                                  @@.
    :@%                                                 *@%
    -@.                                                 %@=
    %@                                                  @@.
    @@                                                 *@%
    @@                                                 %@=
    @%                                                 @@:
   :@%                                                +@@
   :@*                =+-                             #@+
   :@:              .%@@@.                            @@-
   -@              =@@@@@#                           :@@
   =@             *@#.=@@%                           #@%
   *@            #@-  -@@%                           %@-
   @@           #@:   :@@%                           @@:
   @@          #%     .@@%               .#@@*      -@@
   @%         #%      .@@%              +@@@@@-     %@%
   @#        %@       :@@%            .@@@@@@@@     %@:
   @#       %@        :@@%           +@@% .@@@@     @@:
   @#      %@         :@@%          #@@:   :@@@    -@@
   @#     @@.         .@@@        .@@%     .@@@=   %@%
   @#    @@.          .@@@:      %@@-       @@@%   %@:
   @#   @@             @@@@    %@@@         *@@@   @@:
   @# .@@              @@@@@@@@@@=          :@@@   @@
   * @@@               :@@@@@@@@.           :@@@  *@@
.@@@@@%                 -@@@@@.             .@@@  @@=
@@@@@:                    ..                 @@@  @@.
-@%:                                         @@@  @@.
                                             @@@  @@
                                             -@@ =@@
                                             .@@ @@+
                                             .@@:@@.
                                              @@#@-
                                              @@@.
                                              +@-
                                               -

```

**mediocregopher**的小小网络角落

[主页](/)  //  [文章](/posts/)  /  [关注](/follow)  /  [RSS](/feed.xml)  //  [源码](https://dev.mediocregopher.com/mediocre-blog/)  /  [许可证](/static/wtfpl.txt)

# 从Git Repo提供网站而无需克隆

* * *

使用git存储库作为提供网站的工具是相当常见的。Webdev将更改推送到公共git存储库的某个分支，然后某个web服务器在某个地方将该分支的当前指向作为网站提供。Github Pages将是其中最著名的例子。

domani反向代理也支持从git存储库提供网站。以前是通过自动在本地克隆存储库，并定期拉取更改来实现的。这样工作得足够好，但我觉得可以进一步简化，以便除所需分支的当前哈希以外不需要任何本地状态。本文将首先通过git的内部来解释如何实现这一点。

[Domani](https://code.betamike.com/micropelago/domani)

## Git分支：它们是什么？

首先要了解的是git分支到底是什么；它们是一种“ref”（引用）。Git标签是引用的另一种类型。引用不过是一个指向对象哈希的名称，很可能是提交哈希。甚至在没有git工具的情况下，您也可以轻松查看git项目的引用。例如，`main`分支的当前指向可以在`.git/refs/heads/main`文件中找到：

```
# cat .git/refs/heads/main 
3651fd0f0cb8d2a0dd62b1ab096db5e1c23dde3a 
```

Ref文件，因此分支文件，只是包含单个对象哈希的纯文本文件。当分支的当前指向发生更改时，在文件系统上唯一真正发生的变化是更改其引用文件的内容。在其核心，git实际上是一个相当简单的工具。

## Git对象：朋友还是敌人？ 

我们已经确定了git分支通过该对象的哈希指向一个git对象，但这到底意味着什么？

有四种git对象：blob、tree、commit和tag。无论对象的种类如何，都存储在名为`.git/objects`的目录中的对象SHA1的文件中。对象总是使用zlib进行压缩存储，但使用的是它们的未压缩形式进行哈希计算。

此示例计算了前面示例指向的对象的哈希。您可以看到输出的SHA1与对象的文件名相同（前两个字符用作目录名，否则`objects`目录会变得太大）。请注意使用`pigz -d`进行zlib解压缩。

```
# cat .git/objects/36/51fd0f0cb8d2a0dd62b1ab096db5e1c23dde3a | pigz -d | sha1sum 
3651fd0f0cb8d2a0dd62b1ab096db5e1c23dde3a  - 
```

一个git提交对象的主体多多少少是纯文本，除了一个空字节用于分隔头字符串和对象内容，所以我们可以直接查看它：

```
# cat .git/objects/36/51fd0f0cb8d2a0dd62b1ab096db5e1c23dde3a | pigz -d | tr '\0' '\n'
commit 264
tree 15b9b5c79989caee0ee45748e699c470b934ebc5
parent 498a33533f1a1cf00639e99cabcc11c25c330fd7
author Brian Picciano <me@mediocregopher.com> 1708196552 +0100
committer Brian Picciano <me@mediocregopher.com> 1708196552 +0100

Remove full gix project as a dependency 
```

如从标题中所见，问题中的对象是一个提交（但我们已知道这一点）。`264`表示标题后文件剩余部分的大小。跟随`264`的将是一个空字节，但是空字节已被`tr '\0' '\n'`替换为换行符。

文件的大部分其余内容应该是熟悉的。列出了作者以及组成文件尾部的提交描述。父提交引用了链中前一个提交的对象哈希。除非你之前已经深入研究过git的内部，否则树可能不太熟悉，但它对于我们的目的来说是最有趣的部分。

与git通常向其用户展示提交的方式相反，git提交实际上并不包含从先前状态到当前存储库状态的差异。每个提交都包含对一个树的引用，其中每个树都完整描述了存储库文件在该提交时的状态。当您执行像`git show`这样的操作时看到的是实时生成的前后树之间的差异。

正如提到的，树本身是另一种git对象，因此像提交一样被引用和查询。让我们来看看我们提交的树：

```
# cat .git/objects/15/b9b5c79989caee0ee45748e699c470b934ebc5 | pigz -d | tr '\0' '\n'
tree 535
100644 .gitignore
�_���/�j���jS$��
                �100644 Cargo.lock
��"��AJ���?��100644 Cargo.toml

...(plus more garbage) 
```

哎呀，看起来树并不像提交那样简单。幸运的是，git附带了一个方便的工具`cat-file`，用于直接查看对象并漂亮打印其内容：

```
# git cat-file -p 15b9b5c79989caee0ee45748e699c470b934ebc5
100644 blob a45fb6cad22fb76a9ae0e3bb6a5324a90f800cf2    .gitignore
100644 blob 771896770dfaf8227fb0e1414ae5a5edd43fe6fc    Cargo.lock
100644 blob 8e3a31cf00a4a91661adc400afaf7c1d2abe5e39    Cargo.toml
100644 blob be3f7b28e564e7dd05eaf59d64adba1a4065ac0e    LICENSE.txt
100644 blob 0a39e5d12a2040e764b13924dd1955a61d10ff5f    README.md
100644 blob d161f2e1298586fd01e000cad6788f01e8ec446e    config-dev.yml.tpl
100644 blob 9dcb733174c2b7a8842062eeeeb204efb4f6d5b4    config.yml
100644 blob 39bacff615979221b0d50c43eca260b647f6fdd1    default.nix
100644 blob 0ce9e7605a533667693385bbee6fadacbad4a242    flake.lock
100644 blob 26134bf04deed36bcd3e61a24eb01f44cbdd405f    flake.nix
100644 blob e01adca51af5f42b438f0ff184070a7eebe32241    rust-toolchain.toml
100644 blob 77db547fb0079adc2f160af8f0ff50acfae98157    shell.nix
040000 tree 7dca9943ec53acb19678ac753b5ea6b8ae9b07aa    src
040000 tree df6d134b7c8ad6638a14db1d0e23b6686e34680e    static 
```

好多了。我们可以看到树包含一个条目列表，每个条目表示一个文件（blob）或子目录（tree），以及文件/子目录的权限和名称。查看`static`子目录对象的内容时，我们发现又一个树：

```
# git cat-file -p df6d134b7c8ad6638a14db1d0e23b6686e34680e
100644 blob 3417794e08925a6a8164297575430f3a67a24c98    foo.gmi
100644 blob 96a73f5d009a32c50b3980117907808d51076082    foo.html
100644 blob a10841a0b027398ed8ebd79f3d81f7146f7613ad    index.gmi
100644 blob a4317bb1bf03636bf7c3ce1c22942e98576ad922    index.html
100644 blob e67581f93fbdcf2157773ea4b3e8cdb47810c172    penguin.jpg
040000 tree ad8bbea913647a1392cb3073259cc2638516c4c1    subdir 
```

从中我们可以看出git树是如何用来描述存储库的全部内容的，只需一个单一的哈希。如果存储库中的任何文件发生更改，那么其相关的blob对象的哈希将发生变化，这将改变其所在树中的相关条目，进而改变树对象的哈希，这将改变树的父目录中的条目，依此类推。变化向上传播到根树对象及其哈希。然后将此哈希存储在提交中，这使得每个提交能够轻松表示整个存储库的状态。

（使用递归哈希树来唯一标识任意大量层次数据的这种模式称为默克尔树。）

不管怎样，让我们看看实际内容：我们如何查看文件本身？每个文件存储为一个blob对象。让我们来查看我们上一个示例中找到的`foo.html` blob：

```
# cat .git/objects/34/17794e08925a6a8164297575430f3a67a24c98 | pigz -d | tr '\0' '\n'
blob 19
# FOO

This is foo 
```

Blob对象与提交对象类似，易于解析；只需一个标题，一个空字节，然后是文件内容。

这就是git对象的全部内容（忽略标签，今天我们不需要它们）。掌握了这些知识，我们可以继续朝着我们的最终目标前进。

## 远程存储库

当克隆git存储库时，您可能做过类似的操作：

```
git clone https://code.betamike.com/micropelago/domani.git 
```

然后git进行了一些神奇的操作，之后仓库就完全在本地克隆了。但是你的git工具是如何做到的，仅仅给出了一个URL？

答案是：这很复杂。实际上，git可能会通过两种不同的协议来克隆一个仓库：智能协议和哑协议。智能协议速度很快，但需要一个专门的HTTP客户端才能工作。哑协议比智能协议慢，但不需要一个特殊的HTTP客户端；它只是按原样提供文件，没有任何特殊的逻辑。

我们将使用哑协议。

让我们回到开始，记住我们的真正目标：我们想要使用git仓库的内容来提供一个网站，特别是要使用git仓库的特定分支的最新内容。为了做到这一点，我们需要知道该分支当前指向的提交是哪个。我们可以通过发出一个简单的GET请求来发现这个：

```
# curl -sS 'https://code.betamike.com/micropelago/domani.git/info/refs'
3651fd0f0cb8d2a0dd62b1ab096db5e1c23dde3a        refs/heads/main 
```

这个仓库只有一个分支（没有标签），所以只返回了一行。你看，它的提交哈希值与我们本地副本中看到的一样！现在让我们查询该提交对象，看一下一般情况下如何查询对象：

```
# curl -sS 'https://code.betamike.com/micropelago/domani.git/objects/36/51fd0f0cb8d2a0dd62b1ab096db5e1c23dde3a' | pigz -d | tr '\0' '\n'
commit 264
tree 15b9b5c79989caee0ee45748e699c470b934ebc5
parent 498a33533f1a1cf00639e99cabcc11c25c330fd7
author Brian Picciano <me@mediocregopher.com> 1708196552 +0100
committer Brian Picciano <me@mediocregopher.com> 1708196552 +0100

Remove full gix project as a dependency 
```

你可以看到对象以与本地存储的方式完全相同的方式返回。没有什么意外。虽然树在没有`git cat-file`工具（对于远程对象不起作用）的情况下难以查看，但blob仍然很容易：

```
# curl -sS 'https://code.betamike.com/micropelago/domani.git/objects/34/17794e08925a6a8164297575430f3a67a24c98' | pigz -d | tr '\0' '\n'
blob 19
# FOO

This is foo 
```

它的工作原理与本地git仓库完全一样。

## 将所有内容整合在一起

考虑到所有这一切，我的特殊反向代理如何处理对`/static/foo.html`的请求呢？首先，它需要向仓库服务器查询提交（使用`/info/refs`），然后获取提交对象以提取根树哈希，然后获取根树对象。

从那里，服务器需要查看根树对象，并检查是否看到了一个叫做`static`的树条目，并获取其树对象。服务器然后需要检查`static`的树对象是否有一个叫做`foo.html`的blob条目，最后它会获取这个blob，并将其内容返回作为原始请求的响应（在剥离git对象头之后）。

这听起来像是为了提供单个文件而进行了很多步骤，但有两个关键的优化可以实现。首先是在内存中缓存根树的哈希值，这样可以跳过最开始的两次查找。只有当分支的最新提交发生变化时，根树的哈希值才会改变，所以将其缓存在内存中，并有一个单独的后台进程定期重新检查最新提交即可。

第二个优化是使用它们的哈希作为键在内存中缓存树对象。由哈希标识的对象永远不会改变，所以这个缓存很容易管理，通过在内存中缓存树对象（如果内存使用是一个问题，可以使用LRU缓存），所有到远程服务器的往返都可以消除，除了最后一个往返用于文件本身。

如果你想看一个关于这个想法的实现示例，可以查看我为 Domani 编写的 rust 实现：

[git.rs](https://code.betamike.com/micropelago/domani/src/commit/e416a766682af3b78538854da09eee62baaf3762/src/origin/git.rs)

请注意，我能够利用出色的 gix crate 来帮助我解码 git 对象。如果你选择的编程语言没有可用的 git 对象解析库，你就必须手动解析这些对象，但老实说，这并不应该太难。

最后，这里是使用这种技术提供的一个示例网站：

[链接](https://test.domani.micropelago.net/)

就是这样！即使这是一个相当小众的用例，并且并没有改变世界，我希望你仍然觉得它对理解 git 的内部机制有所帮助，并且可能会作为你自己想要滥用 git 进行有趣实验的一个起点。

*发布于 2024-02-17*

* * *

该网站也可以通过**gemini 协议**访问：[gemini://mediocregopher.com/](gemini://mediocregopher.com/)

[什么是 gemini?](/posts/gemspace-tour)
