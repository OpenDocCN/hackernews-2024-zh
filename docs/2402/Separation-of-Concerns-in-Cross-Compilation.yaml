- en: <!--yml
  id: totrans-split-0
  prefs: []
  type: TYPE_NORMAL
- en: 'category: æœªåˆ†ç±»'
  id: totrans-split-1
  prefs: []
  type: TYPE_NORMAL
- en: 'date: 2024-05-27 14:28:33'
  id: totrans-split-2
  prefs: []
  type: TYPE_NORMAL
- en: -->
  id: totrans-split-3
  prefs: []
  type: TYPE_NORMAL
- en: Separation of Concerns in Cross-Compilation
  id: totrans-split-4
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: æ¥æºï¼š[https://nixcademy.com/2024/01/30/cross-compilation-with-nix/](https://nixcademy.com/2024/01/30/cross-compilation-with-nix/)
  id: totrans-split-5
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: Separation of Concerns in Cross-Compilation
  id: totrans-split-6
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '![title image of blog post \](img/6473a66ae1d8e85f6512f9ae6f1f520d.png)'
  id: totrans-split-7
  prefs: []
  type: TYPE_IMG
- en: ğŸ“†
  id: totrans-split-8
  prefs: []
  type: TYPE_NORMAL
- en: January 30, 2024 by Jacek Galowicz
  id: totrans-split-9
  prefs: []
  type: TYPE_NORMAL
- en: Managing complex C++ projects across multiple platforms often ends up being
    a frustrating and time-consuming task. However, this common challenge faced also
    by the most experienced software developers doesnâ€™t have to be an inevitable struggle.
    Imagine a world where cross-compilation is not just feasible, but also efficient
    and less cumbersome. I have noticed in several past friendly discussions with
    other engineers that many are not at all familiar with the type of Separation
    of Concerns that Nix didnâ€™t invent but also uses.
  id: totrans-split-10
  prefs: []
  type: TYPE_NORMAL
- en: 'The earlier article [*C++ with Nix in 2023, Part 2: Package Generation and
    Cross-Compilation*](../../../../2023/11/16/cpp-with-nix-in-2023-part-2-package/)
    concentrated more on the creation of a new package from scratch and explaining
    `mkDerivation` etc., while in this article, weâ€™re going to look from a little
    bit higher level at how cross-compilation is handled so elegantly in Nix, that
    it can improve overall project health and development pace and at the same time
    reduce costs.'
  id: totrans-split-11
  prefs: []
  type: TYPE_NORMAL
- en: What makes Cross-Compilation Hard?
  id: totrans-split-12
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Cross-compilation should in general not be hard: We just need a compiler whose
    backend generates code for the target architecture and let it link the compiled
    code against libraries that are also compiled for that target architecture.'
  id: totrans-split-13
  prefs: []
  type: TYPE_NORMAL
- en: So why does it turn out to be hard whenever itâ€™s being done for huge real-life
    projects?
  id: totrans-split-14
  prefs: []
  type: TYPE_NORMAL
- en: 'It typically goes downhill in steps that have less to do with cross-compilation
    itself but more with managing dependencies:'
  id: totrans-split-15
  prefs: []
  type: TYPE_NORMAL
- en: '**Product**: We assume a project that is already huge and has a complicated
    build system'
  id: totrans-split-16
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Cross-compiler**: We need one'
  id: totrans-split-17
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**External libraries**: We need cross-compiled variants of them'
  id: totrans-split-18
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Distribution**: If we use shared libraries, we will need to provide a way
    to package those along with the app. Alternatively, we use static linking to get
    one big binary thatâ€™s easier to distribute.'
  id: totrans-split-19
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The steps are then:'
  id: totrans-split-20
  prefs: []
  type: TYPE_NORMAL
- en: 'The cross-compiler is now obtained in one of two ways:'
  id: totrans-split-21
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Someone creates a compiler bootstrap script that aims to be Linux-distro independent.
    This script will go into a [Dockerfile](https://docs.docker.com/engine/reference/builder/)
    or right into the build system.
  id: totrans-split-22
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: A cross-compiler package is used. As this ties the project to a certain package
    distribution, we are now forced to this distro or use Docker.
  id: totrans-split-23
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: 'The package manager doesnâ€™t let us install native and foreign-target libraries
    on the same system. And developers also use different package managers. So we
    typically end up building external libraries for the target platform ourselves:'
  id: totrans-split-24
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: These go into the same Docker image.
  id: totrans-split-25
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: Or the project build system also builds them for us.
  id: totrans-split-26
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: æˆ–è€…é¡¹ç›®æ„å»ºç³»ç»Ÿä¹Ÿä¸ºæˆ‘ä»¬æ„å»ºå®ƒä»¬ã€‚
- en: As we do not have package distribution infrastructure, we typically go the static
    building route and end up also fiddling static linkage into our project build
    system.
  id: totrans-split-27
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: ç”±äºæˆ‘ä»¬æ²¡æœ‰åŒ…åˆ†å‘åŸºç¡€è®¾æ–½ï¼Œé€šå¸¸æˆ‘ä»¬é€‰æ‹©é™æ€æ„å»ºè·¯å¾„ï¼Œå¹¶æœ€ç»ˆå°†é™æ€é“¾æ¥è°ƒæ•´åˆ°æˆ‘ä»¬çš„é¡¹ç›®æ„å»ºç³»ç»Ÿä¸­ã€‚
- en: 'The result is then one of these two:'
  id: totrans-split-28
  prefs: []
  type: TYPE_NORMAL
  zh: ç»“æœæ˜¯è¿™ä¸¤ç§ä¹‹ä¸€ï¼š
- en: A huge, complicated, monolithic build system that manages not only the build
    of our actual project, but also the build of the compiler and all the libraries.
  id: totrans-split-29
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: ä¸€ä¸ªå·¨å¤§ã€å¤æ‚çš„ã€å•ç‰‡å¼çš„æ„å»ºç³»ç»Ÿï¼Œä¸ä»…ç®¡ç†æˆ‘ä»¬å®é™…é¡¹ç›®çš„æ„å»ºï¼Œè¿˜ç®¡ç†ç¼–è¯‘å™¨å’Œæ‰€æœ‰åº“çš„æ„å»ºã€‚
- en: Itâ€™s painful to set up and the code takes forever to compile.
  id: totrans-split-30
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: å®‰è£…èµ·æ¥å¾ˆç—›è‹¦ï¼Œè€Œä¸”ç¼–è¯‘ä»£ç éœ€è¦å¾ˆé•¿æ—¶é—´ã€‚
- en: Only senior developers are allowed to touch the fragile parts.
  id: totrans-split-31
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: åªæœ‰é«˜çº§å¼€å‘äººå‘˜è¢«å…è®¸è§¦åŠè„†å¼±éƒ¨åˆ†ã€‚
- en: Complicated upgrading.
  id: totrans-split-32
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: å¤æ‚çš„å‡çº§ã€‚
- en: A Docker image that nicely abstracts the parts away that are different from
    normal non-cross-compilation.
  id: totrans-split-33
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: ä¸€ä¸ªDockeré•œåƒï¼Œå¾ˆå¥½åœ°å°†ä¸æ™®é€šéäº¤å‰ç¼–è¯‘ä¸åŒçš„éƒ¨åˆ†æŠ½è±¡å‡ºæ¥ã€‚
- en: Variant *B* seems to be the cleanest, but a clean execution of it seems to be
    rare in the industry. At least in my experience, development teams end up creating
    a huge pile of complexity in the form of Variant *A*.
  id: totrans-split-34
  prefs: []
  type: TYPE_NORMAL
  zh: å˜ä½“*B*çœ‹èµ·æ¥æœ€æ¸…æ™°ï¼Œä½†åœ¨è¡Œä¸šä¸­å¾ˆå°‘è§åˆ°å…¶å¹²å‡€çš„æ‰§è¡Œã€‚è‡³å°‘åœ¨æˆ‘çš„ç»éªŒä¸­ï¼Œå¼€å‘å›¢é˜Ÿæœ€ç»ˆä¼šåˆ›å»ºå¤§é‡çš„å¤æ‚æ€§ï¼Œå½¢æˆå˜ä½“*A*çš„å½¢å¼ã€‚
- en: Especially in combination with static linking, developers often decide that
    the build system should only build static binaries, because maintaining both dynamic
    and static linking at the same time makes the build system too complex.
  id: totrans-split-35
  prefs: []
  type: TYPE_NORMAL
  zh: ç‰¹åˆ«æ˜¯åœ¨ä¸é™æ€é“¾æ¥ç»“åˆä½¿ç”¨æ—¶ï¼Œå¼€å‘äººå‘˜ç»å¸¸å†³å®šæ„å»ºç³»ç»Ÿä»…æ„å»ºé™æ€äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå› ä¸ºåŒæ—¶ç»´æŠ¤åŠ¨æ€å’Œé™æ€é“¾æ¥ä¼šä½¿æ„å»ºç³»ç»Ÿè¿‡äºå¤æ‚ã€‚
- en: '[CMake](https://cmake.org/) and [meson](https://mesonbuild.com/) can generally
    both be used correctly to keep the project description agnostic of the linking
    method and then simply select the method with command line parameters. However,
    I have not seen many big commercial real-life projects where this was still possible
    without much hassle.'
  id: totrans-split-36
  prefs: []
  type: TYPE_NORMAL
  zh: '[CMake](https://cmake.org/) å’Œ [meson](https://mesonbuild.com/) é€šå¸¸éƒ½å¯ä»¥æ­£ç¡®ä½¿ç”¨ï¼Œä½¿é¡¹ç›®æè¿°ä¸é“¾æ¥æ–¹æ³•æ— å…³ï¼Œç„¶åé€šè¿‡å‘½ä»¤è¡Œå‚æ•°ç®€å•é€‰æ‹©æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œæˆ‘æ²¡æœ‰çœ‹åˆ°å¾ˆå¤šå¤§å‹å•†ä¸šå®é™…é¡¹ç›®åœ¨ä¸å¸¦æ¥å¤ªå¤šéº»çƒ¦çš„æƒ…å†µä¸‹ä»ç„¶å¯èƒ½ä½¿ç”¨è¿™ç§æ–¹æ³•ã€‚'
- en: 'I often asked myself â€œWhy do these build systems do everything completely differently
    than suggested in the official documentation and tutorials of the build systems?â€
    With my experience of today, I think the answer is simple:'
  id: totrans-split-37
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ç»å¸¸é—®è‡ªå·±ï¼šâ€œä¸ºä»€ä¹ˆè¿™äº›æ„å»ºç³»ç»Ÿå®Œå…¨ä¸æŒ‰ç…§å®˜æ–¹æ–‡æ¡£å’Œæ•™ç¨‹ä¸­å»ºè®®çš„æ–¹å¼æ“ä½œï¼Ÿâ€ æ ¹æ®æˆ‘ä»Šå¤©çš„ç»éªŒï¼Œæˆ‘è®¤ä¸ºç­”æ¡ˆå¾ˆç®€å•ï¼š
- en: Separation of Concerns.
  id: totrans-split-38
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: å…³æ³¨ç‚¹åˆ†ç¦»ã€‚
- en: '**Build systems are not designed to manage dependencies.** Not knowing it better,
    developers try to do it anyway. The result is hard to change, extend, maintain,
    and upgrade.'
  id: totrans-split-39
  prefs: []
  type: TYPE_NORMAL
  zh: '**æ„å»ºç³»ç»Ÿå¹¶éè®¾è®¡ç”¨äºç®¡ç†ä¾èµ–å…³ç³»ã€‚** ä¸æ˜ç™½æƒ…å†µçš„æƒ…å†µä¸‹ï¼Œå¼€å‘äººå‘˜ä»è¯•å›¾è¿™æ ·åšã€‚ç»“æœæ˜¯éš¾ä»¥æ›´æ”¹ã€æ‰©å±•ã€ç»´æŠ¤å’Œå‡çº§ã€‚'
- en: As promised in the introduction, we will have a look at how Nix makes it easy
    to change this for the better.
  id: totrans-split-40
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚å‰è¨€æ‰€è¿°ï¼Œæˆ‘ä»¬å°†çœ‹çœ‹Nixå¦‚ä½•ä½¿è¿™ä¸€åˆ‡å˜å¾—æ›´å¥½ã€‚
- en: The Example App
  id: totrans-split-41
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: ç¤ºä¾‹åº”ç”¨
- en: Letâ€™s build an example app that depends on [OpenSSL](https://www.openssl.org/)
    and [Boost](https://www.boost.org/) at run-time. It simply reads a character stream
    from standard input and uses OpenSSL to calculate the [SHA256](https://en.wikipedia.org/wiki/SHA-2)
    hash. We use the boost dependency to stop the time - the [C++ STL](https://en.cppreference.com/w/cpp/chrono)
    could have done that for us, too, but then we wouldnâ€™t have another nice dependency
    on a huge external lib.
  id: totrans-split-42
  prefs: []
  type: TYPE_NORMAL
  zh: è®©æˆ‘ä»¬æ„å»ºä¸€ä¸ªç¤ºä¾‹åº”ç”¨ç¨‹åºï¼Œå®ƒåœ¨è¿è¡Œæ—¶ä¾èµ–äº[OpenSSL](https://www.openssl.org/)å’Œ[Boost](https://www.boost.org/)ã€‚å®ƒç®€å•åœ°ä»æ ‡å‡†è¾“å…¥è¯»å–å­—ç¬¦æµï¼Œå¹¶ä½¿ç”¨OpenSSLè®¡ç®—[SHA256](https://en.wikipedia.org/wiki/SHA-2)å“ˆå¸Œå€¼ã€‚æˆ‘ä»¬ä½¿ç”¨boostä¾èµ–æ¥åœæ­¢æ—¶é—´
    - [C++ STL](https://en.cppreference.com/w/cpp/chrono)ä¹Ÿå¯ä»¥ä¸ºæˆ‘ä»¬åšåˆ°è¿™ä¸€ç‚¹ï¼Œä½†é‚£æ ·æˆ‘ä»¬å°±ä¸ä¼šå¯¹ä¸€ä¸ªå·¨å¤§çš„å¤–éƒ¨åº“æœ‰å¦ä¸€ä¸ªå¾ˆå¥½çš„ä¾èµ–ã€‚
- en: 'The program is roughly 60 LOC short/long. I uploaded the code to this GitHub
    repository: [https://github.com/tfc/cpp-cross-compilation-example](https://github.com/tfc/cpp-cross-compilation-example)'
  id: totrans-split-43
  prefs: []
  type: TYPE_NORMAL
  zh: ç¨‹åºå¤§çº¦æœ‰60è¡ŒLOCï¼ˆæºä»£ç è¡Œæ•°ï¼‰ã€‚æˆ‘å°†ä»£ç ä¸Šä¼ åˆ°GitHubä»“åº“ï¼š[https://github.com/tfc/cpp-cross-compilation-example](https://github.com/tfc/cpp-cross-compilation-example)
- en: 'Letâ€™s call this app `minisha256sum` and write a [`CMakeLists.txt`](https://cmake.org/)
    file for it:'
  id: totrans-split-44
  prefs: []
  type: TYPE_NORMAL
  zh: è®©æˆ‘ä»¬ç§°è¿™ä¸ªåº”ç”¨ä¸º`minisha256sum`ï¼Œå¹¶ä¸ºå®ƒç¼–å†™ä¸€ä¸ª[`CMakeLists.txt`](https://cmake.org/)æ–‡ä»¶ï¼š
- en: '[PRE0]'
  id: totrans-split-45
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: CMake provides good [standard facilities for finding external libraries](https://cmake.org/cmake/help/latest/command/find_package.html).
    This way, the build system may remain simple (it still looks relatively noisy
    compared to other language ecosystems because thatâ€™s how C++ build systems look
    like).
  id: totrans-split-46
  prefs: []
  type: TYPE_NORMAL
  zh: CMakeä¸ºæŸ¥æ‰¾å¤–éƒ¨åº“æä¾›äº†å¾ˆå¥½çš„[æ ‡å‡†è®¾æ–½](https://cmake.org/cmake/help/latest/command/find_package.html)ã€‚è¿™ç§æ–¹å¼ä½¿å¾—æ„å»ºç³»ç»Ÿå¯èƒ½ä¿æŒç®€å•ï¼ˆå®ƒçœ‹èµ·æ¥ä»ç„¶ç›¸å¯¹äºå…¶ä»–è¯­è¨€ç”Ÿæ€ç³»ç»Ÿæ¥è¯´æœ‰äº›å˜ˆæ‚ï¼Œå› ä¸ºè¿™å°±æ˜¯C++æ„å»ºç³»ç»Ÿçš„å¤–è§‚ï¼‰ã€‚
- en: 'This project can now be built via the typical CMake dance:'
  id: totrans-split-47
  prefs: []
  type: TYPE_NORMAL
  zh: ç°åœ¨å¯ä»¥é€šè¿‡å…¸å‹çš„CMakeæ­¥éª¤æ„å»ºæ­¤é¡¹ç›®ï¼š
- en: '[PRE1]'
  id: totrans-split-48
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Letâ€™s check if it works:'
  id: totrans-split-49
  prefs: []
  type: TYPE_NORMAL
  zh: è®©æˆ‘ä»¬æ¥æ£€æŸ¥å®ƒæ˜¯å¦å·¥ä½œï¼š
- en: '[PRE2]'
  id: totrans-split-50
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: It provides the same hash as the [`sha256sum` app from GNU `coreutils`](https://www.gnu.org/software/coreutils/),
    which should be good enough. The app is not really optimized but that will not
    be a matter for the rest of this article.
  id: totrans-split-51
  prefs: []
  type: TYPE_NORMAL
  zh: å®ƒæä¾›ä¸æ¥è‡ªGNU `coreutils`çš„[`sha256sum`åº”ç”¨ç¨‹åº](https://www.gnu.org/software/coreutils/)ç›¸åŒçš„å“ˆå¸Œå€¼ï¼Œè¿™åº”è¯¥è¶³å¤Ÿå¥½äº†ã€‚è¯¥åº”ç”¨ç¨‹åºå¹¶éçœŸæ­£ä¼˜åŒ–ï¼Œä½†å¯¹äºæœ¬æ–‡çš„å…¶ä½™éƒ¨åˆ†å¹¶ä¸é‡è¦ã€‚
- en: Packaging it with Nix
  id: totrans-split-52
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: ä½¿ç”¨Nixæ‰“åŒ…
- en: 'To get a nice `nix build` and `nix run` workflow, we need to provide a few
    nix expressions. Letâ€™s start with a `package.nix` that already reflects our dependency
    structure:'
  id: totrans-split-53
  prefs: []
  type: TYPE_NORMAL
  zh: è¦è·å¾—è‰¯å¥½çš„`nix build`å’Œ`nix run`å·¥ä½œæµç¨‹ï¼Œæˆ‘ä»¬éœ€è¦æä¾›ä¸€äº›Nixè¡¨è¾¾å¼ã€‚è®©æˆ‘ä»¬ä»ä¸€ä¸ªå·²ç»åæ˜ äº†æˆ‘ä»¬ä¾èµ–ç»“æ„çš„`package.nix`å¼€å§‹ï¼š
- en: '[PRE3]'
  id: totrans-split-54
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'When cross-compiling this application, we need:'
  id: totrans-split-55
  prefs: []
  type: TYPE_NORMAL
  zh: å½“è·¨å¹³å°ç¼–è¯‘æ­¤åº”ç”¨ç¨‹åºæ—¶ï¼Œæˆ‘ä»¬éœ€è¦ï¼š
- en: A compiler that runs on the build host but compiles for the target
  id: totrans-split-56
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: åœ¨æ„å»ºä¸»æœºä¸Šè¿è¡Œä½†ä¸ºç›®æ ‡å¹³å°ç¼–è¯‘çš„ç¼–è¯‘å™¨
- en: CMake which runs on the host
  id: totrans-split-57
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: åœ¨ä¸»æœºä¸Šè¿è¡Œçš„CMake
- en: Boost and OpenSSL, but built for the target
  id: totrans-split-58
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Boostå’ŒOpenSSLï¼Œä½†æ„å»ºä¸ºç›®æ ‡
- en: '`nativeBuildInputs` means *â€œcompile-time dependency on the building hostâ€*
    and `buildInputs` means *â€œrun-time dependency on the targetâ€*. The [`nixpkgs`
    documentation describes this in more detail](https://nixos.org/manual/nixpkgs/stable/#ssec-stdenv-dependencies).'
  id: totrans-split-59
  prefs: []
  type: TYPE_NORMAL
  zh: '`nativeBuildInputs`æ„å‘³ç€*â€œåœ¨æ„å»ºä¸»æœºä¸Šçš„ç¼–è¯‘æ—¶ä¾èµ–é¡¹â€*ï¼Œè€Œ`buildInputs`æ„å‘³ç€*â€œç›®æ ‡è¿è¡Œæ—¶ä¾èµ–é¡¹â€*ã€‚[`nixpkgs`æ–‡æ¡£åœ¨è¿™æ–¹é¢æœ‰æ›´è¯¦ç»†çš„æè¿°](https://nixos.org/manual/nixpkgs/stable/#ssec-stdenv-dependencies)ã€‚'
- en: 'To create a buildable, installable, and runnable package from this expression,
    we need to apply the `callPackage` function which is a [well-known pattern in
    the Nix sphere](https://nixos.org/guides/nix-pills/callpackage-design-pattern):
    It automatically fills out all the function parameters from whatâ€™s available in
    `pkgs` that we can see in the first line of `package.nix`, which happen to be
    our dependencies.'
  id: totrans-split-60
  prefs: []
  type: TYPE_NORMAL
  zh: è¦ä»æ­¤è¡¨è¾¾å¼åˆ›å»ºå¯æ„å»ºã€å¯å®‰è£…å’Œå¯è¿è¡Œçš„è½¯ä»¶åŒ…ï¼Œæˆ‘ä»¬éœ€è¦åº”ç”¨`callPackage`å‡½æ•°ï¼Œè¿™æ˜¯[Nixé¢†åŸŸä¸­çš„ä¸€ç§ä¼—æ‰€å‘¨çŸ¥çš„æ¨¡å¼](https://nixos.org/guides/nix-pills/callpackage-design-pattern)ï¼šå®ƒä¼šè‡ªåŠ¨ä»æˆ‘ä»¬åœ¨`package.nix`ç¬¬ä¸€è¡Œä¸­å¯ä»¥çœ‹åˆ°çš„`pkgs`ä¸­å¡«å……æ‰€æœ‰å‡½æ•°å‚æ•°ï¼Œè¿™äº›å‚æ•°ç¢°å·§æ˜¯æˆ‘ä»¬çš„ä¾èµ–é¡¹ã€‚
- en: '[PRE4]'
  id: totrans-split-61
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'In the projectâ€™s `flake.nix` file, we [make this call in this line](https://github.com/tfc/cpp-cross-compilation-example/blob/main/flake.nix#L14).
    With this in place, we can now run it without handling the build commands manually
    (Iâ€™m not hiding code here: `mkDerivation` generally knows how to build CMake projects
    when CMake was mentioned as a dependency). After pushing it to a repository, we
    can even do this from a different computer without cloning the repo first:'
  id: totrans-split-62
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨é¡¹ç›®çš„`flake.nix`æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬[åœ¨è¿™ä¸€è¡Œè¿›è¡Œæ­¤è°ƒç”¨](https://github.com/tfc/cpp-cross-compilation-example/blob/main/flake.nix#L14)ã€‚æœ‰äº†è¿™ä¸ªè®¾ç½®ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥åœ¨ä¸æ‰‹åŠ¨å¤„ç†æ„å»ºå‘½ä»¤çš„æƒ…å†µä¸‹è¿è¡Œå®ƒï¼ˆæˆ‘è¿™é‡Œæ²¡æœ‰éšè—ä»£ç ï¼š`mkDerivation`é€šå¸¸çŸ¥é“å¦‚ä½•åœ¨æåˆ°CMakeä½œä¸ºä¾èµ–é¡¹æ—¶æ„å»ºCMakeé¡¹ç›®ï¼‰ã€‚å°†å…¶æ¨é€åˆ°å­˜å‚¨åº“åï¼Œæˆ‘ä»¬ç”šè‡³å¯ä»¥ä»ä¸åŒçš„è®¡ç®—æœºä¸Šè¿›è¡Œæ­¤æ“ä½œï¼Œè€Œæ— éœ€å…ˆå…‹éš†å­˜å‚¨åº“ï¼š
- en: '[PRE5]'
  id: totrans-split-63
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: Cross-Compilation
  id: totrans-split-64
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: è·¨ç¼–è¯‘
- en: 'This is a quick one:'
  id: totrans-split-65
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™æ˜¯ä¸€ä¸ªå¿«é€Ÿçš„æ–¹æ³•ï¼š
- en: 'Assuming, weâ€™re on a 64bit Intel PC, we can create multiple static/dynamic
    cross-compiled packages like this:'
  id: totrans-split-66
  prefs: []
  type: TYPE_NORMAL
  zh: å‡è®¾æˆ‘ä»¬åœ¨64ä½è‹±ç‰¹å°”PCä¸Šï¼Œæˆ‘ä»¬å¯ä»¥åƒè¿™æ ·åˆ›å»ºå¤šä¸ªé™æ€/åŠ¨æ€äº¤å‰ç¼–è¯‘çš„è½¯ä»¶åŒ…ï¼š
- en: '[PRE6]'
  id: totrans-split-67
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: The attributes `pkgs.pkgsStatic` and `pkgs.pkgsCross.aarch64-multiplatform`
    contain their own version of `callPackage`, but they come with the whole `pkgs`
    package list adapted for the selected target platform.
  id: totrans-split-68
  prefs: []
  type: TYPE_NORMAL
  zh: å±æ€§`pkgs.pkgsStatic`å’Œ`pkgs.pkgsCross.aarch64-multiplatform`åŒ…å«å®ƒä»¬è‡ªå·±ç‰ˆæœ¬çš„`callPackage`ï¼Œä½†å®ƒä»¬é™„å¸¦äº†é’ˆå¯¹æ‰€é€‰ç›®æ ‡å¹³å°è°ƒæ•´è¿‡çš„æ•´ä¸ª`pkgs`è½¯ä»¶åŒ…åˆ—è¡¨ã€‚
- en: Thereâ€™s also `pkgs.pkgsCross.mingwW64`, which compiles binaries for [Microsoft
    Windows](https://en.wikipedia.org/wiki/Microsoft_Windows) using the [minimalist
    GNU environment for Windows `mingw`](https://www.mingw-w64.org/).
  id: totrans-split-69
  prefs: []
  type: TYPE_NORMAL
  zh: è¿˜æœ‰`pkgs.pkgsCross.mingwW64`ï¼Œå®ƒä½¿ç”¨[minimalist GNUç¯å¢ƒ for Windows `mingw`](https://www.mingw-w64.org/)ä¸º[Microsoft
    Windows](https://en.wikipedia.org/wiki/Microsoft_Windows)ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶ã€‚
- en: 'Whenever we use one of those specialized `callPackage` implementations to call
    our `package.nix` function, this happens:'
  id: totrans-split-70
  prefs: []
  type: TYPE_NORMAL
  zh: æ¯å½“æˆ‘ä»¬ä½¿ç”¨è¿™äº›ä¸“é—¨çš„`callPackage`å®ç°ä¹‹ä¸€æ¥è°ƒç”¨æˆ‘ä»¬çš„`package.nix`å‡½æ•°æ—¶ï¼Œå°±ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µï¼š
- en: '![pkgs.callPackage can dissect the different kinds of dependencies](img/463b6e0a3b2c467ff9bcc92f2b2532b9.png)'
  id: totrans-split-71
  prefs: []
  type: TYPE_IMG
  zh: '![pkgs.callPackageå¯ä»¥åˆ†æä¸åŒç±»å‹çš„ä¾èµ–å…³ç³»](img/463b6e0a3b2c467ff9bcc92f2b2532b9.png)'
- en: '`pkgs.callPackage` can dissect the different kinds of dependencies'
  id: totrans-split-72
  prefs: []
  type: TYPE_NORMAL
  zh: '`pkgs.callPackage`å¯ä»¥åˆ†æä¸åŒç±»å‹çš„ä¾èµ–é¡¹'
- en: Because we structurally split the dependencies between compile-time dependencies
    and run-time dependencies, the cross-`callPackage` function can now fill the package
    dependencies with the right versions of each.
  id: totrans-split-73
  prefs: []
  type: TYPE_NORMAL
  zh: å› ä¸ºæˆ‘ä»¬åœ¨ç¼–è¯‘æ—¶ä¾èµ–å’Œè¿è¡Œæ—¶ä¾èµ–ä¹‹é—´è¿›è¡Œäº†ç»“æ„åŒ–åˆ†ç¦»ï¼Œäº¤å‰`callPackage`å‡½æ•°ç°åœ¨å¯ä»¥å¡«å……æ¯ä¸ªåŒ…ä¾èµ–é¡¹çš„æ­£ç¡®ç‰ˆæœ¬ã€‚
- en: 'This way, the build system does not need to be educated a lot about what happens:
    Nix creates the correct build environment for the given package variant (similar
    to the approach with the clean Docker image, but only with exactly the needed
    dependencies and with less overhead for defining it), the build system simply
    uses the given compiler and locates the given dependencies via CMake/meson-specific
    environment variables (that have been set by Nix), and builds the project. (It
    also works with build system combinations like [GNU Automake/Autoconf](https://www.gnu.org/software/automake/)
    and [GNUMake](https://www.gnu.org/software/make/) and others)'
  id: totrans-split-74
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™æ ·ï¼Œæ„å»ºç³»ç»Ÿä¸éœ€è¦è¿‡å¤šäº†è§£å‘ç”Ÿäº†ä»€ä¹ˆï¼šNixä¸ºç»™å®šçš„åŒ…å˜ä½“åˆ›å»ºæ­£ç¡®çš„æ„å»ºç¯å¢ƒï¼ˆç±»ä¼¼äºå¹²å‡€çš„Dockeré•œåƒçš„æ–¹æ³•ï¼Œä½†åªæœ‰ç¡®å®éœ€è¦çš„ä¾èµ–é¡¹ï¼Œå¹¶ä¸”åœ¨å®šä¹‰æ—¶å…·æœ‰æ›´å°‘çš„å¼€é”€ï¼‰ï¼Œæ„å»ºç³»ç»Ÿç®€å•åœ°ä½¿ç”¨ç»™å®šçš„ç¼–è¯‘å™¨å¹¶é€šè¿‡CMake/mesonç‰¹å®šçš„ç¯å¢ƒå˜é‡ï¼ˆç”±Nixè®¾ç½®ï¼‰å®šä½ç»™å®šçš„ä¾èµ–é¡¹ï¼Œå¹¶æ„å»ºé¡¹ç›®ã€‚
    ï¼ˆå®ƒä¹Ÿé€‚ç”¨äºç±»ä¼¼äº[GNU Automake/Autoconf](https://www.gnu.org/software/automake/)å’Œ[GNUMake](https://www.gnu.org/software/make/)ç­‰çš„æ„å»ºç³»ç»Ÿç»„åˆï¼‰
- en: 'I tested this example with the following combinations:'
  id: totrans-split-75
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ä½¿ç”¨ä»¥ä¸‹ç»„åˆæµ‹è¯•äº†è¿™ä¸ªä¾‹å­ï¼š
- en: '| `x86_64-linux` | âœ… | âœ… | âŒ | âŒ | âœ… |'
  id: totrans-split-76
  prefs: []
  type: TYPE_TB
  zh: '| `x86_64-linux` | âœ… | âœ… | âŒ | âŒ | âœ… |'
- en: '| `aarch64-linux` | âœ… | âœ… | âŒ | âŒ | âœ… |'
  id: totrans-split-77
  prefs: []
  type: TYPE_TB
  zh: '| `aarch64-linux` | âœ… | âœ… | âŒ | âŒ | âœ… |'
- en: '| `x86_64-darwin` | âœ… | âœ… | âœ… | âŒ | âœ… |'
  id: totrans-split-78
  prefs: []
  type: TYPE_TB
  zh: '| `x86_64-darwin` | âœ… | âœ… | âœ… | âŒ | âœ… |'
- en: '| `aarch64-darwin` | âœ… | âœ… | âœ… | âœ… | âœ… |'
  id: totrans-split-79
  prefs: []
  type: TYPE_TB
  zh: '| `aarch64-darwin` | âœ… | âœ… | âœ… | âœ… | âœ… |'
- en: Interestingly, if we â€œcross-compileâ€ from the same architecture to the same
    architecture on Linux, we get exactly the same package like for the native `pkgs.callPackage`
    version, so Nix doesnâ€™t even bother to rebuild it.
  id: totrans-split-80
  prefs: []
  type: TYPE_NORMAL
  zh: æœ‰è¶£çš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬åœ¨Linuxä¸Šä»ç›¸åŒæ¶æ„äº¤å‰ç¼–è¯‘åˆ°ç›¸åŒæ¶æ„ï¼Œæˆ‘ä»¬å¾—åˆ°çš„åŒ…ä¸æœ¬åœ°`pkgs.callPackage`ç‰ˆæœ¬å®Œå…¨ç›¸åŒï¼Œæ‰€ä»¥Nixç”šè‡³ä¸éœ€è¦é‡æ–°æ„å»ºå®ƒã€‚
- en: The symbol âœ… includes static/dynamic linkage in all cases but not for Windows.
  id: totrans-split-81
  prefs: []
  type: TYPE_NORMAL
  zh: ç¬¦å· âœ… åœ¨æ‰€æœ‰æƒ…å†µä¸‹åŒ…æ‹¬é™æ€/åŠ¨æ€é“¾æ¥ï¼Œä½†ä¸é€‚ç”¨äºWindowsã€‚
- en: The entries with the âŒ symbol in the table are not implemented in the Nixpkgs
    repository. This could be done if needed. Typically, companies either implement
    functionality and upstream it or provide funding to make it happen.
  id: totrans-split-82
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨Nixpkgså­˜å‚¨åº“ä¸­æœªå®ç°å¸¦æœ‰âŒç¬¦å·çš„æ¡ç›®ã€‚å¦‚æœéœ€è¦ï¼Œå¯ä»¥å®ç°å®ƒã€‚é€šå¸¸ï¼Œå…¬å¸è¦ä¹ˆå®ç°åŠŸèƒ½å¹¶ä¸Šæ¸¸å®ƒï¼Œè¦ä¹ˆæä¾›èµ„é‡‘ä»¥å®ç°å®ƒã€‚
- en: Summary
  id: totrans-split-83
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: æ¦‚è¿°
- en: 'The demonstrated trick shows that we effectively separated the **Dependency
    Management** from the **Build System**. Many developers I talked to about this
    have never thought about this separation. The reason might be simple: Because
    itâ€™s not easy to implement without a good technology for dependency management.
    I feel like Docker has more of a place in deployment than in development.'
  id: totrans-split-84
  prefs: []
  type: TYPE_NORMAL
  zh: å±•ç¤ºçš„æŠ€å·§è¡¨æ˜ï¼Œæˆ‘ä»¬æœ‰æ•ˆåœ°å°†**ä¾èµ–ç®¡ç†**ä¸**æ„å»ºç³»ç»Ÿ**åˆ†å¼€ã€‚æˆ‘ä¸è®¸å¤šå¼€å‘è€…è°ˆè®ºè¿‡è¿™ä¸ªé—®é¢˜ï¼Œä»–ä»¬ä»æœªè€ƒè™‘è¿‡è¿™ç§åˆ†ç¦»ã€‚åŸå› å¯èƒ½å¾ˆç®€å•ï¼šå› ä¸ºæ²¡æœ‰ä¸€ä¸ªå¥½çš„ä¾èµ–ç®¡ç†æŠ€æœ¯ï¼Œå®ç°è¿™ç§åˆ†ç¦»å¹¶ä¸å®¹æ˜“ã€‚æˆ‘è§‰å¾—Dockeråœ¨éƒ¨ç½²ä¸­çš„ä½œç”¨æ¯”åœ¨å¼€å‘ä¸­æ›´å¤§ã€‚
- en: 'The advantages of this separation are huge:'
  id: totrans-split-85
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™ç§åˆ†ç¦»çš„ä¼˜åŠ¿æ˜¯å·¨å¤§çš„ï¼š
- en: A simpler build system that is easy to extend even for non-seniors
  id: totrans-split-86
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: æ›´ç®€å•çš„æ„å»ºç³»ç»Ÿï¼Œå³ä½¿å¯¹äºéé«˜çº§å¼€å‘è€…ä¹Ÿæ˜“äºæ‰©å±•
- en: Free choice between dynamic and static linking per build system parameter
  id: totrans-split-87
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: æ ¹æ®æ„å»ºç³»ç»Ÿå‚æ•°è‡ªç”±é€‰æ‹©åŠ¨æ€å’Œé™æ€é“¾æ¥
- en: Wide support for compiling from/to different host architectures and operating
    systems
  id: totrans-split-88
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: å¹¿æ³›æ”¯æŒä»ä¸åŒä¸»æœºæ¶æ„å’Œæ“ä½œç³»ç»Ÿç¼–è¯‘åˆ°/ä»çš„æ”¯æŒ
- en: 'Not managing compiler, deps, and project in one build system makes everything
    *modular*:'
  id: totrans-split-89
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: ä¸åœ¨ä¸€ä¸ªæ„å»ºç³»ç»Ÿä¸­ç®¡ç†ç¼–è¯‘å™¨ã€ä¾èµ–é¡¹å’Œé¡¹ç›®ä½¿ä¸€åˆ‡*æ¨¡å—åŒ–*ï¼š
- en: Less work with updates
  id: totrans-split-90
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: æ›´æ–°å·¥ä½œæ›´å°‘
- en: Faster setup time per developer
  id: totrans-split-91
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: æ¯ä½å¼€å‘è€…çš„å¿«é€Ÿè®¾ç½®æ—¶é—´
- en: Cacheable dependencies
  id: totrans-split-92
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: å¯ç¼“å­˜çš„ä¾èµ–é¡¹
- en: Easier reuse of individual modules in other projects
  id: totrans-split-93
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: åœ¨å…¶ä»–é¡¹ç›®ä¸­æ›´è½»æ¾åœ°é‡ç”¨å„ä¸ªæ¨¡å—
- en: We only built binaries this time, no [container images](../../../../2023/09/04/nixos-multi-php-version-container/),
    [`systemd-nspawn` images](../../../../2023/08/29/nixos-nspawn/), VMs, or disk
    images. This is however simple to add on top.
  id: totrans-split-94
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™æ¬¡æˆ‘ä»¬åªæ„å»ºäº†äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ²¡æœ‰[å®¹å™¨é•œåƒ](../../../../2023/09/04/nixos-multi-php-version-container/)ï¼Œ[`systemd-nspawn`é•œåƒ](../../../../2023/08/29/nixos-nspawn/)ï¼Œè™šæ‹Ÿæœºæˆ–ç£ç›˜é•œåƒã€‚ä¸è¿‡ï¼Œå¦‚æœéœ€è¦çš„è¯ï¼Œè¿™äº›å¾ˆå®¹æ˜“æ·»åŠ ã€‚
- en: If you want to evaluate Nix or even use it in your real projects, donâ€™t hesitate
    to [give us a call](../../../../meet.html)! We have a lot of experience, especially
    with low-level C++ projects. Contact us and see how the complexity of your projects
    can be simplified.
  id: totrans-split-95
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚æœä½ æƒ³è¯„ä¼°Nixï¼Œç”šè‡³åœ¨ä½ çš„çœŸå®é¡¹ç›®ä¸­ä½¿ç”¨å®ƒï¼Œè¯·æ¯«ä¸çŠ¹è±«åœ°[è”ç³»æˆ‘ä»¬](../../../../meet.html)ï¼æˆ‘ä»¬æœ‰ä¸°å¯Œçš„ç»éªŒï¼Œç‰¹åˆ«æ˜¯åœ¨ä½çº§åˆ«çš„C++é¡¹ç›®ä¸­ã€‚ä¸æˆ‘ä»¬è”ç³»ï¼Œçœ‹çœ‹å¦‚ä½•ç®€åŒ–ä½ é¡¹ç›®çš„å¤æ‚æ€§ã€‚
