<!--yml

category: 未分类

date: 2024-05-27 14:28:47

-->

# 感恩节2023安全事件

> 来源：[https://blog.cloudflare.com/thanksgiving-2023-security-incident](https://blog.cloudflare.com/thanksgiving-2023-security-incident)

这篇文章也有[简体中文](https://blog.cloudflare.com/zh-cn/thanksgiving-2023-security-incident-zh-cn/)、[繁體中文](https://blog.cloudflare.com/zh-tw/thanksgiving-2023-security-incident-zh-tw/)、[日本語](https://blog.cloudflare.com/ja-jp/thanksgiving-2023-security-incident-ja-jp/)、[한국어](https://blog.cloudflare.com/ko-kr/thanksgiving-2023-security-incident-ko-kr/)、[Español](https://blog.cloudflare.com/es-es/thanksgiving-2023-security-incident-es-es/)、[Português](https://blog.cloudflare.com/pt-br/thanksgiving-2023-security-incident-pt-br/)、[Français](https://blog.cloudflare.com/fr-fr/thanksgiving-2023-security-incident-fr-fr/)、[Deutsch](https://blog.cloudflare.com/de-de/thanksgiving-2023-security-incident-de-de/)和[Polski](https://blog.cloudflare.com/pl-pl/thanksgiving-2023-security-incident-pl-pl/)版本。

2023年11月23日感恩节当天，Cloudflare在我们的自托管Atlassian服务器上检测到了一个威胁行为者。我们的安全团队立即展开调查，切断了威胁行为者的访问，并于11月26日星期日，引入了CrowdStrike的取证团队进行他们独立的分析。

昨天，CrowdStrike完成了他们的调查，我们现在发布这篇博文来详细讨论这一安全事件的细节。

我们要向客户强调，此事件未影响Cloudflare客户的任何数据或系统。由于我们的访问控制、防火墙规则和使用我们自己的零信任工具强制执行的硬安全密钥，威胁行为者的横向移动能力受到了限制。没有服务受到牵连，也没有对我们的全球网络系统或配置进行任何更改。这就是零信任架构的承诺：就像船上的舱壁一样，在一个系统受损时限制不至于影响整个组织。

从11月14日到17日，威胁行为者进行了侦察，然后访问了我们的内部Wiki（使用Atlassian Confluence）和我们的Bug数据库（Atlassian Jira）。在11月20日和21日，我们看到了额外的访问迹象，表明他们可能回来测试访问，以确保他们有连接性。

然后他们于11月22日返回，并使用ScriptRunner for Jira在我们的Atlassian服务器上建立了持久访问，并访问了我们的源代码管理系统（使用Atlassian Bitbucket），并尝试但未成功访问一个控制台服务器，该服务器可以访问Cloudflare尚未在巴西圣保罗投入生产的数据中心。

他们使用了一个访问令牌和三个服务账号凭证，这些凭证是在[2023年10月Okta受损事件](https://blog.cloudflare.com/how-cloudflare-mitigated-yet-another-okta-compromise)后被盗取的，我们未能进行轮换。所有威胁行为者的访问和连接在11月24日被终止，CrowdStrike确认最后一次威胁活动是在11月24日10:44。

*(在本博客文章中，所有日期和时间均为协调世界时（UTC）)*。

即使我们认为这起事件的运营影响非常有限，但我们非常重视此事，因为威胁行为者使用盗取的凭证访问了我们的Atlassian服务器，并获取了部分文档和少量源代码。基于我们与行业同事和政府的合作，我们认为这次攻击是由一个国家级攻击者执行的，其目标是获取对Cloudflare全球网络的持久性和广泛性访问。

11月24日，在威胁行为者被从我们的环境中移除之后，我们的安全团队召集了公司内需要的所有人员来调查入侵事件，确保威胁行为者被彻底阻止访问我们的系统，并确保我们理解他们访问或试图访问的全部内容的完整范围。

从11月27日起，我们将Cloudflare技术人员（包括安全团队内外的人员）的大部分精力转向了一个名为“Code Red”的单一项目。重点是加强、验证和修复我们环境中的任何控制措施，以确保我们能够抵御未来的入侵，并验证威胁行为者无法访问我们的环境。此外，我们继续调查每个系统、账户和日志，以确保威胁行为者没有持久性访问，并完全了解他们接触过哪些系统以及他们试图访问过哪些系统。

CrowdStrike对威胁行为者活动的范围和程度进行了独立评估，包括搜索任何仍在我们系统中坚持存在的证据。CrowdStrike的调查为我们的调查提供了有力的证实和支持，但没有发现我们漏掉的任何活动。本博客文章详细概述了我们和CrowdStrike关于威胁行为者活动的所有发现。

攻击者仅能通过盗取的凭证访问使用我们Atlassian环境的生产系统。分析他们访问过的wiki页面、bug数据库问题以及源代码仓库，似乎他们正在寻找有关全球网络架构、安全和管理的信息，毫无疑问，他们是在计划加深立足点。因此，我们决定需要投入巨大努力进一步加固安全协议，以防如果我们在日志文件中遗漏了任何东西，攻击者能够再次获得立足点。

我们的目的是防止攻击者利用有关我们网络操作的技术信息试图再次入侵。尽管我们最初认为并后来确认攻击者的访问有限，我们仍进行了全面的努力，循环每一位生产凭据（超过5,000个独立凭据），物理隔离测试和生产系统，对4,893个系统进行了法医调查，重新镜像并重启了全球网络中的一切机器，包括攻击者访问过的系统和所有Atlassian产品（Jira、Confluence和Bitbucket）。

攻击者还尝试访问我们新建且尚未投入生产的圣保罗数据中心的控制台服务器。所有尝试访问都未成功。为了确保这些系统的绝对安全，我们已将巴西数据中心的设备返回厂家。厂家的法医团队检查了我们所有的系统，确保没有获得任何访问或持久性。未发现异常，但出于安全考虑，我们仍更换了硬件。

我们还检查了未更新的软件包、可能存在创建的用户账户以及未使用的在职员工账户；我们搜索了可能遗留在Jira单据或源代码中的机密，并检查和删除了wiki上传的所有HAR文件，以防其中包含任何形式的令牌。无论情况不确定，我们都假设最坏的情况，并做出改变，确保任何攻击者能够访问的信息将不再使用，因此不再对攻击者有价值。

团队的每一个成员都鼓励指出攻击者可能接触过的区域，以便我们审查日志文件并确定攻击者访问的范围。通过在整个公司的大量人员参与，我们旨在不留任何死角，寻找访问证据或需要改善安全策略的变更。

立即的“红色警报”行动于1月5日结束，但公司内部围绕凭证管理、软件硬化、漏洞管理、额外警报等方面的工作仍在持续进行。

### 攻击时间线

攻击始于10月，由Okta遭到破坏引起，但攻击者仅在11月中旬开始使用Okta泄露的凭证针对我们的系统实施攻击。

如下时间线概述了主要事件：

### 10月18日 - Okta被破坏

我们之前[已经写过这件事](https://blog.cloudflare.com/how-cloudflare-mitigated-yet-another-okta-compromise)，总结来说，我们（第二次）成为了Okta系统被入侵的受害者，结果是攻击者获取了一组凭据。本应旋转这些凭据。

不幸的是，我们未能旋转一个服务令牌和三个服务账户（千里挑一）的凭据，在Okta泄露事件期间。

其中一个是Moveworks服务令牌，授予了对我们Atlassian系统的远程访问权限。第二个凭据是用于SaaS Smartsheet应用的服务账户，具有对我们Atlassian Jira实例的管理访问权限，第三个账户是Bitbucket的服务账户，用于访问我们的源代码管理系统，第四个是一个AWS环境，没有访问全球网络或客户或敏感数据。

一个服务令牌和三个账户之所以没有旋转，是因为错误地认为它们未被使用。这是错误的，也是攻击者首次进入我们系统并对Atlassian产品保持持久性的原因。请注意，这绝不是Atlassian、AWS、Moveworks或Smartsheet的错误。这些仅仅是我们未能旋转的凭据。

### 11月14日 09:22:49 - 攻击者开始探测。

我们的日志显示，攻击者从11月14日开始对我们的系统进行探测和侦察，寻找使用凭据的方法和可访问的系统。他们尝试登录我们的Okta实例未获授权。他们尝试访问Cloudflare仪表板也未获授权。

此外，攻击者还访问了用于支持Cloudflare应用市场的AWS环境。该环境进行了分割，无法访问全球网络或客户数据。访问该环境的服务账户已被撤销，并验证了环境的完整性。

### 11月15日 16:28:38 - 攻击者进入了Atlassian服务。

攻击者成功于11月15日使用Moveworks服务令牌通过我们的网关认证进入了Atlassian Jira和Confluence，然后他们使用Smartsheet服务账户访问了Atlassian套件。第二天，他们开始寻找关于我们全球网络配置和管理的信息，并访问了各种Jira票证。

攻击者搜索了wiki上类似远程访问、秘密、客户端秘密、openconnect、cloudflared和令牌等内容。他们访问了36个Jira票证（共2,059,357张票证）和202个wiki页面（共194,100个页面）。

攻击者访问了有关漏洞管理、秘密轮换、MFA绕过、网络访问甚至我们对Okta事件本身的响应的Jira票证。

Wiki 搜索和访问的页面显示，威胁行为者对我们系统的各个访问方面都非常感兴趣：密码重置、远程访问、配置、我们对 Salt 的使用，但他们并未针对客户数据或客户配置进行攻击。

### 2024年11月16日 14:36:37 - 威胁行为者创建了一个 Atlassian 用户账户

威胁行为者使用 Smartsheet 凭据创建了一个看起来像正常 Cloudflare 用户的 Atlassian 账户。他们将这个用户添加到 Atlassian 的多个组中，以确保在 Smartsheet 服务账户被移除后仍能持续访问 Atlassian 环境。

### 2024年11月17日 14:33:52 至 11月20日 09:26:53 - 威胁行为者暂停访问 Cloudflare 系统

在此期间，攻击者暂停了对我们系统的访问（除了显然简短地测试他们仍然有访问权限之外），并在感恩节前返回。

### 2024年11月22日 14:18:22 - 威胁行为者获得持久性

由于 Smartsheet 服务账户在 Atlassian Jira 上具有管理权限，威胁行为者能够安装 Sliver Adversary Emulation Framework，这是一个广泛使用的工具和框架，用于红队和攻击者实现“C2”（命令和控制）连接，获得安装其上的计算机的持久性和隐秘访问。Sliver 是通过 ScriptRunner for Jira 插件安装的。

这使得他们持续访问了 Atlassian 服务器，并利用这一点尝试侧向移动。在此访问中，威胁行为者试图访问位于我们位于巴西圣保罗数据中心的非生产控制台服务器，由于未执行的 ACL。访问被拒绝，他们未能访问全球网络的任何部分。

在接下来的一天里，威胁行为者查看了 120 个代码仓库（总共 11,904 个仓库中的一部分）。其中，威胁行为者在 76 个仓库上使用了 Atlassian Bitbucket 的 git 存档功能，将它们下载到了 Atlassian 服务器上，尽管我们无法确认它们是否已被外泄，但我们决定将它们视为已被外泄。

这 76 个源代码仓库几乎都与备份工作方式、全球网络的配置和管理方式、Cloudflare 的身份验证方式、远程访问以及我们对 Terraform 和 Kubernetes 的使用有关。其中少数仓库包含了加密的秘密，尽管这些秘密本身已经被强加密，但我们立即进行了更换。

我们特别关注这 76 个源代码仓库，以寻找内嵌的秘密（存储在代码中的秘密已经被更换）、漏洞和攻击者可能利用它们进行后续攻击的方式。这项工作被公司各工程团队作为“Code Red”的一部分优先进行。

作为一家SaaS公司，我们长期以来认为我们的源代码本身并不像向终端用户分发软件的软件公司的源代码那样宝贵。事实上，我们已经公开了大量的源代码，并通过我们的博客公开讨论我们使用的算法和技术。因此，我们的重点不在于某人能否访问源代码，而是源代码是否包含嵌入的秘密（如密钥或令牌）和漏洞。

### 11月23日 - 发现和终止威胁演员的访问开始。

我们的安全团队在16:00收到威胁演员存在的警报，并在35分钟后停用了 Smartsheet 服务帐户。48分钟后，发现并停用了威胁演员创建的用户帐户。以下是在第一次警报引发后阻止威胁演员所采取的主要行动的详细时间表。

15:58 - 威胁演员将 Smartsheet 服务帐户添加到管理员组。

16:00 - 我们的安全团队收到关于 15:58 更改的自动警报。

16:12 - Cloudflare SOC 开始调查警报。

16:35 - Cloudflare SOC 停用 Smartsheet 服务帐户。

17:23 - 威胁演员创建的 Atlassian 用户帐户被发现并停用。

17:43 - 内部 Cloudflare 事故宣布。

21:31 - 防火墙规则放置以阻止威胁演员已知的 IP 地址。

### 11月24日 - Sliver 被移除；所有威胁演员的访问被终止。

10:44 - 已知的最后一次威胁演员活动。

11:59 - Sliver 被移除。

在这段时间内，威胁演员试图访问 Cloudflare 的许多其他系统，但由于我们的访问控制、防火墙规则以及使用我们自己的零信任工具强制实施的硬安全密钥，他们均未成功。

明确地说，我们完全没有任何证据表明威胁演员能够访问我们的全球网络、数据中心、SSL 密钥、客户数据库或配置信息，我们或客户部署的 Cloudflare Workers、AI 模型、网络基础设施或任何我们的数据存储如 Workers KV、R2 或 Quicksilver。他们的访问仅限于 Atlassian 套件和我们的 Atlassian 运行的服务器。

我们“红色代码”努力的重要部分是理解威胁演员获得了什么访问权限以及他们试图访问什么。通过查看各系统的日志，我们能够追踪他们试图访问我们的内部指标、网络配置、构建系统、警报系统和发布管理系统。根据我们的审查，他们对这些系统的访问尝试均未成功。独立的 CrowdStrike 对威胁演员活动的范围和程度进行了评估，未发现我们遗漏的活动，并得出结论称最后一次威胁活动发生在11月24日10:44。

我们确信，在我们的调查和 CrowdStrike 的帮助下，我们完全理解了威胁演员的行动，而这些行动仅限于我们看到其活动的系统。

### 结论

这是一个涉及复杂行动者的安全事件，可能是一个国家实体，他们以深思熟虑和有条不紊的方式操作。我们所采取的措施确保了事件的持续影响被限制，我们也已经做好准备，能够抵御未来的任何复杂攻击。这需要 Cloudflare 大量的工程人员参与，而且在一个月的时间里，这一直是 Cloudflare 的最高优先事项。整个 Cloudflare 团队努力确保我们的系统安全，理解威胁行动者的访问， remediate 紧急优先事项（如大规模凭证轮换），并制定长期工作计划，以改进我们的整体安全性，基于在此过程中发现的改进点。

我们非常感谢 Cloudflare 的每一位在感恩节假期迅速做出初步分析并锁定威胁行动者的人员，以及所有为此付出努力的人。虽然无法名列所有参与者，但他们的长时间工作和专注精神，使得我们能够进行必要的审查和改变 Cloudflare 的安全性，同时保持全球网络和客户服务的运行。

我们非常感谢 CrowdStrike 立即进行独立评估。现在他们的最终报告已经完成，我们对内部分析和入侵修复感到自信，并将此博客文章提供给大家。

**IOCs**

以下是我们从这个威胁行动者看到的威胁迹象（IOCs）。我们发布它们，以便其他组织，尤其是可能受到 Okta 泄漏影响的组织，可以搜索他们的日志，确认相同的威胁行动者未能访问他们的系统。

| 指标 | 指标类型 | SHA256 | 描述 |
| --- | --- | --- | --- |

| 193.142.58[.]126 | IPv4 | N/A | 主要威胁行动者基础设施，由

M247 Europe SRL（布加勒斯特，

罗马尼亚）|

| 198.244.174[.]214 | IPv4 | N/A | Sliver C2 服务器，由 OVH SAS（伦敦，英格兰）所有 |
| --- | --- | --- | --- |
| idowall[.]com | 域名 | N/A | 用于提供 Sliver 载荷的基础设施 |
| jvm-agent | 文件名 | bdd1a085d651082ad567b03e5186d1d4 6d822bb7794157ab8cce95d850a3caaf | Sliver 载荷 |
