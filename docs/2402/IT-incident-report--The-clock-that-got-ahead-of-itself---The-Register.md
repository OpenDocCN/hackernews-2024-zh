<!--yml

category: 未分类

date: 2024-05-27 14:46:33

-->

# IT 事故报告：钟表超前一步 • The Register

> 来源：[https://www.theregister.com/2024/02/09/it_incident_report_the_clock/](https://www.theregister.com/2024/02/09/it_incident_report_the_clock/)

采访 回溯到 2010 年末，“Zimmie” 在一个制造 VPN 设备和相关操作系统的供应商的 IT 支持部门工作。他在一个星期一接到了来自美国一家大型特殊零售商的客户的电话，询问其在周末停止工作的 VPN 硬件的情况。

在调查报告后，问题似乎是证书验证失败的结果，正如他最近在 Mastodon 上的 [帖子](https://infosec.exchange/@bob_zim/111862834586135218) 中描述的那样。

“我当时的雇主的 VPN 设备由一个中央服务器管理，” Zimmie 向 *The Register* 解释道。“这个服务器运行其自己的证书颁发机构（CA），用于为所有设备签署证书。VPN 终端随后使用这些证书进行身份验证到管理服务器（例如，发送日志时）以及彼此之间（主要用于 VPN）。CA 是管理软件的核心部分。”

Zimmie 告诉我们，他宁愿不公开身份、供应商或其客户，以免尴尬任何人。但他同意 *The Register* 讲述他的故事。

Zimmie 指出，验证检查失败是因为系统无法检查证书吊销列表（CRL）——一个由发行机构吊销的数字证书列表。

> 处理验证的软件分配了 512 KiB 的空间来存储 CRL，这也太大了吧？这个 CA 很少使用，所以不应该在人类寿命内达到限制。

“这些设备彼此之间通过类似于 HTTPS 使用的证书进行身份验证，但由私有证书颁发机构（CA）签署。”他解释道。

"每个客户都有自己的 CA。验证证书的过程的一部分是询问 CA 是否吊销了证书。验证失败是因为 VPN 盒无法下载证书吊销列表（CRL）以确认对等证书不在列表上。为什么不能下载 CRL 呢？"

通过检查 VPN 设备的证书操作日志发现，无法下载 CRL 太大了，他发现。

"处理验证的软件分配了 512 KiB 的空间来存储 CRL，这也太大了吧？这个 CA 很少使用，所以不应该在人类寿命内达到限制。CRL 到底出了什么问题，会这么早就达到限制？"

2015 年的 [论文](https://www.cs.umd.edu/~dml/papers/revocations_imc15.pdf) [PDF]，由马里兰大学的研究人员发布，关于证书吊销指出，中位数证书的 CRL 大小为 51KB，一半的 CRL 小于 900B。

这个证书几乎有 1MB 大小，Zimmie 发现其尺寸是由于 CA 每秒重复撤销和重新签发它签署的每个证书。这个 CRL 在周末期间每天增长超过 250 KiB，他估计这相当于一天内的一个世纪增长。

"幸运的是，证书颁发机构有一个证书操作日志，" Zimmie 回忆道。"这个日志记录了 CA 撤销证书、签发新证书或执行其他几个操作的每一次。查看最近的条目，我看到 CA 进程唤醒，决定 CA 自己的证书已过期，然后撤销并重新签发它签署的每个证书。往前看，我看到它在一秒之前做了同样的处理。再往前一秒钟。"

> 在 2037 年之前无效，而在 1910 年之后也无效？这意味着它永远无效。这是怎么发生的？

根据 Zimmie 所说，这些数字[证书](https://datatracker.ietf.org/doc/html/rfc5280)有两个日期：notBefore，表示在此日期之前它们无效；notAfter，表示在此日期之后它们过期。

"我查看了 CA 的证书，上面写着在 1910 年后就无效了，" 他写道。"很奇怪，但至少解释了为什么 CA 告诉我们它的证书已过期。但是当它为自己颁发一张替代证书时，替代证书的有效期也是在 1910 年后。这*非常*奇怪。它应该用新的日期重新发放证书。"

Zimmie 注意到了 notBefore 的日期。"人们很少关心这个日期，因为几乎不可能得到还不有效的证书，" 他解释道。

"但这个证书在 2037 年某个时间之前都不有效。等等，什么？它在 2037 年之前无效，在 1910 年之后也无效？这意味着它永远无效。这是怎么发生的？"

### 错误的计算

处理网络的读者可能已经有了一些想法：时间计算出了问题。

"相当长时间以前，UNIX 的开发人员决定将时间跟踪为从 1970 年 1 月 1 日午夜以来的带符号 32 位秒计数器，" Zimmie 解释道。

"Linux 为了兼容性保留了这个决定。'signed' 部分意味着数字可以是负数，以允许表示 1970 年之前的时间值。32 位足够表示将近 43 亿秒。符号意味着你可以在 1970 年之前获得大约 21 亿秒，在之后获得大约 21 亿秒。21 亿秒大约是不到 25,000 天，或者超过 68 年。"

1970 年后的六十八年后是 2038 年，Zimmie 说。任何处理 UNIX 时间的人都应该认识到 2038 年，这年有[它自己的网站](https://theyear2038problem.com/)警告未来可能出现的问题。

“可以像这样表示的最新时间是 2038 年 1 月 19 日 UTC 时间的 03:14:07，” Zimmie 说。“一旦计时器从此秒开始递增，该值就会 '溢出' 并从一个大正数变为一个大负数。该计数器可以表示的下一个秒是 1901 年 12 月 13 日 UTC 时间的 20:45:52。这就是所谓的 2038 年问题。”

注意到证书颁发机构签署自己的证书以在十年期间内有效，Zimmie 得出结论，计算到期日期时遇到了 2038 年问题。这表明日期数学库或实现该库的代码存在 bug。但这仍然留下一个问题，即为什么它会用相同日期更新证书。

Zimmie 检查了 CA 的自动更新代码，并确认在证书到期时不会重新发放具有较早起始日期的证书。

“这在正常运行下是有道理的，但在像我客户遇到的奇怪情况下是不可能恢复的。”他解释道。“又一个 bug。但它为什么在首次签发不早于 2037 年的证书？”

在检查了冗长的 CA 操作日志后，他发现了一个关于 CA 自我更新的系统日期时间戳在 2037 年。

“现在 2037 年开始的证书有了解释，除了一个不太重要的事实，那就是它是 2010 年而不是 2037 年，”他说。“那么为什么 CA 操作日志有来自 2037 年的条目呢？”

客户 Zimmie 回忆道，他报告称未将时间设置为 2037 年。“尽管如此，他正在使用 NTP，并且每 120 秒与时间服务器同步。”他详细说明道，指的是用于将计算机时钟与网络时间信号同步的网络时间协议。

“我开始查看 NTP 客户端日志。大多数条目是客户端微调时钟向前或向后一小部分秒数。我过滤掉所有调整开始于 '-0.' 或 '0.' 的条目，发现了一些大得多的调整。数万秒。数十万。数百万。我找到一个约为 -40 亿秒的调整，然后又回到数百万或数十万秒。”

### 时间旅行

据 Zimmie 称，系统认为 NTP 服务器已将时间设置为 2010、2019、2028、2037、1907、1918 等，直到再次循环到当前时间。

“操作系统中的 NTP 客户端真的很糟糕，明显允许比合理范围大得多的时间调整。” 他悲叹道。“CA 运行在我雇主提供的设备操作系统上，所以我们拥有 NTP 客户端。这是今天的第三个 bug。至少现在我们知道证书颁发机构为何认为是 2037 年！”

> 操作系统中的 NTP 客户端真的很糟糕，明显允许比合理范围大得多的时间调整。

这仍然让人困惑，为什么 NTP 客户端在可用时间戳空间中快速向前。

“几天后它再次发生，我们得到了一个数据包捕获，证明它实际上发送了虚假时间戳，”他解释道。“不幸的是，NTP 服务器是另一个供应商的设备，所以我只能推测。我认为这是 C 语言中的值类型错误。”

Zimmie 告诉我们：“C 语言具有有符号整数和无符号整数的概念，但它们之间的区分非常弱。你可以告诉系统将这个有符号整数值存储在某个地方，然后你可能会在以后意外地将其解释为无符号值。”

“对于正整数来说，这并不重要。但是对于负整数来说，情况就不同了。由于几个原因，它们以所谓的 '二进制补码' 形式存储在内存中。当你将值 -1 存储为 32 位有符号整数时，在内存中的表示是 0xFFFFFFFF。如果你稍后将其解释为无符号整数，你会得到 4,294,967,295 这个值。”

根据 Zimmie 的说法，NTP 服务器使用无线电接收器监听上游时间源。

“这些无线电通常是 GPS 接收器，但当时的 CDMA 手机网络也提供了足够精确的时间信息。我怀疑 NTP 服务器的内部时钟严重故障，运行得非常快。我还怀疑它失去了无线电信号足够长的时间，以至于内部时钟比从无线电获得的时间快了至少一秒钟。”

“当它重新获得无线电信号时，我认为它会从无线电时间中减去内部时钟时间，以找出它的偏差多少秒。如果我没错，它会得到一个小的负数。我认为在确定它落后多少秒时，它将这个小负数作为无符号整数处理，结果这个小负数变成了一个*巨大*的正数。因此，它以每秒 4.29 亿的速度飞驰。”

“根据我的经验，最令人困惑的行为几乎总是由非常微小的错误引起的，”Zimmie 嘲笑道。“这个小错误可以解释这种行为。”

Zimmie 在他的帖子中写道，恢复过程非常困难。“在 VPN 连接未工作的情况下，他们需要有人亲自去约一百个站点，并让每个站点信任新的 CA，”他解释道。“在一切都能修复之前，这种情况也发生了几次。”

*The Register* 询问 Zimmie 为什么认为这个故事在社交媒体上引起了人们的共鸣。

“人们喜欢解谜，”他回答说。“我们想要理解。我喜欢讲述这个故事，因为它说明了一个简单的问题实际上可能比你想象的要大，但是即使是大而奇怪的问题，仍然可以被分解和理解。我认为这对很多人有共鸣。”

当你真正解决谜团时，这也是一点有趣的事情。

"通常，我开始解决问题是通过询问系统它正在做什么，" Zimmie 解释道。"数据包捕获，查看日志等等。经过几轮这样的操作后，我开始提出假设，并测试我的假设。这些都是基本的科学方法。大多数问题都很简单检查。如果假设错误，我就继续前进。当我开始缩小可能性并验证假设时，真相大白时，我感觉很兴奋。提出一个合理的猜测并证明它是正确的，是非常令人满足的。"

Zimmie 告诉 *The Register* ，像这样的NTP实施问题并不常见。

"我认为我在过去十年中见过的最接近的事情就是那个 [gpsd bug](https://www.theregister.com/2021/10/19/gpsd_bug_reset/)，你在2021年底写过的，" 他回忆道。"当然，最恶心的 bug 和实施问题似乎总是在我们最不经意的时候袭击。随着我们逼近2038年，我肯定会警惕NTP问题。" ®
