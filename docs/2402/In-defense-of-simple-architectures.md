<!--yml

category: 未分类

date: 2024-05-27 15:02:12

-->

# 对简单架构的辩护

> 来源：[https://danluu.com/simple-architectures/](https://danluu.com/simple-architectures/)

<main>

Wave是一家价值17亿美元的公司，拥有70名工程师，其产品是一个CRUD应用程序，用于加减数字。为此，我们的架构是一个标准的CRUD应用程序架构，即Python单体架构在Postgres之上。[从简单架构开始，通过简单方式解决问题](https://twitter.com/danluu/status/1462607028585525249)在可能的情况下允许我们扩展到这一规模，而工程师们主要专注于为用户提供价值的工作。

Stackoverflow将单体架构扩展到了良好的效果（[2013架构](https://nickcraver.com/blog/2013/11/22/what-it-takes-to-run-stack-overflow/) / [2016架构](https://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/)），最终被收购为18亿美元。如果我们看的是流量而不是市值，Stackoverflow是互联网上流量最高的100个网站之一（关于建立在单体架构之上的有价值公司的更多例子，请[参阅此Twitter线程的回复](https://twitter.com/danluu/status/1498678300163588096)）。我们的网站并不具有很高的Web流量，因为我们是一个移动应用，但即使如此，Alexa仍然将我们的网站列为前75k，尽管我们的网站基本上只是一个让人们找到应用程序的途径，大多数人甚至不是通过我们的网站找到应用程序的。

有些应用程序的需求使得在无聊的数据库之上建立简单的单体架构根本行不通，但对于大多数应用程序而言，即使在高达前100个网站访问量的情况下，计算机的速度已经足够快，可以通过简单的架构来服务高流量应用程序，这些架构通常比复杂的架构更便宜、更容易创建。

尽管简单架构非常有效，但大多数关注都集中在复杂架构上。例如，在最近的一次综合性技术会议上，有六场关于如何构建或处理基于复杂微服务的架构或其副作用的讨论，但关于如何构建简单单体架构的讨论却一场也没有。关于量子计算的讨论（一场）甚至比单体架构的讨论（零场）更多。较大的会议也是如此；最近在旧金山举办的企业导向会议上，有两位数的讨论是关于如何处理复杂先进架构的复杂性，却没有一场是关于如何构建简单单体架构的。我上次参加那个会议时，让我印象深刻的是多少参会者在那些可以使用简单架构构建的低规模企业应用中，却照搬了会议和Hacker News上流行的最新、最先进的复杂技术。

我们的架构非常简单，我甚至不打算画架构图。相反，我将讨论一些无聊的事情，这些事情帮助我们保持枯燥。

我们目前使用单调、同步的Python，这意味着我们的服务器进程在等待I/O（如网络请求）时会阻塞。我们之前尝试过Eventlet，一个异步框架，理论上可以让我们在Python中获得更高的效率，但是遇到了很多bug，我们决定等待事件的CPU和延迟成本不值得我们为了解决Eventlet问题而承担运维痛苦。还有其他[知名的Python异步框架](https://twitter.com/mcfunley/status/1194713713330122752)，但是大规模使用这些框架的用户通常也报告称[在大规模使用这些框架时会有显著的问题](https://twitter.com/mcfunley/status/1194715290841432064)。使用同步Python很昂贵，因为我们为了等待网络请求而支付了CPU的成本，但是由于我们每月只处理数十亿次请求（目前），即使使用像Python这样的慢语言，并支付公共云的零售价格，这种成本也很低。我们工程团队的成本完全主导了我们运营系统的成本。

与其复杂化我们的单体架构，我们将长时间运行的任务（我们不希望等待响应的任务）分配到队列中处理。

我们不能像我们想要的那样无聊的地方是我们的本地数据中心。当我们仅在塞内加尔和科特迪瓦运营时，我们完全在云端运作，但随着我们扩展到乌干达（以及未来更多国家），为了遵守当地的数据存储法律法规，我们必须分割我们的后端并在本地部署。这并不是一个简单的操作，但是任何完成过类似复杂服务架构的人都知道，这个操作比如果我们有复杂的服务架构要简单得多。

另一个领域是我们不得不构建的软件（而不是购买）。当我们刚开始时，我们强烈倾向于购买而不是构建软件，因为只有少数几名工程师的团队无法承担构建所有内容的时间成本。那时做出了正确的选择，即使 [“购买”选项通常提供的工具并不起作用](https://danluu.com/nothing-works/)。在供应商无法被说服修复对我们至关重要的阻碍性致命错误时，[构建更多我们自己的工具并在更多领域保持内部专业知识的做法确实是有道理的](https://danluu.com/in-house/)，这与公司应该只选择在其核心竞争力领域 “构建”的标准建议相矛盾。其中许多复杂性是我们不愿承担的复杂性，但在某些产品类别中，即使经过相当广泛的研究，我们也没有找到任何似乎能为我们提供适用产品的供应商。为了公平对待我们的供应商，他们需要解决的问题比我们需要解决的问题复杂得多，因为我们的供应商正承担解决每个客户的问题的复杂性，而我们只需要解决一个客户的问题，也就是我们自己的问题。

在运行的最初几个月中我们犯了一个错误，这个错误今天仍然带来了一些成本，那就是没有仔细地界定数据库事务的边界。在 Wave 的代码库中，SQLAlchemy 数据库会话是一个请求全局变量；每当访问 DB 对象的属性时，它会隐式地开始一个新的数据库事务，并且 Wave 代码库中的任何函数都可以调用会话的 commit 方法，导致提交所有待处理的更新。这使得我们难以控制数据库更新发生的时间，增加了我们微妙数据完整性错误的发生率，同时也增加了构建诸如 [幂等键](https://brandur.org/idempotency-keys) 或 [事务化阶段作业排放](https://brandur.org/job-drain) 等功能时的难度。这也增加了我们意外持续运行数据库事务的风险，这可能会使 [模式迁移在操作上变得困难](https://gocardless.com/blog/zero-downtime-postgres-migrations-the-hard-parts/)。

我们对某些选择还不确定（这些是我们正在考虑改变的事情，或者是我们建议其他团队从头开始考虑不同的方法），比如使用 RabbitMQ（对于我们的目的，Redis 可能同样适用作为任务队列，仅使用 Redis 将减少操作负担），使用 Celery（对于我们的用例来说过于复杂，并且由于向后兼容性问题在版本升级期间导致了几次宕机），使用 SQLAlchemy（这使得开发人员难以理解他们的代码将发出什么数据库查询，导致一些难以调试的情况和不必要的操作痛苦，特别是与上述关于数据库事务边界的问题相关）。这些选择没有一个是重大的错误，对于一些选择（比如 Python），其缺点足够小，以至于我们继续承担增加的维护负担要比投资迁移到理论上更好的东西更为便宜，但如果我们今天从头开始创建类似的代码库，我们会认真考虑它们是否是正确的选择。

在我们的 API 中，我们使用 GraphQL；在我们的传输协议中，我们曾经使用了一段时间的自定义协议，它运行在 UDP 之上，同时具备 SMS 和 USSD 的后备方案，[关于这次演讲中提到的性能原因](https://www.youtube.com/watch?v=EAxnA9L5rS8)。随着 HTTP/3 的推出，我们已经能够用 HTTP/3 替换我们的自定义协议，通常只在像马里最近的互联网关闭事件这样的事件中才需要 USSD。

至于使用 GraphQL，我们认为对我们来说，利大于弊：

优点：

+   精确返回类型的自我文档化。

+   精确返回类型的代码生成可提高客户端的安全性。

+   GraphiQL 交互式浏览器提高了生产力。

+   我们的各种应用程序（用户应用程序、支持应用程序、Wave 代理应用程序等）大多可以共享一个 API，从而减少了复杂性。

+   可组合的查询语言允许客户端在单个数据包往返中精确获取他们所需的数据，而无需构建大量特定目的的端点。

+   消除了关于何为 RESTful API 的无谓争论。

缺点：

+   当我们采用 GraphQL 时，GraphQL 库并不是很好用（基础的 Python 库是 JavaScript 版本的移植，所以不太符合 Python 的风格，Graphene 需要大量的样板代码，而 Apollo-Android 生成的代码优化得非常差）。

+   默认的 GQL 编码是冗余的，我们非常关心限制大小，因为我们的许多客户带宽有限。

至于 Kubernetes，我们使用 Kubernetes 是因为我们知道，如果业务成功（事实证明确实如此），并且我们继续扩展，最终会扩展到需要在该国家运营服务的国家。具体的法规因国家而异，但我们已经在进入一个需要我们在该国家运营“主数据中心”的主要非洲市场，并且其他国家的法规要求我们能够故障转移至该国家的数据中心。

我们面临不可避免的复杂性之一是与电信集成相关的问题。理论上，我们可以为所有事情使用 SaaS 短信提供商，但是[主要的 SaaS 短信提供商并不在非洲的每个地方运营](https://youtu.be/6tb8ALAvodM?t=196)，而在所有地方使用他们的成本将是禁止性的。如果我们为所有短信需求使用 SaaS 短信提供商，之前关于工程师补偿成本主导我们系统成本的评论就不成立了；提供电信集成的团队多次超额支付自身的成本。

通过保持我们的应用架构尽可能简单，我们可以在有利于我们业务的复杂性处花费我们的复杂性（和人头）预算。除非有强烈理由增加复杂性，否则尽可能简单地做事的想法使我们能够建立一个相当大的业务，尽管运营非洲金融业务通常被认为是一个艰难的业务，我们将在未来的帖子中讨论这一点（我们最早和最有帮助的顾问之一曾建议我们，由于预见到了许多潜在的困难，Wave 是一个糟糕的商业理念，创始人应选择另一个）。

*感谢 Ben Kuhn、Sierra Rotimi-Williams、June Seif、Kamal Marhubi、Ruthie Byers、Lincoln Quirk、Calum Ball、John Hergenroeder、Bill Mill、Sophia Wisdom 和 Finbarr Timbers 的评论/修正/讨论。*

</main>
