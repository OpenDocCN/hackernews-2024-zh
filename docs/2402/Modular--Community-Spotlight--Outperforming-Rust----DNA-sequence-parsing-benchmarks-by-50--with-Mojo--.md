<!--yml

category: æœªåˆ†ç±»

date: 2024-05-27 14:40:20

-->

# Modular: ç¤¾åŒºèšç„¦ï¼šç”¨ Mojo ğŸ”¥ æˆ˜èƒœ Rust âš™ï¸ DNA åºåˆ—è§£æåŸºå‡†æµ‹è¯•ï¼Œæ€§èƒ½æå‡50%

> æ¥æºï¼š[https://www.modular.com/blog/outperforming-rust-benchmarks-with-mojo](https://www.modular.com/blog/outperforming-rust-benchmarks-with-mojo)
> 
> è¿™æ˜¯ Mohamed Mabrouk çš„å®¢åº§åšå®¢æ–‡ç« ã€‚Mohamed æ˜¯ [MojoFastTrim](https://github.com/MoSafi2/MojoFastTrim) çš„åˆ›ä½œè€…ï¼Œä¸€ä¸ª Mojo ğŸ”¥ ç¤¾åŒºé¡¹ç›®ã€‚Mohamed åœ¨Pythonä¸Šå–å¾—äº†100å€çš„æ€§èƒ½æå‡ï¼Œå¹¶æ¯”Rustæœ€å¿«çš„å®ç°æé«˜äº†50%ã€‚ä»–å¾ˆå¿«å­¦ä¼šäº†è¿™é—¨è¯­è¨€ï¼Œç¬¬ä¸€æ¬¡å®ç°ä»…ç”¨äº†200è¡Œä»£ç ã€‚ç»§ç»­é˜…è¯»äº†è§£ä»–åº”ç”¨çš„é¢å¤–ä¼˜åŒ–ç»†èŠ‚ï¼Œä»¥æˆ˜èƒœç°æœ‰æœ€å¿«åŸºå‡†æµ‹è¯•ï¼

### ç”Ÿç‰©ä¿¡æ¯å­¦çš„å¤§æ•°æ®æ—¶ä»£

å½“ä»Šç”Ÿç‰©ä¿¡æ¯å­¦é¢ä¸´çš„æŒ‘æˆ˜æ ¹æºäºå¤§æ•°æ®å¤„ç†ã€‚æˆåƒä¸Šä¸‡å°ä»·å€¼æ•°ç™¾ä¸‡ç¾å…ƒçš„DNAæµ‹åºæœºå™¨åœ¨ç”Ÿç‰©æŠ€æœ¯ã€åŒ»å­¦å’Œç”Ÿç‰©åŒ»å­¦ç ”ç©¶çš„æ‰€æœ‰é¢†åŸŸä¸­ä¸åœåœ°å·¥ä½œã€‚é¢„è®¡åˆ°2025å¹´ï¼Œæ¯å¹´çš„æµ‹åºæ•°æ®è§„æ¨¡å°†è¾¾åˆ°[40è‰¾å­—èŠ‚](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4494865/)çš„åŸå§‹åºåˆ—æ•°æ®ã€‚è¿™ç›¸å½“äºYouTubeæ¯å¹´ä¸Šä¼ çš„æ•°æ®é‡çš„**20å€**ã€‚

å¤§å¤šæ•°æœ€ç»ˆåˆ†ææ˜¯åœ¨é«˜çº§è¯­è¨€å¦‚Pythonå’ŒRä¸­è¿›è¡Œçš„ï¼Œä½†ç”Ÿç‰©ä¿¡æ¯å­¦çš„ä¸–ç•Œå´æ˜¯ç”±Cã€C++å’ŒJavaç­‰ä½å±‚é»‘é­”æ³•é©±åŠ¨çš„ï¼è¿™äº›é«˜åº¦ä¼˜åŒ–çš„å·¥å…·ç”¨äºé¢„å¤„ç†å’Œæ€»ç»“å¤§é‡åŸå§‹æ•°æ®ã€‚è¿™å°±äº§ç”Ÿäº†ä¸€ä¸ªåŒé‡ä¸–ç•Œçš„é—®é¢˜ï¼Œé‚£äº›ä¸ç†Ÿæ‚‰ä½çº§è¯­è¨€çš„ç”Ÿç‰©ä¿¡æ¯å­¦å®¶æ— æ³•ç†è§£ã€å®šåˆ¶å’Œå®ç°ä½çº§æ“ä½œã€‚æ­¤å¤–ï¼Œå…¸å‹çš„ç”Ÿç‰©ä¿¡æ¯å­¦æµæ°´çº¿æ˜¯Bashå’ŒPythonè„šæœ¬ä¸é¢„ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶æ··åˆï¼Œè¿˜åŒ…æ‹¬åˆ†æé€»è¾‘æœ¬èº«ã€‚å¯¹æ–°è€ç”Ÿç‰©ä¿¡æ¯å­¦å®¶æ¥è¯´ï¼Œè¿™ç§å¤æ‚æ€§å’ŒæŒ«æŠ˜æ„Ÿè¶Šæ¥è¶Šä¸¥é‡ã€‚è¿™ä¸äººå·¥æ™ºèƒ½ç¤¾åŒºæ‰€é¢ä¸´çš„é—®é¢˜ç›¸åŒã€‚

### Mojo ğŸ”¥ ç»Ÿæ²»ä¸€åˆ‡çš„å·¥å…·

æˆ‘ç¬¬ä¸€æ¬¡ä»[Jeremy Howard](https://www.youtube.com/watch?v=6GvB5lZJqcE)çš„æ¼”ç¤ºè§†é¢‘ä¸­äº†è§£åˆ°Mojoã€‚å®ƒçš„ä»·å€¼æè®®å¾ˆç®€å•ï¼Œå®ƒæ˜¯ä¸€ç§Pythonicè¯­è¨€ï¼Œå…è®¸ç¨‹åºå‘˜åœ¨æ›´ä½çš„å±‚æ¬¡ä¸Šè¿›è¡Œä¼˜åŒ–ï¼Œä»¥ç»Ÿä¸€äººå·¥æ™ºèƒ½ç­‰é¢†åŸŸçš„ç¢ç‰‡åŒ–ã€‚å¯¹æˆ‘æ¥è¯´ï¼Œä»Pythonä¸–ç•Œæ¥çœ‹ï¼Œå­¦ä¹ Mojoç›¸å¯¹å®¹æ˜“ï¼Œåªç”¨äº†å‡ å¤©å°±ä¹ æƒ¯äº†é¢å¤–çš„è¯­æ³•ã€‚æˆ‘å†³å®šåœ¨ä¸€ä¸ªä¸¥è‚ƒçš„é¡¹ç›®ä¸­å°è¯•Mojo ğŸ”¥ï¼Œç”¨äºä½çº§ç”Ÿç‰©ä¿¡æ¯å­¦ä»»åŠ¡ï¼šFASTQè§£æå’Œè´¨é‡ä¿®å‰ªã€‚[FASTQ](https://en.wikipedia.org/wiki/FASTQ_format)æ˜¯å¤§å¤šæ•°DNAæµ‹åºæ“ä½œçš„åŸºæœ¬æ ¼å¼ï¼ŒåŒ…å«äº†æ¯ä¸ªç¢±åŸºå‘¼å«çš„åŸºå› ç»„åºåˆ—å’Œæœºå™¨çš„ç½®ä¿¡åº¦åˆ†æ•°ã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„è§£ææ ¼å¼ï¼Œå¤§å¤šæ•°è®°å½•çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

FASTQ

@SEQ_ID # æ–°çš„è¯»å–å¤´ + read_id GATTTGGGGTTCAAAGCAGTATCGATCAAATAGTAAA... # DNA åºåˆ— + # è´¨é‡æ ‡å¤´ + idï¼ˆå¯é€‰ï¼‰ï¼''*((((***+))%%%++)(%%%%).1***-+*'')... # Phred è´¨é‡åˆ†æ•°

ç„¶è€Œï¼Œå…¸å‹çš„æœªå‹ç¼©æ–‡ä»¶å¤§å°ä¸º1-50 GBï¼Œä¸€ä¸ªå¹³å‡ä»¥åºåˆ—ä¸ºä¸»çš„ç ”ç©¶å¯èƒ½ä¸ºå•ä¸ªæ–‡ä»¶ç”Ÿæˆè¶…è¿‡1 TB çš„æ•°æ®ã€‚åœ¨è§£æå’Œæ•°æ®å¤„ç†ä¸­ï¼Œæ€§èƒ½è‡³å…³é‡è¦ã€‚

æˆ‘å°è¯•ç¼–å†™ä¸€ä¸ªç®€å•çš„è§£æå™¨ï¼Œå®ƒå¯ä»¥ï¼š

1\. ä½œä¸º *String* è¯»å–æ–‡ä»¶çš„ä¸€ä¸ªå—ã€‚

2\. æ ¹æ®æ¢è¡Œç¬¦ *\n* åˆ†éš”å­—ç¬¦ä¸²ã€‚

3\. è·å–æ¯4è¡Œï¼ŒéªŒè¯å®ƒä»¬æ˜¯å¦æ˜¯ä¸€è‡´ä¸”æ­£ç¡®çš„ FASTQ è®°å½•ï¼Œå¹¶è¿”å›å®ƒã€‚

4\. åå¤æ‰§è¡Œç›´åˆ°è¾¾åˆ° *EOF*ã€‚

åœ¨ [ç¬¬ä¸€æ¬¡å°è¯•](https://github.com/MoSafi2/MojoFastTrim/tree/v0.1)ï¼Œ*MojoFastTrim ğŸ”¥* çš„æ€§èƒ½è¾¾åˆ°äº† Python çš„ [SeqIO](https://biopython.org/wiki/SeqIO) çš„ **8x**ã€‚æˆ‘å¯¹å¼€å‘æ—¶é—´æ„Ÿåˆ°æ„‰å¿«çš„æƒŠè®¶ã€‚æˆ‘çš„ä»£ç ä»ç„¶ä¿æŒ Python é£æ ¼ï¼Œç®€æ´åœ°çº¦200è¡Œï¼Œå¹¶ä½¿ç”¨æ™®é€š Python å¼€å‘è€…èƒ½ç†è§£çš„åŠŸèƒ½ã€‚åœ¨è´¨é‡ä¿®å‰ªä¸­ï¼Œä»æ¯ä¸ªè¯»å–ä¸­åˆ é™¤ä½è´¨é‡ç¢±åŸºï¼Œå®ƒè¾¾åˆ°äº†è¡Œä¸šæ ‡å‡†å·¥å…· [Cutadapt](https://github.com/marcelm/cutadapt) çš„50%-80%ã€‚å¯¹æˆ‘æŠ•å…¥åˆ°é¡¹ç›®ä¸­çš„å¼€å‘æ—¶é—´æ¥è¯´ï¼Œè¿™æ˜¯æƒŠäººçš„æ€§èƒ½æ°´å¹³ã€‚

### æ²‰è¿·äºä¼˜åŒ–çš„å…”å­æ´

Mojo ğŸ”¥ æœ€å¼ºå¤§çš„å¥½å¤„åœ¨äºå®ƒä¸ºæ‚¨æä¾›äº†è®¿é—®ä½çº§ä¼˜åŒ–çš„èƒ½åŠ›ã€‚Mojo æ ‡å‡†åº“çš„åˆæœŸçŠ¶æ€æ„å‘³ç€æˆ‘ä¸å¾—ä¸ä»å¤´å¼€å§‹ç¼–å†™ã€æµ‹è¯•å’ŒåŸºå‡†ä¸€äº›å‡½æ•°ã€‚Mojo å¯¹ *SIMD* å‘é‡åŒ–çš„ä¸€æµæ”¯æŒéå¸¸æœ‰å¸®åŠ©ï¼Œè€Œä¸”ä»¤äººæƒŠè®¶åœ°ç›´è§‚ã€‚è¿™é‡Œæ˜¯åœ¨ Mojo ä¸­å®ç°å‘é‡åŒ–ç‰ˆæœ¬çš„å‡½æ•°ï¼Œç”¨äºæ‰¾åˆ°æ¢è¡Œç¬¦ç´¢å¼•çš„å®ç°ï¼š

##### è¿­ä»£çš„

Mojo

@always_inline fn find_chr_next_occurance_iter[ T: DType ](in_tensor: Tensor[T], chr: Int = 10, start: Int = 0) -> Int: for i in range(start, in_tensor.num_elements()): if in_tensor[i] == chr: return i return -1

##### SIMDÂ Vectorized

Mojo

@always_inline fn find_chr_next_occurance_simd[ T: DType ](in_tensor: Tensor[T], chr: Int = 10, start: Int = 0) -> Int: alias simd_width = simdwidthof[T]() let len = in_tensor.num_elements() - start let aligned = start + math.align_down(len, simd_width) for s in range(start, aligned, simd_width): let v = in_tensor.simd_load[simd_width](s) let mask = v == chr if mask.reduce_or(): return s + arg_true(mask) # Handling other elements iteratively return -1

å‘é‡åŒ–ç‰ˆæœ¬åŠ è½½32ä¸ª *Int8* å…ƒç´ ï¼Œå¹¶ä½¿ç”¨æ›´å°‘çš„æ“ä½œæ£€æŸ¥æ¢è¡Œç¬¦çš„å­˜åœ¨ã€‚

åœ¨ä»¥ä¸‹å›¾è¡¨ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ° SIMD å‘é‡åŒ–çš„æ•ˆæœã€‚å®ƒæä¾›äº†é«˜è¾¾ **4x** çš„åŠ é€Ÿï¼Œå¹³å‡åŠ é€Ÿåº¦ä¸º **3.2x**ã€‚åŒæ ·ï¼Œ*SIMD* ä»å¼ é‡ä¸­çš„å­˜å‚¨å’ŒåŠ è½½æä¾›äº†æ˜¾è‘—çš„æ€§èƒ½æå‡ã€‚

æ­¤å¤–ï¼Œæˆ‘æ¢ç´¢äº†æ¥è‡ªC/C++å®ç°çš„ä¼˜åŒ–ã€‚æˆ‘æ‹…å¿ƒåŠ è½½çš„å—æ²¡æœ‰ä¸ºæ˜ç¡®çš„å†…å­˜ç¼“å†²åŒºè¿›è¡Œåˆ†é…ï¼Œä½†Mojoç¼–è¯‘å™¨å·²ç»ç…§é¡¾åˆ°äº†è¿™ä¸€ç‚¹ï¼Œå¹¶é¿å…äº†æ–°çš„å†…å­˜åˆ†é…ï¼š

Mojo

fn test_chunk_ptr_index() raises: let f = open("large_fastq_file.fastq", "r") var offset = 0 var chunk_no = 0 while True: let t = f.read_bytes(Size) print(t._ptr.__as_index()) offset += Size chunk_no += 1 _ = f.seek(offset) if t.num_elements() == 0: break # chunk 0çš„å†…å­˜åœ°å€ï¼š139711892942912 # chunk 1çš„å†…å­˜åœ°å€ï¼š139711892942912 # chunk 2çš„å†…å­˜åœ°å€ï¼š139711892942912 # chunk 3çš„å†…å­˜åœ°å€ï¼š139711892942912 # chunk 4çš„å†…å­˜åœ°å€ï¼š139711892942912

å®ç°è¿™äº›ä¼˜åŒ–å¯¼è‡´é¢å¤–çš„**3x**é€Ÿåº¦æå‡ï¼Œè€Œ*MojoFastTrim ğŸ”¥*å¹³å‡æ¯”Pythonçš„*SeqIO*å¿«äº†**24x**ã€‚æ­¤å¤–ï¼Œç”±äºMojoå¯¹å¼•ç”¨å’Œå€¼è¯­ä¹‰çš„æ§åˆ¶ğŸ”¥ï¼Œæˆ‘åº”ç”¨äº†è§£æå™¨çš„*FastParser*ç‰ˆæœ¬ã€‚åœ¨è§£ææœŸé—´ä¸ä¼šè¿›è¡Œå†…å­˜å¤åˆ¶ï¼Œå¹¶ä¸”å„ä¸ªè¯»å–éƒ½è¢«ä¼ é€’ä¸ºå¯¹å†…å­˜ä¸­åŠ è½½çš„å—çš„å¼•ç”¨ã€‚è¿™ç§æ–¹æ³•åœ¨Rustçš„[needletail](https://github.com/onecodex/needletail)è§£æå™¨ä¸­å®ç°ã€‚å°½ç®¡Mojoä»ç„¶æ˜¯ä¸€é—¨å¹´è½»çš„è¯­è¨€ï¼Œä½†æˆ‘çš„å®ç°åœ¨Apple Siliconä¸Šæ¯”Rustå®ç°å¿«äº†**50%**ï¼Œæ¯”*SeqIO*å¿«äº†**100x**ã€‚åœ¨è´¨é‡ä¿®å‰ªæ–¹é¢ï¼Œ*MojoFastTrim ğŸ”¥*å¹³å‡æ¯”é«˜åº¦ä¼˜åŒ–çš„Python/Cythonçš„*Cutadapt*å¿«äº†**2x**ã€‚

è¿™ä¸ªåŸºå‡†å¯ä»¥é€šè¿‡[æŒ‰ç…§è¿™é‡Œçš„è¯´æ˜](https://github.com/MoSafi2/MojoFastTrim?tab=readme-ov-file#setup)æ¥é‡ç°ã€‚

### æœ€åçš„æ€è€ƒ

å¯¹äºæƒ³è¦ç¼–å†™æ›´å…·æ€§èƒ½çš„Pythonç¨‹åºå‘˜æ¥è¯´ï¼ŒMojoæ˜¯ä¸€ä¸ªå€¼å¾—å°è¯•å’Œå­¦ä¹ çš„å¥½å·¥å…·ã€‚ç„¶è€Œï¼Œè¯­è¨€å’Œç”Ÿæ€ç³»ç»Ÿä»åœ¨æˆé•¿ï¼Œæˆ‘ä¸å¾—ä¸ä½¿ç”¨æ‰“å°è°ƒè¯•æ¥æ·±å…¥äº†è§£æˆ‘é‡åˆ°çš„é”™è¯¯ã€‚è°ƒè¯•å™¨ä»å¤„äºé¢„è§ˆçŠ¶æ€ä¸”æœªç»è®°å½•ï¼Œå°½ç®¡ä»–ä»¬å‘Šè¯‰æˆ‘å®ƒå¾ˆå¿«å°†æ­£å¼æ¨å‡ºï¼

æ€»ä¹‹ï¼Œæˆ‘è®¤ä¸ºMojoå¯ä»¥æˆä¸ºPythonè®­ç»ƒçš„ç§‘å­¦å®¶å’Œç ”ç©¶äººå‘˜åœ¨è®¸å¤šé¢†åŸŸè¿›è¡Œæ¿€è¿›æ”¹å˜çš„å·¥å…·ã€‚å®ƒå¯ä»¥è®©ä»–ä»¬åœ¨æ€§èƒ½å’Œæ§åˆ¶æ–¹é¢è¾¾åˆ°ä»¥å‰æ— æ³•å®ç°çš„æ°´å¹³ã€‚

æ„Ÿè°¢é˜…è¯»ï¼
