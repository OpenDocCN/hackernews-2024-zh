<!--yml

category: 未分类

date: 2024-05-27 14:56:42

-->

# 所以你认为你理解 IP 分段了吗？[LWN.net]

> 来源：[https://lwn.net/Articles/960913/](https://lwn.net/Articles/960913/)

| **LWN.net 需要你！** 没有订户，LWN 就无法存在。请考虑[订阅](/subscribe/)并帮助维持 LWN 的出版 |
| --- |

2024 年 2 月 7 日

本文由 Valerie Aurora 贡献

IP 分段是什么，为什么它很重要，人们是否理解它？对于最后一个问题的答案是“并不像他们想象的那样好”。本文还将回答其余这些问题，并介绍[fragquiz](https://valerieaurora.org/fragquiz.html)，这是一个我编写的游戏，让玩家猜测当 IP 数据包过大无法适应网络时它们的行为。作为 IP 分段理解不佳的证据，一个由网络专家组成的房间玩了 fragquiz，并得到了远非完美分数的分数。此外，我将描述一个我们和同事们开发的新的分段避免算法，这促使了 fragquiz 的开发。

#### 为什么要关心？

IP 分段是当 IP（Internet Protocol）数据包在发送到另一台计算机之前被分成较小片段时发生的情况。TCP 和 UDP 以及许多其他网络协议都建立在 IP 之上。许多网络专家认为他们知道 IP 分段将在何时发生，我也曾如此认为，直到我不得不为 VPN 实现算法时。那时我才意识到，像我一样，许多其他网络专家在预测何时数据包会被分割成片段时表现不佳。为了解释为什么会这样，我们首先要了解 IP 分段是什么。

IP 数据包是互联网的基本构建块：一个小应用数据块，带有描述其内容、发送位置以及允许中间路由器对其进行的操作等信息的头部。源主机和目标主机之间路径上的每个路由器读取 IP 头部，稍作更改，查阅路由表，然后（希望）将数据包传送到路径上的下一个路由器。

每个网络链路都有一个能发送的最大 IP 数据包大小：最大传输单元（MTU）。路径最小传输单元（PMTU）是两个主机之间路径上所有 MTU 的最小值。然而，路径可以随时间改变，这取决于拥塞、故障和其他网络变化。

IP 分段发生在 IP 数据包被分割成较小的 IP 数据包时，每个都有自己的头部，以便适应网络路径的 MTU。在 IPv4 和 IPv6 中，分段可以在数据包起源处发生，即数据包生成的计算机上。在 IPv4 中，数据包也可以由路径上任何路由器分段。

一般而言，IP 分段在各个方面对性能都有负面影响：吞吐量、延迟、CPU 使用率、内存使用率和网络拥塞。要了解为什么，可以想象一个典型的 IPv4 数据包，其中包含 20 字节的 IP 元数据和 1480 字节的数据，已经被分割成每个只包含八字节或更少数据的数据包，共 1480/8 = 185 个数据包。（这种情况可能发生，但在现实中不太可能发生；通常数据包只会被分割成两部分。）

要在八字节片段中发送 1480 字节的数据，源必须发送 185 * 20 = 3700 字节的元数据，而不是在未分段情况下仅需 20 字节。处理数据包头会消耗一定数量的 CPU 时间，这将在路径上的每个主机上发生 185 次。在收到所有片段之前，目标无法将数据传递给网络堆栈，因此延迟是 185 个数据包的最坏情况。目标还必须为组装分段数据包保留内存，如果等待合理时间后未收到任何片段，则将丢弃此内存。

更糟糕的是，片段更容易丢失。许多路由器和防火墙认为片段是安全风险，因为它们不包含来自于像 TCP 或 UDP 这样的更高层协议的信息，也无法基于端口进行过滤，所以它们会丢弃所有 IP 片段。此外，负载平衡系统可能会将片段路由到不同的主机，那里永远无法重新组装它们。

即使 IP 数据包只分成两部分，通常也会因为每个数据包的开销加倍而导致连接性能明显下降。有时，如果路由器配置为丢弃片段，则 IP 分段会导致网络“黑洞”。连接初始化的小数据包能够通过，但包含数据的较大数据包被分割，所以它们都被丢弃。这就是为什么网络程序员非常希望防止 IP 分段。

#### 预防措施

只有发送小于或等于两个主机之间路径 MTU 的数据包才能防止 IP 分段。但是我们如何找到路径 MTU 呢？这称为路径 MTU 发现（PMTUD），根据网络协议和网络特性，有多种方法可以实现此目的。找到路径 MTU 的一种可靠方法是发送一个已知大小的 IP 数据包，该数据包不允许分段。如果源获得确认数据包已到达目的地，则路径 MTU 至少与该数据包大小一样大。

因此，为了防止 IP 分段，您必须充分了解 IP 分段，以预测两件事：由源主机发送的 IP 数据包的大小，以及任何中间路由器是否允许将数据包分段成更小的片段。这取决于，除其他因素外：

+   本地接口的 MTU

+   IP 版本（IPv4 或 IPv6）

+   IP 数据包头中的选项

+   协议（TCP/UDP/ICMP 等）

+   套接字选项

+   任何系统范围的与 PMTUD 相关的设置

+   任何相关的 PMTU 缓存条目

如果发送方尝试发送大于路径中接收主机的 MTU 的 IP 数据包，则有三种可能性：`send()` 系统调用返回 `EMSGSIZE`，数据包被分段，和/或数据包被丢弃。（后两种情况可能发生在源主机或中间路由器上，具体取决于数据包类型和选项。）当我说某人“理解 IP 分段”时，我指的是他们能预测对于给定数据包可能发生的情况。

#### 明白了吗？

如果你一年前问我大多数网络专家是否能预测 IP 数据包的大小和分段状态，我会自信地说“可以”。然后我不得不为 VPN 实现 [DPLPMTUD](https://datatracker.ietf.org/doc/html/rfc8899)。（是的，这是一个真实的首字母缩略词，用于真实的软件，来自真实的 RFC。它代表 Datagram Packetization Layer Path Maximum Transmission Unit Discovery。）

最初，这似乎很容易。我的同事们都是网络专家，有着丰富的应用经验，这个应用程序基于 WireGuard VPN，支持 IPv4 和 IPv6。我们一起设计了一种快速简单的路径 MTU 发现算法。他们确信软件已经只发送无法分段的数据包，所以我们只需发送正确大小的探测数据包，使用内置的 ping 功能，并记录响应。想象一下我们看到数据包捕获结果充满了分段数据包时的惊讶。

当我寻找禁用 IP 分段的方法时，在 Stack Overflow 上找到了很多误导和无用的答案。有时候最好的答案会被踩。官方文档要么不存在（macOS），要么难以理解（Linux）。我们都以为应该在 Linux 上使用 `IP_PMTUDISC_DO` 设置来发送探测数据包，但几周后才意识到我们实际上想要的是 `IP_PMTUDISC_PROBE`。最终我弄清楚了 Linux 和 macOS 的所有正确设置，但用了比预期更长的时间。

我想和其他人分享我学到的东西，但现在我面临一个更大的问题：如何教会那些认为他们已经了解的人？无论我看哪里，包括镜子里，人们对 IP 分段都有着自信的错误理解。另外，让我们面对现实，IP 分段有点无聊。

#### 引入 fragquiz

我决定编写一个游戏，帮助人们学习IP分片。该程序将发送大于本地网络连接（网关接口）的MTU的数据包，同时更改IP版本（IPv6或IPv4）、传输层协议（TCP或UDP）和套接字分段选项（在macOS上是否分段，在Linux上来自[ip(7)手册页](https://man7.org/linux/man-pages/man7/ip.7.html)的四个不同的PMTUD选项）。然后它将报告数据包是否已发送、数据包的分片设置以及在传输过程中是否分片——但首先它会让用户猜测会发生什么。最后，它会告诉他们他们的得分，并鼓励他们将他们的得分和程序链接发送给其他人，类似Wordle的方式。

我有几个要求：

+   在macOS和Linux上运行

+   易于运行（无需超级用户、无需单独的服务器、无需配置）

+   没有虚拟化、隧道或者环回接口，因为它们经常存在与MTU相关的错误。

+   没有主机数据包跟踪，因为分片/重组经常发生在网络接口上。

我决定使用一个[路由追踪](https://zh.wikipedia.org/wiki/路由追踪)-风格的解决方案。路由追踪的默认模式发送带有小生存时间（TTL）的数据包，或者针对IPv6的跳数限制。当路由器接收到一个数据包时，它会从TTL中减去一；如果TTL现在为零且数据包不是发给路由器自己的，则会丢弃该数据包并向源发送ICMP超时消息。路由追踪然后读取发送路由器的IP地址，并将其打印出来。它继续发送具有递增TTL的数据包，以查找越来越接近目的地的路由器的IP地址。

Fragquiz使用相同的TTL技术，发送每个带有小TTL的数据包，并读取路由器发送的ICMP超时数据包。超时消息包括触发消息的数据包的头部，其中包括数据包大小和分片状态。在macOS和Linux上，非特权用户可以使用非特权ICMP套接字类型读取（和发送）受限制的ICMP消息的受限子集。

它起作用了，但是在这个过程中也有一些意外。

最初，我假设路由器不会重新组装 TTL 为一的数据包，因为它们只会在完成后减少 TTL 并且在抛弃数据包之前执行。但是我测试的第一个路由器，我的家用 WiFi 接入点，确实执行了这个动作。我添加了代码来自动使用不断增加的 TTL 值通过发送大于 MTU 的数据包来探测网络，直到收到一个超时消息，该消息表明数据包在到达路由器之前已被分片。然后我使用了这个 TTL 值进行测试 IP 分片。通常所需的 TTL 是一或两；我在实践中看到的最大 TTL 是六，这意味着路由器一到五都在发送超时响应前重新组装了分片。

有些网络根本不发送超时消息。当 fragquiz 突然停止工作时，我苦苦寻找自己的错误几分钟，然后我意识到关闭 VPN 后 fragquiz 又能正常工作了。在我的经验中，网络能正确生成 IPv4 和 IPv6 的超时消息是罕见的。

在 macOS 上，非特权 ICMP 监听程序允许非超级用户读取超时消息，但这段代码在 Linux 上只对超级用户有效。根据 ICMP 套接字的 [初次提交消息](https://git.kernel.org/linus/c319b4d76b9e)，使用 `IP_RECVERR` 在发送套接字上可以使非特权用户读取 ICMP 超时消息。目前我还没有实现这一功能，所以 Linux 版本目前只能以 root 用户身份运行。

macOS 和 Linux 都会保存操作系统发现的路径 MTU 的缓存。在某些情况下，缓存的路径 MTU 将影响 IP 分片的行为，这使得测试变得很麻烦，因为我必须等待缓存的路径 MTU 过期。我希望未来添加一个选项来清除路径 MTU 缓存。此外，请注意原型版本目前有一种占位符许可证，但我计划未来发布一个开放许可证版本。

我在 [RIPE 87](https://ripe87.ripe.net/archives/video/1252/) 上介绍了 fragquiz，这是一个面向网络运营商和互联网服务提供商的会议。在演讲结束时，我让听众通过举手投票来玩 fragquiz。几乎每个问题都有人同时投票 "是" 和 "否"。他们的总分接近 80%。这意味着一个由专业网络工程师和研究人员组成的观众群体甚至没有达到 "B"。我们可以有把握地认为理解 IP 分片是困难的。

#### 一个新颖的 (?) 算法

最后，我承诺解释这项新算法，这是我与 Salman Aljammaz 和 James Tucker 共同创造的。

大多数路径 MTU 发现算法一次只测试一个路径 MTU。它们发送一个特定大小的数据包，并查看是否传输成功，然后决定下一步该怎么做：发送更大的数据包，发送更小的数据包，或者决定当前路径 MTU 的估计已经足够好并终止搜索算法。这可能需要多次往返才能找到最佳的路径 MTU。

我们的第一个发现是，[正如Custura等人所示](https://aura.abdn.ac.uk/bitstream/handle/2164/11693/tma2018_paper57.pdf)，在现实世界中可能的数据包大小很少，不到十种。我们并不是第一个意识到这一点的人；事实上，[RFC 8899](https://datatracker.ietf.org/doc/html/rfc8899#name-selection-of-probe-sizes)说：“<q>实现可以通过选择一张常见 PMTU 大小的表格来优化搜索过程。</q>”

我们做得不同的是：我们同时发送了所有可能的数据包大小。因此，如果本地的 MTU 是 9000 字节，那么我们同时发送大小为 1280、1400、1500、8000 和 9000 字节的数据包。对方会对它看到的每个数据包发送确认。然后我们将路径 MTU 设置为被确认的最大数据包大小。如果有少量字节的偏差也没关系；大多数 PMTU 搜索算法在达到“足够接近”时会停止探测。

每十分钟，我们通过发送一个比当前 MTU 大的数据包来重新探测路径 MTU。如果我们收到了较大 MTU 大小的确认，那么我们知道路径 MTU 已经改变，然后我们使用比本地 MTU 大且小于新确认的路径 MTU 的所有数据包大小重新探测。否则，我们继续使用当前路径 MTU 十分钟。如果由于任何原因导致数据包丢失，包括路径 MTU 缩小，我们将从头开始重新协商连接。

这个算法的延迟为一个 RTT（往返时间），非常简单：一个定时器，一个静态表，和一个变量来保存当前路径的最大传输单元（MTU）。缺点是，与其他路径 MTU 搜索算法相比，可能会使用更多的带宽，如果它们能够用更少的数据包找到路径 MTU。

#### 读者挑战

希望现在你也可以自豪地说你不懂 IP 分段了。如果你仍然不确定，这里有一个有趣的挑战：下载 [fragquiz](https://valerieaurora.org/fragquiz.html)，并在 Linux 或 macOS 上使用标准配置运行以下命令。（如果你在过去的10分钟内与 bing.com 建立了 TCP 连接，请将其替换为你最近未连接的域名。如果你在 macOS 上，不需要使用 sudo。）

```
    $ sudo ./fragquiz -p udp4 -f default -a bing.com:80
    $ sudo ./fragquiz -p tcp4 -f default -a bing.com:80
    $ sudo ./fragquiz -p udp4 -f default -a bing.com:80

```

第一条和第三条命令得到相同的答案吗？为什么？提示：参考上面链接的 Linux ip(7) 手册页面。

[ [瓦莱丽·奥罗拉](https://valerieaurora.org/)是一位软件顾问，喜欢编写荒谬的黑客技巧并解决复杂的系统问题。 ]

* * *

（

[登录](https://lwn.net/Login/?target=/Articles/960913/)

发布评论）
