<!--yml

category：未分类

date：2024-05-27 14:54:33

-->

# Ledger：Stripe 跟踪和验证资金流动的系统

> 来源：[https://stripe.com/blog/ledger-stripe-system-for-tracking-and-validating-money-movement](https://stripe.com/blog/ledger-stripe-system-for-tracking-and-validating-money-movement)

上一次黑色星期五到网络星期一，Stripe 处理了 3 亿笔交易，总支付金额达到 186 亿美元—而 Stripe API 保持了超过 99.999% 的可用性。这些指标的基础是我们的全球支付和财务网络（GPTN），管理着接受支付、资金存储和资金流动的复杂性。今天，Stripe 通过与 185 个国家的地方银行和金融网络的合作，支持超过 135 种货币和支付方式。这些实体提供不同的接口、数据模型和行为，而 Stripe 则不断管理这种复杂性，使开发人员能够快速将 GPTN 集成到他们的业务中。

在内部，Stripe 需要保证支付处理过程中我们期望发生的事情确实发生，以满足我们内部客户和外部数据审核员的需求。我们构建了 Ledger，一个不可变且可审计的日志，作为我们所有财务数据的可信记录系统。Ledger 标准化我们对资金流动的表达，并作为我们自动化数据质量（DQ）平台的可扩展基础—确保 Stripe 忠实地为用户管理资金。

许多现有系统提供了准确会计的基本原语，但现实世界是不完美的、不完整的，且在不断变化。我们目睹了像是报告格式不正确或从银行或网络合作伙伴传播的错误等基本和显而易见的失败，以及广泛的宏观经济变化，如货币停止存在或大银行在一夜之间倒闭。在 Stripe 的规模下，虽然我们希望有条不紊的理想，但这是不可能的—因此，我们建立了一个能够使这些缺陷可管理和有界的系统。

Ledger 模型内部数据生成系统，采用常见模式，并依靠积极的警报来提出问题和建议解决方案。每天，Ledger 处理五十亿事件，我们的美元交易量的 99.99% 在四天内完全接收和验证。在这些活动中，99.999% 通过丰富的调查工具进行监控、分类和分析—剩余的长尾则通过手动分析可靠处理。Ledger 与 DQ 平台共同确保超过 99.9999% 的资金流动可解释性，即使 Stripe 的数据量增长了 10 倍。

在这篇博文中，我们将分享关于如何构建这一最先进的资金流动追踪系统的技术细节，并描述 Stripe 团队如何与支撑我们全球支付网络的数据质量指标进行交互。

## Stripe 如何处理支付

GPTN部分是一个支付处理网络，由客户业务调用Stripe的API以及Stripe与各种银行和支付方法的交互组成。跟踪Stripe向合作伙伴发出的请求、金融合作伙伴之间的实际资金移动以及Stripe收到的报告存在复杂性。我们通过将Stripe平台划分为离散服务、数据库和API/gRPC接口来使这个多方面的问题变得可解决，这样我们可以解决个别问题，而不会被更广泛的系统所淹没。

这种方法的挑战在于，没有内在机制强制这些系统以相同的方式表示或传递数据。有些可能实时操作，而其他可能以月度频率运行，数据量迥异；一些生产者每天生成数十亿个事件，而其他可能只生成几百个。此外，每个系统可能都有自己的正确性或可靠性定义。我们需要一种能够处理这些变化并证明这些个别系统共同正确建模我们财务状况的机制。

Stripe与外部实体互动的简化摘要视图

## 我们如何设计账本

上述的Stripe服务具有独立的责任，但它们合作解决一个大型的联邦问题。一个理想的解决方案提供了一个正确性的心理模型——由可信的统计数据支持——可以轻松推广到新的用例。此外，我们希望将Stripe平台上的所有活动表示为一个通用的数据结构，可以被单一系统分析。

这是我们处理它的方式：

+   账本将生产系统的状态机表示编码，并将其行为建模为逻辑基金流——账户（状态）之间的余额（事件）移动。

+   账本计算所有账户余额，以评估系统的健康状况，根据各种细分生成全面的统计数据。

这种方法抽象了底层系统之间的个别差异，并提供了它们正常运行的数学证据。

### 账本作为语义数据存储

账本是Stripe平台所有支付流程底层状态的忠实表示。账本不是基于传入数据管道计算派生数据集，而是模拟生产系统的实际工作，将每个操作记录为交易。账本建模可能会偏离上游数据，但我们通过数据完整性检查明确防范这些情况。

结合我们的其他数据质量指标，我们可以安全地依赖账本的数据表示来监视外部系统。如果我们仪表化账本，我们间接仪表化数据生产流水线。如果我们发现问题，我们会向我们的内部用户报警，指出他们数据管道的哪个部分出了问题——以及他们如何修复它。

处理   处理待付费用的创建事件和完成事件的收费。

在账本内部，我们将这一活动表示为在两个离散状态（创建和完成）之间的余额移动，将上述过程转化为一个可观察的状态机。

在账本中处理费用，表示为待付费用的创建事件和完成事件。

### 系统抽象。

账本还抽象了生产系统。我们不再单独监控数据管道之间的交接，而是将系统建模为连接账户之间的资金流动。由于账本是一个事务级的记录系统，我们可以证明即使是复杂的多系统管道，包含多个交接阶段，也能正确运行。我们还对断开连接的系统之间的数据一致性进行建模，并跟踪每笔交易的整个生命周期。我们称之为追踪，在我们的规模下，这总共达到每天数十亿笔交易。

### 通过资金流动统一不同的系统。

考虑一个抽象的端到端资金流：例如，一个企业向其余额中增加资金。这需要在银行之间转移资金，将资金流动与第三方报告进行对账，并将监管报告与财务报告匹配。资金流跨越多个内部团队边界，分离事件在不同的系统上以不同的时间发布。如果我们用逻辑构造建模这个资金流，账本可以统一这些系统中的数据，并监控其正确性。

### 不可变性。

账本的核心是一个不可变的事件日志。先前发布到账本的交易不能被删除或修改，我们始终可以通过处理所有事件到那一时刻的过程重构过去的状态。所有构造——余额、资金流、数据质量控制等——都是静态基础结构的转换。账本的不可变性确保我们可以随时审计和重现任何数据点。不变性通过保证我们能够解释和分析确切的有问题数据，来证明我们的数据质量措施。

## 我们如何设计数据质量（DQ）平台。

账本是我们数据质量（DQ）平台的基础，统一了资金流动问题的检测和响应工具。经验表明，DQ平台确保了Stripe关键业务线的可靠及时报告：即使数据量增长了10倍，我们也保持了99.999%的可用性目标。

事务级的资金流为我们提供了强大的工具来推理复杂的互联子组件。我们使用一组可信的数据质量指标来分析这些抽象，这些指标衡量资金流的健康状况。这些指标基于所有资金流的共同问题集合。对于特定的数据横截面，在时间X进行评估，我们关注：

+   **清算：** 资金流是否正确完成？

+   **时效性：** 数据是否按时到达？

+   **完整性：** 我们是否对底层数据系统有完整的表现？

然后，我们会根据各个资金流的数据质量指标（DQ metrics）进行打分和针对技术专家提供有针对性的指导。这些测量结果会汇总为一个统一的DQ分数——系统获得99.99%的数据质量分数极不可能掩盖重大问题——这将一个复杂的分布式分析问题转变为一个简单的统计练习。技术用户同样可以信任，提高的DQ分数反映了底层系统行为和准确性的真正改善。

### 清算

分类账（Ledger）基于双重记账法，这是一种保证系统中所有资金都经过贷方和借方平衡完全核对的标准方法。在这一构造的基础上进行分析可以给我们带来数学上的正确性证明。如果您之前从未听说过这个术语，可以参考[“工程师双重记账指南”。](https://anvil.works/blog/double-entry-accounting-for-engineers)

使用双重记账来验证资金流动类似于分析通过管道网络（过程）最终进入储水池（资产负债表）的水流。在稳态下，终端（非清算）储水池是满的，而中间（清算）管道是空的。如果管道中有积水，那么就会有问题——换句话说，资产负债表上存在未解决的余额。

传统上，记账纯粹是会计构造，但我们以一种新颖的方式应用这些思想。我们不只是简单地列出资金的流入和流出，而是同时建模内部数据系统的行为，这些行为可能与资金的实际移动无关，例如货币转换、报告解析、估算或账单分析。我们可以使用相同的记账概念来推理这些系统，并以一种更加普遍的方式评估它们的正确性。

### 检测问题

清算衡量的是在稳态下被适当清零的分类账（Ledger）的比例。考虑一个模拟两个步骤流程的例子：`charge creation`（潜在资金移动）和 `release`（资金可用）。在跟随流程时，请记住以下定义：

+   **账户**是通过其类型（例如，`charge_unsubmitted`）和属性（例如，`id`、`business`）区分的资金存储桶。

+   **事件** 在账户之间转移资金（例如，`charge.creation` 和 `charge.release`）。

在时间 `T0`，`charge.creation` 事件在未支付账户中设立余额；然后在 `T1`，`charge.release` 完成了流程并将资金移至 `business_balance` 账户。

需要注意的是`creation`和`release`事件是完全独立的。即使它们以不同的顺序到达或由不同的来源创建，总账仍通过`business`和`id`的标识符维护准确的资金流动。但是，如果`release`事件从未发布或具有错误的`id`，总账将不会清算与`charge_undisbursed`账户相关联的余额，并且它会将余额保留在`charge_undisbursed`的另一个实例中。

### 示例清算问题

接下来考虑一个错误值（`business: B` vs. `business: A`）导致两个清算账户余额不为零。与为`business: A`单独一个资金池不同，我们最终得到了两个——一个用于`business: A`，另一个用于`business: B`。

从这个例子中泛化，我们对总账内的每笔资金流动、账户类型和基于属性的细分都重复此过程。即使我们有数十亿的交易量，一个单独的缺失、延迟或错误的交易会立即通过简单的查询创建一个可检测的准确性问题，例如，“*查找清算账户余额不为零的账户。”*

### 及时性

清算防止持久性问题，但我们还需要确保数据按时到达，以满足诸如月度报告生成之类的时效性功能。生产者在与总账集成时创建时间戳，并测量数据首次进入Stripe平台和到达总账之间的时间差。我们设置了数据交付窗口的严格阈值，并为后续的报告、分析和操作创造了余地，以确保99.999%的及时性。

### 完整性

我们通过明确的跨系统检查和自动异常检测，保证数据完整性，并防止来自上游系统的数据丢失。例如，我们确保生产者数据库中的每个ID都有匹配的总账事件。我们还对数据可用性进行统计建模。我们为每种账户类型建立模型，利用历史趋势计算预期的数据到达时间，如果事件没有出现，我们会解释这可能是缺失数据。

## Stripe团队如何探索DQ指标

在DQ平台之上，我们建立了分层自动警报和丰富的工具。我们将交互式度量显示与分析和指导相结合。内部领导和团队成员的体验侧重于积极的反馈、数据简单操作和有意义的指标。我们还提供依赖于业务部门的使用情况特定的上下文。例如，考虑我们如何为我们的周期性财务报告展示团队级别的DQ指标，我们称之为会计结算。注：部分细节由于隐私问题被屏蔽。

总体视图通常处于良好状态，但在支付工程团队内部的团队层面存在改进空间。例如，50%的老账户余额得分意味着一些清算问题长期存在：

数据质量指标的单一团队级视图

这种团队级视图显示了与行动呼叫相关的 DQ 指标，包括自动生成的工单、相关资源和工具链接——所有这些都是自助服务所需的。对于领导者而言，此视图提供了 DQ 问题的确切经济影响。

### 战术视图

当在总账中观察到问题时，DQ 得分会下降。虽然总账是底层系统的投影，但总账问题通常不是总账中的抄录或数据建模问题。它们主要揭示了系统实施、集成或实际货币流动的真正问题。在这些情况下，我们提供战术视图，以追溯问题根源，无论是在 Stripe 平台内部还是外部系统中。

考虑特定账户类型的未结清余额——必须开具和支付的处理费用。在稳态下，发票应该支付，余额为零，但随着时间的推移，我们观察到一个不清零的余额。

### 调查和归因

单击图中的某一点会在 Presto 中生成 SQL 查询（我们的特别SQL查询引擎），并呈现相关数据：参考键、元数据、所有权和提示信息。如果总账用户无法调试和发布校正——也许是因为根本原因与他们无法控制的基础设施或第三方事件有关——他们可以重新分配所有权给正确的内部利益相关者，并将其排除在警报之外。

当问题归因于已知事件时，我们可以回顾性地分析各团队在数据质量指标上的影响，以充分了解 Stripe 受到的影响：

综合来看，我们具备测量和分析数据质量、识别根本原因问题，并灵活地与底层数据结构交互的能力，以随时间管理我们的问题负载。在这种情况下，解决总账中的问题可能涉及重新发布来自源系统的数据。

### 数据校正

总账是我们的记录系统，必须保持真理的常青表现。持续存在的问题会降低对新问题的可见性，并可能导致不正确的报告或派生数据集。由于总账是事件不可变的日志，我们无法运行简单的查询来改变状态；相反，我们必须回退并重新处理之前的操作。如果发生事件，我们需要一种工具来规模化地纠正数据。

我们建立了一个支持性实用工具，用于创建并安全执行迁移，受到数据质量工具的保护，该工具会生成关于提议更改生产影响的带外报告。这些工具共同近似于用于特别数据修复操作的 CI 管道。所有操作必须经过数据及其相关 DQ 影响的两阶段审查和提交。

## 减少数据问题，提高报告的可靠性

我们的系统需要在混乱的现实中运作，但本文介绍的创新推动我们朝着可信和可解释的运营模型迈进。同样，随着企业和资金流动机制的不可避免的演变，Stripe有能力跟上这一变化的步伐。

DQ平台确保了跨所有Stripe业务线的可靠和及时的报告。结算、及时性和完整性指标的结合确保内部利益相关者可以就底层数据系统的正确性做出明智的判断，而无需担心维护复杂的专业知识。

数字经济将继续加速，我们的重点是构建强大和可扩展的系统来支撑它。未来，我们希望提高到分钟级别的时效性分析和响应能力，提供更低延迟的处理，这将增强欺诈检测并增加可用的响应时间，以解决可能的财务问题。

我们还在投资先进的丰富能力，使我们能够在保证符合我们数据质量标准的同时，以声明方式组合新数据集和报告界面。这项工作安全地推动了我们内部系统的复杂性与Stripe的增长相辅相成。

我们很高兴继续解决艰难而重要的问题。如果你也有兴趣，请考虑加入我们的[工程团队](https://stripe.com/jobs/search?query=engineer)。
