<!--yml

类别：未分类

日期：2024-05-27 14:42:40

-->

# 当“让它崩溃”不再足够

> 来源：[https://flawless.dev/essays/when-letting-it-crash-is-not-enough/](https://flawless.dev/essays/when-letting-it-crash-is-not-enough/)

# 当“让它崩溃”不再足够

在谈论计算机系统时，[Erlang/OTP](https://www.erlang.org)编程平台对于处理故障有着独特的方法。它也以“让它崩溃”闻名。这背后的核心思想与现代应用程序的多状态有关。你的应用程序越复杂，你需要跟踪的变量就越多。最终，开发者无法预测这些变量组合出现的所有状态。一旦你的应用程序陷入不良状态，最好的做法是重置它，并从一个已知且正确的状态重新开始。

这与Erlang的特性非常契合，即每个进程都有单独的内存空间。这使得我们可以有选择地重置应用程序的部分，同时保持整个系统运行。然后我们可以将应用程序分成类似树状结构，并不断重启其部分，直到达到根部并被迫重启整个系统。这个概念也被称为[监督树](https://www.erlang.org/doc/design_principles/des_princ)。

如果你仔细研究Erlang的方法，这正是人类会做的事情。如果你的手机在播放视频时卡住，你会尝试重启应用程序；如果这行不通，你可能会重启手机，甚至是家里的路由器。你本能地知道，通过你的家庭传播故障最终会将所有设备带入一个类似于你初始设置时一切正常的状态。

即使有时Erlang关于弹性和容错性的说法有些**[言过其实](https://stackoverflow.com/a/26447543)**，我仍然认为这是处理故障的一种非常有效的方式。如果我的Web应用程序崩溃，我首先会重启服务器。在大多数情况下，这会立即解决问题，而我会深入日志文件以找出问题的根源。在应用程序的每个抽象层面都具有这种自动重启能力，无疑会让你睡得更安心。

然而，仅仅重置状态几乎从来都不够。以手机为例，一旦手机重新启动，你仍然需要回到停止时的状态。这通常意味着重新找到视频并跳回正确的时间点。我们部分地重建了停止时的状态，但忽略了其他可能出错的所有状态，比如我们家里的互联网连接断开了。

对于人类来说，大致记住我们停止观看视频的位置很容易，但对于应用程序来说，如果没有开发者显式跟踪，重新构建状态是不可能的。如何快照您的状态，存储在哪里以及多频繁执行这些操作，都是非常困难的问题。即使进行非常频繁的快照，也可能在两次快照之间发生故障，导致数据丢失。在这样的系统中完全自信的唯一方式是捕获每个状态变化。

### 持久执行

这让我想到了我最近的一个发现，一种完全颠覆了我认知的处理失败的方法 🤯。它通常被称为持久执行，是处理“跟踪状态变化”问题的一个优雅解决方案，并且与 Erlang 的方法完美结合。

最简单的思考方式是将其视为计算进程的数据库。它存储最小量的数据，以便随时重构应用程序的状态。它使您的局部变量不可毁灭，并且对于许多场景，您甚至不再需要传统的数据库。

想象一下，如果您可以开始任意计算，并且系统保证它将运行直到完成，并且所有操作将被**精确执行一次**。即使您的应用程序需要在中途重新启动。或者即使您需要停止计算，将其移动到另一台机器并继续。您正在运行的代码突然变成了一种可触及的东西，您可以查看、移动和操作。

持久执行是一种更通用的技术，可以用于不同的用例，比如跨分布式服务的事务，或者非常长时间运行的作业（几个月）。但是底层的保证也使它成为创建快照的终极工具，以便在需要部分重启系统时可以继续之前的进度。

我一直在开发名为 **[flawless](https://flawless.dev)** 的持久执行引擎。它隐式地记录副作用的日志，因此您始终可以重构最新状态并继续上次中断的工作。它目前仍处于私人阶段，但我希望很快能向大家开放并分享。

~ [伯纳德](https://twitter.com/bkolobara)
