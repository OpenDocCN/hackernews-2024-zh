<!--yml

分类：未分类

日期：2024-05-27 14:29:40

-->

# 需要一个 C++ 未定义行为附录

> 来源：[https://community.intel.com/t5/Blogs/Tech-Innovation/Tools/Why-do-we-need-a-Undefined-Behavior-Annex-for-the-C-standard/post/1574397](https://community.intel.com/t5/Blogs/Tech-Innovation/Tools/Why-do-we-need-a-Undefined-Behavior-Annex-for-the-C-standard/post/1574397)

Intel 的开发软件工程师不仅在 Intel® oneAPI DPC++/C++ Compiler 的最新优化和改进上工作。我们还积极贡献于 Khronos Group 的 [SYCL*](https://www.khronos.org/sycl/)、[LLVM*](https://llvm.org/) 项目以及最新的 C 和 [C++ 语言标准](https://isocpp.org/std/the-standard)。

我们希望与软件工程社区分享 C 和 C++ 领域正在发生的详细情况，以及 Intel 如何积极贡献于最新的标准修订。

## 关于我们的 C/C++ 标准贡献的博客系列

为此，我们正在开始一系列新的博客文章，重点介绍 Intel 在 C 和 C++ 标准上的工作。

特别是，安全性和安全性是我们在下一个语言标准修订中工作的最活跃的焦点之一。本文将讨论为 C++ 标准创建非常必要的未定义行为附录的努力。这将加强功能确定性和安全性的编码标准，即使是对于不常见或未预料到的应用程序代码路径。

我们知道，[Intel® oneAPI DPC++/C++ Compiler](https://www.intel.com/content/www/us/en/developer/tools/oneapi/dpc-compiler.html) 用户社区和整个 oneAPI 和 C/C++ 社区的重点领域有几个。这是因为 C 和 C++ 是不断发展的语言。如果你不积极参与，很难跟上社区快速变化的步伐。Intel 的 C 和 C++ 编译器团队在这一进程中参与了多个点，通过参与标准化工作。

+   写提案

+   参加会议

+   担任委员会主席

+   提交开源贡献给 LLVM 和 Clang 编译器。

+   在整个社区中积极参与。

我们希望通过这种格式将我们与社区的互动推向一个新的水平，以鼓励关于 C 和 C++ 编程的最新发展和焦点的对话。

## 未定义行为情景附录

我是 Intel 的编译工程师 Shafik Yaghmour，支持 C++。我在 C++ 社区以多种形式积极参与：

这篇博客突出了我在 C++ 标准委员会的一些工作。

我的提案，[P1705R1: Enumerating Core Undefined Behavior](http://wg21.link/P1705R1) [2]，讨论了向 C++ 标准添加未定义行为附录。

调用*未定义行为*会导致各种不直观的后果，例如[删除安全检查](https://blog.regehr.org/archives/970)、[使有限循环无限](https://stackoverflow.com/questions/32506643/c-compilation-bug)、[布尔值既可以是false也可以是true](https://markshroyer.com/2012/06/c-both-true-and-false/)，而且显然[未定义行为甚至可以时间旅行](https://devblogs.microsoft.com/oldnewthing/20140627-00/?p=633) [3] 🤯。这些后果是不可取的，可能导致安全和安全问题。

## 未定义行为的安全影响

为了避免代码中未定义行为的后果，许多行业采用了两种策略：

1.  严格且有文档支持的动态功能安全性和安全攻击向量验证测试。监管机构通常要求在医疗设备、航空、制造业和汽车等安全敏感行业中进行此类测试。

1.  严格遵守编码标准（如MISRA和AUTOSAR），这可能限制开发人员利用最新的C++语言特性的能力。

开发人员这样做，因为未定义行为导致的非确定性功能结果可能意味着不仅财产的损失，还可能危及人们的安全！

因此我问自己：

+   如果我们利用C和C++的丰富且悠久的历史，并记录了未定义行为的案例，以定义一个明确、完整、权威的潜在未定义行为场景清单，以避免并推荐修复方法，那会怎样？

+   如果这个清单成为C++标准的一部分呢？

这可能为更广泛的用例引入新的功能安全和对抗许多安全漏洞的保护，而无需DOE-178或ISO 26262类型的限制性开销。

## 未定义行为的综合参考资料

目前，这个提议的关于*未定义行为*的综合参考资料还不存在。如果你是开发人员，试图理解需要避免的*未定义行为*，你必须参考2000多页的C++标准文档和20多年的缺陷报告。增加难度的是，文档中可能用几种不同的短语来描述*未定义行为*：

+   程序的行为是未定义的

+   行为未定义

+   导致未定义行为

+   行为是未定义的

+   具有未定义行为

+   是未定义的

+   结果具有未定义行为

然后，在找到每个*未定义行为*条目后，可能没有示例。因此，可能不清楚*未定义行为*的工作原理。即使对于非常了解C++的开发人员来说，这也是一项艰巨的任务。这也妨碍了工具开发人员构建使软件更安全的工具，以及软件安全和安全性研究人员。

我们也忽略 ***隐式未定义行为***，这是违反标准规则但没有明确指出为 *未定义行为* 的行为。它和显式的那种一样糟糕，但更难发现。

因此，*P1705R1* 的主要目标之一是创建一个 ***未定义行为附件*** 或者列出 ***显式* *未定义行为*** 在 C++ 标准中。每一条目都会包括以易于理解的语言描述和代码中的 *未定义行为* 示例。这应该让开发人员能够学习有关未定义行为的知识。尽管我们不指望日常开发人员自行查阅 C++ 标准，但这些材料将允许博客作者、会议演讲者和培训师开发更全面的涵盖 *未定义行为* 的资料。

这还将允许 C++ 委员会跟踪 *未定义行为* 的增长或减少。我们还将要求未来的提案作者保持附件的更新，如果他们添加或删除 *未定义行为*。他们正在使 *未定义行为* 成为审查提案时讨论的明确主题。这也为未来的提案作者提供了明确的目标，试图在标准中减少 *未定义行为*。

在最近一次提案审查中提出的另一个目标是，我们希望将隐式 *未定义行为* 转变为 ***显式未定义行为***。这需要识别 *隐式未定义行为*，然后让 [核心语言措辞组](https://isocpp.org/std/the-committee) 更新措辞，使行为明确为 *未定义*。这里的好处是我们记录更多 *未定义行为*。这也是一个机会来确定这是否是意图为此为 *未定义*，如果不是，则记录下来。

在 [P3075R0: 添加未定义行为和 IFNDR 附件](https://wg21.link/P3075R0) [4] 中，我还扩展了这个想法，包括添加一个不需要诊断的不规范附件（IFNDR）。*IFNDR* 与 *未定义行为* 的区别在于，尽管程序仍然是 *未定义* 的，但这是程序的 *静态属性而非运行时属性*。虽然这不像 *未定义行为* 那样有无限制的运行时后果，但它仍可能导致安全和安全问题，因为包含 *IFNDR* 的程序可能不会被诊断，并可能产生出乎意料的结果。

## 分享您的想法

我们期待您对提案 [P3075R0: 添加未定义行为和 IFNDR 附件](https://wg21.link/P3075R0) 的反馈。

您认为应该考虑什么？让我们共同努力推动 C++ 标准的发展，使其完全拥抱安全和安全范式。

请随时在下方留下评论。

### 参考资料

**[1]** S. Yaghmour，《什么是严格别名规则，为什么我们关心？》，Gist.GitHub，2020年

**[2]** S. Yaghmour，P1075R1：[列举核心未定义行为](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2019/p1705r1.html)，2019

**[3]** R. Chen，[未定义行为可能导致时间旅行](https://devblogs.microsoft.com/oldnewthing/20140627-00/?p=633)，Microsoft* DevBlogs，2014

**[4]** S. Yaghmour，P3075R0：[添加未定义行为和IFNDR附件](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2023/p3075r0.pdf)，2023

### 进一步阅读
