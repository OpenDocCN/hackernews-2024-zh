<!--yml

类别：未分类

日期：2024-05-27 14:31:40

-->

# 自顶向下编写代码

> 来源：[https://www.teamten.com/lawrence/programming/write-code-top-down.html](https://www.teamten.com/lawrence/programming/write-code-top-down.html)

# 自顶向下编写代码

有两种方法来设计程序和编写代码：自顶向下和自底向上。

*自顶向下*设计让你从整个程序的愿景开始，也许是一些组件的概念，以及它们如何组合在一起，但是组件本身仍然模糊不清。你实现一个调用组件简化版本（可能什么也不做）的高级程序，并逐步深入到每个组件的细节中。

*底向上*设计让你从组件开始，这些组件你能清楚地看到，但它们如何拼凑在一起尚不明确。你分别编写这些组件，对它们进行单元测试，然后将它们组装成一个完整的程序。

正确的程序设计和编写方式是自顶向下的。这不是品味或偏好的问题。自底向上的设计基本上是有缺陷的，你不应该使用它。我参与过的每个使用自顶向下方法的系统都取得了成功，而使用自底向上方法的系统都失败了。Edsger Dijkstra写了一篇[完整的独白](http://www.cs.utexas.edu/users/EWD/ewd02xx/EWD249.PDF)来探讨这个问题。我从未见过一位架构师提倡自底向上。

当你编写自底向上的代码时，你是在理解它们如何组合之前编写组件。这种方式有两个问题，一个小问题和一个大问题：

+   小问题在于，这些组件可能不适合这个任务。API可能不正确，或者组件的工作方式可能不正确，或者根本不需要这个组件。通过首先编写组件，你有可能浪费时间。

+   *底向上*编程的主要问题是，你最终得到的程序可能会*过于复杂*。在开发一个组件时，你不确定它将如何使用，因此很容易陷入过度泛化的诱惑。通用的解决方案比具体的解决方案更复杂。当最终将组件插入整个程序时，只需要特定用途，多余的复杂性永远不会被剔除；它将永远存在，不必要地增加了代码、负担和复杂性。而复杂性正是导致大型程序失败的原因。

假设你正在设计一个大型网站，一个大公司的在线商店。通过自顶向下编程，你可以从（例如）导入Tomcat开始，编写一个简单的几乎空白的servlet，并让它写“Hello world!”。现在你有了一个端到端的网站。你可以编译它，尝试它，并演示它。你甚至可以将其部署到生产环境。它有bug，因为它显示的是“Hello world!”而不是客户可以购买的商品。你通过添加一个模板引擎和一个简单的主页模板逐步修复这个bug。然后，你添加一个数据库调用来获取一组商品，并在模板中列出它们。然后添加一个购物车。然后是登录方式。每一步都有一个可运行但不完整的站点，并且每一步系统*做的事情都尽可能简单*。下一步该做什么是明确的，下一个组件需要什么也是明确的。

采用自底向上的编程方法，你开始考虑最终会得到哪些组件。你将需要一种方法来决定显示哪个页面，一种从后端服务获取数据的方法，以及一种渲染模板的方法。让我们来看看模板。你将使用哪种模板引擎？还不确定，所以最好用一个抽象层将其做成可插拔的。模板如何知道在哪里写入其输出？你甚至还没有选择Web容器。最好为此添加一个抽象层，并为模板的输入也添加一个抽象层。如何获取关于请求的信息，例如页面类型、cookie、语言、设备类型等？最好创建一个可插拔的可扩展系统，用于收集任意数据并将其存储在通用上下文对象中！当你开始将所有这些组件放在一起时，它们每个都做得太多、太复杂，而且太难理解和扩展。几乎所有的普遍性最终都未被使用，永远未被移除。

聪明的工程师自然倾向于自底向上的编程。设计一个组件是一个小而可行的任务，可以完成并称之为*完成*。你正在创建一个完美的、美丽的、可重用的宝石。所有工程师真正想要*做的*就是编写组件。自顶向下的方法没有这种好的特性；产品永远不完整。是的，对某些人来说，自顶向下可能不那么吸引人。不管怎样，也要去做。

大公司特别容易无意识地采用自底向上的方法。需要一个强大的个性来承担自顶向下应用的责任，建立足够的应用以查看组件，然后将组件分派给不同的团队。在组织上，猜测组件、分派它们并希望它们最终集成起来更容易。这就是为什么如此多的大型项目失败，为什么这些组件在使用之前就被废弃，以及为什么大公司似乎永远无法取得多少进展。

对于个体程序员而言，现代工具还鼓励自底向上的编程方式。例如，在像Eclipse这样的集成开发环境中，如果你要调用的类型和方法已经定义好，编写代码会更容易。但如果你首先定义了这些内容，那么你就是在进行自底向上的编程！在IDE中编写自顶向下的代码会导致其出现错误提示，直到你实现这些方法为止。在这种情况下，有持续的压力让你先编写被调用的函数。

最后，还有单元测试。当自底向上编写组件时，没有应用程序可以尝试它们，因此你被迫编写单元测试以确保它们正常工作。这是好事。而自顶向下编程时，你可以直接运行应用程序来查看组件是否正常工作。这时编写测试的压力较小，事实上，组件可能无法以便于编写测试的方式编写。这是自顶向下编程的一个不幸副作用，但总的来说我并不看好单元测试；其中大多数并不提供任何价值（参见[大多数情况下避免单元测试](mostly-avoid-unit-tests.html)）。对于那些有价值的测试，无论如何都要编写它们，尽管组件目前已经在应用程序中正常工作。

在每个层次都存在自底向上编程的压力。要避免这种情况。相反，从顶部开始，从`main()`函数或其等效部分开始编写代码，并假设所有部分都已经编写好。确保代码看起来正确。在你能够编译和运行代码之前，用桩代码或硬编码的方式填充部分内容。然后慢慢向下移动，*尽可能保持简单和直接*。不要编写不解决当前问题的代码。只有这样，你才有可能成功地编写出一个大型、运行良好且长寿的程序。
