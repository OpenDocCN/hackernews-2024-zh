<!--yml

ç±»åˆ«ï¼šæœªåˆ†ç±»

æ—¥æœŸï¼š2024-05-29 12:43:16

-->

# Flatpakæ„å»ºä¸å…·å¤‡å¤ç°æ€§ï¼Œè¿™æ˜¯ä¸€ä¸ªå®é™…é—®é¢˜

> æ¥æºï¼š[https://ranfdev.com/blog/flatpak-builds-are-not-reproducible/](https://ranfdev.com/blog/flatpak-builds-are-not-reproducible/)

<hgroup>

# Flatpakæ„å»ºä¸å…·å¤‡å¤ç°æ€§ï¼Œè¿™æ˜¯ä¸€ä¸ªå®é™…é—®é¢˜

## é˜…è¯»æ—¶é—´6åˆ†é’Ÿã€‚å‘å¸ƒæ—¥æœŸï¼š2022-05-09

</hgroup>

<details class="toc"><summary>ç›®å½•</summary></details>

## *æ›´æ–° 2022-05-10*

æˆ‘åˆšåˆšä¸ä¸€ä¸ªflatpakçš„è´¡çŒ®è€…äº¤è°ˆè¿‡ï¼Œä»–ç»™äº†æˆ‘æ›´å¤šå…³äºè¿™ä¸ªä¸»é¢˜çš„ä¿¡æ¯ã€‚flatpakåœ¨*æŠ€æœ¯ä¸Š* **æ˜¯å¯ä»¥å¤ç°çš„ï¼** æ‰€æœ‰é‡ç°æ„å»ºæ‰€éœ€çš„å…ƒæ•°æ®éƒ½å­˜åœ¨äºæ„å»ºçš„åŒ…ä¸­ **å†…éƒ¨**ã€‚

> å·²ç»ç”Ÿæˆäº†ä¸€ä¸ªé”å®šæ–‡ä»¶ï¼Œå¹¶ä¸”æ˜¯æœ€ç»ˆæ„å»ºçš„ä¸€éƒ¨åˆ†ã€‚æ‚¨å¯ä»¥åœ¨/runtimeä¸‹æ‰¾åˆ°å®ƒä»¬ï¼Œä½äº/usr/manifest.jsonå’Œ/app/manifest.jsonï¼Œåˆ†åˆ«ç”¨äºè¿è¡Œæ—¶å’Œåº”ç”¨ç¨‹åºã€‚

å®é™…ä¸Šï¼Œè¿™äº›æ–‡ä»¶ä¿®å¤äº†è¿è¡Œæ—¶ã€sdkå’Œå…¶ä»–ä¾èµ–é¡¹çš„ç¡®åˆ‡æäº¤ï¼š

```
[ğŸ“¦ org.gnome.Podcasts ~]$ cat /app/manifest.json {
 "id" : "org.gnome.Podcasts", "runtime" : "org.gnome.Platform", "runtime-version" : "41", "runtime-commit" : "a306cb5f76bba5e87223de4c98881ff65f32c2fba3dfac7af2673507d18dd741", "sdk" : "org.gnome.Sdk", "sdk-commit" : "be925b0b2a0092bd1372f130c72e7d2fffb53b238953469bb7943e75a0808bd7", ... } 
```

æ­¤å¤–ï¼Œä»–ä»¬æ‰¿è®¤å¹¶éä¸€åˆ‡éƒ½å®Œç¾ï¼Œä½†è¿™åªæ˜¯å› ä¸ºåœ¨æ‰€æœ‰åœ°æ–¹éƒ½å®ç°å¤ç°æ€§æ˜¯ä¸€ä¸ªéš¾é¢˜ï¼ˆå¯¹æ¯ä¸ªäººæ¥è¯´éƒ½æ˜¯ï¼‰ã€‚ä»–ä»¬æ­£åœ¨è·Ÿè¸ªå¤ç°æ€§çŠ¶æ€çš„é—®é¢˜ï¼Œå¹¶ä¸”è¿˜åœ¨ä¸è®¾è®¡ç”¨äºéµå®ˆå½’æ¡£æ³•è§„çš„å…¶ä»–æŠ€æœ¯åˆä½œï¼š

> Buildstreamï¼Œæˆ‘ä»¬ç”¨äºè¿è¡Œæ—¶ï¼Œä½†ä¹Ÿç”¨äºæ„å»ºendlessoså’Œè®¸å¤šåµŒå…¥å¼ç³»ç»Ÿçš„å·¥å…·ï¼Œåœ¨è¿™æ–¹é¢åšå¾—æ›´å¥½ã€‚å®ƒè¢«è®¾è®¡ç”¨äºèƒ½å¤Ÿå¤„ç†ä¾‹å¦‚æ±½è½¦è¡Œä¸šä¸­çš„å½’æ¡£æ³•è§„ï¼Œè¿™æ˜¯ä¸€ç§æ›´å¤ç°æ€§çš„æ–¹æ³•ã€‚

### ä½†æ˜¯...

è™½ç„¶é‡ç°æ„å»ºæ‰€éœ€çš„ä¿¡æ¯ç¡®å®å­˜åœ¨äºæ„å»ºçš„åŒ…å†…éƒ¨ï¼Œä½†**è¿™äº›ä¿¡æ¯æœªæäº¤åˆ°æºä»£ç æ ‘**ï¼Œè¿™å°±æ˜¯æˆ‘åœ¨åŸæ–‡ä¸­åˆ—å‡ºçš„é—®é¢˜ã€‚Flatpakæ˜¯å¯ä»¥å¤ç°çš„ï¼Œä½†åœ¨æ„å»ºå·¥å…·æ–¹é¢ä»æœ‰æ”¹è¿›çš„ç©ºé—´ï¼Œä»¥æå‡å¼€å‘è€…çš„ä½“éªŒã€‚

* * *

## ä»‹ç»

æ ¹æ®[flatpak.org](https://flatpak.org)ï¼Œ"Flatpakæ˜¯ä¸€ç§åœ¨Linuxä¸Šæ„å»ºå’Œåˆ†å‘æ¡Œé¢åº”ç”¨ç¨‹åºçš„å…ˆè¿›æŠ€æœ¯"ã€‚æˆ‘ç›¸ä¿¡flatpakæ­£åœ¨æˆä¸ºäº‹å®ä¸Šçš„æ ‡å‡†åº”ç”¨ç¨‹åºåˆ†å‘æ ¼å¼ï¼šåªéœ€æ‰“å¼€[flathub.org](https://flathub.org)çœ‹çœ‹å·²ç»æœ‰å¤šå°‘flatpakå¯ç”¨ï¼›å®ƒå¾—åˆ°äº†å¹¿æ³›çš„å‘è¡Œç‰ˆæ”¯æŒï¼Œå®Œå…¨å¼€æºï¼ˆç”šè‡³æ˜¯æœåŠ¡å™¨ç«¯ï¼‰ï¼›æ€»ä½“ä¸Šï¼Œå®ƒå¾—åˆ°äº†ç”¨æˆ·å’Œå¼€å‘è€…çš„é«˜åº¦èµèµã€‚æˆ‘å¸Œæœ›flatpakèƒ½å¤ŸæˆåŠŸï¼Œä½†æˆ‘è®¤ä¸ºä»–ä»¬åœ¨æŸäº›åŸºæœ¬äº‹é¡¹ä¸Šæé”™äº†ã€‚å¹¸è¿çš„æ˜¯ï¼Œè¿™äº›é—®é¢˜æ˜¯å¯ä»¥è§£å†³çš„ã€‚

è¦åˆ›å»ºä¸€ä¸ªflatpakï¼Œä½œä¸ºå¼€å‘è€…ï¼Œä½ éœ€è¦ä¸¤ä¸ªå·¥å…·ï¼š`flatpak` å’Œ `flatpak-builder`ã€‚

> "Flatpak-builderæ˜¯ä¸€ä¸ªä»æºä»£ç æ„å»ºflatpaksçš„å·¥å…·ã€‚"

è€Œ`flatpak`å·¥å…·åˆ™ä¸»è¦ç”¨äºå®‰è£…flatpakså’Œç®¡ç†flatpakä»“åº“ã€‚

## flatpakæ¸…å•

è¦æ‰“åŒ…flatpakåº”ç”¨ç¨‹åºï¼Œæ‚¨éœ€è¦å£°æ˜ä¸€ä¸ªæ¸…å•ï¼Œå³ä¸€ä¸ªJSONæ–‡ä»¶ï¼Œå°†ç”±`flatpak-builder`è¯»å–ã€‚æ­¤æ–‡ä»¶å¿…é¡»å£°æ˜æ‚¨çš„åº”ç”¨ç¨‹åºéœ€è¦çš„æ¯ä¸ªä¾èµ–é¡¹ï¼šè¿è¡Œæ—¶ï¼ˆä¸€ä¸ªå¸¸è§çš„è½¯ä»¶æ†ç»‘åŒ…ï¼‰ã€è¿è¡Œæ—¶æ‰©å±•ï¼ˆç”¨äºæ‰©å±•è¿è¡Œæ—¶çš„å¸¸è§è½¯ä»¶ï¼‰å’Œè‡ªå®šä¹‰ä¾èµ–é¡¹ã€‚

è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªï¼ˆç®€åŒ–çš„ï¼‰ä¾‹å­ï¼Œæ¥è‡ªæˆ‘çš„ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œ[Geopard](https://ranfdev.com/projects/geopard)ï¼š

```
{
  "app-id" : "com.ranfdev.Geopard.Devel",
  "runtime" : "org.gnome.Platform",
  "runtime-version" : "42",
  "sdk" : "org.gnome.Sdk",
  "sdk-extensions" : [
  "org.freedesktop.Sdk.Extension.rust-stable"
 ],  "command" : "geopard",
  "finish-args" : [
  "--share=ipc",
  "--socket=fallback-x11",
  "--socket=wayland",
  "--device=dri",
  "--share=network",
  "--filesystem=xdg-download/Geopard"
 ],  ...   "modules" : [
 {  "name" : "Geopard",
  "buildsystem" : "meson",
  "sources" : [
 {  "type" : "git",
  "url" : "../",
  "branch": "master"
 } ] } ] } 
```

## é—®é¢˜1ï¼šæˆ‘åº”è¯¥ä»å“ªé‡Œè·å–è¿è¡Œæ—¶ï¼Ÿ

`flatpak-builder`å°†è§£æå…ˆå‰çš„æ¸…å•å¹¶æŠ±æ€¨... è¿è¡Œæ—¶`org.gnome.Sdk`æœªå®‰è£…ï¼å¥½...ä½†æ˜¯æˆ‘åº”è¯¥ä»å“ªé‡Œä¸‹è½½è¿è¡Œæ—¶ï¼ŸFlatpakè½¯ä»¶æ˜¯ä»å­˜å‚¨åº“ä¸‹è½½çš„ï¼Œä½†åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå“ªä¸ªå­˜å‚¨åº“ï¼Ÿæ— æ³•ç¡®å®šï¼Œä½†å½“æ‚¨ä¸ç¡®å®šæ—¶ï¼Œåº”å§‹ç»ˆå°è¯•`https://flathub.org`ï¼Œè¿™æ˜¯æœ€å¤§çš„å…¬å…±å­˜å‚¨åº“ã€‚

å»ºç«‹åº“å¹¶å®‰è£…å…¶ä»–æ‰€éœ€è½¯ä»¶ï¼ˆè¯·æ³¨æ„ï¼Œæˆ‘ä»¬å¿…é¡»æ‰‹åŠ¨å®Œæˆï¼ï¼‰ï¼š

```
flatpak --user remote-add flathub https://flathub.org/repo/flathub.flatpakrepo flatpak --user install org.gnome.Platform//42 # I've manually added the version (stated in the manifest) as a suffix. # ... 
```

### è§£å†³æ–¹æ¡ˆ

æ¸…å•ä¸­åº”è¯¥æœ‰ä¸€ä¸ªâ€œreposâ€å­—æ®µï¼Œä»¥ä¾¿äººä»¬ï¼ˆå’Œå·¥å…·ï¼‰ç¡®åˆ‡çŸ¥é“ä»å“ªé‡Œè·å–ä¸œè¥¿ï¼šæ³¨æ„ï¼šæ­¤å­—æ®µä¸æ˜¯å¯é€‰çš„ã€‚**æ²¡æœ‰æ‰€éœ€å­˜å‚¨åº“çš„æ¸…å•åº”è¢«è§†ä¸ºæ— æ•ˆ**ã€‚

```
{
 "app-id" : "com.ranfdev.Geopard.Devel", "repos" : ["https://flathub.org/repo/flathub.flatpakrepo"], ... } 
```

## é—®é¢˜2ï¼šå®ƒçš„ç‰ˆæœ¬æ˜¯å¤šå°‘ï¼Ÿ

åœ¨å®‰è£…æ‰€éœ€çš„è¿è¡Œæ—¶å’Œæ‰©å±•æ—¶ï¼Œæˆ‘ä»¬å·²ç»åˆ°äº†è¿™ä¸€æ­¥ï¼š

```
$ flatpak --user install org.freedesktop.Sdk.Extension.rust-stable Looking for matchesâ€¦ Similar refs found for â€˜org.freedesktop.Sdk.Extension.rust-stableâ€™ in remote â€˜flathubâ€™ (user):   1) runtime/org.freedesktop.Sdk.Extension.rust-stable/x86_64/1.6 2) runtime/org.freedesktop.Sdk.Extension.rust-stable/x86_64/18.08 3) runtime/org.freedesktop.Sdk.Extension.rust-stable/x86_64/19.08 4) runtime/org.freedesktop.Sdk.Extension.rust-stable/x86_64/20.08 5) runtime/org.freedesktop.Sdk.Extension.rust-stable/x86_64/21.08   Which do you want to use (0 to abort)? [0-5]: 
```

å¥½é—®é¢˜... æˆ‘æƒ³ä½¿ç”¨å“ªä¸ªâ€œrefâ€ï¼Ÿ... æˆ‘ä¸çŸ¥é“ã€‚

### è§£å†³æ–¹æ¡ˆ

æ²¡æœ‰ç‰ˆæœ¬åç¼€çš„ref *å¿…é¡»* è¢«è§†ä¸ºæ— æ•ˆã€‚

æ— æ•ˆï¼š

```
{"sdk-extensions" : [
  "org.freedesktop.Sdk.Extension.rust-stable" ]} 
```

æœ‰æ•ˆï¼š

```
{"sdk-extensions" : [
  "org.freedesktop.Sdk.Extension.rust-stable//21.08" ]} 
```

## é—®é¢˜3ï¼šå¯é‡ç°æ€§

ç”±äºæ²¡æœ‰è¶³å¤Ÿçš„ä¿¡æ¯æ¥çŸ¥é“æ‰€éœ€çš„ä¾èµ–å…³ç³»ï¼Œå¾ˆæ˜æ˜¾æ²¡æœ‰å¯é‡ç°æ€§ã€‚å®˜æ–¹flatpakç½‘ç«™ä¸Šçš„æ–‡å­—è¯¯å¯¼ï¼šâ€œåœ¨ä¸ç”¨æˆ·ç›¸åŒçš„ç¯å¢ƒä¸­å¼€å‘å’Œæµ‹è¯•æ‚¨çš„åº”ç”¨ç¨‹åºã€‚â€ç”šè‡³å¼€å‘äººå‘˜éƒ½æ²¡æœ‰ä¸€è‡´çš„å¼€å‘ç¯å¢ƒã€‚

### è§£å†³æ–¹æ¡ˆ

ä¸€æ—¦`flatpak-builder`æˆåŠŸæ„å»ºæ¸…å•ï¼Œå®ƒåº”è¯¥å°†æ‰€ä½¿ç”¨çš„ç¡®åˆ‡ä¾èµ–é¡¹å†™å…¥é”å®šæ–‡ä»¶ã€‚è¿™ç§æ¨¡å¼å¯¹äºå…³å¿ƒå¯é‡ç°æ€§çš„æ¯ä¸ªè½¯ä»¶åŒ…ç®¡ç†å™¨éƒ½å¾ˆå¸¸è§ï¼šNixã€cargoã€npmç­‰ç­‰... æˆ‘æ˜ç™½`flatpak-builder`ä¸æ˜¯ä¸€ä¸ªè½¯ä»¶åŒ…ç®¡ç†å™¨ï¼Œä½†æ˜¯åœ¨flatpakæ„å»ºé“¾ä¸­çš„*æŸä¸ªä¸œè¥¿*åº”è¯¥åˆ›å»ºé”å®šæ–‡ä»¶ã€‚

æˆ‘ä¹Ÿæ˜ç™½ä¸ºä»€ä¹ˆäººä»¬å¯èƒ½å®é™…ä¸Š*ä¸æƒ³*é”å®šä»–ä»¬çš„è¿è¡Œæ—¶åˆ°ç‰¹å®šç‰ˆæœ¬ï¼šå¦‚æœè¿è¡Œæ—¶è¢«é”å®šï¼Œæ²¡æœ‰ç¨‹åºå‘˜çš„å¹²é¢„å°±æ— æ³•æ›´æ–°ï¼Œå› æ­¤åº”ç”¨ç¨‹åºæ— æ³•è‡ªåŠ¨é‡å»ºä»¥è·å–å®‰å…¨æ›´æ–°ã€‚è¿™ç¡®å®æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œä½†å¯ä»¥é€šè¿‡è½¯ä»¶å­˜å‚¨åº“è½»æ¾è§£å†³ï¼Œæ–¹æ³•æ˜¯ç®€å•åœ°è¦†ç›–é”å®šæ–‡ä»¶ã€‚è¿™æ ·ï¼Œå¼€å‘äººå‘˜å°±å¯ä»¥è·å¾—å¯é‡ç°çš„è°ƒè¯•æ„å»ºï¼ˆä»¥ä¾¿å®é™…ä¸Šå¯ä»¥è¿½è¸ªé”™è¯¯ï¼‰ï¼Œè€Œç”¨æˆ·å¯ä»¥æ¥æ”¶å®‰å…¨æ›´æ–°ã€‚è¿™ä»ç„¶æ¯”ç°åœ¨å¥½ã€‚

## ç»“è®º

è¿™äº›ï¼ˆæ¦‚å¿µä¸Šï¼‰æ˜¯ç®€å•çš„è§£å†³æ–¹æ¡ˆï¼Œä½†æˆ‘è®¤ä¸ºå®ƒä»¬å¯ä»¥æå¤§åœ°æ”¹å–„ Flatpak ç”Ÿæ€ç³»ç»Ÿã€‚Nix å’Œ Guixï¼Œè¿™ä¸¤ä¸ªæœ€å…ˆè¿›çš„åŒ…ç®¡ç†å™¨ï¼Œå·²ç»è§£å†³äº†è¿™äº›é—®é¢˜ã€‚Flatpak æ­£åœ¨å°è¯•æˆä¸ºæ—¢æ˜¯åŒ…ç®¡ç†å™¨åˆæ˜¯åº”ç”¨åˆ†å‘ç³»ç»Ÿã€‚åè€…éƒ¨åˆ†å¾ˆå¥½ï¼Œå‰è€…éƒ¨åˆ†åªæ˜¯â€¦â€¦ ç³Ÿç³•ã€‚

* * *

ç‰ˆæƒï¼šRanfdev 2019-2023
