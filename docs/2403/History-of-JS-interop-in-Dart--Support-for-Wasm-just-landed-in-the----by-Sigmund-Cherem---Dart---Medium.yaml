- en: <!--yml
  id: totrans-split-0
  prefs: []
  type: TYPE_NORMAL
- en: 'category: 未分类'
  id: totrans-split-1
  prefs: []
  type: TYPE_NORMAL
- en: 'date: 2024-05-29 12:48:59'
  id: totrans-split-2
  prefs: []
  type: TYPE_NORMAL
- en: -->
  id: totrans-split-3
  prefs: []
  type: TYPE_NORMAL
- en: History of JS interop in Dart. Support for Wasm just landed in the… | by Sigmund
    Cherem | Dart | Medium
  id: totrans-split-4
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 来源：[https://medium.com/dartlang/history-of-js-interop-in-dart-98b06991158f](https://medium.com/dartlang/history-of-js-interop-in-dart-98b06991158f)
  id: totrans-split-5
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: History of JS interop in Dart
  id: totrans-split-6
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Support for Wasm just landed in the current Flutter beta, thanks to an exciting
    JavaScript interop milestone reached in Dart 3.3\. To celebrate, we’re taking
    a look back at the decade-long journey of Dart and JS interoperability.
  id: totrans-split-7
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: AI Image generated by Gemini
  id: totrans-split-8
  prefs: []
  type: TYPE_NORMAL
- en: Interoperability has been a core focus from the beginning of Dart. When Dart
    was first released in 2011, it was designed to be *embeddable* and *multi-platform*.
    It ran on a standalone virtual machine, embedded in a browser, and compiled to
    JavaScript. When Flutter came along in 2015, we were ready to embed it there,
    too. Now, we’re excited to [target WasmGC runtimes](https://docs.flutter.dev/platform-integration/web/wasm),
    as well.
  id: totrans-split-9
  prefs: []
  type: TYPE_NORMAL
- en: 'At first, we worked quickly to expose the capabilities of each platform where
    Dart was embedded. That’s how our SDK platform-specific libraries emerged: `[dart:io](https://api.dart.dev/stable/dart-io/dart-io-library.html)`
    exposed the file system on the VM, `[dart:html](https://api.dart.dev/stable/dart-html/dart-html-library.html)`
    exposed the browser APIs on the web, and so on. These libraries looked and felt
    like regular Dart libraries, but behind the scenes hid some sophisticated low-level,
    native primitives to make them work. This was the very first form of interop we
    ever invented. It was expressive, but restricted to only SDK libraries.'
  id: totrans-split-10
  prefs: []
  type: TYPE_NORMAL
- en: On the web, developers needed access to more than just browser APIs. So we started
    looking at ways to open interoperability to cover more targets. As a starting
    point, we introduced `[dart:js](https://codereview.chromium.org//15782009)` in
    2013 to enable access to JavaScript libraries.
  id: totrans-split-11
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  id: totrans-split-12
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: '[PRE1]'
  id: totrans-split-13
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: We knew then that `dart:js` was not the programming model we wanted. You had
    to use strings to access names from JavaScript — forget about finding issues at
    compile-time, and don’t even think about code completion! The implementation was
    expensive, too. It heavily relied on boxes and deep copies for most operations.
    So we continued [drafting](https://github.com/dart-archive/js-interop-deprecated)
    ideas in 2014 and 2015 until v0.6 of `package:js` was released.
  id: totrans-split-14
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  id: totrans-split-15
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'With `[package:js](https://pub.dev/documentation/js/latest/)` we finally had
    an open API that was efficient and user friendly. You could sprinkle some annotations
    on abstract classes, and *voila,* you had access to JavaScript APIs. It all worked
    like magic, until it didn’t. There was a lot you couldn’t do with `package:js`:
    accessing browser APIs directly, renaming members, conversions, attaching Dart
    logic, and [more](https://github.com/dart-lang/sdk/issues/35084). To compensate,
    we also shipped `[dart:js_util](https://codereview.chromium.org/2150313003/)`
    — a lightweight and efficient low-level API similar to `dart:js`, as a fallback.
    All the limitations in `package:js` really bothered us, but our hands were tied.
    We needed more from the Dart language to do better.'
  id: totrans-split-16
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 `[package:js](https://pub.dev/documentation/js/latest/)`，我们最终拥有了一个高效且用户友好的开放式
    API。您可以在抽象类上添加一些注解，*voila*，即可访问 JavaScript API。一切都像魔术一样运行良好，直到不行为止。使用 `package:js`
    有很多限制：无法直接访问浏览器 API、重命名成员、转换、附加 Dart 逻辑及其他 [更多](https://github.com/dart-lang/sdk/issues/35084)。为了弥补这些不足，我们还发布了
    `[dart:js_util](https://codereview.chromium.org/2150313003/)` —— 一种轻量且高效的低级 API，类似于
    `dart:js`，作为备用方案。`package:js` 中的所有限制确实让我们很困扰，但我们束手无策。我们需要 Dart 语言的更多支持才能做得更好。
- en: Around that time, we were already working on the biggest change to the language
    we have ever made — we were making Dart [sound](https://dart.dev/language/type-system#what-is-soundness).
    Ironically, when we released the new type system with Dart 2.0 in 2018, interoperability
    got *worse*! Beyond those early limitations, that magic that made `package:js`
    special had a dark side — it couldn’t check the validity of types. This meant
    that our interoperability was a source of unsoundness in our otherwise sound language.
  id: totrans-split-17
  prefs: []
  type: TYPE_NORMAL
  zh: 大约在那个时候，我们已经在进行我们有史以来最大的语言改进 — 我们正在使 Dart 变得 [sound](https://dart.dev/language/type-system#what-is-soundness)。具有讽刺意味的是，当我们在2018年发布了新的类型系统
    Dart 2.0 时，互操作性变得 *更差*！超出了这些早期的限制，使 `package:js` 特殊的魔力也有了一个阴暗面 — 它无法检查类型的有效性。这意味着我们的互操作性在我们本来就是完全类型安全的语言中成为了不安全的源头。
- en: Then, our journey changed to focus on improving both Dart and JS-interop as
    a concerted effort. With clear principles (be idiomatic, expressive, compositional,
    precise, approachable, pragmatic, non-magical, and complete) we steered towards
    a design that anchored on typing and static dispatching, and that challenged the
    Dart language. What followed was a side-by-side evolution.
  id: totrans-split-18
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，我们的旅程转向专注于共同改进 Dart 和 JS-interop。遵循明确的原则（成为惯用的、表达力强的、组合的、精确的、平易近人的、务实的、非魔法的和完整的），我们朝着一种依赖于类型和静态调度的设计前进，挑战
    Dart 语言。接下来是并行的演进。
- en: In 2019, Dart 2.7 added static extension methods. You could attach custom Dart
    logic to a JS-interop class and convert values, like a JS `Promise` into a Dart
    `Future`, without using wrappers.
  id: totrans-split-19
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在2019年，Dart 2.7 添加了静态扩展方法。您可以将自定义的 Dart 逻辑附加到 JS-interop 类上，并转换值，例如将 JS 的 `Promise`
    转换为 Dart 的 `Future`，而无需使用包装器。
- en: In 2021, we released `@staticInterop` with `package:js` v0.6.4\. At last, JS-interop
    was expressive enough — you could expose browser APIs that previously were exclusively
    managed by SDK libraries like `dart:html`.
  id: totrans-split-20
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在2021年，我们发布了 `@staticInterop` 与 `package:js` v0.6.4。最后，JS-interop 变得足够表达力强 ——
    您可以公开之前由 SDK 库如 `dart:html` 独家管理的浏览器 API。
- en: In 2023, when we dropped unsound null safety in Dart 3.0, we could finally see
    the progress we had made, our designs and `@staticInterop` work made it clear
    we were ready to address the soundness gap we had for so long.
  id: totrans-split-21
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在2023年，当我们在 Dart 3.0 中放弃了不安全的空安全性时，我们终于看到了我们所取得的进展，我们的设计和 `@staticInterop` 的工作清楚地表明，我们已经准备好解决我们长期以来存在的声音差距。
- en: That year, we introduced compilation to WasmGC and leveraged JS-interop to run
    rich frameworks like [Flutter web](/flutter/whats-next-for-flutter-b94ce089f49c)
    on it. This sparked work on [JS Types](https://dart.dev/interop/js-interop/js-types)
    to clearly define the Dart and JS boundary in the programming model and find a
    consistent way to work with JS in both Wasm and JS compilation targets. We also
    started the [extension types](https://dart.dev/language/extension-types) language
    experiment — a feature launched in Dart 3.3 that bridges the gap between the Dart
    language and JS-interop. For years, JS-interop had behaviors, like type erasure,
    that didn’t match anything else in Dart. With extension types, JS-interop could
    finally be idiomatic and get the support it deserves in Dart development tools.
  id: totrans-split-22
  prefs: []
  type: TYPE_NORMAL
  zh: 那一年，我们引入了对 WasmGC 的编译，并利用 JS-interop 在其上运行像 [Flutter web](/flutter/whats-next-for-flutter-b94ce089f49c)
    这样的丰富框架。这促使了 [JS Types](https://dart.dev/interop/js-interop/js-types) 的工作，明确定义了
    Dart 和 JS 在编程模型中的边界，并找到了在 Wasm 和 JS 编译目标中与 JS 一致工作的方法。我们还开始了 [extension types](https://dart.dev/language/extension-types)
    的语言实验 —— 这是 Dart 3.3 中推出的一个功能，它弥合了 Dart 语言与 JS-interop 之间的差距。多年来，JS-interop 有一些行为，如类型擦除，与
    Dart 中的其他内容不匹配。有了扩展类型，JS-interop 最终可以成为惯用的，得到在 Dart 开发工具中应有的支持。
- en: 'Despite the many shifts and turns along the way, one thing remained consistent
    throughout the entire decade: the active engagement of our Dart community. Community
    members took early steps testing and contributing to `dart:js`, then later influencing
    the design of `package:js`. They wrote tools to address feature gaps (`[package:js_wrapping](https://github.com/a14n/dart-js-wrapping)`),
    and experimented with ways to improve productivity by autogenerating Dart APIs
    (`[package:js_facade_gen](https://github.com/dart-archive/js_facade_gen)`, `[package:js_bindings](https://pub.dev/packages/js_bindings)`,
    `[package:typings](https://pub.dev/packages/typings)`). Each contribution helped
    make Dart’s interop design better. To each of you out there, thank you for making
    this such an exciting adventure!'
  id: totrans-split-23
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管历经多次变化，但整个十年中有一件事始终如一：我们 Dart 社区的积极参与。社区成员早期就开始测试和贡献 `dart:js`，后来影响了 `package:js`
    的设计。他们编写了工具来解决功能差距（`[package:js_wrapping](https://github.com/a14n/dart-js-wrapping)`），并尝试通过自动生成
    Dart API（`[package:js_facade_gen](https://github.com/dart-archive/js_facade_gen)`、`[package:js_bindings](https://pub.dev/packages/js_bindings)`、`[package:typings](https://pub.dev/packages/typings)`）来提高生产力。每一份贡献都帮助改进了
    Dart 的互操作设计。感谢你们每一个人，让这段旅程如此激动人心！
- en: Finally, here we are in 2024\. We released `[dart:js_interop](https://dart.dev/interop/js-interop)`
    in Dart 3.3 together with `[package:web](https://dart.dev/interop/js-interop/package-web)`,
    the newest solutions for JS interop in Dart that make compiling [Flutter to Wasm](https://docs.flutter.dev/platform-integration/web/wasm)
    possible.
  id: totrans-split-24
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，现在是 2024 年。我们在 Dart 3.3 中发布了 `[dart:js_interop](https://dart.dev/interop/js-interop)`，连同
    `[package:web](https://dart.dev/interop/js-interop/package-web)`，这是 Dart 中用于 JS
    互操作的最新解决方案，使得将 [Flutter 编译到 Wasm](https://docs.flutter.dev/platform-integration/web/wasm)
    成为可能。
- en: '[PRE3]'
  id: totrans-split-25
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: '`dart:js_interop` is a static, sound, idiomatic, expressive, and consistent
    form of interop based on extension types that is capable of exposing any JavaScript
    or browser APIs.'
  id: totrans-split-26
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`dart:js_interop` 是一种基于扩展类型的静态、健全、表达力强且一致的互操作形式，能够暴露任何 JavaScript 或浏览器 API。'
- en: '`package:web` uses `dart:js_interop` to do what `dart:html` once did 13 years
    ago, but in a way that is supported both in JavaScript and WasmGC.'
  id: totrans-split-27
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`package:web` 使用 `dart:js_interop` 来完成 13 年前 `dart:html` 的工作，但以一种既支持 JavaScript
    又支持 WasmGC 的方式进行。'
- en: Today, we are excited to celebrate a new form of Dart/JS interop and the future
    it enables. Knowing our past, we are certain this isn’t the end of the journey,
    but an exciting point in our history.
  id: totrans-split-28
  prefs: []
  type: TYPE_NORMAL
  zh: 今天，我们很高兴庆祝 Dart/JS 互操作的新形式及其所带来的未来。了解我们的过去，我们可以肯定，这不是旅程的终点，而是我们历史上一个激动人心的时刻。
- en: We can’t wait to see what you’ll build with it!
  id: totrans-split-29
  prefs: []
  type: TYPE_NORMAL
  zh: 我们迫不及待想看到你们将用它来构建什么！
