<!--yml

category: 未分类

date: 2024-05-27 15:00:00

-->

# QUIC的扩展并非一蹴而就 [LWN.net]

> 来源：[https://lwn.net/Articles/964377/](https://lwn.net/Articles/964377/)

| **LWN订阅者的好处**[订阅LWN](/subscribe/)的主要好处是帮助我们继续出版，此外，订阅者可以立即访问所有站点内容并使用许多额外的站点功能。请立即注册！ |
| --- |

作者：**Daroc Alden**

2024年3月6日

[QUIC](https://zh.wikipedia.org/wiki/QUIC)是基于UDP的传输协议，是[HTTP/3](/Articles/814522)的基础。它最初在2012年由Google开发，并于2021年成为[IETF](https://www.ietf.org/)标准。然而，该协议的标准化并未停止工作。[QUIC工作组](https://quicwg.org/)发布了几个后续标准。现在，他们正在致力于QUIC的四个扩展，旨在修补当前协议的各种缺陷 — 虽然进展并不迅速。

QUIC作为TCP和TLS的替代方案，具有多个有趣的优点。通过结合建立连接和加密的握手过程，QUIC可以减少应用程序在发送数据前需要的往返次数 — 在某些情况下甚至可以减少到零。将加密与传输层结合还允许QUIC隐藏中间路由器（“中间盒”）的连接细节。QUIC还支持在相同底层连接上发送多个独立的流。这种能力对于像Web服务器这样的应用程序非常有用，它们希望在不同流中传输相关资源，而不会因为一个流中的丢包而延迟其他流 — 这是TCP中已知的[线头阻塞](https://zh.wikipedia.org/wiki/%E5%85%B3%E5%8D%A1%E9%98%BB%E6%96%AD)问题。

#### 负载平衡

QUIC的一个有趣特性是[连接迁移](https://www.rfc-editor.org/rfc/rfc9000.html#name-connection-migration)，允许计算机在保持连接的同时无缝更改IP地址。QUIC数据包都包含连接标识符，可用于确定数据包所属的连接，即使其来源地址与预期不同。这对于负载均衡器构成挑战，因为它们通常根据源地址和目标地址的IP地址和端口号确定如何转发数据包。连接标识符是数据包中为数不多的未加密部分之一，以允许服务器确定应使用哪个加密密钥 — 因此，QUIC感知负载均衡器可以使用连接标识符替代，但这与QUIC的另一个方面[连接标识符轮换](https://www.rfc-editor.org/rfc/rfc9000.html#name-privacy-implications-of-con)相互作用不佳。

QUIC允许服务器为特定连接向客户端提供一组连接ID池，以减少"<q>可链接性</q>"。如果一个QUIC连接长时间保持开放 —— 比如因为正在进行一个持续的电话呼叫 —— 攻击者可以利用数据包的连接ID跟踪用户在不同网络间的移动。为了缓解这一问题，客户端如果知道即将切换网络（比如因为即将从蜂窝连接切换到WiFi），可以在切换时开始使用来自池中的新连接ID。而服务器则知道它为客户端提供了哪些连接ID，可以继续服务连接而无需中断。

任何未参与连接的实体看到的是源IP地址、端口号和连接ID同时变化，这使得识别新数据流作为同一连接的一部分变得困难。不幸的是，这包括位于服务器前端的任何负载均衡器，它们无法识别应将数据包路由到处理初始请求的同一服务器。

QUIC工作组正试图通过[a new standard](https://quicwg.org/load-balancers/draft-ietf-quic-load-balancers.html)来增强负载均衡，安全地在连接ID中编码负载均衡信息。使用这一新标准的服务器通过结合服务器ID和[cryptographic nonce](https://en.wikipedia.org/wiki/Cryptographic_nonce)来创建连接ID，然后使用与负载均衡器共享的密钥对生成的字符串进行加密。这个密钥需要由配置系统的人员提供给服务器和负载均衡器。当负载均衡器接收到数据包时，它会尝试解密连接ID，然后将数据包转发给相关的服务器。该标准还包括处理版本更新或密钥迁移的规定。

2023年6月，新标准的一位作者之一Martin Duke [表示](https://mailarchive.ietf.org/arch/msg/quic/QBT4XU9NWVWRhmJA7ys61doCFHk/)，草案"<q>基本已经准备好了，但我们暂时搁置它，直到它在某处得到部署</q>"。自那时以来进行了几处小修改，但目前尚不清楚草案何时准备好迈向IETF标准的下一步：即被提议给互联网工程指导组（IESG）进行审议。

#### 多路径

在几个方面，TCP仍然比QUIC具有优势。其中之一是[multipath support](/Articles/544399)。Multipath TCP连接可以同时通过不同的网络路径发送数据 —— 例如，通过WiFi和蜂窝数据 —— 以提供比单独任何一条路径更好的吞吐量。

[正在进行中的QUIC多路径扩展](https://quicwg.org/multipath/draft-ietf-quic-multipath.html)将调整QUIC的连接迁移机制，允许同时使用多条路径。目前，当计算机开始在新路径上发送现有连接的数据包时，这被视为应该放弃之前的路径的信号。如果使用了`enable_multipath`选项建立连接，则在新路径上发送数据包会将该路径添加到连接中，并允许同时使用两条路径。

一个复杂性在于网络地址转换（NAT）重新绑定。QUIC通过源和目标的IP地址和端口来识别路径。不幸的是，对于给定的路径，这些参数并不总是稳定的。一些路由器执行NAT，允许多台计算机共享单个IP地址。当TCP连接通过这样的路由器时，路由器可以观察TCP会话建立，并保持将同一外部端口映射到相同的内部IP地址，直到连接结束。

这种方法在QUIC中不起作用有两个原因。首先，QUIC是一个相对较新的协议，许多现有的路由器没有处理它的代码。其次，QUIC加密了连接的许多细节，以避免干扰和减少可链接性。这意味着NAT需要回退到用于其他UDP协议的非连接感知方法：在看到出站数据包时建立映射，然后在超时后清除该映射。一个负载过重的计算机、丢失的数据包或错误配置的NAT可能会导致超时到期，尽管有活跃的QUIC连接。这反过来导致NAT选择为下一个数据包选择不同的出口端口，使路径看起来发生了变化。

在现有的QUIC中，服务器会将其视为连接迁移，并继续工作正常。使用多路径扩展后，服务器会将新路径添加到连接中，但仍会在旧路径上发送一些数据，这些数据将被NAT丢弃。为了克服这一问题，多路径QUIC *要求*客户端在切换到新路径时使用新的连接ID，如上所述。因此，如果服务器看到使用相同连接ID的路径更改，它可以将更改视为NAT重新绑定事件，并停止向旧地址发送数据包。

另一个问题是数据包编号和加密。当加密数据包内容时，QUIC 使用连接中每个数据包的数据包编号作为加密的密码。但是在使用多个同时路径时，数据包编号变得更加复杂。为了简化实现，多路径扩展的作者选择对连接中每个路径使用单独的数据包编号集。这反过来又需要对数据包的加密方式进行更改，以防止任何 nonce 被多次使用。

还有其他几个需要解决的考虑因素，以确保多路径 QUIC 的可行性。草案已经经历了多轮修订，并且仍然在工作组的开发中。计划在即将到来的三月 IETF 会议上更详细地讨论此问题的 [会话](https://datatracker.ietf.org/meeting/119/agenda.txt)。

#### 确认频率

由于 QUIC 被设计为 TCP 的替代品，它需要自行处理数据完整性和拥塞控制。为了确保所有发送的数据都能接收到，QUIC 连接的两端都会发送确认消息。目前，这些消息每发送两个数据包发送一次。这是在发送确认过快（浪费资源）和发送过慢（阻碍拥塞控制算法及时响应网络变化）之间的一种妥协。

不幸的是，并非每个 QUIC 连接都有相同的需求。一些不对称的互联网连接在发送数据包时降低了接收带宽，使得确认变得更加昂贵。一些设备有电池功耗或传输频率的限制。一些设备通过可靠的路径连接，这些路径没有明显的抖动或丢包。处于这些情况下的设备将从发送更少的确认中受益。

不幸的是，发送更少的确认不能单方面实现，因为连接另一端的计算机会解释这意味着数据应该被重新传输，或者至少路径的往返时间比实际情况要差得多。但是，如果连接中的另一方预期会省略确认，那么省略确认仍然可以起作用。

草案 [确认频率](https://quicwg.org/ack-frequency/draft-ietf-quic-ack-frequency.html) 扩展允许连接中的参与者请求更改确认机制。使用该扩展的系统可以设置在发送确认之前可以发生的最大数据包数量或时间量。

该扩展还添加了一个`IMMEDIATE_ACK`消息，显式请求连接的另一端在接收到消息后发送确认。文档的大部分内容用于详细说明在何时实现可能希望使用`IMMEDIATE_ACK`消息，以确保延迟确认不会引起不必要的减速。

扩展理论上已准备好进入标准化的下一步，因为其最后的评论征求在2023年10月结束，没有引发另一次修订。然而，扩展的作者们并没有继续进行IETF标准化过程的下一步，[导致](https://mailarchive.ietf.org/arch/msg/quic/Z5fBhljh2BL9X8C3AFInR3c3GBA/)工作组成员之一Gorry Fairhurst在二月中旬的邮件列表上提问：“这篇文档是已经完成了还是在等待基于问题的行动？”但是并未收到任何回应。

#### 部分交付

QUIC允许在同一连接上复用分开的流，可以独立失败 — 例如，在视频会议中，一个参与者有问题而其他人没有。当只有一个流遇到问题时，服务器可以发送`RESET_STREAM`消息，向客户端信号表明特定流受到影响。当这种情况发生时，QUIC规定客户端应丢弃到目前为止接收到的该流的任何数据，并且服务器不应对数据的重传请求做出响应。

对于像[draft WebTransport标准](https://datatracker.ietf.org/doc/html/draft-ietf-webtrans-http3-08)这样的协议来说，发送一些必须在流上可靠接收的初始数据，但仍希望流可以重置，这是一个问题。QUIC工作组正在通过[draft QUIC扩展](https://quicwg.org/reliable-stream-reset/draft-ietf-quic-reliable-stream-reset.html)来处理这种用例，该扩展定义了一个`RESET_STREAM_AT`消息。这将允许服务器重置一个流，同时指定在特定偏移之前的数据应保留或在传输中丢失时重新请求。

这份草案 [几乎已经准备好](https://datatracker.ietf.org/doc/draft-ietf-quic-reliable-stream-reset/) 成为一个已发布的标准，最后的评论征求在2月8日结束。在标准提交到IESG进行可能的发布之前，IETF规定了一些额外的流程，所以可能还需要一些时间才能被采纳。

#### 结论

这些对QUIC的潜在改进有望使协议更加实用和高效，尤其是对于具有非对称或间歇性可用链路的设备。不幸的是，这些改进的进展并不算快。长期贡献者Christian Huitema对工作组的进展[表达了不满](https://www.privateoctopus.com/2024/02/28/long-slow-path-to-quic-multipath.html)：

> 在过去，IETF倾向于找到一个足够好的解决方案，发布它，积累经验，然后在以后修订标准以填补空白。如果我们按照那个流程，可能去年或者前年就已经发布了QUIC多路径RFC，草案6肯定足够好，之前的草案可能也还行。但我们决定在批准草案之前讨论所有细节。结果可能会更好，尽管更早积累经验也有助于提高质量。无论如何，这个过程并不快速。

目前还不确定IETF完成新标准的时间。与此同时，QUIC的采用率正在[增长](https://pulse.internetsociety.org/technologies)，各大主流浏览器都以某种形式支持[QUIC](https://caniuse.com/http3)。QUIC设计者的一个关键考虑是避免[协议僵化](/Articles/745590)，但如果标准化进程的缓慢性妨碍了协议的进一步改进，那么QUIC的抗僵化设计选择可能无济于事。

* * *

(

[登录](https://lwn.net/Login/?target=/Articles/964377/)

发表评论)
