<!--yml

分类：未分类

日期：2024-05-27 15:04:41

-->

# 一个新的无服务器Postgres平台

> 来源：[https://xata.io/blog/serverless-postgres-platform](https://xata.io/blog/serverless-postgres-platform)

从今天开始，Xata数据库和分支也是无服务器Postgres数据库。这意味着你可以使用任何Postgres客户端连接到它们，并通常像使用任何其他Postgres数据库一样使用它们，同时**仍然保留**你喜欢Xata的一切：即时DB/分支创建，零冷启动，无活动暂停/睡眠，全文搜索引擎，文件附件等等。是的，Xata的免费套餐也适用于Postgres数据库，使其成为行业中最慷慨的Postgres免费套餐之一。

使这一切成为可能是一个有趣的技术挑战，并且是几个与Postgres相关的项目的结合结果。我们将在本博文中详细介绍。

新的启用了Postgres的数据库正在公开测试版中，你现在可以按照下面的说明尝试它们。

在Xata中启用Postgres连接

测试版

Xata现在允许直接连接到Postgres。要启用它，请按照以下步骤进行：

* * *

2

创建一个启用了Postgres的全新数据库

3

在你的项目中使用我们的API的`@next`版本

`npm install -g @xata.io/cli@next`

`npm install @xata.io/client@next`

* * *

检查Postgres的[文档](/docs/postgres)以获取详细信息和故障排除。

如果你之前没有听说过Xata，让我们从一些介绍开始。在2022年11月，我们[发布](https://xata.io/blog/xata-public-release)了Xata数据库服务，旨在为数据库提供尽可能好的开发者体验。那时，我们感到现代开发者工作流程、API和整体体验方面的数据库有点落后。因此，我们从头开始重新思考，而不局限于任何现有的数据库技术。

我们将我们的产品想象为Airtable和传统数据库之间的中间地带，并且我们认为我们在坚持这一愿景方面做得相当好。就像在Airtable中一样，“x数据库”可以立即启动，具有丰富的类型，没有冷启动，永不暂停。就像在传统数据库中一样，它们没有行限制，具有ACID事务，具有具有参照完整性的约束，并且性能高效。

从那时起，成千上万的开发者发现了Xata，并积极在他们的应用程序中使用它，并给了我们非常宝贵的反馈。我们的[社区](https://xata.io/blog/tags/community)的开发者们赞赏Xata的易用性，快速迭代的能力，以及它更像是一个SaaS产品而不是另一个DBaaS的感觉。

在过去的一年中，我们继续发布功能，展示了数据库平台价值，而不是 DBaaS。从新的类似 git 的[开发工作流](https://xata.io/blog/workflow-github-vercel-netlify-xata)，通过我们的分支功能进行模式更改，到[文件附件](https://xata.io/blog/file-attachments)，使得在数据库中作为列处理文件和图像变得轻松。这些功能引起了[很多](https://x.com/rauchg/status/1651614599874252802?s=20)[激动](https://news.ycombinator.com/item?id=37324370)。

最后但同样重要的是，我们已经开源了[pgroll](https://github.com/xataio/pgroll)，这是一个为任何 PostgreSQL 数据库提供零停机和可逆架构迁移的工具。这也引起了广泛的[关注](https://news.ycombinator.com/item?id=37752366)和[兴趣](https://simonwillison.net/2024/Jan/30/pgroll/)，来自更广泛的 Postgres 社区。本周晚些时候，我们将宣布另一个我们认为你会喜欢的开源项目 🦎。

这带来了今天的发布：一个新的无服务器 Postgres 服务，位于 Xata 平台的中心。单独看 Postgres 服务（忽略 Xata 平台中的其他所有内容），它表现得相当不错：

+   计算与存储分离，提供无限存储。

+   可选根据负载自动扩展和缩减。

+   通过多个可用区中的只读副本和自动故障转移实现高可用性。

+   支持原生的 Postgres 协议和通过 HTTP 的 SQL（便于从边缘函数访问）。

+   支持最常见的 Postgres 扩展。

+   能够扩展到 1TB RAM 和 128 vCPUs。

我们设计了 Postgres 服务，以优化**可靠性**、**可扩展性**和**成本效率**。

Xata Postgres 服务在底层使用 AWS Aurora，这是一个经过多次验证的服务，被许多非常大的 Postgres 安装所使用。自 Xata 初始推出以来，我们一直在使用 AWS Aurora，并且我们对我们引以为豪的可靠性[记录](https://www.xatastatus.com/)感到自豪。现在我们还有一个官方[SLA](/docs/appendix/sla)。

即使在免费层，我们也提供高可用性和冗余，副本在多个可用区运行。从主实例到副本的故障转移是自动的，并且保证没有数据丢失。在存储层，数据同步复制到三个可用区的六个存储节点。

Xata 中的可用实例类型可以扩展到**128 vCPUs 和 1TB RAM**。存储可以扩展到每个集群 128TiB。这对于垂直扩展来说是相当大的余地。

在水平扩展方面，您可以在全球范围内即时创建数据库和分支，而且可以在集群之间无需停机地移动它们，这打开了几种架构可能性。例如，您可以为每个客户创建一个逻辑数据库，并将它们放置在不同的区域。这得益于我们的[全球控制平面和逻辑数据库](/docs/concepts/serverless-data-platform#global-control-plane-for-databases-and-branches)。

Xata提供了高度的**可选择性**，从而在广泛的使用场景中实现成本效益。Xata使得从一个类型的集群切换到另一个类型变得非常容易，因此您可以在不同类型的集群上尝试您的工作负载，以确定从性能和成本效率的角度来看哪种最合适。

在小规模上，我们提供一个**免费层**，其中包括高可用性和读取副本，无冷启动，以及没有几天后的实例暂停。我们可以持续提供这种服务，因为免费层利用了[共享集群](/docs/concepts/serverless-data-platform#shared-postgres-clusters)和自动缩放技术。

在大规模上，使用[专用集群](/docs/dedicated-cluster)（目前处于私有α测试阶段），您按照您使用的资源付费，并且有很高的控制度。例如，对于可预测的负载，您可以配置特定的实例大小，而对于不可预测的负载，自动缩放可能更具成本效益。同样地，您可以选择标准存储和面向I/O优化的存储，在I/O密集型工作负载上更具成本效益。

鉴于行业内的免费计划最近倾向于早逝，您可能对我们的15GB免费存储，包括高可用性、无冷启动等免费层有些怀疑。我们知道信任是多年积累而来（但在几分钟内可能会失去），我们是一家初创企业，正在做一些初创企业该做的事情，利率*某些内容*，但我们认为有几件事是值得说的：

首先，Xata架构从一开始就设计成能够可持续地提供免费层，这要归功于使用共享集群和自动缩放技术。目前，一个活跃的免费数据库，每月的常规流量在速率限制内，我们的成本低于每月$1.5。这不仅包括Postgres，还包括Elasticsearch以及它们之间的复制，并且运行两个副本以实现高可用性。这得益于我们的共享集群（见[实施](#the-implementation)）。如果未被使用，搜索和复制功能将被禁用，并将数据库转移到冷存储中，如果多个月未活跃的话，其成本将进一步降低。换句话说，一个活跃的免费层数据库，如果使用了所有功能，可能每月成本为几美元，而大部分时间处于不活跃状态的免费数据库的成本将接近于零。

其次，免费层对我们很重要，因为涉及到公司的历史。Xata的想法起源于一个[非营利组织](https://www.tupu.io/)，当我们意识到管理数据库对许多小项目是一个限制因素时。今天，我很自豪地说，多个非营利组织正在免费层上构建Xata，其中一些在免费层上。

如果您只想使用Xata作为Postgres服务，而不使用其他服务，我们会感到非常高兴。然而，我们对Xata的思考方式不是作为Postgres的DBaaS，而是作为**PostgreSQL数据平台**：多个服务和工具被更紧密地集成在一起，比传统的云提供商更简化开发人员构建数据中心应用和管理数据库的方式。

这是Xata平台的高层次概述：

Xata 数据平台图

数据通过逻辑复制自动复制，包括模式更改，到Elasticsearch，它为我们的搜索、向量搜索和聚合端点提供服务，因此在其擅长的领域。文件存储在S3中，并通过Cloudflare CDN提供服务。复制事件用于保持文件的引用计数，因此它们可以在分支之间共享，但在不再需要时进行删除。

如果文件附件、全文搜索或向量/混合搜索对您的应用程序至关重要，Xata可能会为您提供比经典的DBaaS更好的平台。而且这仅仅是个开始，我们计划为时间序列、智能缓存、排队等提供类似紧密集成的解决方案。

Xata 实施中的一个关键概念是*逻辑数据库分支*的概念。一个数据库可以有多个分支，并且默认情况下至少有一个，称为`main`。在Postgres中，数据库分支表示为[schema](https://www.postgresql.org/docs/current/ddl-schemas.html)，可以分配到世界上多个Postgres集群中的一个，并且可以从一个集群移动到另一个集群。

这导致了应用程序体验到的逻辑数据库和分支与它们运行的基础Postgres实例之间的解耦。由于集群已经预配，逻辑数据库和分支可以立即启动，并根据业务需求分配和移动。这解锁了一些有趣的用例，例如每个租户作为一个分支的分片，为每个微服务使用逻辑数据库，或者为每个拉取请求自动创建开发者分支。我们在免费层中使用这种逻辑分离，许多小型数据库和分支共享相同相对较大的底层Postgres集群。

数据库分支调度到各种Postgres集群

为了实现这一点，我们必须解决几个挑战：

+   基于关于数据库分支的元数据，将流量路由到正确的集群。

+   确保分支级连接只能访问该单个分支。

+   确保攻击者无法调用危险的SQL函数。

+   限制在共享集群中的噪音邻居问题。

大多数这些问题的解决方案的关键在于我们的SQL代理技术。虽然有许多Postgres代理（如pgbouncer、pgcat、Supavisor）用于实现各种目标，但Xata SQL代理不仅支持Postgres的协议，还能在相当深的层次上理解正在执行的SQL。例如，它可以知道访问哪些表、请求哪些列、调用哪些带有哪些参数的函数等。这使我们能够阻止对Postgres集群有危险的操作。虽然安全性主要通过Postgres角色来保证，但代理可以在共享集群上强制执行速率和并发限制（我们不对专用集群执行此操作）。

代理允许我们"虚拟化"访问分支中的数据，还能访问Postgres表、函数、序列等目录。像Prisma和Drizzle这样的ORM会进行相当复杂的内省，以查看当前定义的表和列，我们希望确保它们可以在不进行任何修改的情况下正常工作。

您可能想知道为什么我们选择将数据库分支表示为Postgres模式而不是单独的Postgres数据库。原因在于逻辑复制，这是数据库平台的关键组成部分，可靠的变更数据捕获（CDC）是保持多个数据存储同步的重要功能。单独的数据库将迫使我们为每个数据库做一个复制槽。

谈到逻辑复制，我们不得不解决的另一个挑战是获取Postgres的数据事件和模式事件。Postgres逻辑复制系统的一个众所周知的限制是它只包括数据更改，而不包括DDL更改。然而，将模式更改与相同的事件流合并显著简化了逻辑复制事件的下游消费者。我们解决这个问题的方法是安装[DDL事件触发器](https://www.postgresql.org/docs/current/event-triggers.html)，将模式更改写入一个"出箱"表，通过相同的复制槽进行复制。

我们认为这项技术将对许多Postgres应用程序有所帮助，因此我们计划很快将其作为独立项目开源。

新Xata架构的另一个关键组成部分是我们的开源项目[pgroll](https://github.com/xataio/pgroll)，用于零停机时间、可逆的模式迁移。

虽然`pgroll`是一个CLI工具，为了向所有Xata用户提供其优势，我们为其开发了一个服务器包装器，与我们的控制平面集成。该服务器提供特定迁移的API，还会自动拦截通过协议执行的DDL。这使我们能够在Xata平台上本地提供部分pgroll的优势，而您甚至无需知道自己在使用pgroll！

虽然还有一些工作要做才能完全整合pgroll，但您已经获得了一些重要的好处：保持模式迁移历史记录，自动避免[锁定问题](https://xata.io/blog/postgres-schema-changes-pita)，并启用需要数据回填的更复杂的迁移。目前我们还没有同时公开多个版本的模式，但我们计划在未来这样做。这将是实现各种模式迁移的简单和安全工作流程的关键，我们对未来充满期待。

本周晚些时候，请密切关注有关pgroll及其如何整合到Xata中的详细博客文章。

从构建此服务的人那里了解更多关于该服务的开发，并观看一个快速演示以了解其运作方式。在这里查看我们最新的“见证奇迹者”会议：

如果您想进一步了解，请到[Discord](https://xata.io/discord)上打个招呼👋。

如果您还没有Xata帐户，现在是[创建一个](https://app.xata.io/signup)的绝佳时机！
