<!--yml

类别：未分类

日期：2024-05-27 15:00:26

-->

# ECC vs non-ECC RAM and ZFS | TrueNAS Community

> 来源：[https://www.truenas.com/community/threads/ecc-vs-non-ecc-ram-and-zfs.15449/](https://www.truenas.com/community/threads/ecc-vs-non-ecc-ram-and-zfs.15449/)

我看到很多人不幸因为这个问题失去了他们的zpools，所以我会尽量提供尽可能详细的信息。如果你不想读到最后，那就选择ECC RAM吧。对于那些想要了解非ECC RAM可能有多破坏性的人，我鼓励你继续阅读。记住，ZFS本身完全在系统RAM内运行。通常你的硬件RAID控制器会执行与ZFS代码相同的功能。而且你使用过的每个硬件RAID控制器都有ECC缓存。简单的原因是：他们知道不要让少数位从垃圾桶中损坏整个阵列。硬件RAID控制器（就像ZFS一样）绝对需要信任RAM中的数据是正确的。

对于那些不想阅读的人，理解ECC就像你厨房桌子上的一条腿，你拿掉了那条腿，因为你想重新使用使用非ECC RAM的旧硬件。只需购买ECC RAM并信任ZFS。坏的RAM就像你的计算机患上了痴呆症。就像那些老人院一样，你不能去问他们忘记了什么。他们不记得，你的计算机也不会记得。

这里是我做出的一些假设并对它们进行解释：

1\. 我们将处理一个存在单个位错误的系统。一个内存位置卡在“1”上。显然，如果存在多个位错误，将导致更广泛的损坏。在我的示例中，我将提供一个假设的8位RAM。第2位将卡在“1”上。我会正确标记它

**下划线和粗体**

对于最终损坏的位。稍后我会移动这个位置，但那时我会和你讨论这个问题。

2\. 大多数服务器系统进程使用的RAM非常少，而大量RAM用于缓存，因此我们假设系统运行稳定，没有问题，因为错误很可能在缓存中。即使系统偶尔在错误的RAM位置导致崩溃，你很可能会重新启动并继续，直到在短时间内多次崩溃后意识到有其他问题。在那时，你可能已经进入了“哦，糟糕”的境地。

3\. 对于我的示例，我将忽略文件系统的任何潜在损坏。显然，文件系统本身的损坏非常严重，可能对数据造成致命影响。我将在讨论的最后阶段涉及这个主题。

4\. 不会有来自任何其他子系统或数据路径的额外损坏。显然，任何额外的损坏都不会让事情变得更容易。

5\. 我将解释的内容是ZFS的一个限制。这是

不

特指FreeNAS。它是特指ZFS的。

现在开始一些示例：

**当非ECC RAM在不做自己的奇偶校验和校验的文件系统中损坏时会发生什么？**

所以假装一个文件加载到RAM中，然后保存到不执行自己的奇偶校验/校验和的NTFS/ext4/UFS/任何您想要的文件系统中。

文件长度为8位。00110011。

由于我们的文件存储在RAM中，它已经损坏了。现在它是0

**1**

110011。然后这被转发到磁盘子系统，随后存储在磁盘上被破坏了。如果这是文件系统数据，你可能会有更大的问题。所以现在，不管你的目的地是什么，硬盘、固态硬盘还是冗余阵列，这个文件都会被错误保存。对于那个文件来说没什么大不了的，但它可能导致你的最爱办公套件无法打开文件，或者导致你流媒体视频画面暂时损坏。

**当非ECC RAM在ZFS系统中损坏时会发生什么？**

所以假设我们的相同8位文件存储在错误的RAM中。

与上述相同的文件和相同的长度：00110011。

文件加载到RAM中，由于它将被存储在您的超安全zpool上，因此将会传输到ZFS进行奇偶校验和校验和。所以您的RAIDZ2 zpool得到了文件。但这里是棘手的部分。由于您的坏RAM位置，文件现在已经损坏了。

ZFS得到0

**1**

110011并被告知安全地存储在池中。因此，它为损坏的数据计算奇偶校验和校验和。然后，将这些数据保存到磁盘中。嗯，比上面糟糕得不多，因为文件已经被摧毁了。但是您的奇偶校验和校验和不会帮助您，因为它们是在

*之后*

数据已损坏。

但是，现在情况变得混乱。当您读取该数据时会发生什么？假设坏RAM位置相对于加载到RAM中的文件移动了。它偏离了3位并移动到第5位置。所以现在我读取回来的数据是：

从磁盘读取：0

**1**

110011。

但是什么存储在RAM中？0

**1**

11

**1**

011。

好的，没问题。ZFS将根据其奇偶校验进行检查。糟糕，奇偶校验失败了，因为我们有一个

*新*

损坏的位。请记住，校验和数据是在第一个内存错误损坏后计算的。因此现在奇偶校验数据被用来“修复”坏数据。所以数据在RAM中“修复”了。现在应该被修正为01110011，对吧？但是，由于我们有一个坏的第五位置，它就变成了

*仍然*

糟糕！修正了可能的一个时钟周期，但由于我们糟糕的RAM位置，立即又损坏了。所以我们并没有真正“修复”任何东西。0

**1**

11

**1**

011仍然在RAM中。现在，由于ZFS检测到来自磁盘的损坏数据，它将修复写入驱动器。但实际上它会更糟，因为修复没有修复任何东西。所以你可以看到，随着时间的推移，事情只会变得更糟。

现在让我们考虑一下你的备份。

如果你使用 rsync，那么 rsync 将会备份该文件的损坏形式。但如果文件一开始是正确的，后来才损坏呢？嗯，多亏了 rsync，备份本身实际上也是损坏的。

ZFS 复制呢？肯定比这个更好吧？嗯，有点道理。多亏了那些定期快照，你的服务器会愉快地将损坏复制到备份服务器上。还别忘了，在复制过程中出现损坏的风险也增加了，因为当计算 ZFS 校验和以通过 SSH 传输时，这些数据可能也会损坏！

但我们非常聪明。我们也会定期进行 zpool scrub。那么当你对池进行 scrub 时会发生什么呢？当那个卡住的内存位置被持续读写时，ZFS 将尝试“修复”它认为来自硬盘的损坏数据，并将数据写回。但实际上，它读取

*好的*

从你的驱动器中获取数据，在 RAM 中损坏它，在 RAM 中修复它（这并不像上面展示的那样修复它），然后将“修复”的数据写入你的磁盘。这意味着在尝试执行 scrub 时整个池的数据都被破坏了。

因此总结：

1\. 所有关于 ZFS 自我修复的东西如果系统没有使用 ECC RAM，就毫无意义了。

2\. 备份很可能因为坏 RAM 而被破坏。根据过去 18 个月论坛用户的经验，你几乎没有机会在意识到 RAM 坏掉时保持你的备份安全。

3\. 对于 ZFS 来说，Scrub 是你能做的最好的事情，但如果使用了坏的 RAM，它们也可能成为你的大敌。

4\. 校验数据、校验和以及实际数据必须完全匹配。如果不匹配，则会开始修复。如果因为损坏而需要更换磁盘，而校验数据和实际数据不匹配，数据将会丢失。

为了保护你的数据免受 ZFS 的损失，这里有些你需要知道的事情：

1\. 使用 ECC RAM。这是一个基本的真理。

2\. ZFS 使用校验、镜像、和 copies 参数以各种方式保护你的数据。校验证明磁盘上的数据没有损坏，校验/镜像/副本纠正这些错误。只要你有足够的校验/镜像/副本来修复任何可能发生的错误，你的数据就是 100% 安全的（再次强调，假设你使用的是 ECC RAM）。所以运行 RAIDZ1 是

**非常**

危险，因为当一个磁盘失败时，你将失去更多的保护。在重新构建池的漫长（而费力）任务期间，你很可能会遇到剩余磁盘上的错误的高风险。所以任何错误都被检测到了，但没有被纠正。希望这个错误不是在你的文件系统中，因为对整个池来说，这种损坏可能是致命的。实际上，约 90% 的用户丢失数据是因为他们使用了 RAIDZ1 并遭受了 2 个磁盘故障。

3\. 如果你的校验/镜像用完了，你的池就无法挂载，你就陷入了

深入

麻烦。对于 ZFS 没有恢复工具，而且数据恢复专家的报价

开始

在5位数范围内。人们通常用于恢复桌面文件系统的所有那些工具在ZFS上都不起作用。ZFS与任何其他文件系统都不同，恢复工具通常只能找到看起来像文件碎片的数十亿个4K数据块。显然，即使您不得不建立第二个FreeNAS服务器，只需制作备份会更便宜（而且更可靠）。别忘了，如果ZFS损坏了

*只是*

足够糟糕以至于由于坏内存而无法卸载，即使您的文件大部分是安全的，您也必须考虑那5位数的价格标签。

4\. 通常，当内存损坏时，您通常会失去多个内存位置，而不仅仅是一个。损坏通常是位置之间绝缘断裂，因此相邻位置也开始受到破坏。这只会产生更多的多位错误。

5\. ZFS被设计用来修复损坏，而不是处理您无法纠正的损坏。这就是为什么ZFS没有fsck/chkdsk的原因。所以一旦您到达ZFS的文件结构被损坏且由于没有冗余性而无法修复的时候，您可能会丢失池（并且系统可能会内核崩溃）。

现在您确信ECC真的是

*那*

很重要，您可以用相对便宜的价格建立一个带ECC的系统...

主板：

[Supermicro X9SCM-F（约160美元）](http://www.amazon.com/dp/SUPERMICRO/?tag=ozlp-20)

CPU：

[奔腾 G2020（约60美元）](http://www.amazon.com/dp/B00D5ZZZ70/?tag=ozlp-20)

内存：

[KVR16E11K4/32 32GB DDR3-ECC-1600MHz RAM（约350美元）](http://www.amazon.com/dp/B008LMO1DG/?tag=ozlp-20)

总成本大约是

**570美元**

。如果您不想使用32GB的全套内存，那么价格可以降低约

**370美元**

。G2020对于FreeNAS来说是一个很棒的CPU。

当然，如果您计划使用像Plex这样对转码要求较高的插件，您将需要更多的计算能力。要注意哪些CPU支持ECC，哪些不支持。所有的Xeon都支持，有些i3也支持。请查阅Intel的规格表以确保

之前

您花了钱。我使用

[E3-1230v2](http://www.amazon.com/dp/B0085MQUTU/?tag=ozlp-20)

（大约250美元），而且非常棒！无论我用它做什么，我都不能超过大约30%的CPU使用率。也不要只看TDP来选择“最环保”的CPU。TDP是指满负荷时的热量输出。这并不能说明您在空闲时（通常情况下系统会处于空闲状态99%的时间）将看到什么样的功耗。我的系统在没有安装硬盘且系统空闲时功耗约为35瓦。不幸的是，我无法帮助AMD CPU，因为我不喜欢AMD。我知道尝试选择AMD的“绿色”CPU已经让这里的许多人感到失望。“绿色”CPU的性能比其他CPU要慢，所以要小心，不要买一个速度不能让您满意的CPU。

我列出的主板也很理想。它具有双英特尔Gb LAN、IPMI（永远不需要键盘、鼠标和显示器！）以及用于未来可能需要的M1015 SAS控制器的PCIe插槽。我无法告诉你IPMI有多棒。但它基本上是你系统的远程桌面。除了你甚至可以在启动期间使用它。例如，你可以进入你的BIOS并远程更改设置！你甚至可以在没有计算机上的CD-ROM的情况下远程挂载CD！多酷啊！再加上通过IPMI远程开关和关闭服务器的能力，你对于那些想要塞到角落并忘记的服务器有了解决方案。

ECC RAM只能检测

和

正确的单比特错误。当你有多比特错误（如果我的经验是任何指示），系统可以检测（但不能纠正）这些错误，并立即在屏幕上显示带有坏内存位置的警告消息停止系统。当然，停止系统是不好的，因为系统变得不可用。但一旦意识到内存出现问题，停止系统比让你的zpool因为坏内存而损坏是最好的选择。记住，整个目标是保护你的zpool，一旦意识到情况不妙，系统停止是最好的选择。

这里有另一种看待它的方式：

示例1：运行具有其本机文件系统（可能是ext3、NTFS或HFS+）的服务器，非ECC RAM。你唯一可能期望丢失整个驱动器数据的方式是如果你的驱动器完全失败。如果你的RAM坏了，你可能会因最近打开的几个文件的损坏而丢失一些文件。你可能需要在分区上运行chkdsk/fsck来使其恢复良好。但你可以把那张盘放到另一台机器上，并恢复大部分（如果不是全部）数据。即使在最糟糕的情况下，也有很多工具像

[Ontrack EasyRecovery DIY](http://www.krollontrack.com/data-recovery/recovery-software/)

可用于NTFS的软件，你可以期望有合理的机会恢复大部分（如果不是全部）的数据。你还可以打电话给那些数据恢复专业人员，他们可能会从失败的磁盘中恢复你的数据，需要4位数的费用。

示例2：服务器使用ZFS和非ECC RAM。现在你有更多丢失数据的方法：

1\. 如果驱动器完全损坏（显然）。

2\. 基于以前使用过非ECC RAM失败的用户，你将重新启动以发现你的池子无法安装。这意味着你的数据丢失了。对于ZFS没有数据恢复工具。没有。它们全部永远丢失了。

3\. 那你用那些非服务器级部件呢？猜猜看，它们也能损坏你的池子并使其无法安装。结果与#2完全相同。你刚刚丢失了

所有

你的数据是否能够被加载，因为池不会安装。

问题在于你的本机文件系统有像chkdsk和fsck这样的工具来修复文件系统错误。你还有许多选项可以使用像

[Ontrack EasyRecovery DIY](http://www.krollontrack.com/data-recovery/recovery-software/)

软件。

但是，无论你做多少搜索，都找不到ZFS恢复工具。您可以联系像Ontrack这样的公司进行数据恢复。我知道有人这样做了，他们花了3000美元只是为了找出

*if*

他们的数据是可恢复的。然后，他们又花了15000美元仅恢复了200GB的数据。

那么告诉我你更愿意陷入哪个例子？＃1 在这里，您有更少的机会失去一切并且有恢复选项。或＃2，在这里，您有更多机会失去一切并且没有恢复选项。我宁愿处于情景1而不是情景2。我无法想象您也会希望情景2。

因此，当您了解如何使用ZFS是“全有或全无”时，我并不是在编造。我是认真的，因为它确实是这样运作的。ZFS要么工作得很好，要么根本不工作。那

确实

真实的工作原理

如果不喜欢，可以选择使用不推荐的组件中的少数人。这是你的胜利（或失败）。但是，当您出现时，您的存储池无法挂载时，绝对不会得到同情，就像许多认为可以建立便宜系统并逃脱惩罚的人一样。

**请注意，不要使用非ECC RAM与ZFS。** [Intel关于RAM错误和非ECC与ECC的精彩演讲。](http://cache-www.intel.com/cd/00/00/46/78/467819_467819.pdf)

另一位证实这一点的人是

[https://pthree.org/2013/12/10/zfs-administration-appendix-c-why-you-should-use-ecc-ram/](https://pthree.org/2013/12/10/zfs-administration-appendix-c-why-you-should-use-ecc-ram/)

一些不幸经历了因坏的非ECC RAM导致的数据丢失的帖子列表（我记得时更新）：

已发布信息并确认ECC救了他们的一些人的列表：
