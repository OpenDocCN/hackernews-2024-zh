<!--yml

category: 未分类

date: 2024-05-29 12:44:45

-->

# Kubernetes and back - Why I don't run distributed systems - davd.io

> 来源：[https://www.davd.io/posts/2024-03-20-kubernetes-and-back-why-i-dont-run-distributed-systems/](https://www.davd.io/posts/2024-03-20-kubernetes-and-back-why-i-dont-run-distributed-systems/)

在一家宣称自己是云原生、无头等等的公司工作时，说我不喜欢分布式系统几乎是令人震惊的。也许每个有一些时髦认证的SRE都会认为我是个完全的白痴，但请听我说完。

大约一年前，我决定将一个我的边缘项目切换到基于Kubernetes的多节点环境。无需停机部署、节点维护，更好的可扩展性和“自愈”功能，如果一个节点宕机，听起来都太好了，不可能不跟着这个不断增长的技术营销浪潮。

我花了一些时间计算在AWS、Google或Azure这样的超大规模云服务提供商的K8s平台上托管我的应用的成本，结果发现*这*对我来说不是一个选择。

因此，我选择自己托管。设置了6台虚拟机（工作节点和控制平面），每月花费不到三位数的价格，并设置了Kubernetes。我花了大量时间，精确地获取了适合我的应用的K8s规格，从单机Docker Compose环境迁移，配备适当的云卷分布，一个带有三个副本的MongoDB设置，每个服务多个副本的Pod，负载均衡器等等。最终，我得到了一个 - 理论上 - 高可用的系统。

并非一切都很好，我立即想念我的卷上的ZFS，以前用来在备份之前快照我的应用状态。我也意识到，由于复制（这是一个混乱的设置 - 我在想谁在MongoDB公司设计的），我的数据库变得相当慢（因为我希望有最高级别的数据复制安全性）。更不用说Redis和ElasticSearch集群了。

我设置每次复制时，系统变得更加混乱，并且遇到了多种性能问题，这些问题非常昂贵和复杂，难以调试。

应用程序一旦开始运行并实际受到客户流量的影响，我重新运行了在设置系统时运行过的相同测试，以确保高可用设置正常运行。从云 VM 控制面板中杀死一个工作节点，集群竟然花费了很长时间才意识到节点已经消失。MongoDB 复制需要多秒钟才能弄清楚接下来该做什么。最终，应用程序出现了大约一分钟的停机时间，这并不是我从一个完全冗余的系统中期望的设置。我花了很多时间调整，了解不同的网络插件，添加额外的心跳和健康检查等等，使一切工作到我可以有信心撤下一个节点，甚至不在其故障之前也能如此（最终，这就是停机的情况）。最终仍然是几秒钟的停机时间。

备份也让我头疼和做噩梦。我的 MongoDB 数据库非常大，我再也不能合理地转储它了。通常我会快照文件系统并备份它。但是如果您的 CSI 驱动程序不支持 btrfs 或 ZFS 该怎么办呢？所以又多做了一些工作，增加了一些复杂性，最终在 CI 管道中停止了我的一个 MongoDB 复制，冷备份数据库，然后再次恢复，这导致剩余集群不必要地负载增加以重新启动复制。如果在备份期间节点崩溃会发生什么情况（我经常需要这样做）？那么我的复制就没有法定人数了，所有剩余的节点都开始尖叫，而应用程序再次下线。

是否有所有这些问题的解决方案？可能有。但到我达到一种工作状态的时候，一切变得如此复杂，以至于维护这一切真的很痛苦。当然，成本也越来越高了。

这时我停下来想：“好吧，这真的值得吗？”嗯，我想这取决于您的用例，但对我来说并不值得。那时我真的开始质疑 Kubernetes 到底有什么好处。当然，我有点夸张。但想想看：承诺是您拥有一个抽象平台，可以运行分布式工作负载，通常通过运行您从未仔细检查过的容器 - 或者您真的曾经深入研究过 certmanager 的工作原理吗？我很确定您没有，但毫无疑问，您的 Ansible playbook 中肯定有那个 Helm chart。但它真的能实现吗？分布式系统早在 Kubernetes 和 Docker 以及可能所有现代技术堆栈之前就已存在。尽管云供应商的所有营销努力，但您仍然需要了解所有这些低级事物：数据库复制如何工作？存在哪些负载均衡范例？如何为内部服务设置私有网络并仅公开表面？如何正确配置防火墙？那个设置静态路由的愚蠢命令是什么来着？

这就是每个人都默默忽视的事情，没有人在他们的Kubernetes认证中被问及，但每当事情不按文档描述工作时，每个人都感到不知所措。但你是一个糟糕的SRE。你仍然需要了解所有这些，再加上所有愚蠢的Kubernetes对象类型，你供应商的云控制器的特殊性以及Azure上那些该死的服务叫什么。

最终，认知负荷和应用复杂性（以及由此带来的可能的错误、安全问题等）远高于传统的孤立方法。

今天，我回到了一个单机处理高峰500并发用户的机器上，每月成本约为40美元。而且它更快。我有一个冷备用虚拟机，可以通过启动它，更新应用程序到最新状态，重新挂载云卷，并重新分配浮动IP来接管运营。这是一个单一的Shell脚本（当然在GitLab CI管道内运行，因为我们很时尚）。整个操作比我杀死节点时优化的Kubernetes配置要快。但现在这些是单机器。可理解和可调试。我有一个心跳监测生产机器的脚本，如果它停机超过一定时间，它会启动该脚本。*那*比HA集群更快吗？不。但是更容易理解，对于我的用例，我真的不需要更多。如果你在云虚拟机每隔几年宕机时损失不了数百万，那几分钟的时间是可以接受的。

或者用 ThePrimeagen 的话来说：

> “JUST PUT IT ON A SERVER!!1”

那么，我讨厌Kubernetes吗？当然不是。我想说的是：选择你的武器要谨慎。你不会是第一个用你本来是用来保护自己的武器给自己脚开枪的人。
