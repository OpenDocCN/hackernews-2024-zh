<!--yml

category: 未分类

date: 2024-05-29 12:48:53

-->

# 为什么 Figma 要重新发明 PostgreSQL 的轮子？ | 作者：Denis Magda | 2024年3月 | Medium

> 来源：[https://medium.com/@magda7817/why-has-figma-reinveted-the-wheel-with-postgresql-3a1cb2e9297c](https://medium.com/@magda7817/why-has-figma-reinveted-the-wheel-with-postgresql-3a1cb2e9297c)

# 为什么 Figma 要重新发明 PostgreSQL 的轮子？

几周前，Figma 发布了一篇[文章](https://www.figma.com/blog/how-figmas-databases-team-lived-to-tell-the-scale/)，介绍了他们为 PostgreSQL 自己开发的分片解决方案。Figma 工程团队已经意识到并评估了几种现有选项，这些选项本可以使他们的数据库层水平扩展。但他们最终决定从零开始构建自己的分片解决方案。

在本文中，我将分享我对以下问题的看法（有时是推测）：

+   首先，为什么经验丰富的 Figma 工程团队决定重新发明轮子，而不是从广泛的 PostgreSQL 生态系统中选择一个现有选项？

+   其次，Figma 的自定义解决方案未来会是怎样的？团队会坚持他们的分片解决方案，还是最终会迁移到其中一个现有且更成熟的选项？

+   最后，如果 Figma 最终从 PostgreSQL 生态系统迁移到其他选项，那么这个选项将会是什么？

# 快速解决方案概述

我知道并非每个人都有时间从头到尾阅读[Figma 的文章](https://www.figma.com/blog/how-figmas-databases-team-lived-to-tell-the-scale/)，这就是为什么我想简要介绍一下他们的定制解决方案。

分片是一种技术，它将数据和负载分布到多个独立的数据库实例中。它允许你将原始数据集分成片段，然后分布到多个数据库实例中。

要使分片工作，你需要制定一个分片键和一个哈希函数。然后，编写使用哈希函数将键与相关记录映射到分片，然后将分片映射到数据库节点的逻辑。

Figma 团队通过选择最适合其数据集和哈希函数的分片键，并实施了一种[数据共位方法](/@magda7817/colocated-and-interleaved-tables-in-distributed-sql-databases-tradeoffs-f2e7b1b9d68e)，使得相关数据可以存储在同一片/节点上。例如，所有针对特定 Figma 文件留下的评论都与文件记录一起存储在同一个节点上。

然而，在任何分片实施中，这一第一步都是最简单的。更具挑战性的部分在后面。一旦你把数据分布到多个数据库服务器上，你需要决定：

+   如何通过支持全局唯一索引和外键来维护数据完整性？

+   如何协调、提交和回滚跨分片/节点事务？

+   如何在所有数据库节点上原子地推出模式更改？

+   如何在必要时重新分片和重新平衡数据？

+   如何从应用层路由查询？应该有一个协调器，还是这成为应用开发者的责任？

+   如何使整体解决方案高度可用（具备备用、复制品、故障转移解决方案）？

+   还有许多其他考虑……

Figma团队承认了大部分这些挑战，并努力解决了其中的几个。例如，他们引入了一个名为DBProxy的协调器组件，显著简化了应用开发者的工作。

协调器在任何分片解决方案中都扮演着关键角色，前提是它完全了解数据在节点间的分布。这个组件可能会被称为各种名称，比如协调器、路由器、指挥官或代理。客户端或应用连接到协调器，然后协调器将请求路由到特定的数据库节点或在整个群集中广播。

# 为什么要自定义分片解决方案？

总的来说，作为一名工程师，参与分片解决方案的开发永远不会后悔。这是一个复杂的工程问题，有许多非平凡的任务需要解决。但对于一家赞助开发的公司来说，这也是一项巨大的投资 —— 需要有人来构建并在生产中支持/维护这个解决方案。

Figma团队显然意识到定制与现有解决方案之间的权衡，并评估了几个现有选项：

> 有许多流行的开源和托管解决方案适用于横向分片的数据库，与Postgres或MySQL兼容。在我们的评估期间，我们探索了CockroachDB、TiDB、Spanner和Vitess。

但是，他们仍然决定继续创建他们自己的分片解决方案。为什么他们要这样做呢？

他们通过以下方式证明了他们的定制实现：

> 然而，切换到任何这些替代数据库都需要进行复杂的数据迁移，以确保在两种不同的数据库存储之间的一致性和可靠性……考虑到我们非常激进的增长速度，我们只剩下几个月的运营时间。减少完全新的存储层的风险，并完成我们最关键业务用例的端到端迁移，将会在必要的时间轴上非常冒险。

简而言之，听起来某些评估的选项对他们来说可能有效，但他们没有足够的时间迁移到其中一个现有的解决方案上。如果需要转向诸如TiDB或Spanner之类的分布式数据库，这听起来是合理的。然而，这并不能解释为什么[CitusData](https://www.citusdata.com)，PostgreSQL的默认分片扩展，对他们来说行不通。他们甚至没有将CitusData添加到他们的评估列表中。

然而，如果你仔细阅读这篇文章，你会注意到团队提到了以下内容：

> 在过去几年中，我们已经积累了如何在内部可靠和高效地运行**RDS Postgres**的大量专业知识。而在迁移过程中，我们本来必须从头开始重建我们的领域专业知识。

Figma并不使用PostgreSQL的开源分发，而是通过订阅[Amazon RDS](https://aws.amazon.com/rds/)来利用PostgreSQL作为服务。关于大型云服务提供商和小型供应商提供的PostgreSQL托管服务，有一个有趣的常被忽视的事实。虽然这些服务通常提供所有核心的PostgreSQL功能，但支持的扩展列表取决于服务提供商。

现在，我们有了CitusData，一个成熟的PostgreSQL分片扩展，并且我们知道Figma使用了Amazon的完全托管的PostgreSQL服务RDS。然而，如果你查看[PostgreSQL扩展列表](https://docs.aws.amazon.com/AmazonRDS/latest/PostgreSQLReleaseNotes/postgresql-extensions.html)，你会发现CitusData并不包括在内：

所以，现在让我推测一下。Figma重新发明了轮子创建他们自己的分片定制解决方案的真正原因可能如此简单——*Figma希望留在RDS上，而由于亚马逊过去决定不支持CitusData扩展，Figma团队别无选择，只能从头开发他们自己的分片解决方案*。

# 未来会是怎样的呢？

我真正喜欢Figma工程团队的是他们的透明度。他们对他们所面临的选择和权衡非常开放。我深深尊重他们的决定，并相信他们选择的路径在当时是最明智的。

不过，这是否意味着Figma团队将继续使用并投资于他们自己的分片解决方案呢？未来会怎样？

团队给了我们以下提示：

> 一旦我们有了足够的时间窗口，**我们也将重新评估我们最初的方法**，即内部RDS水平分片。我们在18个月前开始了这个旅程，当时时间紧迫。NewSQL存储继续发展和成熟。我们**最终会有带宽来重新评估**继续当前路径与切换到开源或托管解决方案之间的权衡。

总的来说，未来可能如下所示：

+   选项＃1：Figma继续投资于他们自己的分片定制解决方案，并在其足够成熟后将其开源。然而，他们随后需要找到一种与CitusData扩展区分开的方法。

+   选项＃2：考虑到 Figma 是 Amazon RDS 的客户，一旦这项服务被 Amazon 批准用于生产，他们可能会迁移到[Amazon Aurora 无限](https://aws.amazon.com/blogs/aws/join-the-preview-amazon-aurora-limitless-database/)。Aurora 无限是为 AWS 用户提供的 Postgres 分片解决方案。然而，他们需要仔细评估 TCO（总拥有成本），因为许多评估这项新服务的人士认为，“无限”也可能意味着无限的成本。

+   选项＃3：Figma 迁移到[来自 PostgreSQL 生态系统的现有解决方案之一](https://www.yugabyte.com/postgresql/distributed-postgresql/)，支持水平扩展或完全分布。这可能是 CitusData 扩展，甚至是[YugabyteDB](https://www.yugabyte.com)，这是一个基于 Postgres 构建的分布式共享无关数据库。考虑到团队之前探索过 TiDB 和 CockroachDB，YugabyteDB 可能是一个可能的选择。

好的，希望你喜欢这次“调查”。让我们祝愿 Figma 团队好运，并继续关注他们的分片解决方案发展的进展！
