- en: <!--yml
  id: totrans-split-0
  prefs: []
  type: TYPE_NORMAL
- en: 'category: 未分类'
  id: totrans-split-1
  prefs: []
  type: TYPE_NORMAL
- en: 'date: 2024-05-27 14:37:08'
  id: totrans-split-2
  prefs: []
  type: TYPE_NORMAL
- en: -->
  id: totrans-split-3
  prefs: []
  type: TYPE_NORMAL
- en: How to speed up the Rust compiler in March 2024 | Nicholas Nethercote
  id: totrans-split-4
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 来源：[https://nnethercote.github.io/2024/03/06/how-to-speed-up-the-rust-compiler-in-march-2024.html](https://nnethercote.github.io/2024/03/06/how-to-speed-up-the-rust-compiler-in-march-2024.html)
  id: totrans-split-5
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: It has been over six months since my [last update](https://nnethercote.github.io/2023/08/25/how-to-speed-up-the-rust-compiler-in-august-2023.html)
    on the Rust compiler’s performance. Time for an update.
  id: totrans-split-6
  prefs: []
  type: TYPE_NORMAL
- en: Big wins
  id: totrans-split-7
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Let’s start with some big improvements. This list isn’t comprehensive, it’s
    just some things I noticed over this time period. The information about metrics
    at the top of [this post](https://nnethercote.github.io/2022/10/27/how-to-speed-up-the-rust-compiler-in-october-2022.html)
    still applies.
  id: totrans-split-8
  prefs: []
  type: TYPE_NORMAL
- en: '[#115554](https://github.com/rust-lang/rust/pull/115554): There are many build
    configuration choices that can affect the performance of built Rust binaries.
    One choice is to build with [a single codegen unit](https://nnethercote.github.io/perf-book/build-configuration.html#codegen-units),
    which increases build times but can improve runtime speed and binary size. In
    this PR [Jakub Beránek](https://github.com/Kobzol) made the Rust compiler itself
    be built with a single codegen unit on Linux. This gave a [mean wall-time reduction
    of 1.57% across all benchmark results](https://perf.rust-lang.org/compare.html?start=c16823d757b376f90c5f5cbd542ce83235befbc4&end=871407a0341262d2a86703ca43b449d35fa5f236&stat=wall-time&nonRelevant=true),
    a [mean max-rss reduction of 1.96% across all results](https://perf.rust-lang.org/compare.html?start=c16823d757b376f90c5f5cbd542ce83235befbc4&end=871407a0341262d2a86703ca43b449d35fa5f236&stat=max-rss&nonRelevant=true),
    and also reduced the size of the `rustc` binary. This change has not yet been
    done for Windows or Mac builds because the improvements were smaller, but it may
    happen soon.'
  id: totrans-split-9
  prefs: []
  type: TYPE_NORMAL
- en: '[#117727](https://github.com/rust-lang/rust/pull/117727): In this PR, [Ben
    Kimock](https://github.com/saethlin/) made all `Debug::fmt` methods generated
    via `#[derive(Debug)]` be marked with `#[inline]`. This was a small, innocuous-sounding
    change that gave amazing results: a [mean wall-time reduction of 1.33% across
    all benchmark results](https://perf.rust-lang.org/compare.html?start=eae4135939881ae730342bd336ae6302c3787e27&end=0f44eb32f1123ac93ab404d74c295263ce468343&stat=wall-time&nonRelevant=true).
    and a [mean binary size reduction of 1.32% across all release build results](https://perf.rust-lang.org/compare.html?start=eae4135939881ae730342bd336ae6302c3787e27&end=0f44eb32f1123ac93ab404d74c295263ce468343&stat=size%3Alinked_artifact&nonRelevant=true&doc=false&debug=false&check=false&incrFull=false&incrUnchanged=false&incrPatched=false).'
  id: totrans-split-10
  prefs: []
  type: TYPE_NORMAL
- en: '[#119977](https://github.com/rust-lang/rust/pull/119977): In this PR, [Mark
    Rousskov](https://github.com/Mark-Simulacrum) introduced a cache that helped avoid
    many hash table lookups within the compiler. This gave a [mean wall-time reduction
    of 1.20% across all benchmark results](https://perf.rust-lang.org/compare.html?start=92f2e0aa62113a5f31076a9414daca55722556cf&end=098d4fd74c078b12bfc2e9438a2a04bc18b393bc&stat=wall-time&nonRelevant=true).
    The idea for this first arose [6.5 years ago](https://github.com/rust-lang/rust/issues/45275)!'
  id: totrans-split-11
  prefs: []
  type: TYPE_NORMAL
  zh: '[#119977](https://github.com/rust-lang/rust/pull/119977)：在这个PR中，[Mark Rousskov](https://github.com/Mark-Simulacrum)引入了一个缓存，帮助减少编译器内的许多哈希表查找。这导致[所有基准结果中的平均墙时减少了1.20%](https://perf.rust-lang.org/compare.html?start=92f2e0aa62113a5f31076a9414daca55722556cf&end=098d4fd74c078b12bfc2e9438a2a04bc18b393bc&stat=wall-time&nonRelevant=true)。这个想法首次出现是[6.5年前](https://github.com/rust-lang/rust/issues/45275)！'
- en: '[#120055](https://github.com/rust-lang/rust/pull/120055): In this PR, [Nikita
    Popov](https://github.com/nikic) upgraded the LLVM version used by the compiler
    to LLVM 18\. This gave a [mean wall-time reduction of 0.87% across all benchmark
    results](https://perf.rust-lang.org/compare.html?start=bc1b9e0e9a813d27a09708b293dc2d41c472f0d0&end=eaff1af8fdd18ee3eb05167b2836042b7d4315f6&stat=wall-time&nonRelevant=true).
    This is the latest in a long run of LLVM updates that have made rustc faster.
    Fantastic work from the LLVM folks!'
  id: totrans-split-12
  prefs: []
  type: TYPE_NORMAL
  zh: '[#120055](https://github.com/rust-lang/rust/pull/120055)：在这个PR中，[Nikita Popov](https://github.com/nikic)将编译器使用的LLVM版本升级到LLVM
    18。这导致[所有基准结果中的平均墙时减少了0.87%](https://perf.rust-lang.org/compare.html?start=bc1b9e0e9a813d27a09708b293dc2d41c472f0d0&end=eaff1af8fdd18ee3eb05167b2836042b7d4315f6&stat=wall-time&nonRelevant=true)。这是一系列LLVM更新的最新版本，使rustc更快。LLVM的工作非常出色！'
- en: In other big news, the Cranelift codegen backend is now available for [general
    use](https://nnethercote.github.io/perf-book/build-configuration.html#cranelift-codegen-back-end)
    on x86-64/Linux and ARM/Linux. It is an alternative to the standard LLVM codegen
    backend used by rustc, and is designed to reduce compile times at the cost of
    lower generated code quality. Give it a try for your debug builds! This is the
    culmination of [a lot of work](https://bjorn3.github.io/2023/10/31/progress-report-oct-2023.html)
    by [bjorn3](https://github.com/bjorn3).
  id: totrans-split-13
  prefs: []
  type: TYPE_NORMAL
  zh: 另一则重要消息是，Cranelift代码生成后端现在可以在x86-64/Linux和ARM/Linux上[普遍使用](https://nnethercote.github.io/perf-book/build-configuration.html#cranelift-codegen-back-end)。这是rustc使用的标准LLVM代码生成后端的一个替代方案，旨在减少编译时间，但代价是生成代码质量较低。试试看吧，特别是在调试构建时！这是[由bjorn3进行了大量工作的成果](https://bjorn3.github.io/2023/10/31/progress-report-oct-2023.html)。
- en: Finally, Jakub greatly reduced the size of compiled binaries by [excluding debug
    info by default](https://kobzol.github.io/rust/cargo/2024/01/23/making-rust-binaries-smaller-by-default.html).
    For small programs this can reduce their size on disk by up to 10x!
  id: totrans-split-14
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，Jakub通过[默认排除调试信息](https://kobzol.github.io/rust/cargo/2024/01/23/making-rust-binaries-smaller-by-default.html)大大减小了编译后程序的大小。对于小程序，这可以将它们在磁盘上的大小减少多达10倍！
- en: My (lack of) improvements
  id: totrans-split-15
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 我（缺乏）的改进
- en: For the first time ever, I’m writing one of these posts without having made
    any improvements to compile speed myself. I have always used a profile-driven
    optimization strategy, and the profiles you get when you measure rustc these days
    are incredibly flat. It’s hard to find improvements when the hottest functions
    only account for 1% or 2% of execution time. Because of this I have been working
    on things unrelated to compile speed.
  id: totrans-split-16
  prefs: []
  type: TYPE_NORMAL
  zh: 我第一次在没有自己提高编译速度的情况下写这些帖子。我一直使用基于配置文件的优化策略，而当你测量rustc时得到的配置文件现在非常平坦。在执行时间中，最热门的功能只占1%或2%，很难找到改进的地方。因此，我一直在处理与编译速度无关的事务。
- en: That doesn’t mean there are no speed improvements left to be made, as the previous
    section shows. But they are much harder to find, and often require domain-specific
    insights that are hard to get when fishing around with a general-purpose profiler.
    And there is always other useful work to be done.
  id: totrans-split-17
  prefs: []
  type: TYPE_NORMAL
  zh: 这并不意味着没有可以改进的速度，正如前一部分所示。但是这些改进要难得多，通常需要特定领域的见解，在用通用分析器进行探索时很难获得。而且总是有其他有用的工作要做。
- en: General Progress
  id: totrans-split-18
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 总体进展
- en: For the period 2023-08-23 to 2024-03-04 we had some excellent overall performance
    results.
  id: totrans-split-19
  prefs: []
  type: TYPE_NORMAL
  zh: 在2023-08-23到2024-03-04期间，我们取得了一些出色的整体性能结果。
- en: 'First, [wall-time](https://perf.rust-lang.org/compare.html?start=97fff1f2ed01f6f7c0c204530b693c74d88c2105&end=50e77f133f8eb1f745e05681163a0143d6c4dd7d&stat=wall-time&nonRelevant=true):'
  id: totrans-split-20
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，[墙上时间](https://perf.rust-lang.org/compare.html?start=97fff1f2ed01f6f7c0c204530b693c74d88c2105&end=50e77f133f8eb1f745e05681163a0143d6c4dd7d&stat=wall-time&nonRelevant=true)：
- en: There were 526 results measured across 43 benchmarks.
  id: totrans-split-21
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 测得了43个基准测试中的526个结果。
- en: 437 of these were improvements, and 89 were regressions. The mean change was
    a reduction of 7.13%, and plenty of the reductions were in the double digits.
    (In my [last post](https://nnethercote.github.io/2023/08/25/how-to-speed-up-the-rust-compiler-in-august-2023.html)
    the equivalent reduction was also 7.13%. Quite the coincidence!)
  id: totrans-split-22
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 这些改进有437个，恶化有89个。平均变化是7.13%的减少，许多减少都在两位数范围内。（在我的[上篇文章](https://nnethercote.github.io/2023/08/25/how-to-speed-up-the-rust-compiler-in-august-2023.html)中，等效的减少也是7.13%。真是个巧合！）
- en: 'Next, [peak memory usage](https://perf.rust-lang.org/compare.html?start=97fff1f2ed01f6f7c0c204530b693c74d88c2105&end=50e77f133f8eb1f745e05681163a0143d6c4dd7d&stat=max-rss&nonRelevant=true):'
  id: totrans-split-23
  prefs: []
  type: TYPE_NORMAL
  zh: 下一个，[内存使用峰值](https://perf.rust-lang.org/compare.html?start=97fff1f2ed01f6f7c0c204530b693c74d88c2105&end=50e77f133f8eb1f745e05681163a0143d6c4dd7d&stat=max-rss&nonRelevant=true)：
- en: Again, there were 526 results measured across 43 benchmarks.
  id: totrans-split-24
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 再次，在43个基准测试中，测量了526个结果。
- en: 367 of these were improvements, and 159 were regressions. The mean change was
    a 2.05% reduction, and most of the changes were in the single digits.
  id: totrans-split-25
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 这些改进有367个，恶化有159个。平均变化是2.05%的减少，大多数变化在个位数范围内。
- en: 'Finally, [binary size](https://perf.rust-lang.org/compare.html?start=97fff1f2ed01f6f7c0c204530b693c74d88c2105&end=50e77f133f8eb1f745e05681163a0143d6c4dd7d&stat=size%3Alinked_artifact&nonRelevant=true):'
  id: totrans-split-26
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，[二进制大小](https://perf.rust-lang.org/compare.html?start=97fff1f2ed01f6f7c0c204530b693c74d88c2105&end=50e77f133f8eb1f745e05681163a0143d6c4dd7d&stat=size%3Alinked_artifact&nonRelevant=true)：
- en: There were 324 results measured across 43 benchmarks.
  id: totrans-split-27
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在43个基准测试中，测量了324个结果。
- en: 318 of these were improvements, and 6 were regressions. The mean change was
    a 28.03% reduction, and almost every result was a double-digit reduction.
  id: totrans-split-28
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 这些改进有318个，恶化有6个。平均变化是28.03%的减少，几乎每个结果都是两位数的减少。
- en: If we restrict things to [non-incremental release builds](https://perf.rust-lang.org/compare.html?start=97fff1f2ed01f6f7c0c204530b693c74d88c2105&end=50e77f133f8eb1f745e05681163a0143d6c4dd7d&stat=size%3Alinked_artifact&nonRelevant=true&incrFull=false&incrUnchanged=false&incrPatched=false&check=false&debug=false&doc=false),
    which is the most interesting case for binary size, there were 42 improvements,
    1 regression, and the mean change was a reduction of 37.08%. The `helloworld`
    benchmark saw a whopping 91.05% reduction.
  id: totrans-split-29
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果我们将事物限制在[非增量发布构建](https://perf.rust-lang.org/compare.html?start=97fff1f2ed01f6f7c0c204530b693c74d88c2105&end=50e77f133f8eb1f745e05681163a0143d6c4dd7d&stat=size%3Alinked_artifact&nonRelevant=true&incrFull=false&incrUnchanged=false&incrPatched=false&check=false&debug=false&doc=false)，这对于二进制大小是最有趣的情况，有42个改进，1个恶化，平均变化是37.08%的减少。`helloworld`基准测试看到惊人的91.05%的减少。
- en: These improvements are mostly to the omission of debug info mentioned above,
    plus some metadata improvements made by Mark.
  id: totrans-split-30
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 这些改进主要是上述调试信息的省略，以及由Mark进行的一些元数据改进。
- en: For all three metrics, all but a handful of results met the significance threshold.
    I haven’t bothered separating those results because they made little difference
    to the headline numbers. As always, these measurements are done on Linux.
  id: totrans-split-31
  prefs: []
  type: TYPE_NORMAL
  zh: 对于所有三个度量标准，除了少数结果未达到显著性阈值外，其余均达标。我没有分开这些结果，因为它们对主要数据影响不大。一如既往，这些测量是在Linux上进行的。
- en: Finally, Jakub recently [observed](https://twitter.com/Beranek1582/status/1760546947352453317)
    that compile times (as measured on Linux by the benchmark suite) dropped by 15%
    between February 2023 and February 2024\. The corresponding reductions over each
    of the preceding three years were 7%, 17%, and 13%, and the reduction over the
    whole four year period was 37%. There is something to be said for steady, continuous
    improvements over long periods of time.
  id: totrans-split-32
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，Jakub最近[观察到](https://twitter.com/Beranek1582/status/1760546947352453317)，编译时间（由基准测试套件在Linux上测量）在2023年2月到2024年2月之间下降了15%。前三年的相应减少分别为7%，17%和13%，四年期间的总减少为37%。持续长时间的稳定改进确实有所帮助。
