<!--yml

category: 未分类

日期：2024-05-29 12:43:42

-->

# APFS 今天已经七岁了——The Eclectic Light Company

> 来源：[https://eclecticlight.co/2024/03/27/happy-birthday-apfs-7-years-old-today/](https://eclecticlight.co/2024/03/27/happy-birthday-apfs-7-years-old-today/)

七年前的今天，即2017年3月27日，苹果推出了自Mac OS X 10.0 Cheetah发布16年以来其操作系统中最重大的变化之一。那天，将iOS更新到版本10.3的人们的iPhone存储被悄悄地转换为苹果文件系统的首个发布版本APFS。六个月后，随着2017年9月25日macOS 10.13 High Sierra的发布，Mac用户也步入了同样的行列。

当时，这些都是非常大的赌注。灾难的可能性很大，临近最后时刻，苹果决定那些带有Fusion Drive的Mac还必须继续使用旧的Mac OS 扩展文件系统（HFS+）一年，然后它们也可以从APFS启动。在一些市场，特别是韩国，即使是苹果自己的软件也无法适应新文件系统处理文件名方式的变化。

尽管在过去的七年中，APFS确实有其低谷时期，但苹果的赌注最终取得了成功，并且对Apple Silicon Mac的成功起到了关键作用。如果没有APFS，诸如安全引导和签名系统卷（SSV）等基本技术可能会更加困难，甚至不可能实现。多年来，Mac和苹果的设备一直急需现代化文件系统；尽管曾有过可能是ZFS的时刻，但在2014年，苹果决定从头开始编写自己的文件系统，Dominic Giampaolo和Mike Mackovitch担任首席工程师。

#### 史前历史

第一台Mac使用的是MFS，专为400 KB软盘设计，无法处理大于20 MB的存储。1985年，这被用HFS替代，后来在1998年演变为HFS+，旨在解决硬盘寻址时间、碎片化和有限的存储空间问题。2002年，添加了日志功能以提高其可靠性。

苹果在2016年的WWDC上宣布了APFS，预计如果开发和测试顺利的话，将在18个月后发布。那些希望得到ZFS的人感到失望，今天仍然有很多人如此。但在过去的七年里，APFS已经克服了大部分最初的问题，现在是最广泛使用的文件系统之一，并且在从手表到大型企业网络的各种设备上表现出色。

#### 历史

macOS Sierra已经有了供那些想要预览的人使用的预发布版本。当我们升级到High Sierra时，发现与即将到来的版本相比，它们大相径庭。

在测试版期间，APFS 与广受欢迎的融合驱动器之间发现了基本问题。macOS 10.13 的首次发布搭载了 APFS 版本 748.1.46，但突然停止支持这些驱动器，只对固态硬盘和硬盘上的启动卷进行了转换。快照起初不稳定，很快就清楚，APFS 永远不会在旋转磁盘上表现良好。

High Sierra 在早期发布历史上颇为风波，一系列安全问题搅局。不到两周后的 10.13 补充更新修复了漏洞，留下 10.13.1 于 10 月 31 日优化快照。许多人期待对融合驱动器的问题能迅速修复，但直到隔年 9 月才解决。另一个困扰 APFS 引入所有平台的问题是，在测试版期间拒绝集成 Unicode 正规化，这得在 macOS 10.13 和 iOS 10 的后续版本中解决，详见[这里](https://mjtsai.com/blog/2017/06/27/apfs-native-normalization/)和[这里](https://eclecticlight.co/2021/05/08/explainer-unicode-normalization-and-apfs/)。

2018 年 9 月，苹果终于发布了 Mojave 10.14，并支持了融合驱动器，附带首个苹果文件系统参考资料版本。尽管这是一份长而详细的文档，开发人员很快意识到其不完整，尽管其发布已有很长一段时间。终于第三方文件系统开发人员有了一些切实的信息可以使用，用户开始认为第三方磁盘维护和修复工具即将推出。

Catalina 对 APFS 做出了重大改变，使用扩展卷角色形成系统卷组，其独立但使用链接指向的系统和数据卷。macOS 10.15.5 修复了一个严重的错误，阻止向 RAID 卷传输大量数据。当时，苹果发布了更新版本的苹果文件系统参考资料，建立了第三方工具即将问世的预期，至少在那些不知晓仍有多少信息缺失的人中间如此。近四年后，仍然是 2020 年 6 月 22 日的那一版仍是苹果发布的有关 APFS 的最新信息。

更重大的变化出现在2020年11月发布的Big Sur 11.0.1版本中，引入了封闭和签名的快照，现在用于启动macOS。这也是第一个支持将Time Machine备份到APFS卷，并支持Apple Silicon Mac的发布。从那时起，macOS继续利用APFS中的许多新功能。苹果持续未能通知开发者即使发生了变化，似乎Monterey增加了一个功能来修剪UDRW磁盘映像，直到一年多前才[被发现](https://eclecticlight.co/2023/01/15/last-week-on-my-mac-how-apfs-trims-a-disk-image-to-size/)。谁知道Sonoma中APFS仍然隐藏了什么？

#### 空闲空间还是耐久性？

或许对于APFS最常见的日常烦恼是它似乎无法清晰地估算容器中的可用空间。这是其复杂性的弊端，使得空闲空间动态变化，因此其中很多可能是暂时性的和有条件的。我和其他人已经多次写到，我们对macOS目前所有空闲空间估计的信心不足，这在最关键的时候表现最糟糕，例如在尝试更新macOS时。

然而，几乎没有引起注意的是APFS如何设计来延长SSD的工作寿命，通过最小化写入/擦除周期的数量。尽管用户可能无法意识到使用稀疏文件和克隆文件所实现的空间效率，例如，通过减少实际写入存储块的文件存储，但是使用APFS每个写入/擦除周期应存储唯一数据，而不是不必要的副本或空数据。

对于那些被迫使用硬盘进行存储的人来说，这些都没有什么或没有安慰，即使只是用于Time Machine备份。尽管绝大多数APFS用户的设备永远不会连接到硬盘，但对于在macOS中运行它的少数用户来说，它们仍然是备份和其他大容量存储的首选介质，并且易受文件系统碎片化导致的性能下降的影响。

#### 第三方工具

尽管苹果早先暗示APFS可能会作为开源发布，但经过七年，由苹果发布的其内部信息仍然似乎不足以使第三方开发者能够创建独立于macOS捆绑工具之外的维护工具。这不仅仅是关于外部开发者有可能改进`fsck`或磁盘工具的性能，还涉及到苹果没有显示支持的功能。

虽然苹果可能满足于仅在文件系统本身中检查完整性，但许多用户也希望确保关键数据不会损坏或修改。在文档不足的情况下，对完整性检查的第三方支持仍然相对笨拙。

另一个显著且持久的遗漏是基本能力，即将 Time Machine 备份复制到不同的存储设备上。受到报告的鼓舞，我最近再次尝试使用 Disk Utility 的还原功能进行此操作，但一再被告知我的 Time Machine 备份存储卷不是正确类型，无法复制到其他位置。

苹果不愿意记录 APFS 的内部细节，可能是因为文件系统与 macOS 安全性有着深度关联。如果是这样，那么出于安全性而剥夺我们更好地保护 Mac 上数据的工具的选择是一种奇怪的选择。也许如果 APFS 没有取得如此大的成功，我们或许可以知道更多关于它的秘密。

#### 版本编号

APFS 版本号非常重要，因为它们在文件系统中被引用，并且可能被用来指明创建特定容器或卷的版本，以及最后修改它的版本。

其主要版本号随 macOS 的主要版本变化：

+   macOS 10.12 的 APFS 版本是 0.3 或 249.x.x。

+   10.13 的版本是 748.x.x。

+   10.14 的版本是 945.x.x。

+   10.15 的版本是 1412.x.x。

+   11 的版本是 1677.x.x。

+   12 的版本是 1933.x.x 直到 12.2，之后是 1934.x.x。

+   13 的版本是 2142.x.x。

+   14 的版本是 2235.x.x 直到 14.3，之后是 2236.x.x。

小版本号会随 macOS 的小版本递增，而补丁号则没有规律可循。因此，更改版本号并不能说明对 APFS 所做更改的范围或重要性。由于苹果很少提供有关对 APFS 所做更改的信息，所以任何人都无法猜测到具体情况。

#### APFS 生日快乐，感谢所有工程师们的努力，使其如此成功。

*2024 年 3 月 28 日更改，将迈克·麦克沃奇添加为联合首席工程师，感谢多米尼克·贾帕洛不愿独占风头（请参阅他的下方评论）。*
