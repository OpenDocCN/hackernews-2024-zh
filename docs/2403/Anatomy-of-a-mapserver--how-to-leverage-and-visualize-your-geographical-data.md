<!--yml

category: 未分类

date: 2024-05-27 15:04:05

-->

# 地图服务器的解剖学：如何利用和可视化您的地理数据

> 来源：[https://www.go-inicio.com/blog/anatomy-of-a-mapserver-how-to-leverage-and-visualize-your-geographical-data](https://www.go-inicio.com/blog/anatomy-of-a-mapserver-how-to-leverage-and-visualize-your-geographical-data)

# **地图服务器的解剖学：如何利用和可视化您的地理数据**

在 Inicio 我们建立了 Eywa，一个可以使用数十亿地理数据点找到最佳太阳能发电厂位置的算法。有时，理解所有这些数据可能很困难：森林、潮湿地区、地籍等。

为了帮助我们的团队对这些数据实际**看起来**是什么有所了解，我们建立了一个工具，允许在多个客户端进行可视化。它是一个构建地图的服务器，建立在一个名为 MapServer 的库上。

现在，我们在各个地方都使用这个服务器：从 QA 以确保我们的算法是否按预期使用正确数据，到业务开发团队使用它来从算法找到的最佳位置中进行选择。

这篇博文将指导您在开始在 Inicio 设置这个软件时，我希望自己当初知道的事情。

布列塔尼的土壤类型，每种颜色代表一种类型的土壤：矿物质、石灰岩、潮湿等。

## **为什么需要一个 MapServer？**

+   **可视化**：地理数据固有地是可视的。我们都对阅读地图和在空间中可视化数据有一定的亲和力。您可以对空间数据进行任意转换，但如果您无法将其可视化，将很难提取有用的见解。

+   **展示**：将您的见解发布并展示给世界。

+   **分享**：将您的数据集成到许多 GIS 工具和 Web 地图可视化中。您已经创建了一个很棒的数据可视化，想与世界分享？

    可以在您的网站上设置交互式地图可视化就足够了。**‍**

+   **构建：** 创建一个健壮且始终更新的资源以适应您的业务需求。

### **它能做什么？**

一个地图服务器连接到各种地理数据源。它可以执行转换、过滤、组合和样式化。然后，通过服务器使数据可用。

这听起来可能相对简单，但地理数据是具有挑战性的。您需要关注投影、索引和有效地提供非常复杂的几何数据。

### **为什么选择 MapServer 而不是 Geoserver**

在地图服务器的世界中，有两个主要的选择：MapServer 和 Geoserver。

在 Inicio，我们很快意识到我们需要一个可扩展、灵活且快速的地图服务器来服务我们大量且不断增长的地理数据，我们既摄取又产生这些数据。

+   MapServer 速度快：它是用 C 语言构建的，并且大量使用了几何数据操作中最成熟和最快的库：GDAL 和 PROJ。

+   MapServer 轻巧

+   MapServer 是可配置和可脚本化的

+   MapServer 是开源的，并且已经由一个庞大的社区积极维护了将近 30 年，还得到了诸如 NASA 等大型组织的资助！（当我说积极维护时，我的意思是：截至 2023 年 4 月的最新版本已发布）

# **Mapserver 的结构解剖**

MapServer 的组成部分包括：

## **mapfile 究竟是什么？**

mapfile 只是一个用 MapServer 配置语言编写的配置文件。它定义了服务器绘制地图所需的一切。对象用开放标签定义，并且。

这是一个 mapfile 的最小示例。缩进是可选的，但有助于保持整体结构清晰。

这里是一个带有注释的示例文件：

💡 选择为 MapServer 配置文件制定自定义配置语言是一个令人惊讶的选择。

当这个库被创建时可能是有意义的，但现在似乎没有比 JSON 或 TOML 等现在得到广泛支持和配备大量工具的东西更有优势。

在 Inicio，我们实际上使用 [Pydantic](https://docs.pydantic.dev/latest/) 模型来镜像这些配置文件的结构，并将它们序列化为 mapfile 格式！这使我们能够生成和操作这些配置文件作为 Python 对象，而不必担心不常见的语法。“配置即代码”

**‍**

### **我可以使用什么样的数据源？**

您可以从 MapServer 中提供各种不同类型的地理数据。这些数据源是服务器的支柱。

数据可以从文件中读取，支持多种格式（例如 Shapefile、GML、GeoJSON、KML，[以及更多](https://mapserver.org/input/vector/index.html#vector)）。

在 Inicio，我们经常使用的另一个选项是直接从数据库中读取数据的能力。我们运行一个支持 Postgis 的数据库来存储大部分地理数据，我们的 MapServer 直接从中获取所需的数据。

在 mapfile 中对数据库运行查询看起来像这样：

必填字段是一个唯一的 `id` 和一个 `geometry`（或 postigs `geography`）。在这里，我们导出额外的字段，这些字段将用于在图层内显示信息，例如根据植物类型着色区域。

在提供大量数据时，使用空间索引至关重要，服务器知道如何在显示边界框内的数据时利用它们。

### **什么是图层？如何创建一个？**

图层是您将通过服务器提供的数据的基础结构。

下面的图层是一个示例，直接从数据库向 WMS 端点提供森林数据。

在 Inicio，我们使用标准协议来提供我们的数据，比如 WMS。它被大多数 GIS 软件和库支持，并允许高效地提供大量数据。

‍

💡 **什么是** [**WMS**](https://en.wikipedia.org/wiki/Web_Map_Service)**？**

Web Map Service 是用于提供地理数据的标准。它基于 XML，通常以图像的形式（PNG、JPEG 等）提供数据。

这种格式使得以视觉方式显示复杂的空间数据变得简单。它可以通过将数据呈现为图像并发送回来，在一个边界框内提供矢量和栅格数据。

让我们一步步地解码上面的图层定义：

### **我应该为WMS服务器层添加什么元数据？**

第一部分包含了层的一些元数据。为了通过WMS提供数据，有一些必需的元数据，比如`"wms_include_items"`，它指定是否应该在层中包括所有输入数据。

### **定义**

此部分定义了数据的来源，如何访问它，是否应该显示它，它覆盖的范围以及应该以哪种投影方式提供它。

### **你如何指定样式？**

最后一部分是关于给图层设置样式。这意味着定义图层对象的颜色、宽度、透明度以及所有其他细节。

这里的好处是颜色可以作为SQL查询的一部分返回。

### **我如何运行它？通过支持CGI的服务器**

现在我们谈论我们服务器的前端。

这也许是MapServer尊贵年龄的另一个标志，但推荐的运行方式是通过一个支持CGI的服务器，通常意味着一个Apache HTTP服务器（已接近30年历史！）。

这是一个经过战斗考验的服务器软件，目前在小型和大型结构中运行着非常多的服务器。它也是超级可定制的，使其成为一个总体可靠和强大的软件。然而，这是以简单性为代价的，很容易在基本上可以让你做任何事情（包括危险的事情 ☠️）的定制选项中迷失方向。

对于我们的生产服务器，我们选择在我们基础设施的一个受保护良好的部分内运行一个配置良好的Apache服务器。然后，另一个前端反向代理处理所有的重要工作，包括HTTPS、身份验证、提供其他服务以及一些静态文件。

### **接下来怎么办？**

+   一旦您的MapServer提供了WMS并运行起来，并且您正在得到一些使用，您可能想考虑缓存提供的瓦片以使访问更快（以存储和复杂性为代价）。在Inicio，我们使用[mapproxy](https://mapproxy.org/)来缓存我们的WMS瓦片。[MapCache](https://mapserver.org/mapcache/index.html)，来自MapServer的同一开发者，也可能值得一试。

+   脚本化创建图层。一旦开始提供多个数据源，编写Map文件可能会开始感觉重复，而且很容易诱惑到脚本生成它们。你可以像我们一样自己做出解决方案，或者使用像[MapScript](https://mapserver.org/mapscript/index.html)这样的外部库。

+   在MapServer上有很多潜在的优化和调优可以进行，这取决于你的使用情况。[MapServer文档](https://mapserver.org/optimization/index.html)中有一些很好的提示可以帮助你入门。

‍
